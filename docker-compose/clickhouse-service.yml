version: "2.3"

services:
  clickhouse:
    # This looks weird, but it allows running subsequent docker-compose commands without CLICKHOUSE_DOCKER_IMAGE in the environment
    image: $CLICKHOUSE_DOCKER_IMAGE
    build:
      context: .
      dockerfile: clickhouse.Dockerfile
      args:
        CLICKHOUSE_DOCKER_IMAGE: $CLICKHOUSE_DOCKER_IMAGE

    init: true
    expose:
      - "9000"
      - "9009"
      - "8123"
    environment:
      - COORDINATOR_HOST_1=${CLICKHOUSE_TESTS_COORDINATOR}1
      - COORDINATOR_HOST_2=${CLICKHOUSE_TESTS_COORDINATOR}2
      - COORDINATOR_HOST_3=${CLICKHOUSE_TESTS_COORDINATOR}3
    entrypoint: tail -f /dev/null
    healthcheck:
      test: echo 1
      interval: 10s
      timeout: 10s
      retries: 3
      start_period: 300s
    cap_add:
      - SYS_PTRACE
    security_opt:
      - label:disable
