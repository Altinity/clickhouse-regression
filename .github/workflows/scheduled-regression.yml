name: Run scheduled CI/CD regression tests
run-name: ${{ github.actor }} is running regression tests
on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:
    inputs:
      package:
        description: "Package either 'docker://' or 'https://'. Example: 'https://s3.amazonaws.com/clickhouse-builds/23.3/.../package_release/clickhouse-common-static_23.3.1.64_amd64.deb', or 'docker://clickhouse/clickhouse-server:22.11.6-alpine'"
        required: true
        type: string
        default: docker://clickhouse/clickhouse-server
      version:
        description: "Expected version. Example: 23.3.1.64"
        required: true
        type: string
        default: 23.2.2.20
      artifacts:
        description: "Artifact S3 bucket"
        type: choice
        options:
          - internal
          - public

env:
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_REPORT_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_REPORT_SECRET_ACCESS_KEY }}
  AWS_DEFAULT_REGION: ${{ secrets.AWS_REPORT_REGION }}
  PYTHONIOENCODING: utf-8
  artifacts: ${{ inputs.artifacts }}
  args: --test-to-end
    --local
    --collect-service-logs 
    --output ${{ vars.OUTPUT }} 
    --parallel ${{ vars.PARALLEL }}
    --attr project="$GITHUB_REPOSITORY" project.id="$GITHUB_REPOSITORY_ID" user.name="$GITHUB_ACTOR" version="${{ inputs.version }}" package="${{ inputs.package }}" repository="https://github.com/Altinity/clickhouse-regression" commit.hash="$GITHUB_SHA" job.id="$GITHUB_RUN_ID" job.url="$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID" arch="${{ vars.ARCH }}"
    --log raw.log
  artifact_paths: |
    ./report.html
    ./*.log.txt
    ./*.log
    ./*.html
    ./*/_instances/*.log
    ./*/_instances/*/logs/*.log
    ./*/*/_instances/*/logs/*.log
    ./*/*/_instances/*.log

jobs:
  aes_encryption:
    strategy:
      matrix:
        include:
          - version: 22.8.13.21.altinitystable
            clickhouse_binary_path: docker://altinity/clickhouse-server
          - version: 22.3.15.34.altinitystable
            clickhouse_binary_path: docker://altinity/clickhouse-server
          - version: 23.2.4.12
            clickhouse_binary_path: docker://clickhouse/clickhouse-server
    runs-on: self-hosted
    env:
      SUITE: aes_encryption
      clickhouse_binary_path: ${{ matrix.clickhouse_binary_path }}
      version: ${{ matrix.version }}
    steps:
      - uses: actions/checkout@v3

      - name: Setup
        run: .github/setup.sh

      - name: Run ${{ env.SUITE }} suite
        run: python3
              -u ${{ env.SUITE }}/regression.py
              --clickhouse-binary-path ${{ env.clickhouse_binary_path }}
              --clickhouse-version ${{ env.version }}
              ${{ env.args }}

      - name: Create and upload logs
        if: success() || failure()
        run: .github/create_and_upload_logs.sh ${{ vars.UPLOAD_LOGS }}

      - uses: actions/upload-artifact@v3
        if: always()
        with:
          name: ${{ env.SUITE }}-artifacts
          path: ${{ env.artifact_paths}}

  aggregate_functions:
    strategy:
      matrix:
        include:
          - version: 22.8.13.21.altinitystable
            clickhouse_binary_path: docker://altinity/clickhouse-server
          - version: 22.3.15.34.altinitystable
            clickhouse_binary_path: docker://altinity/clickhouse-server
          - version: 23.2.4.12
            clickhouse_binary_path: docker://clickhouse/clickhouse-server
    runs-on: self-hosted
    env:
      SUITE: aggregate_functions
      clickhouse_binary_path: ${{ matrix.clickhouse_binary_path }}
      version: ${{ matrix.version }}
    steps:
      - uses: actions/checkout@v3

      - name: Setup
        run: .github/setup.sh

      - name: Run ${{ env.SUITE }} suite
        run: python3
              -u ${{ env.SUITE }}/regression.py
              --clickhouse-binary-path ${{ env.clickhouse_binary_path }}
              --clickhouse-version ${{ env.version }}
              ${{ env.args }}

      - name: Create and upload logs
        if: success() || failure()
        run: .github/create_and_upload_logs.sh ${{ vars.UPLOAD_LOGS }}

      - uses: actions/upload-artifact@v3
        if: always()
        with:
          name: ${{ env.SUITE }}-artifacts
          path: ${{ env.artifact_paths}}

  atomic_insert:
    strategy:
      matrix:
        include:
          - version: 22.8.13.21.altinitystable
            clickhouse_binary_path: docker://altinity/clickhouse-server
          - version: 22.3.15.34.altinitystable
            clickhouse_binary_path: docker://altinity/clickhouse-server
          - version: 23.2.4.12
            clickhouse_binary_path: docker://clickhouse/clickhouse-server
    runs-on: self-hosted
    env:
      SUITE: atomic_insert
      clickhouse_binary_path: ${{ matrix.clickhouse_binary_path }}
      version: ${{ matrix.version }}
    steps:
      - uses: actions/checkout@v3

      - name: Setup
        run: .github/setup.sh

      - name: Run ${{ env.SUITE }} suite
        run: python3
              -u ${{ env.SUITE }}/regression.py
              --clickhouse-binary-path ${{ env.clickhouse_binary_path }}
              --clickhouse-version ${{ env.version }}
              ${{ env.args }}

      - name: Create and upload logs
        if: success() || failure()
        run: .github/create_and_upload_logs.sh ${{ vars.UPLOAD_LOGS }}

      - uses: actions/upload-artifact@v3
        if: always()
        with:
          name: ${{ env.SUITE }}-artifacts
          path: ${{ env.artifact_paths}}

  base_58:
    strategy:
      matrix:
        include:
          - version: 22.8.13.21.altinitystable
            clickhouse_binary_path: docker://altinity/clickhouse-server
          - version: 22.3.15.34.altinitystable
            clickhouse_binary_path: docker://altinity/clickhouse-server
          - version: 23.2.4.12
            clickhouse_binary_path: docker://clickhouse/clickhouse-server
    runs-on: self-hosted
    env:
      SUITE: base_58
      clickhouse_binary_path: ${{ matrix.clickhouse_binary_path }}
      version: ${{ matrix.version }}
    steps:
      - uses: actions/checkout@v3

      - name: Setup
        run: .github/setup.sh

      - name: Run ${{ env.SUITE }} suite
        run: python3
              -u ${{ env.SUITE }}/regression.py
              --clickhouse-binary-path ${{ env.clickhouse_binary_path }}
              --clickhouse-version ${{ env.version }}
              ${{ env.args }}

      - name: Create and upload logs
        if: success() || failure()
        run: .github/create_and_upload_logs.sh ${{ vars.UPLOAD_LOGS }}

      - uses: actions/upload-artifact@v3
        if: always()
        with:
          name: ${{ env.SUITE }}-artifacts
          path: ${{ env.artifact_paths}}

  # benchmark:
  #   strategy:
  #     matrix:
  #       include:
  #         - version: 22.8.13.21.altinitystable
  #           clickhouse_binary_path: docker://altinity/clickhouse-server
  #         - version: 22.3.15.34.altinitystable
  #           clickhouse_binary_path: docker://altinity/clickhouse-server
  #         - version: 23.2.4.12
  #           clickhouse_binary_path: docker://clickhouse/clickhouse-server
  #   runs-on: self-hosted
  #   env:
  #     SUITE: ontime_benchmark
  #   steps:
  #     - uses: actions/checkout@v3

  #     - name: Setup
  #       run: .github/setup.sh

  #     - name: Run ${{ env.SUITE }} suite
  #       run: python3 
  #             -u ${{ env.SUITE }}/benchmark.py
  #             --storage minio
  #             --storage aws_s3
  #             --aws-s3-bucket ${{ secrets.AWS_BUCKET }}
  #             --aws-s3-region ${{ secrets.AWS_REGION }}
  #             --aws-s3-key-id ${{ secrets.AWS_KEY_ID }}
  #             --aws-s3-access-key ${{ secrets.AWS_ACCESS_KEY }}
  #             --storage gcs
  #             --gcs-uri ${{ secrets.GCS_URI }}
  #             --gcs-key-id ${{ secrets.GCS_KEY_ID }}
  #             --gcs-key-secret ${{ secrets.GCS_KEY_SECRET }}
  #             --clickhouse-binary-path ${{ env.clickhouse_binary_path }}
  #             --clickhouse-version ${{ env.version }}
  #             ${{ env.args }}

  #     - name: Create and upload logs
  #       if: success() || failure()
  #       run: .github/create_and_upload_logs.sh ${{ vars.UPLOAD_LOGS }}

  #     - uses: actions/upload-artifact@v3
  #       if: always()
  #       with:
  #         name: benchmark-artifacts
  #         path: ${{ env.artifact_paths}}

  clickhouse_keeper:
    strategy:
      matrix:
        include:
          - version: 22.8.13.21.altinitystable
            clickhouse_binary_path: docker://altinity/clickhouse-server
          - version: 22.3.15.34.altinitystable
            clickhouse_binary_path: docker://altinity/clickhouse-server
          - version: 23.2.4.12
            clickhouse_binary_path: docker://clickhouse/clickhouse-server
    runs-on: self-hosted
    env:
      SUITE: clickhouse_keeper
      clickhouse_binary_path: ${{ matrix.clickhouse_binary_path }}
      version: ${{ matrix.version }}
    steps:
      - uses: actions/checkout@v3

      - name: Setup
        run: .github/setup.sh

      - name: Run ${{ env.SUITE }} suite
        run: python3
              -u ${{ env.SUITE }}/regression.py
              --clickhouse-binary-path ${{ env.clickhouse_binary_path }}
              --clickhouse-version ${{ env.version }}
              ${{ env.args }}

      - name: Create and upload logs
        if: success() || failure()
        run: .github/create_and_upload_logs.sh ${{ vars.UPLOAD_LOGS }}

      - uses: actions/upload-artifact@v3
        if: always()
        with:
          name: ${{ env.SUITE }}-artifacts
          path: ${{ env.artifact_paths}}

  datetime64_extended_range:
    strategy:
      matrix:
        include:
          - version: 22.8.13.21.altinitystable
            clickhouse_binary_path: docker://altinity/clickhouse-server
          - version: 22.3.15.34.altinitystable
            clickhouse_binary_path: docker://altinity/clickhouse-server
          - version: 23.2.4.12
            clickhouse_binary_path: docker://clickhouse/clickhouse-server
    runs-on: self-hosted
    env:
      SUITE: datetime64_extended_range
      clickhouse_binary_path: ${{ matrix.clickhouse_binary_path }}
      version: ${{ matrix.version }}
    steps:
      - uses: actions/checkout@v3

      - name: Setup
        run: .github/setup.sh

      - name: Run ${{ env.SUITE }} suite
        run: python3
              -u ${{ env.SUITE }}/regression.py
              --clickhouse-binary-path ${{ env.clickhouse_binary_path }}
              --clickhouse-version ${{ env.version }}
              ${{ env.args }}

      - name: Create and upload logs
        if: success() || failure()
        run: .github/create_and_upload_logs.sh ${{ vars.UPLOAD_LOGS }}

      - uses: actions/upload-artifact@v3
        if: always()
        with:
          name: ${{ env.SUITE }}-artifacts
          path: ${{ env.artifact_paths}}

  disk_level_encryption:
    strategy:
      matrix:
        include:
          - version: 22.8.13.21.altinitystable
            clickhouse_binary_path: docker://altinity/clickhouse-server
          - version: 22.3.15.34.altinitystable
            clickhouse_binary_path: docker://altinity/clickhouse-server
          - version: 23.2.4.12
            clickhouse_binary_path: docker://clickhouse/clickhouse-server
    runs-on: self-hosted
    env:
      SUITE: disk_level_encryption
      clickhouse_binary_path: ${{ matrix.clickhouse_binary_path }}
      version: ${{ matrix.version }}
    steps:
      - uses: actions/checkout@v3

      - name: Setup
        run: .github/setup.sh

      - name: Run ${{ env.SUITE }} suite
        run: python3
              -u ${{ env.SUITE }}/regression.py
              --clickhouse-binary-path ${{ env.clickhouse_binary_path }}
              --clickhouse-version ${{ env.version }}
              ${{ env.args }}

      - name: Create and upload logs
        if: success() || failure()
        run: .github/create_and_upload_logs.sh ${{ vars.UPLOAD_LOGS }}

      - uses: actions/upload-artifact@v3
        if: always()
        with:
          name: ${{ env.SUITE }}-artifacts
          path: ${{ env.artifact_paths}}

  dns:
    strategy:
      matrix:
        include:
          - version: 22.8.13.21.altinitystable
            clickhouse_binary_path: docker://altinity/clickhouse-server
          - version: 22.3.15.34.altinitystable
            clickhouse_binary_path: docker://altinity/clickhouse-server
          - version: 23.2.4.12
            clickhouse_binary_path: docker://clickhouse/clickhouse-server
    runs-on: self-hosted
    env:
      SUITE: dns
      clickhouse_binary_path: ${{ matrix.clickhouse_binary_path }}
      version: ${{ matrix.version }}
    steps:
      - uses: actions/checkout@v3

      - name: Setup
        run: .github/setup.sh

      - name: Run ${{ env.SUITE }} suite
        run: python3
              -u ${{ env.SUITE }}/regression.py
              --clickhouse-binary-path ${{ env.clickhouse_binary_path }}
              --clickhouse-version ${{ env.version }}
              ${{ env.args }}

      - name: Create and upload logs
        if: success() || failure()
        run: .github/create_and_upload_logs.sh ${{ vars.UPLOAD_LOGS }}

      - uses: actions/upload-artifact@v3
        if: always()
        with:
          name: ${{ env.SUITE }}-artifacts
          path: ${{ env.artifact_paths}}

  example:
    strategy:
      matrix:
        include:
          - version: 22.8.13.21.altinitystable
            clickhouse_binary_path: docker://altinity/clickhouse-server
          - version: 22.3.15.34.altinitystable
            clickhouse_binary_path: docker://altinity/clickhouse-server
          - version: 23.2.4.12
            clickhouse_binary_path: docker://clickhouse/clickhouse-server
    runs-on: self-hosted
    env:
      SUITE: example
      clickhouse_binary_path: ${{ matrix.clickhouse_binary_path }}
      version: ${{ matrix.version }}
    steps:
      - uses: actions/checkout@v3

      - name: Setup
        run: .github/setup.sh

      - name: Run ${{ env.SUITE }} suite
        run: python3
              -u ${{ env.SUITE }}/regression.py
              --clickhouse-binary-path ${{ env.clickhouse_binary_path }}
              --clickhouse-version ${{ env.version }}
              ${{ env.args }}

      - name: Create and upload logs
        if: success() || failure()
        run: .github/create_and_upload_logs.sh ${{ vars.UPLOAD_LOGS }}

      - uses: actions/upload-artifact@v3
        if: always()
        with:
          name: ${{ env.SUITE }}-artifacts
          path: ${{ env.artifact_paths}}

  extended_precision_data_types:
    strategy:
      matrix:
        include:
          - version: 22.8.13.21.altinitystable
            clickhouse_binary_path: docker://altinity/clickhouse-server
          - version: 22.3.15.34.altinitystable
            clickhouse_binary_path: docker://altinity/clickhouse-server
          - version: 23.2.4.12
            clickhouse_binary_path: docker://clickhouse/clickhouse-server
    runs-on: self-hosted
    env:
      SUITE: extended_precision_data_types
      clickhouse_binary_path: ${{ matrix.clickhouse_binary_path }}
      version: ${{ matrix.version }}
    steps:
      - uses: actions/checkout@v3

      - name: Setup
        run: .github/setup.sh

      - name: Run ${{ env.SUITE }} suite
        run: python3
              -u ${{ env.SUITE }}/regression.py
              --clickhouse-binary-path ${{ env.clickhouse_binary_path }}
              --clickhouse-version ${{ env.version }}
              ${{ env.args }}

      - name: Create and upload logs
        if: success() || failure()
        run: .github/create_and_upload_logs.sh ${{ vars.UPLOAD_LOGS }}

      - uses: actions/upload-artifact@v3
        if: always()
        with:
          name: ${{ env.SUITE }}-artifacts
          path: ${{ env.artifact_paths}}

  # functional:
  #       strategy:
    #   matrix:
    #     include:
    #       - version: 22.8.13.21.altinitystable
    #         clickhouse_binary_path: docker://altinity/clickhouse-server
    #       - version: 22.3.15.34.altinitystable
    #         clickhouse_binary_path: docker://altinity/clickhouse-server
    #       - version: 23.2.4.12
    #         clickhouse_binary_path: docker://clickhouse/clickhouse-server
    # runs-on: self-hosted
  #   env:
  #     SUITE: clickhouse/functional
  #   steps:
  #     - uses: actions/checkout@v3

  #     - name: Setup
  #       run: .github/setup.sh

  #     - name: Run ${{ env.SUITE }} suite
  #       run: python3
  #             -u ${{ env.SUITE }}/functional.py
  #             --clickhouse-binary-path ${{ env.clickhouse_binary_path }}  
  #             --clickhouse-version ${{ env.version }} 
  #             ${{ env.args }}

  #     - name: Create and upload logs
  #       if: success() || failure()
  #       run: .github/create_and_upload_logs.sh ${{ vars.UPLOAD_LOGS }}

  #     - uses: actions/upload-artifact@v3
  #       if: always()
  #       with:
  #         name: clickhouse-functional-artifacts
  #         path: ${{ env.artifact_paths}}

  kafka:
    strategy:
      matrix:
        include:
          - version: 22.8.13.21.altinitystable
            clickhouse_binary_path: docker://altinity/clickhouse-server
          - version: 22.3.15.34.altinitystable
            clickhouse_binary_path: docker://altinity/clickhouse-server
          - version: 23.2.4.12
            clickhouse_binary_path: docker://clickhouse/clickhouse-server
    runs-on: self-hosted
    env:
      SUITE: kafka
      clickhouse_binary_path: ${{ matrix.clickhouse_binary_path }}
      version: ${{ matrix.version }}
    steps:
      - uses: actions/checkout@v3

      - name: Setup
        run: .github/setup.sh

      - name: Run ${{ env.SUITE }} suite
        run: python3
              -u ${{ env.SUITE }}/regression.py
              --clickhouse-binary-path ${{ env.clickhouse_binary_path }}
              --clickhouse-version ${{ env.version }}
              ${{ env.args }}

      - name: Create and upload logs
        if: success() || failure()
        run: .github/create_and_upload_logs.sh ${{ vars.UPLOAD_LOGS }}

      - uses: actions/upload-artifact@v3
        if: always()
        with:
          name: ${{ env.SUITE }}-artifacts
          path: ${{ env.artifact_paths}}

  kerberos:
    strategy:
      matrix:
        include:
          - version: 22.8.13.21.altinitystable
            clickhouse_binary_path: docker://altinity/clickhouse-server
          - version: 22.3.15.34.altinitystable
            clickhouse_binary_path: docker://altinity/clickhouse-server
          - version: 23.2.4.12
            clickhouse_binary_path: docker://clickhouse/clickhouse-server
    runs-on: self-hosted
    env:
      SUITE: kerberos
      clickhouse_binary_path: ${{ matrix.clickhouse_binary_path }}
      version: ${{ matrix.version }}
    steps:
      - uses: actions/checkout@v3

      - name: Setup
        run: .github/setup.sh

      - name: Run ${{ env.SUITE }} suite
        run: python3
              -u ${{ env.SUITE }}/regression.py
              --clickhouse-binary-path ${{ env.clickhouse_binary_path }}
              --clickhouse-version ${{ env.version }}
              ${{ env.args }}

      - name: Create and upload logs
        if: success() || failure()
        run: .github/create_and_upload_logs.sh ${{ vars.UPLOAD_LOGS }}
      - uses: actions/upload-artifact@v3
        if: always()
        with:
          name: ${{ env.SUITE }}-artifacts
          path: ${{ env.artifact_paths}}

  ldap_authentication:
    strategy:
      matrix:
        include:
          - version: 22.8.13.21.altinitystable
            clickhouse_binary_path: docker://altinity/clickhouse-server
          - version: 22.3.15.34.altinitystable
            clickhouse_binary_path: docker://altinity/clickhouse-server
          - version: 23.2.4.12
            clickhouse_binary_path: docker://clickhouse/clickhouse-server
    runs-on: self-hosted
    env:
      SUITE: ldap/authentication
      clickhouse_binary_path: ${{ matrix.clickhouse_binary_path }}
      version: ${{ matrix.version }}
    steps:
      - uses: actions/checkout@v3

      - name: Setup
        run: .github/setup.sh

      - name: Run ${{ env.SUITE }} suite
        run: python3 
              -u ${{ env.SUITE }}/regression.py
              --clickhouse-binary-path ${{ env.clickhouse_binary_path }}
              --clickhouse-version ${{ env.version }}
              ${{ env.args }}

      - name: Create and upload logs
        if: success() || failure()
        run: .github/create_and_upload_logs.sh ${{ vars.UPLOAD_LOGS }}

      - uses: actions/upload-artifact@v3
        if: always()
        with:
          name: ldap-authentication-artifacts
          path: ${{ env.artifact_paths}}

  ldap_external_user_directory:
    strategy:
      matrix:
        include:
          - version: 22.8.13.21.altinitystable
            clickhouse_binary_path: docker://altinity/clickhouse-server
          - version: 22.3.15.34.altinitystable
            clickhouse_binary_path: docker://altinity/clickhouse-server
          - version: 23.2.4.12
            clickhouse_binary_path: docker://clickhouse/clickhouse-server
    runs-on: self-hosted
    env:
      SUITE: ldap/external_user_directory
      clickhouse_binary_path: ${{ matrix.clickhouse_binary_path }}
      version: ${{ matrix.version }}
    steps:
      - uses: actions/checkout@v3

      - name: Setup
        run: .github/setup.sh

      - name: Run ${{ env.SUITE }} suite
        run: python3 
              -u ${{ env.SUITE }}/regression.py
              --clickhouse-binary-path ${{ env.clickhouse_binary_path }}
              --clickhouse-version ${{ env.version }}
              ${{ env.args }}

      - name: Create and upload logs
        if: success() || failure()
        run: .github/create_and_upload_logs.sh ${{ vars.UPLOAD_LOGS }}

      - uses: actions/upload-artifact@v3
        if: always()
        with:
          name: ldap-external_user_directory-artifacts
          path: ${{ env.artifact_paths}}

  ldap_role_mapping:
    strategy:
      matrix:
        include:
          - version: 22.8.13.21.altinitystable
            clickhouse_binary_path: docker://altinity/clickhouse-server
          - version: 22.3.15.34.altinitystable
            clickhouse_binary_path: docker://altinity/clickhouse-server
          - version: 23.2.4.12
            clickhouse_binary_path: docker://clickhouse/clickhouse-server
    runs-on: self-hosted
    env:
      SUITE: ldap/role_mapping
      clickhouse_binary_path: ${{ matrix.clickhouse_binary_path }}
      version: ${{ matrix.version }}
    steps:
      - uses: actions/checkout@v3

      - name: Setup
        run: .github/setup.sh

      - name: Run ${{ env.SUITE }} suite
        run: python3
              -u ${{ env.SUITE }}/regression.py
              --clickhouse-binary-path ${{ env.clickhouse_binary_path }}
              --clickhouse-version ${{ env.version }}
              ${{ env.args }}

      - name: Create and upload logs
        if: success() || failure()
        run: .github/create_and_upload_logs.sh ${{ vars.UPLOAD_LOGS }}

      - uses: actions/upload-artifact@v3
        if: always()
        with:
          name: ldap-role_mapping-artifacts
          path: ${{ env.artifact_paths}}

  lightweight_delete:
    strategy:
      matrix:
        include:
          - version: 22.8.13.21.altinitystable
            clickhouse_binary_path: docker://altinity/clickhouse-server
          - version: 22.3.15.34.altinitystable
            clickhouse_binary_path: docker://altinity/clickhouse-server
          - version: 23.2.4.12
            clickhouse_binary_path: docker://clickhouse/clickhouse-server
    runs-on: self-hosted
    env:
      SUITE: lightweight_delete
      clickhouse_binary_path: ${{ matrix.clickhouse_binary_path }}
      version: ${{ matrix.version }}
    steps:
      - uses: actions/checkout@v3

      - name: Setup
        run: .github/setup.sh

      - name: Run ${{ env.SUITE }} suite
        run: python3 
              -u ${{ env.SUITE }}/regression.py
              --clickhouse-binary-path ${{ env.clickhouse_binary_path }}
              --clickhouse-version ${{ env.version }}
              ${{ env.args }}

      - name: Create and upload logs
        if: success() || failure()
        run: .github/create_and_upload_logs.sh ${{ vars.UPLOAD_LOGS }}

      - uses: actions/upload-artifact@v3
        if: always()
        with:
          name: ${{ env.SUITE }}-artifacts
          path: ${{ env.artifact_paths}}

  map_type:
    strategy:
      matrix:
        include:
          - version: 22.8.13.21.altinitystable
            clickhouse_binary_path: docker://altinity/clickhouse-server
          - version: 22.3.15.34.altinitystable
            clickhouse_binary_path: docker://altinity/clickhouse-server
          - version: 23.2.4.12
            clickhouse_binary_path: docker://clickhouse/clickhouse-server
    runs-on: self-hosted
    env:
      SUITE: map_type
      clickhouse_binary_path: ${{ matrix.clickhouse_binary_path }}
      version: ${{ matrix.version }}
    steps:
      - uses: actions/checkout@v3

      - name: Setup
        run: .github/setup.sh

      - name: Run ${{ env.SUITE }} suite
        run: python3
              -u ${{ env.SUITE }}/regression.py
              --clickhouse-binary-path ${{ env.clickhouse_binary_path }}
              --clickhouse-version ${{ env.version }}
              ${{ env.args }}

      - name: Create and upload logs
        if: success() || failure()
        run: .github/create_and_upload_logs.sh ${{ vars.UPLOAD_LOGS }}

      - uses: actions/upload-artifact@v3
        if: always()
        with:
          name: ${{ env.SUITE }}-artifacts
          path: ${{ env.artifact_paths}}

  parquet:
    strategy:
      matrix:
        include:
          - version: 22.8.13.21.altinitystable
            clickhouse_binary_path: docker://altinity/clickhouse-server
          - version: 22.3.15.34.altinitystable
            clickhouse_binary_path: docker://altinity/clickhouse-server
          - version: 23.2.4.12
            clickhouse_binary_path: docker://clickhouse/clickhouse-server
    runs-on: self-hosted
    env:
      SUITE: parquet
      clickhouse_binary_path: ${{ matrix.clickhouse_binary_path }}
      version: ${{ matrix.version }}
    steps:
      - uses: actions/checkout@v3

      - name: Setup
        run: .github/setup.sh

      - name: Run ${{ env.SUITE }} suite
        run: python3
              -u ${{ env.SUITE }}/regression.py
              --clickhouse-binary-path ${{ env.clickhouse_binary_path }}
              --clickhouse-version ${{ env.version }}
              ${{ env.args }}

      - name: Create and upload logs
        if: success() || failure()
        run: .github/create_and_upload_logs.sh ${{ vars.UPLOAD_LOGS }}

      - uses: actions/upload-artifact@v3
        if: always()
        with:
          name: ${{ env.SUITE }}-artifacts
          path: ${{ env.artifact_paths}}

  part_moves_between_shards:
    strategy:
      matrix:
        include:
          - version: 22.8.13.21.altinitystable
            clickhouse_binary_path: docker://altinity/clickhouse-server
          - version: 22.3.15.34.altinitystable
            clickhouse_binary_path: docker://altinity/clickhouse-server
          - version: 23.2.4.12
            clickhouse_binary_path: docker://clickhouse/clickhouse-server
    runs-on: self-hosted
    env:
      SUITE: part_moves_between_shards
      clickhouse_binary_path: ${{ matrix.clickhouse_binary_path }}
      version: ${{ matrix.version }}
    steps:
      - uses: actions/checkout@v3

      - name: Setup
        run: .github/setup.sh

      - name: Run ${{ env.SUITE }} suite
        run: python3
              -u ${{ env.SUITE }}/regression.py
              --clickhouse-binary-path ${{ env.clickhouse_binary_path }}
              --clickhouse-version ${{ env.version }}
              ${{ env.args }}

      - name: Create and upload logs
        if: success() || failure()
        run: .github/create_and_upload_logs.sh ${{ vars.UPLOAD_LOGS }}

      - uses: actions/upload-artifact@v3
        if: always()
        with:
          name: ${{ env.SUITE }}-artifacts
          path: ${{ env.artifact_paths}}

  rbac:
    strategy:
      matrix:
        include:
          - version: 22.8.13.21.altinitystable
            clickhouse_binary_path: docker://altinity/clickhouse-server
          - version: 22.3.15.34.altinitystable
            clickhouse_binary_path: docker://altinity/clickhouse-server
          - version: 23.2.4.12
            clickhouse_binary_path: docker://clickhouse/clickhouse-server
    runs-on: self-hosted
    env:
      SUITE: rbac
      clickhouse_binary_path: ${{ matrix.clickhouse_binary_path }}
      version: ${{ matrix.version }}
    steps:
      - uses: actions/checkout@v3

      - name: Setup
        run: .github/setup.sh

      - name: Run ${{ env.SUITE }} suite
        run: python3
              -u ${{ env.SUITE }}/regression.py
              --clickhouse-binary-path ${{ env.clickhouse_binary_path }}
              --clickhouse-version ${{ env.version }}
              ${{ env.args }}

      - name: Create and upload logs
        if: success() || failure()
        run: .github/create_and_upload_logs.sh ${{ vars.UPLOAD_LOGS }}

      - uses: actions/upload-artifact@v3
        if: always()
        with:
          name: ${{ env.SUITE }}-artifacts
          path: ${{ env.artifact_paths}}

  selects:
    strategy:
      matrix:
        include:
          - version: 22.8.13.21.altinitystable
            clickhouse_binary_path: docker://altinity/clickhouse-server
          - version: 22.3.15.34.altinitystable
            clickhouse_binary_path: docker://altinity/clickhouse-server
          - version: 23.2.4.12
            clickhouse_binary_path: docker://clickhouse/clickhouse-server
    runs-on: self-hosted
    env:
      SUITE: selects
      clickhouse_binary_path: ${{ matrix.clickhouse_binary_path }}
      version: ${{ matrix.version }}
    steps:
      - uses: actions/checkout@v3

      - name: Setup
        run: .github/setup.sh

      - name: Run ${{ env.SUITE }} suite
        run: python3
              -u ${{ env.SUITE }}/regression.py
              --clickhouse-binary-path ${{ env.clickhouse_binary_path }}
              --clickhouse-version ${{ env.version }}
              ${{ env.args }}

      - name: Create and upload logs
        if: success() || failure()
        run: .github/create_and_upload_logs.sh ${{ vars.UPLOAD_LOGS }}

      - uses: actions/upload-artifact@v3
        if: always()
        with:
          name: ${{ env.SUITE }}-artifacts
          path: ${{ env.artifact_paths}}

  s3_minio:
    strategy:
      matrix:
        include:
          - version: 22.8.13.21.altinitystable
            clickhouse_binary_path: docker://altinity/clickhouse-server
          - version: 22.3.15.34.altinitystable
            clickhouse_binary_path: docker://altinity/clickhouse-server
          - version: 23.2.4.12
            clickhouse_binary_path: docker://clickhouse/clickhouse-server
    runs-on: self-hosted
    env:
      SUITE: s3
      clickhouse_binary_path: ${{ matrix.clickhouse_binary_path }}
      version: ${{ matrix.version }}
    steps:
      - uses: actions/checkout@v3

      - name: Setup
        run: .github/setup.sh

      - name: Run ${{ env.SUITE }} suite
        run: python3 
              -u ${{ env.SUITE }}/regression.py
              --storage minio
              --clickhouse-binary-path ${{ env.clickhouse_binary_path }}
              --clickhouse-version ${{ env.version }}
              ${{ env.args }}

      - name: Create and upload logs
        if: success() || failure()
        run: |
          export STORAGE=minio/
          .github/create_and_upload_logs.sh ${{ vars.UPLOAD_LOGS }}

      - uses: actions/upload-artifact@v3
        if: always()
        with:
          name: ${{ env.SUITE }}-minio-artifacts
          path: ${{ env.artifact_paths}}

  s3_aws:
    strategy:
      matrix:
        include:
          - version: 22.8.13.21.altinitystable
            clickhouse_binary_path: docker://altinity/clickhouse-server
          - version: 22.3.15.34.altinitystable
            clickhouse_binary_path: docker://altinity/clickhouse-server
          - version: 23.2.4.12
            clickhouse_binary_path: docker://clickhouse/clickhouse-server
    runs-on: self-hosted
    env:
      SUITE: s3
      clickhouse_binary_path: ${{ matrix.clickhouse_binary_path }}
      version: ${{ matrix.version }}
    steps:
      - uses: actions/checkout@v3

      - name: Setup
        run: .github/setup.sh

      - name: Run ${{ env.SUITE }} suite
        run: python3 
              -u ${{ env.SUITE }}/regression.py
              --storage aws_s3
              --aws-s3-bucket ${{ secrets.AWS_BUCKET }}
              --aws-s3-region ${{ secrets.AWS_REGION }}
              --aws-s3-key-id ${{ secrets.AWS_KEY_ID }}
              --aws-s3-access-key ${{ secrets.AWS_ACCESS_KEY }}
              --clickhouse-binary-path ${{ env.clickhouse_binary_path }}
              --clickhouse-version ${{ env.version }}
              ${{ env.args }}

      - name: Create and upload logs
        if: success() || failure()
        run: |
          export STORAGE=aws/
          .github/create_and_upload_logs.sh ${{ vars.UPLOAD_LOGS }}

      - uses: actions/upload-artifact@v3
        if: always()
        with:
          name: ${{ env.SUITE }}-aws-artifacts
          path: ${{ env.artifact_paths}}

  s3_gcs:
    strategy:
      matrix:
        include:
          - version: 22.8.13.21.altinitystable
            clickhouse_binary_path: docker://altinity/clickhouse-server
          - version: 22.3.15.34.altinitystable
            clickhouse_binary_path: docker://altinity/clickhouse-server
          - version: 23.2.4.12
            clickhouse_binary_path: docker://clickhouse/clickhouse-server
    runs-on: self-hosted
    env:
      SUITE: s3
      clickhouse_binary_path: ${{ matrix.clickhouse_binary_path }}
      version: ${{ matrix.version }}
    steps:
      - uses: actions/checkout@v3

      - name: Setup
        run: .github/setup.sh

      - name: Run ${{ env.SUITE }} suite
        run: python3 
              -u ${{ env.SUITE }}/regression.py
              --storage gcs
              --gcs-uri ${{ secrets.GCS_URI }}
              --gcs-key-id ${{ secrets.GCS_KEY_ID }}
              --gcs-key-secret ${{ secrets.GCS_KEY_SECRET }}
              --clickhouse-binary-path ${{ env.clickhouse_binary_path }}
              --clickhouse-version ${{ env.version }}
              ${{ env.args }}

      - name: Create and upload logs
        if: success() || failure()
        run: |
          export STORAGE=gcs/
          .github/create_and_upload_logs.sh ${{ vars.UPLOAD_LOGS }}

      - uses: actions/upload-artifact@v3
        if: always()
        with:
          name: ${{ env.SUITE }}-gcs-artifacts
          path: ${{ env.artifact_paths}}

  ssl_server:
    strategy:
      matrix:
        include:
          - version: 22.8.13.21.altinitystable
            clickhouse_binary_path: docker://altinity/clickhouse-server
          - version: 22.3.15.34.altinitystable
            clickhouse_binary_path: docker://altinity/clickhouse-server
          - version: 23.2.4.12
            clickhouse_binary_path: docker://clickhouse/clickhouse-server
    runs-on: self-hosted
    env:
      SUITE: ssl_server
      clickhouse_binary_path: ${{ matrix.clickhouse_binary_path }}
      version: ${{ matrix.version }}
    steps:
      - uses: actions/checkout@v3

      - name: Setup
        run: .github/setup.sh

      - name: Run ${{ env.SUITE }} suite
        run: python3
              -u ${{ env.SUITE }}/regression.py
              --clickhouse-binary-path ${{ env.clickhouse_binary_path }}
              --clickhouse-version ${{ env.version }}
              ${{ env.args }}

      - name: Create and upload logs
        if: success() || failure()
        run: .github/create_and_upload_logs.sh ${{ vars.UPLOAD_LOGS }}

      - uses: actions/upload-artifact@v3
        if: always()
        with:
          name: ${{ env.SUITE }}-artifacts
          path: ${{ env.artifact_paths}}

  tiered_storage:
    strategy:
      matrix:
        include:
          - version: 22.8.13.21.altinitystable
            clickhouse_binary_path: docker://altinity/clickhouse-server
          - version: 22.3.15.34.altinitystable
            clickhouse_binary_path: docker://altinity/clickhouse-server
          - version: 23.2.4.12
            clickhouse_binary_path: docker://clickhouse/clickhouse-server
    runs-on: self-hosted
    env:
      SUITE: tiered_storage
      clickhouse_binary_path: ${{ matrix.clickhouse_binary_path }}
      version: ${{ matrix.version }}
    steps:
      - uses: actions/checkout@v3

      - name: Setup
        run: .github/setup.sh

      - name: Run ${{ env.SUITE }} suite
        run: python3 
              -u ${{ env.SUITE }}/regression.py
              --clickhouse-binary-path ${{ env.clickhouse_binary_path }}
              --clickhouse-version ${{ env.version }}
              ${{ env.args }}

      - name: Create and upload logs
        if: success() || failure()
        run: .github/create_and_upload_logs.sh ${{ vars.UPLOAD_LOGS }}

      - uses: actions/upload-artifact@v3
        if: always()
        with:
          name: ${{ env.SUITE }}-artifacts
          path: ${{ env.artifact_paths}}

  tiered_storage_minio:
    strategy:
      matrix:
        include:
          - version: 22.8.13.21.altinitystable
            clickhouse_binary_path: docker://altinity/clickhouse-server
          - version: 22.3.15.34.altinitystable
            clickhouse_binary_path: docker://altinity/clickhouse-server
          - version: 23.2.4.12
            clickhouse_binary_path: docker://clickhouse/clickhouse-server
    runs-on: self-hosted
    env:
      SUITE: tiered_storage
      clickhouse_binary_path: ${{ matrix.clickhouse_binary_path }}
      version: ${{ matrix.version }}
    steps:
      - uses: actions/checkout@v3

      - name: Setup
        run: .github/setup.sh

      - name: Run ${{ env.SUITE }} suite
        run: python3 
              -u ${{ env.SUITE }}/regression.py
              --with-minio
              --clickhouse-binary-path ${{ env.clickhouse_binary_path }}
              --clickhouse-version ${{ env.version }}
              ${{ env.args }}

      - name: Create and upload logs
        if: success() || failure()
        run: |
          export STORAGE=minio/
          .github/create_and_upload_logs.sh ${{ vars.UPLOAD_LOGS }}

      - uses: actions/upload-artifact@v3
        if: always()
        with:
          name: ${{ env.SUITE }}-minio-artifacts
          path: ${{ env.artifact_paths}}

  tiered_storage_aws:
    strategy:
      matrix:
        include:
          - version: 22.8.13.21.altinitystable
            clickhouse_binary_path: docker://altinity/clickhouse-server
          - version: 22.3.15.34.altinitystable
            clickhouse_binary_path: docker://altinity/clickhouse-server
          - version: 23.2.4.12
            clickhouse_binary_path: docker://clickhouse/clickhouse-server
    runs-on: self-hosted
    env:
      SUITE: tiered_storage
      clickhouse_binary_path: ${{ matrix.clickhouse_binary_path }}
      version: ${{ matrix.version }}
    steps:
      - uses: actions/checkout@v3

      - name: Setup
        run: .github/setup.sh

      - name: Run ${{ env.SUITE }} suite
        run: python3 
              -u ${{ env.SUITE }}/regression.py
              --with-s3amazon
              --aws-s3-access-key ${{ secrets.AWS_ACCESS_KEY }}
              --aws-s3-key-id ${{ secrets.AWS_KEY_ID }}
              --aws-s3-uri https://s3.${{ secrets.AWS_REGION}}.amazonaws.com/${{ secrets.AWS_BUCKET }}/data/
              --clickhouse-binary-path ${{ env.clickhouse_binary_path }}
              --clickhouse-version ${{ env.version }}
              ${{ env.args }}

      - name: Create and upload logs
        if: success() || failure()
        run: |
          export STORAGE=aws/
          .github/create_and_upload_logs.sh ${{ vars.UPLOAD_LOGS }}

      - uses: actions/upload-artifact@v3
        if: always()
        with:
          name: ${{ env.SUITE }}-aws-artifacts
          path: ${{ env.artifact_paths}}

  tiered_storage_gcs:
    strategy:
      matrix:
        include:
          - version: 22.8.13.21.altinitystable
            clickhouse_binary_path: docker://altinity/clickhouse-server
          - version: 22.3.15.34.altinitystable
            clickhouse_binary_path: docker://altinity/clickhouse-server
          - version: 23.2.4.12
            clickhouse_binary_path: docker://clickhouse/clickhouse-server
    runs-on: self-hosted
    env:
      SUITE: tiered_storage
      clickhouse_binary_path: ${{ matrix.clickhouse_binary_path }}
      version: ${{ matrix.version }}
    steps:
      - uses: actions/checkout@v3

      - name: Setup
        run: .github/setup.sh

      - name: Run ${{ env.SUITE }} suite
        run: python3 
              -u ${{ env.SUITE }}/regression.py
              --with-s3gcs 
              --gcs-key-id ${{ secrets.GCS_KEY_ID }}
              --gcs-key-secret ${{ secrets.GCS_KEY_SECRET }}
              --gcs-uri ${{ secrets.GCS_URI }}
              --clickhouse-binary-path ${{ env.clickhouse_binary_path }}
              --clickhouse-version ${{ env.version }}
              ${{ env.args }}

      - name: Create and upload logs
        if: success() || failure()
        run: |
          export STORAGE=gcs/
          .github/create_and_upload_logs.sh ${{ vars.UPLOAD_LOGS }}

      - uses: actions/upload-artifact@v3
        if: always()
        with:
          name: ${{ env.SUITE }}-gcs-artifacts
          path: ${{ env.artifact_paths}}

  window_functions:
    strategy:
      matrix:
        include:
          - version: 22.8.13.21.altinitystable
            clickhouse_binary_path: docker://altinity/clickhouse-server
          - version: 22.3.15.34.altinitystable
            clickhouse_binary_path: docker://altinity/clickhouse-server
          - version: 23.2.4.12
            clickhouse_binary_path: docker://clickhouse/clickhouse-server
    runs-on: self-hosted
    env:
      SUITE: window_functions
      clickhouse_binary_path: ${{ matrix.clickhouse_binary_path }}
      version: ${{ matrix.version }}
    steps:
      - uses: actions/checkout@v3

      - name: Setup
        run: .github/setup.sh

      - name: Run ${{ env.SUITE }} suite
        run: python3
              -u ${{ env.SUITE }}/regression.py
              --clickhouse-binary-path ${{ env.clickhouse_binary_path }}
              --clickhouse-version ${{ env.version }}
              ${{ env.args }}

      - name: Create and upload logs
        if: success() || failure()
        run: .github/create_and_upload_logs.sh ${{ vars.UPLOAD_LOGS }}

      - uses: actions/upload-artifact@v3
        if: always()
        with:
          name: ${{ env.SUITE }}-artifacts
          path: ${{ env.artifact_paths}}