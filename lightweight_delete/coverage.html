<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<link href="https://fonts.googleapis.com/css?family=Open+Sans&display=swap" rel="stylesheet"> 
<style>
body {-webkit-text-size-adjust: 100%; padding: 7vw 15vw 7vw 15vw; color: #2e2e2e; font-family: 'Open Sans', Arial, sans-serif; }
a { color: #3a6cac; text-decoration-line: None; word-break: break-all; }
a:hover { text-decoration-line: underline}
strong { color: #329f7b }
hr { border-top: 1px solid #eaeaea; }
h1, h2 { color: #6594d0; border-bottom: 1px solid #eaeaea; padding-bottom: 0.3em; }
h3 { color: #6594d0; font-size: 1.2em; }
h4 { color: #6594d0; font-size: 1.1em; }
h5 { color: #6594d0; font-size: 1.0em; }
h6 { color: #6594d0; font-size: 0.95em; }
h1[id^="rqsrs"],
h2[id^="rqsrs"],
h3[id^="rqsrs"],
h4[id^="rqsrs"],
h5[id^="rqsrs"],
h6[id^="rqsrs"]
{
  color: white;
  background: #7a4166;
  padding: 10px;
  font-weight: normal;
  border-radius: 5px;
  margin-bottom: 0px;
  cursor: pointer;
}
h1[id^="rqsrs"] + p,
h2[id^="rqsrs"] + p,
h3[id^="rqsrs"] + p,
h4[id^="rqsrs"] + p,
h5[id^="rqsrs"] + p,
h6[id^="rqsrs"] + p
{
  font-size: smaller;
}
th, td { text-align: left; padding-left: 15px; padding-right: 15px; color: #313335 }
thead th { padding-top: 20px; padding-bottom: 20px }
table { display: block; overflow-x: auto; }
table.stripped.danger tr:nth-child(even) { background-color: #f023231f; }
table.stripped.primary tr:nth-child(even) { background-color: #307bbb3b; }
/* Webkit customized scrollbar */
::-webkit-scrollbar { width: 4px; height: 4px; background: transparent; }
::-webkit-scrollbar-thumb { background: #6593d0; }
/* Misc */
.with-border { border: 1px solid #eaeaea; }
/* Tag styles */
.tag {color: white; padding: 1px; padding-left: 10px; padding-right: 10px; border-radius: 15px;}
.tag-0 { background: #19177c;}
.tag-1 { background: #800080;}
.tag-2 { background: #006f80;}
.tag-3 { background: #008033;}
.tag-4 { background: #f87d00;}
code { background: #6593d0; border-radius: 5px; color: white; padding: 2px; }
li.infocus { font-weight: bold !important; }
li.infocus > a { color: #43bd43; }
.highlight code { background: inherit; border-radius: inherit; color: inherit; padding: inherit; }
/* Test map */
#map-chart { border: 1px solid #eaeaea; }
/* Text classes */
.requirement-inline {
    color: #354558;
    border: 1px solid #cccccc;
    display: inline-block;
    margin-bottom: 7px;
    padding: 5px;
    border-radius: 15px;
    margin-top: 5px;
    background: #f8fcff;
}
hr { border-color: #3fdc84; }
ul { padding-left: 1.5em; }
.stripped:nth-child(odd) { background-color: #f8fff9; }
.compact h1,
.compact h2,
.compact h3,
.compact h4,
.compact h5,
.compact h6 { margin: 0; padding: 0.5em 0 0.25em 0; }
.compact p { margin: 0; padding: 0.25em 0 0.25em 0; }
.p-padding-left p { padding-left: 2em; }
.text-small { font-size: small; }
.clearfix { overflow: auto; }
.logo { max-width: 10em; float: right; }
.copyright { color: grey; font-size: 12px; }
.confidential { color: darkorange; }
.hidden { display: none !important; }
.show {display: inherit !important; }
.requirement, .test { cursor: pointer; user-select: none; }
.test.active { border: 1px solid #dedede; border-radius: 15px; background: #fefee7; }
.requirement-inline.active { background: #ffffe7; }
.requirement-description, .test-procedure { border: 1px solid #dedede; padding: 15px; background: #fdfdfd; margin-bottom: 1em; overflow-x: auto; }
.test-description {
    background: #f5f5f5;
    border-radius: 5px;
    padding-left: 1em;
    padding-right: 1em;
    padding-bottom: 0.25em;
    margin-top: 0.25em;
    padding-top: 0.25em;
    font-size: small;
}
.test-procedure { background: #fdfdfd; margin-top: 15px; margin-bottom: 15px; }
.test-procedure .highlight { height: 70vh; }
.no-tests { color: #ffa400; vertical-align: middle; margin-left: 0.5em !important; border: 1px dashed #ffa400; }
/* Result color classes */
.time { color: #666666; }
.time-inline { display: inline-block; margin-right: 10px; margin-left: 10px; width: 6em; }
.result { display: block; font-weight: normal; text-align: center; padding-left: 10px; padding-right: 10px; }
.result-inline { display: inline-block; margin-right: 10px; margin-left: 10px; width: 3em; text-align: center; }
.result-ok { color: #0dad55 }
.result-xout, .result-xok, .result-xfail, .result-xerror, .result-xnull { background-color: #307bbb; color: white; }
.result-retried { background-color: #11c1c1; color: white; }
.result-fail { background-color: #f02323; color: white; }
.result-error { background-color: #ffa400; color: white; }
.result-skip {background-color: #aeaeae; color: white; }
.result-null {background-color: purple; color: white; }
/* UTF-8 icons */
.utf-icon { padding-right: 10px; font-size: 1.5em;}
.color-ok { color: #0dad55; }
.color-fail { color: #f02323; }
.color-error { color: #ffa400; }
.color-null { color: purple; }
/* Code Highlighting */
.highlight .hll { background-color: #ffffcc }
.highlight  { background-color: #fff; color: #383e44; border: 1px solid rgb(229, 229, 229); padding-left: 10px; padding-right: 10px; overflow-y: scroll; display: block;}
.highlight .c { color: #a8a8a8; font-style: italic } /* Comment */
.highlight .err { background-color: #ffeaee; } /* Error */
.highlight .k { color: #6594d0; font-weight: bold } /* Keyword */
.highlight .o { color: #666666 } /* Operator */
.highlight .ch { color: #a8a8a8; font-style: italic } /* Comment.Hashbang */
.highlight .cm { color: #a8a8a8; font-style: italic } /* Comment.Multiline */
.highlight .cp { color: #BC7A00 } /* Comment.Preproc */
.highlight .cpf { color: #a8a8a8; font-style: italic } /* Comment.PreprocFile */
.highlight .c1 { color: #a8a8a8; font-style: italic } /* Comment.Single */
.highlight .cs { color: #a8a8a8; font-style: italic } /* Comment.Special */
.highlight .gd { color: #A00000 } /* Generic.Deleted */
.highlight .ge { font-style: italic } /* Generic.Emph */
.highlight .gr { color: #FF0000 } /* Generic.Error */
.highlight .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.highlight .gi { color: #00A000 } /* Generic.Inserted */
.highlight .go { color: #888888 } /* Generic.Output */
.highlight .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.highlight .gs { font-weight: bold } /* Generic.Strong */
.highlight .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.highlight .gt { color: #0044DD } /* Generic.Traceback */
.highlight .kc { color: #6594d0; font-weight: bold } /* Keyword.Constant */
.highlight .kd { color: #6594d0; font-weight: bold } /* Keyword.Declaration */
.highlight .kn { color: #6594d0; font-weight: bold } /* Keyword.Namespace */
.highlight .kp { color: #6594d0 } /* Keyword.Pseudo */
.highlight .kr { color: #6594d0; font-weight: bold } /* Keyword.Reserved */
.highlight .kt { color: #B00040 } /* Keyword.Type */
.highlight .m { color: #666666 } /* Literal.Number */
.highlight .s { color: #009F64 } /* Literal.String */
.highlight .na { color: #7D9029 } /* Name.Attribute */
.highlight .nb { color: #6594d0 } /* Name.Builtin */
.highlight .nc { color: #0000FF; font-weight: bold } /* Name.Class */
.highlight .no { color: #880000 } /* Name.Constant */
.highlight .nd { color: #AA22FF } /* Name.Decorator */
.highlight .ni { color: #999999; font-weight: bold } /* Name.Entity */
.highlight .ne { color: #D2413A; font-weight: bold } /* Name.Exception */
.highlight .nf { color: #0000FF } /* Name.Function */
.highlight .nl { color: #A0A000 } /* Name.Label */
.highlight .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.highlight .nt { color: #6594d0; } /* Name.Tag */
.highlight .nv { color: #19177C } /* Name.Variable */
.highlight .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.highlight .w { color: #bbbbbb } /* Text.Whitespace */
.highlight .mb { color: #666666 } /* Literal.Number.Bin */
.highlight .mf { color: #666666 } /* Literal.Number.Float */
.highlight .mh { color: #666666 } /* Literal.Number.Hex */
.highlight .mi { color: #666666 } /* Literal.Number.Integer */
.highlight .mo { color: #666666 } /* Literal.Number.Oct */
.highlight .sa { color: #009F64 } /* Literal.String.Affix */
.highlight .sb { color: #009F64 } /* Literal.String.Backtick */
.highlight .sc { color: #009F64 } /* Literal.String.Char */
.highlight .dl { color: #009F64 } /* Literal.String.Delimiter */
.highlight .sd { color: #009F64; font-style: italic } /* Literal.String.Doc */
.highlight .s2 { color: #009F64 } /* Literal.String.Double */
.highlight .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
.highlight .sh { color: #009F64 } /* Literal.String.Heredoc */
.highlight .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
.highlight .sx { color: #6594d0 } /* Literal.String.Other */
.highlight .sr { color: #BB6688 } /* Literal.String.Regex */
.highlight .s1 { color: #009F64 } /* Literal.String.Single */
.highlight .ss { color: #19177C } /* Literal.String.Symbol */
.highlight .bp { color: #6594d0 } /* Name.Builtin.Pseudo */
.highlight .fm { color: #0000FF } /* Name.Function.Magic */
.highlight .vc { color: #19177C } /* Name.Variable.Class */
.highlight .vg { color: #19177C } /* Name.Variable.Global */
.highlight .vi { color: #19177C } /* Name.Variable.Instance */
.highlight .vm { color: #19177C } /* Name.Variable.Magic */
.highlight .il { color: #666666 } /* Literal.Number.Integer.Long */
.highlight .r  { color: purple } /* Result */
.highlight .ro { color: #0dad55; font-weight: bold } /* Result.OK */
.highlight .rf { color: #f02323; font-weight: bold } /* Result.Fail */
.highlight .re { color: #ffa400; font-weight: bold } /* Result.Error */
.highlight .rn { color: purple; font-weight: bold } /* Result.Null */
.highlight .rs { color: #aeaeae; font-weight: bold } /* Result.Skip */
.highlight .rx { color: #307bbb; font-weight: bold } /* Result.Xout */
/* Pie charts */
.chart { float: left; width: 100%; }
/* https://github.com/afuersch/css-percentage-circle
Copyright (c) 2016 Adrian Fürschuß
Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation
files (the "Software"), to deal in the Software without restriction, including without limitation the rights to
use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit
persons to whom the Software is furnished to do so, subject to the following conditions:
The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.
THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT
NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.
IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH
 THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.*/
.rect-auto,
.c100.p51 .slice,
.c100.p52 .slice,
.c100.p53 .slice,
.c100.p54 .slice,
.c100.p55 .slice,
.c100.p56 .slice,
.c100.p57 .slice,
.c100.p58 .slice,
.c100.p59 .slice,
.c100.p60 .slice,
.c100.p61 .slice,
.c100.p62 .slice,
.c100.p63 .slice,
.c100.p64 .slice,
.c100.p65 .slice,
.c100.p66 .slice,
.c100.p67 .slice,
.c100.p68 .slice,
.c100.p69 .slice,
.c100.p70 .slice,
.c100.p71 .slice,
.c100.p72 .slice,
.c100.p73 .slice,
.c100.p74 .slice,
.c100.p75 .slice,
.c100.p76 .slice,
.c100.p77 .slice,
.c100.p78 .slice,
.c100.p79 .slice,
.c100.p80 .slice,
.c100.p81 .slice,
.c100.p82 .slice,
.c100.p83 .slice,
.c100.p84 .slice,
.c100.p85 .slice,
.c100.p86 .slice,
.c100.p87 .slice,
.c100.p88 .slice,
.c100.p89 .slice,
.c100.p90 .slice,
.c100.p91 .slice,
.c100.p92 .slice,
.c100.p93 .slice,
.c100.p94 .slice,
.c100.p95 .slice,
.c100.p96 .slice,
.c100.p97 .slice,
.c100.p98 .slice,
.c100.p99 .slice,
.c100.p100 .slice {
  clip: rect(auto, auto, auto, auto);
}
.pie,
.c100 .bar,
.c100.p51 .fill,
.c100.p52 .fill,
.c100.p53 .fill,
.c100.p54 .fill,
.c100.p55 .fill,
.c100.p56 .fill,
.c100.p57 .fill,
.c100.p58 .fill,
.c100.p59 .fill,
.c100.p60 .fill,
.c100.p61 .fill,
.c100.p62 .fill,
.c100.p63 .fill,
.c100.p64 .fill,
.c100.p65 .fill,
.c100.p66 .fill,
.c100.p67 .fill,
.c100.p68 .fill,
.c100.p69 .fill,
.c100.p70 .fill,
.c100.p71 .fill,
.c100.p72 .fill,
.c100.p73 .fill,
.c100.p74 .fill,
.c100.p75 .fill,
.c100.p76 .fill,
.c100.p77 .fill,
.c100.p78 .fill,
.c100.p79 .fill,
.c100.p80 .fill,
.c100.p81 .fill,
.c100.p82 .fill,
.c100.p83 .fill,
.c100.p84 .fill,
.c100.p85 .fill,
.c100.p86 .fill,
.c100.p87 .fill,
.c100.p88 .fill,
.c100.p89 .fill,
.c100.p90 .fill,
.c100.p91 .fill,
.c100.p92 .fill,
.c100.p93 .fill,
.c100.p94 .fill,
.c100.p95 .fill,
.c100.p96 .fill,
.c100.p97 .fill,
.c100.p98 .fill,
.c100.p99 .fill,
.c100.p100 .fill {
  position: absolute;
  border: 0.08em solid #307bbb;
  width: 0.84em;
  height: 0.84em;
  clip: rect(0em, 0.5em, 1em, 0em);
  border-radius: 50%;
  -webkit-transform: rotate(0deg);
  -moz-transform: rotate(0deg);
  -ms-transform: rotate(0deg);
  -o-transform: rotate(0deg);
  transform: rotate(0deg);
}
.pie-fill,
.c100.p51 .bar:after,
.c100.p51 .fill,
.c100.p52 .bar:after,
.c100.p52 .fill,
.c100.p53 .bar:after,
.c100.p53 .fill,
.c100.p54 .bar:after,
.c100.p54 .fill,
.c100.p55 .bar:after,
.c100.p55 .fill,
.c100.p56 .bar:after,
.c100.p56 .fill,
.c100.p57 .bar:after,
.c100.p57 .fill,
.c100.p58 .bar:after,
.c100.p58 .fill,
.c100.p59 .bar:after,
.c100.p59 .fill,
.c100.p60 .bar:after,
.c100.p60 .fill,
.c100.p61 .bar:after,
.c100.p61 .fill,
.c100.p62 .bar:after,
.c100.p62 .fill,
.c100.p63 .bar:after,
.c100.p63 .fill,
.c100.p64 .bar:after,
.c100.p64 .fill,
.c100.p65 .bar:after,
.c100.p65 .fill,
.c100.p66 .bar:after,
.c100.p66 .fill,
.c100.p67 .bar:after,
.c100.p67 .fill,
.c100.p68 .bar:after,
.c100.p68 .fill,
.c100.p69 .bar:after,
.c100.p69 .fill,
.c100.p70 .bar:after,
.c100.p70 .fill,
.c100.p71 .bar:after,
.c100.p71 .fill,
.c100.p72 .bar:after,
.c100.p72 .fill,
.c100.p73 .bar:after,
.c100.p73 .fill,
.c100.p74 .bar:after,
.c100.p74 .fill,
.c100.p75 .bar:after,
.c100.p75 .fill,
.c100.p76 .bar:after,
.c100.p76 .fill,
.c100.p77 .bar:after,
.c100.p77 .fill,
.c100.p78 .bar:after,
.c100.p78 .fill,
.c100.p79 .bar:after,
.c100.p79 .fill,
.c100.p80 .bar:after,
.c100.p80 .fill,
.c100.p81 .bar:after,
.c100.p81 .fill,
.c100.p82 .bar:after,
.c100.p82 .fill,
.c100.p83 .bar:after,
.c100.p83 .fill,
.c100.p84 .bar:after,
.c100.p84 .fill,
.c100.p85 .bar:after,
.c100.p85 .fill,
.c100.p86 .bar:after,
.c100.p86 .fill,
.c100.p87 .bar:after,
.c100.p87 .fill,
.c100.p88 .bar:after,
.c100.p88 .fill,
.c100.p89 .bar:after,
.c100.p89 .fill,
.c100.p90 .bar:after,
.c100.p90 .fill,
.c100.p91 .bar:after,
.c100.p91 .fill,
.c100.p92 .bar:after,
.c100.p92 .fill,
.c100.p93 .bar:after,
.c100.p93 .fill,
.c100.p94 .bar:after,
.c100.p94 .fill,
.c100.p95 .bar:after,
.c100.p95 .fill,
.c100.p96 .bar:after,
.c100.p96 .fill,
.c100.p97 .bar:after,
.c100.p97 .fill,
.c100.p98 .bar:after,
.c100.p98 .fill,
.c100.p99 .bar:after,
.c100.p99 .fill,
.c100.p100 .bar:after,
.c100.p100 .fill {
  -webkit-transform: rotate(180deg);
  -moz-transform: rotate(180deg);
  -ms-transform: rotate(180deg);
  -o-transform: rotate(180deg);
  transform: rotate(180deg);
}
.c100 {
  position: relative;
  font-size: 120px;
  width: 1em;
  height: 1em;
  border-radius: 50%;
  float: left;
  margin: 0 0.1em 0.1em 0;
  background-color: #cccccc;
}
.c100 *,
.c100 *:before,
.c100 *:after {
  -webkit-box-sizing: content-box;
  -moz-box-sizing: content-box;
  box-sizing: content-box;
}
.c100.center {
  float: none;
  margin: 0 auto;
}
.c100.big {
  font-size: 240px;
}
.c100.small {
  font-size: 80px;
}
.c100 > span {
  position: absolute;
  width: 100%;
  z-index: 1;
  left: 0;
  top: 0;
  width: 5em;
  line-height: 4em;
  font-size: 0.2em;
  color: #307bbb;
  display: block;
  text-align: center;
  white-space: nowrap;
  -webkit-transition-property: all;
  -moz-transition-property: all;
  -o-transition-property: all;
  transition-property: all;
  -webkit-transition-duration: 0.2s;
  -moz-transition-duration: 0.2s;
  -o-transition-duration: 0.2s;
  transition-duration: 0.2s;
  -webkit-transition-timing-function: ease-out;
  -moz-transition-timing-function: ease-out;
  -o-transition-timing-function: ease-out;
  transition-timing-function: ease-out;
}
.c100:after {
  position: absolute;
  top: 0.08em;
  left: 0.08em;
  display: block;
  content: " ";
  border-radius: 50%;
  background-color: #f5f5f5;
  width: 0.84em;
  height: 0.84em;
  -webkit-transition-property: all;
  -moz-transition-property: all;
  -o-transition-property: all;
  transition-property: all;
  -webkit-transition-duration: 0.2s;
  -moz-transition-duration: 0.2s;
  -o-transition-duration: 0.2s;
  transition-duration: 0.2s;
  -webkit-transition-timing-function: ease-in;
  -moz-transition-timing-function: ease-in;
  -o-transition-timing-function: ease-in;
  transition-timing-function: ease-in;
}
.c100 .slice {
  position: absolute;
  width: 1em;
  height: 1em;
  clip: rect(0em, 1em, 1em, 0.5em);
}
.c100.p1 .bar {
  -webkit-transform: rotate(3.6deg);
  -moz-transform: rotate(3.6deg);
  -ms-transform: rotate(3.6deg);
  -o-transform: rotate(3.6deg);
  transform: rotate(3.6deg);
}
.c100.p2 .bar {
  -webkit-transform: rotate(7.2deg);
  -moz-transform: rotate(7.2deg);
  -ms-transform: rotate(7.2deg);
  -o-transform: rotate(7.2deg);
  transform: rotate(7.2deg);
}
.c100.p3 .bar {
  -webkit-transform: rotate(10.8deg);
  -moz-transform: rotate(10.8deg);
  -ms-transform: rotate(10.8deg);
  -o-transform: rotate(10.8deg);
  transform: rotate(10.8deg);
}
.c100.p4 .bar {
  -webkit-transform: rotate(14.4deg);
  -moz-transform: rotate(14.4deg);
  -ms-transform: rotate(14.4deg);
  -o-transform: rotate(14.4deg);
  transform: rotate(14.4deg);
}
.c100.p5 .bar {
  -webkit-transform: rotate(18deg);
  -moz-transform: rotate(18deg);
  -ms-transform: rotate(18deg);
  -o-transform: rotate(18deg);
  transform: rotate(18deg);
}
.c100.p6 .bar {
  -webkit-transform: rotate(21.6deg);
  -moz-transform: rotate(21.6deg);
  -ms-transform: rotate(21.6deg);
  -o-transform: rotate(21.6deg);
  transform: rotate(21.6deg);
}
.c100.p7 .bar {
  -webkit-transform: rotate(25.2deg);
  -moz-transform: rotate(25.2deg);
  -ms-transform: rotate(25.2deg);
  -o-transform: rotate(25.2deg);
  transform: rotate(25.2deg);
}
.c100.p8 .bar {
  -webkit-transform: rotate(28.8deg);
  -moz-transform: rotate(28.8deg);
  -ms-transform: rotate(28.8deg);
  -o-transform: rotate(28.8deg);
  transform: rotate(28.8deg);
}
.c100.p9 .bar {
  -webkit-transform: rotate(32.4deg);
  -moz-transform: rotate(32.4deg);
  -ms-transform: rotate(32.4deg);
  -o-transform: rotate(32.4deg);
  transform: rotate(32.4deg);
}
.c100.p10 .bar {
  -webkit-transform: rotate(36deg);
  -moz-transform: rotate(36deg);
  -ms-transform: rotate(36deg);
  -o-transform: rotate(36deg);
  transform: rotate(36deg);
}
.c100.p11 .bar {
  -webkit-transform: rotate(39.6deg);
  -moz-transform: rotate(39.6deg);
  -ms-transform: rotate(39.6deg);
  -o-transform: rotate(39.6deg);
  transform: rotate(39.6deg);
}
.c100.p12 .bar {
  -webkit-transform: rotate(43.2deg);
  -moz-transform: rotate(43.2deg);
  -ms-transform: rotate(43.2deg);
  -o-transform: rotate(43.2deg);
  transform: rotate(43.2deg);
}
.c100.p13 .bar {
  -webkit-transform: rotate(46.800000000000004deg);
  -moz-transform: rotate(46.800000000000004deg);
  -ms-transform: rotate(46.800000000000004deg);
  -o-transform: rotate(46.800000000000004deg);
  transform: rotate(46.800000000000004deg);
}
.c100.p14 .bar {
  -webkit-transform: rotate(50.4deg);
  -moz-transform: rotate(50.4deg);
  -ms-transform: rotate(50.4deg);
  -o-transform: rotate(50.4deg);
  transform: rotate(50.4deg);
}
.c100.p15 .bar {
  -webkit-transform: rotate(54deg);
  -moz-transform: rotate(54deg);
  -ms-transform: rotate(54deg);
  -o-transform: rotate(54deg);
  transform: rotate(54deg);
}
.c100.p16 .bar {
  -webkit-transform: rotate(57.6deg);
  -moz-transform: rotate(57.6deg);
  -ms-transform: rotate(57.6deg);
  -o-transform: rotate(57.6deg);
  transform: rotate(57.6deg);
}
.c100.p17 .bar {
  -webkit-transform: rotate(61.2deg);
  -moz-transform: rotate(61.2deg);
  -ms-transform: rotate(61.2deg);
  -o-transform: rotate(61.2deg);
  transform: rotate(61.2deg);
}
.c100.p18 .bar {
  -webkit-transform: rotate(64.8deg);
  -moz-transform: rotate(64.8deg);
  -ms-transform: rotate(64.8deg);
  -o-transform: rotate(64.8deg);
  transform: rotate(64.8deg);
}
.c100.p19 .bar {
  -webkit-transform: rotate(68.4deg);
  -moz-transform: rotate(68.4deg);
  -ms-transform: rotate(68.4deg);
  -o-transform: rotate(68.4deg);
  transform: rotate(68.4deg);
}
.c100.p20 .bar {
  -webkit-transform: rotate(72deg);
  -moz-transform: rotate(72deg);
  -ms-transform: rotate(72deg);
  -o-transform: rotate(72deg);
  transform: rotate(72deg);
}
.c100.p21 .bar {
  -webkit-transform: rotate(75.60000000000001deg);
  -moz-transform: rotate(75.60000000000001deg);
  -ms-transform: rotate(75.60000000000001deg);
  -o-transform: rotate(75.60000000000001deg);
  transform: rotate(75.60000000000001deg);
}
.c100.p22 .bar {
  -webkit-transform: rotate(79.2deg);
  -moz-transform: rotate(79.2deg);
  -ms-transform: rotate(79.2deg);
  -o-transform: rotate(79.2deg);
  transform: rotate(79.2deg);
}
.c100.p23 .bar {
  -webkit-transform: rotate(82.8deg);
  -moz-transform: rotate(82.8deg);
  -ms-transform: rotate(82.8deg);
  -o-transform: rotate(82.8deg);
  transform: rotate(82.8deg);
}
.c100.p24 .bar {
  -webkit-transform: rotate(86.4deg);
  -moz-transform: rotate(86.4deg);
  -ms-transform: rotate(86.4deg);
  -o-transform: rotate(86.4deg);
  transform: rotate(86.4deg);
}
.c100.p25 .bar {
  -webkit-transform: rotate(90deg);
  -moz-transform: rotate(90deg);
  -ms-transform: rotate(90deg);
  -o-transform: rotate(90deg);
  transform: rotate(90deg);
}
.c100.p26 .bar {
  -webkit-transform: rotate(93.60000000000001deg);
  -moz-transform: rotate(93.60000000000001deg);
  -ms-transform: rotate(93.60000000000001deg);
  -o-transform: rotate(93.60000000000001deg);
  transform: rotate(93.60000000000001deg);
}
.c100.p27 .bar {
  -webkit-transform: rotate(97.2deg);
  -moz-transform: rotate(97.2deg);
  -ms-transform: rotate(97.2deg);
  -o-transform: rotate(97.2deg);
  transform: rotate(97.2deg);
}
.c100.p28 .bar {
  -webkit-transform: rotate(100.8deg);
  -moz-transform: rotate(100.8deg);
  -ms-transform: rotate(100.8deg);
  -o-transform: rotate(100.8deg);
  transform: rotate(100.8deg);
}
.c100.p29 .bar {
  -webkit-transform: rotate(104.4deg);
  -moz-transform: rotate(104.4deg);
  -ms-transform: rotate(104.4deg);
  -o-transform: rotate(104.4deg);
  transform: rotate(104.4deg);
}
.c100.p30 .bar {
  -webkit-transform: rotate(108deg);
  -moz-transform: rotate(108deg);
  -ms-transform: rotate(108deg);
  -o-transform: rotate(108deg);
  transform: rotate(108deg);
}
.c100.p31 .bar {
  -webkit-transform: rotate(111.60000000000001deg);
  -moz-transform: rotate(111.60000000000001deg);
  -ms-transform: rotate(111.60000000000001deg);
  -o-transform: rotate(111.60000000000001deg);
  transform: rotate(111.60000000000001deg);
}
.c100.p32 .bar {
  -webkit-transform: rotate(115.2deg);
  -moz-transform: rotate(115.2deg);
  -ms-transform: rotate(115.2deg);
  -o-transform: rotate(115.2deg);
  transform: rotate(115.2deg);
}
.c100.p33 .bar {
  -webkit-transform: rotate(118.8deg);
  -moz-transform: rotate(118.8deg);
  -ms-transform: rotate(118.8deg);
  -o-transform: rotate(118.8deg);
  transform: rotate(118.8deg);
}
.c100.p34 .bar {
  -webkit-transform: rotate(122.4deg);
  -moz-transform: rotate(122.4deg);
  -ms-transform: rotate(122.4deg);
  -o-transform: rotate(122.4deg);
  transform: rotate(122.4deg);
}
.c100.p35 .bar {
  -webkit-transform: rotate(126deg);
  -moz-transform: rotate(126deg);
  -ms-transform: rotate(126deg);
  -o-transform: rotate(126deg);
  transform: rotate(126deg);
}
.c100.p36 .bar {
  -webkit-transform: rotate(129.6deg);
  -moz-transform: rotate(129.6deg);
  -ms-transform: rotate(129.6deg);
  -o-transform: rotate(129.6deg);
  transform: rotate(129.6deg);
}
.c100.p37 .bar {
  -webkit-transform: rotate(133.20000000000002deg);
  -moz-transform: rotate(133.20000000000002deg);
  -ms-transform: rotate(133.20000000000002deg);
  -o-transform: rotate(133.20000000000002deg);
  transform: rotate(133.20000000000002deg);
}
.c100.p38 .bar {
  -webkit-transform: rotate(136.8deg);
  -moz-transform: rotate(136.8deg);
  -ms-transform: rotate(136.8deg);
  -o-transform: rotate(136.8deg);
  transform: rotate(136.8deg);
}
.c100.p39 .bar {
  -webkit-transform: rotate(140.4deg);
  -moz-transform: rotate(140.4deg);
  -ms-transform: rotate(140.4deg);
  -o-transform: rotate(140.4deg);
  transform: rotate(140.4deg);
}
.c100.p40 .bar {
  -webkit-transform: rotate(144deg);
  -moz-transform: rotate(144deg);
  -ms-transform: rotate(144deg);
  -o-transform: rotate(144deg);
  transform: rotate(144deg);
}
.c100.p41 .bar {
  -webkit-transform: rotate(147.6deg);
  -moz-transform: rotate(147.6deg);
  -ms-transform: rotate(147.6deg);
  -o-transform: rotate(147.6deg);
  transform: rotate(147.6deg);
}
.c100.p42 .bar {
  -webkit-transform: rotate(151.20000000000002deg);
  -moz-transform: rotate(151.20000000000002deg);
  -ms-transform: rotate(151.20000000000002deg);
  -o-transform: rotate(151.20000000000002deg);
  transform: rotate(151.20000000000002deg);
}
.c100.p43 .bar {
  -webkit-transform: rotate(154.8deg);
  -moz-transform: rotate(154.8deg);
  -ms-transform: rotate(154.8deg);
  -o-transform: rotate(154.8deg);
  transform: rotate(154.8deg);
}
.c100.p44 .bar {
  -webkit-transform: rotate(158.4deg);
  -moz-transform: rotate(158.4deg);
  -ms-transform: rotate(158.4deg);
  -o-transform: rotate(158.4deg);
  transform: rotate(158.4deg);
}
.c100.p45 .bar {
  -webkit-transform: rotate(162deg);
  -moz-transform: rotate(162deg);
  -ms-transform: rotate(162deg);
  -o-transform: rotate(162deg);
  transform: rotate(162deg);
}
.c100.p46 .bar {
  -webkit-transform: rotate(165.6deg);
  -moz-transform: rotate(165.6deg);
  -ms-transform: rotate(165.6deg);
  -o-transform: rotate(165.6deg);
  transform: rotate(165.6deg);
}
.c100.p47 .bar {
  -webkit-transform: rotate(169.20000000000002deg);
  -moz-transform: rotate(169.20000000000002deg);
  -ms-transform: rotate(169.20000000000002deg);
  -o-transform: rotate(169.20000000000002deg);
  transform: rotate(169.20000000000002deg);
}
.c100.p48 .bar {
  -webkit-transform: rotate(172.8deg);
  -moz-transform: rotate(172.8deg);
  -ms-transform: rotate(172.8deg);
  -o-transform: rotate(172.8deg);
  transform: rotate(172.8deg);
}
.c100.p49 .bar {
  -webkit-transform: rotate(176.4deg);
  -moz-transform: rotate(176.4deg);
  -ms-transform: rotate(176.4deg);
  -o-transform: rotate(176.4deg);
  transform: rotate(176.4deg);
}
.c100.p50 .bar {
  -webkit-transform: rotate(180deg);
  -moz-transform: rotate(180deg);
  -ms-transform: rotate(180deg);
  -o-transform: rotate(180deg);
  transform: rotate(180deg);
}
.c100.p51 .bar {
  -webkit-transform: rotate(183.6deg);
  -moz-transform: rotate(183.6deg);
  -ms-transform: rotate(183.6deg);
  -o-transform: rotate(183.6deg);
  transform: rotate(183.6deg);
}
.c100.p52 .bar {
  -webkit-transform: rotate(187.20000000000002deg);
  -moz-transform: rotate(187.20000000000002deg);
  -ms-transform: rotate(187.20000000000002deg);
  -o-transform: rotate(187.20000000000002deg);
  transform: rotate(187.20000000000002deg);
}
.c100.p53 .bar {
  -webkit-transform: rotate(190.8deg);
  -moz-transform: rotate(190.8deg);
  -ms-transform: rotate(190.8deg);
  -o-transform: rotate(190.8deg);
  transform: rotate(190.8deg);
}
.c100.p54 .bar {
  -webkit-transform: rotate(194.4deg);
  -moz-transform: rotate(194.4deg);
  -ms-transform: rotate(194.4deg);
  -o-transform: rotate(194.4deg);
  transform: rotate(194.4deg);
}
.c100.p55 .bar {
  -webkit-transform: rotate(198deg);
  -moz-transform: rotate(198deg);
  -ms-transform: rotate(198deg);
  -o-transform: rotate(198deg);
  transform: rotate(198deg);
}
.c100.p56 .bar {
  -webkit-transform: rotate(201.6deg);
  -moz-transform: rotate(201.6deg);
  -ms-transform: rotate(201.6deg);
  -o-transform: rotate(201.6deg);
  transform: rotate(201.6deg);
}
.c100.p57 .bar {
  -webkit-transform: rotate(205.20000000000002deg);
  -moz-transform: rotate(205.20000000000002deg);
  -ms-transform: rotate(205.20000000000002deg);
  -o-transform: rotate(205.20000000000002deg);
  transform: rotate(205.20000000000002deg);
}
.c100.p58 .bar {
  -webkit-transform: rotate(208.8deg);
  -moz-transform: rotate(208.8deg);
  -ms-transform: rotate(208.8deg);
  -o-transform: rotate(208.8deg);
  transform: rotate(208.8deg);
}
.c100.p59 .bar {
  -webkit-transform: rotate(212.4deg);
  -moz-transform: rotate(212.4deg);
  -ms-transform: rotate(212.4deg);
  -o-transform: rotate(212.4deg);
  transform: rotate(212.4deg);
}
.c100.p60 .bar {
  -webkit-transform: rotate(216deg);
  -moz-transform: rotate(216deg);
  -ms-transform: rotate(216deg);
  -o-transform: rotate(216deg);
  transform: rotate(216deg);
}
.c100.p61 .bar {
  -webkit-transform: rotate(219.6deg);
  -moz-transform: rotate(219.6deg);
  -ms-transform: rotate(219.6deg);
  -o-transform: rotate(219.6deg);
  transform: rotate(219.6deg);
}
.c100.p62 .bar {
  -webkit-transform: rotate(223.20000000000002deg);
  -moz-transform: rotate(223.20000000000002deg);
  -ms-transform: rotate(223.20000000000002deg);
  -o-transform: rotate(223.20000000000002deg);
  transform: rotate(223.20000000000002deg);
}
.c100.p63 .bar {
  -webkit-transform: rotate(226.8deg);
  -moz-transform: rotate(226.8deg);
  -ms-transform: rotate(226.8deg);
  -o-transform: rotate(226.8deg);
  transform: rotate(226.8deg);
}
.c100.p64 .bar {
  -webkit-transform: rotate(230.4deg);
  -moz-transform: rotate(230.4deg);
  -ms-transform: rotate(230.4deg);
  -o-transform: rotate(230.4deg);
  transform: rotate(230.4deg);
}
.c100.p65 .bar {
  -webkit-transform: rotate(234deg);
  -moz-transform: rotate(234deg);
  -ms-transform: rotate(234deg);
  -o-transform: rotate(234deg);
  transform: rotate(234deg);
}
.c100.p66 .bar {
  -webkit-transform: rotate(237.6deg);
  -moz-transform: rotate(237.6deg);
  -ms-transform: rotate(237.6deg);
  -o-transform: rotate(237.6deg);
  transform: rotate(237.6deg);
}
.c100.p67 .bar {
  -webkit-transform: rotate(241.20000000000002deg);
  -moz-transform: rotate(241.20000000000002deg);
  -ms-transform: rotate(241.20000000000002deg);
  -o-transform: rotate(241.20000000000002deg);
  transform: rotate(241.20000000000002deg);
}
.c100.p68 .bar {
  -webkit-transform: rotate(244.8deg);
  -moz-transform: rotate(244.8deg);
  -ms-transform: rotate(244.8deg);
  -o-transform: rotate(244.8deg);
  transform: rotate(244.8deg);
}
.c100.p69 .bar {
  -webkit-transform: rotate(248.4deg);
  -moz-transform: rotate(248.4deg);
  -ms-transform: rotate(248.4deg);
  -o-transform: rotate(248.4deg);
  transform: rotate(248.4deg);
}
.c100.p70 .bar {
  -webkit-transform: rotate(252deg);
  -moz-transform: rotate(252deg);
  -ms-transform: rotate(252deg);
  -o-transform: rotate(252deg);
  transform: rotate(252deg);
}
.c100.p71 .bar {
  -webkit-transform: rotate(255.6deg);
  -moz-transform: rotate(255.6deg);
  -ms-transform: rotate(255.6deg);
  -o-transform: rotate(255.6deg);
  transform: rotate(255.6deg);
}
.c100.p72 .bar {
  -webkit-transform: rotate(259.2deg);
  -moz-transform: rotate(259.2deg);
  -ms-transform: rotate(259.2deg);
  -o-transform: rotate(259.2deg);
  transform: rotate(259.2deg);
}
.c100.p73 .bar {
  -webkit-transform: rotate(262.8deg);
  -moz-transform: rotate(262.8deg);
  -ms-transform: rotate(262.8deg);
  -o-transform: rotate(262.8deg);
  transform: rotate(262.8deg);
}
.c100.p74 .bar {
  -webkit-transform: rotate(266.40000000000003deg);
  -moz-transform: rotate(266.40000000000003deg);
  -ms-transform: rotate(266.40000000000003deg);
  -o-transform: rotate(266.40000000000003deg);
  transform: rotate(266.40000000000003deg);
}
.c100.p75 .bar {
  -webkit-transform: rotate(270deg);
  -moz-transform: rotate(270deg);
  -ms-transform: rotate(270deg);
  -o-transform: rotate(270deg);
  transform: rotate(270deg);
}
.c100.p76 .bar {
  -webkit-transform: rotate(273.6deg);
  -moz-transform: rotate(273.6deg);
  -ms-transform: rotate(273.6deg);
  -o-transform: rotate(273.6deg);
  transform: rotate(273.6deg);
}
.c100.p77 .bar {
  -webkit-transform: rotate(277.2deg);
  -moz-transform: rotate(277.2deg);
  -ms-transform: rotate(277.2deg);
  -o-transform: rotate(277.2deg);
  transform: rotate(277.2deg);
}
.c100.p78 .bar {
  -webkit-transform: rotate(280.8deg);
  -moz-transform: rotate(280.8deg);
  -ms-transform: rotate(280.8deg);
  -o-transform: rotate(280.8deg);
  transform: rotate(280.8deg);
}
.c100.p79 .bar {
  -webkit-transform: rotate(284.40000000000003deg);
  -moz-transform: rotate(284.40000000000003deg);
  -ms-transform: rotate(284.40000000000003deg);
  -o-transform: rotate(284.40000000000003deg);
  transform: rotate(284.40000000000003deg);
}
.c100.p80 .bar {
  -webkit-transform: rotate(288deg);
  -moz-transform: rotate(288deg);
  -ms-transform: rotate(288deg);
  -o-transform: rotate(288deg);
  transform: rotate(288deg);
}
.c100.p81 .bar {
  -webkit-transform: rotate(291.6deg);
  -moz-transform: rotate(291.6deg);
  -ms-transform: rotate(291.6deg);
  -o-transform: rotate(291.6deg);
  transform: rotate(291.6deg);
}
.c100.p82 .bar {
  -webkit-transform: rotate(295.2deg);
  -moz-transform: rotate(295.2deg);
  -ms-transform: rotate(295.2deg);
  -o-transform: rotate(295.2deg);
  transform: rotate(295.2deg);
}
.c100.p83 .bar {
  -webkit-transform: rotate(298.8deg);
  -moz-transform: rotate(298.8deg);
  -ms-transform: rotate(298.8deg);
  -o-transform: rotate(298.8deg);
  transform: rotate(298.8deg);
}
.c100.p84 .bar {
  -webkit-transform: rotate(302.40000000000003deg);
  -moz-transform: rotate(302.40000000000003deg);
  -ms-transform: rotate(302.40000000000003deg);
  -o-transform: rotate(302.40000000000003deg);
  transform: rotate(302.40000000000003deg);
}
.c100.p85 .bar {
  -webkit-transform: rotate(306deg);
  -moz-transform: rotate(306deg);
  -ms-transform: rotate(306deg);
  -o-transform: rotate(306deg);
  transform: rotate(306deg);
}
.c100.p86 .bar {
  -webkit-transform: rotate(309.6deg);
  -moz-transform: rotate(309.6deg);
  -ms-transform: rotate(309.6deg);
  -o-transform: rotate(309.6deg);
  transform: rotate(309.6deg);
}
.c100.p87 .bar {
  -webkit-transform: rotate(313.2deg);
  -moz-transform: rotate(313.2deg);
  -ms-transform: rotate(313.2deg);
  -o-transform: rotate(313.2deg);
  transform: rotate(313.2deg);
}
.c100.p88 .bar {
  -webkit-transform: rotate(316.8deg);
  -moz-transform: rotate(316.8deg);
  -ms-transform: rotate(316.8deg);
  -o-transform: rotate(316.8deg);
  transform: rotate(316.8deg);
}
.c100.p89 .bar {
  -webkit-transform: rotate(320.40000000000003deg);
  -moz-transform: rotate(320.40000000000003deg);
  -ms-transform: rotate(320.40000000000003deg);
  -o-transform: rotate(320.40000000000003deg);
  transform: rotate(320.40000000000003deg);
}
.c100.p90 .bar {
  -webkit-transform: rotate(324deg);
  -moz-transform: rotate(324deg);
  -ms-transform: rotate(324deg);
  -o-transform: rotate(324deg);
  transform: rotate(324deg);
}
.c100.p91 .bar {
  -webkit-transform: rotate(327.6deg);
  -moz-transform: rotate(327.6deg);
  -ms-transform: rotate(327.6deg);
  -o-transform: rotate(327.6deg);
  transform: rotate(327.6deg);
}
.c100.p92 .bar {
  -webkit-transform: rotate(331.2deg);
  -moz-transform: rotate(331.2deg);
  -ms-transform: rotate(331.2deg);
  -o-transform: rotate(331.2deg);
  transform: rotate(331.2deg);
}
.c100.p93 .bar {
  -webkit-transform: rotate(334.8deg);
  -moz-transform: rotate(334.8deg);
  -ms-transform: rotate(334.8deg);
  -o-transform: rotate(334.8deg);
  transform: rotate(334.8deg);
}
.c100.p94 .bar {
  -webkit-transform: rotate(338.40000000000003deg);
  -moz-transform: rotate(338.40000000000003deg);
  -ms-transform: rotate(338.40000000000003deg);
  -o-transform: rotate(338.40000000000003deg);
  transform: rotate(338.40000000000003deg);
}
.c100.p95 .bar {
  -webkit-transform: rotate(342deg);
  -moz-transform: rotate(342deg);
  -ms-transform: rotate(342deg);
  -o-transform: rotate(342deg);
  transform: rotate(342deg);
}
.c100.p96 .bar {
  -webkit-transform: rotate(345.6deg);
  -moz-transform: rotate(345.6deg);
  -ms-transform: rotate(345.6deg);
  -o-transform: rotate(345.6deg);
  transform: rotate(345.6deg);
}
.c100.p97 .bar {
  -webkit-transform: rotate(349.2deg);
  -moz-transform: rotate(349.2deg);
  -ms-transform: rotate(349.2deg);
  -o-transform: rotate(349.2deg);
  transform: rotate(349.2deg);
}
.c100.p98 .bar {
  -webkit-transform: rotate(352.8deg);
  -moz-transform: rotate(352.8deg);
  -ms-transform: rotate(352.8deg);
  -o-transform: rotate(352.8deg);
  transform: rotate(352.8deg);
}
.c100.p99 .bar {
  -webkit-transform: rotate(356.40000000000003deg);
  -moz-transform: rotate(356.40000000000003deg);
  -ms-transform: rotate(356.40000000000003deg);
  -o-transform: rotate(356.40000000000003deg);
  transform: rotate(356.40000000000003deg);
}
.c100.p100 .bar {
  -webkit-transform: rotate(360deg);
  -moz-transform: rotate(360deg);
  -ms-transform: rotate(360deg);
  -o-transform: rotate(360deg);
  transform: rotate(360deg);
}
.c100.green .bar,
.c100.green .fill {
  border-color: #4db53c !important;
}
.c100.red .bar,
.c100.red .fill {
  border-color: red !important;
}
.c100.gray .bar,
.c100.gray .fill {
  border-color: gray !important;
}
.c100.purple .bar,
.c100.purple .fill {
  border-color: purple !important;
}
.c100.orange .bar,
.c100.orange .fill {
  border-color: orange !important;
}
.c100.cyan .bar,
.c100.cyan .fill {
  border-color: #11c1c1 !important;
}
.c100.green > span {
  color: green;
}
.c100.orange > span {
  color: orange;
}
.c100.red > span {
  color: red;
}
.c100.gray > span {
  color: gray;
}
.c100.purple > span {
  color: purple;
}
.c100.cyan > span {
  color: #11c1c1;
}
.c100 > span.title {
  top: 1em;
}
.c100.smaller-title > span {
    width: inherit;
    line-height: 5em;
    font-size: 0.15em;
}
/* Embedded images */
.logo-test { color: #4e4e4e; font-weight: bold; }
.logo-flows { color: deepskyblue; font-weight: bold; }
.testflows-logo {
    padding-left: 24px;
    padding-right: 0.2em;
    background-size: contain;
    background-repeat: no-repeat;
	background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAMAAAAp4XiDAAABrVBMVEUAAAAAAP8A//8AgP8A//8Aqv8A//8Av/8A1f8A4/8AzP8A0f8Av/8A1f8A2P8A2/8AzP8Az/8A0v8Axv8A1f8Ayf8AzP8Azv8A0f8AyP8A0/8Ayv8AzP8Axv8AyP8Ayv8AzP8Azv8A0f8AzP8Axv8Az/8Ayf8Ay/8AzP8Azf8Azv8Ay/8Azf8Ayf8Azv8Az/8Ay/8AzP8AyP8Azf8Ayf8Azv8Ayv8AzP8Azf8Ayf8Azv8Ayv8Ay/8Azf8Ayv8Azv8Ayv8Ay/8Azf8Azv8Ay/8AzP8Ayv8Azf8Ay/8AzP8Ayv8Ay/8Ay/8Azf8Azf8Azv8Ay/8AzP8Azf8Azf8Ay/8AzP8Azf8Azf8Azv8AzP8Azf8Azf8AzP8AzP8Azf8AzP8Azv8AzP8Ay/8AzP8AzP8Azf8Ay/8AzP8Ay/8Azf8AzP8Ayv8Ay/8AzP8Azv8AzP8AzP8Ay/8AzP8AzP8AzP8AzP8Ay/8AzP8Azf8Azf8AzP8Ay/8Azf8AzP8Azf8Ay/8Azf8AzP8Ay/8AzP8AzP8AzP8AzP8AzP8AzP8AzP8Ay/8AzP8AzP8AzP8AzP9YzlPqAAAAj3RSTlMAAQECAgMDBAYJCgsMDA0ODxAREhITFBUWFxcYGRscHR4fISMkJSYnKCkqLC4vLzAxMjMzNDQ1Nzg5OTo7PT4+P0BCQ0RGSEhKS01OT1FSU1haW1xeX2BhYmRlZmhpa21tb3FydHV2eHp6fH5/gYGDh4iMkJKVmZydqKmrsrO3vMDExsnN0dbY2t7j5+vw80T/rZQAAAF7SURBVHjaldNpOwJRFMDxK0uW7DvZypYhiZKkiBBFkuxLsssW2bWQtPGZTZFm5nnM3PN/dd78nnPui4vAlYJFTSNUCIkqoGiQEQKYaFLKCD5ItKiVsg6QEGlJ0gwRYn2CVANEuyFJ8vFFpzFJenjYosv0Q1qxBTH/S+pwRbclRQowRe9iisgxn9Jv/yNiPKFcS5MKLDG4mSaqHByh3qEQCY7QOKmkFkOMHFCJBuOusWMaaeMWehedFHKKiQs6UXAKwyWDlHOJKTeDyLmE8ZpBpos4xIyHScQcwnTLJEMZ7MJ8nyBXFKLjs4LsSbfbQ9tiHchC/8ZXOG7MiUEgUs0uO5PENlrGAsxP3hcLSpdbKawvZvuJ0ke/z7uAAM0FAn6fFQAyz4NvAb8NIHiud5LYEaDTEElWIGIpTJJViJB+kGQdIkpeI+HQBoJ0F42Et0BiPBaNbINEXjAWdSBQZ/HYLkxI4vE9BOvhcx8o+r4OEbDnI6gYPkHQtGDxDUUplrGY+46YAAAAAElFTkSuQmCC);
}
/* Customize the label (the container) */
.container {
  display: block;
  position: relative;
  padding-left: 35px;
  margin-bottom: 12px;
  cursor: pointer;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}
/* Hide the browser's default checkbox */
.container input {
  position: absolute;
  opacity: 0;
  cursor: pointer;
  height: 0;
  width: 0;
}
/* Create a custom checkbox */
.checkmark {
  position: absolute;
  top: 0;
  left: 0;
  height: 25px;
  width: 25px;
  background-color: #eee;
}
/* On mouse-over, add a grey background color */
.container:hover input ~ .checkmark {
  background-color: #2196F3;
}
/* When the checkbox is checked, add a blue background */
.container input:checked ~ .checkmark {
  background-color: #2196F3;
}
/* Create the checkmark/indicator (hidden when not checked) */
.checkmark:after {
  content: "";
  position: absolute;
  display: none;
}
/* Show the checkmark when checked */
.container input:checked ~ .checkmark:after {
  display: block;
}
/* Style the checkmark/indicator */
.container .checkmark:after {
  left: 9px;
  top: 5px;
  width: 5px;
  height: 10px;
  border: solid white;
  border-width: 0 3px 3px 0;
  -webkit-transform: rotate(45deg);
  -ms-transform: rotate(45deg);
  transform: rotate(45deg);
}

</style>
</head>
<body>
<section class="clearfix"></section>

<hr />

<h1 id="requirements-coverage-reportbrsrs023-clickhouse-lightweight-delete">Requirements Coverage Report<br>SRS023 ClickHouse Lightweight Delete</h1>

<table>
<tbody>
<tr><td><strong>Date</strong></td><td>Sep 14, 2022 15:46</td></tr>
<tr><td><strong>Framework</strong></td><td><span class="testflows-logo"></span> <a target="_blank" rel="nofollow noopener noreferrer" href="https://testflows.com"><span class="logo-test">Test</span><span class="logo-flows">Flows</span></a> 1.9.220712.1163352</td></tr>
</tbody>
</table>

<h2 id="summary">Summary</h2>

<div class="chart"><div class="c100 p74 green smaller-title"><span>74.2%</span><span class="title">Satisfied</span><div class="slice"><div class="bar"></div><div class="fill"></div></div></div>
<div class="c100 p12 red smaller-title"><span>12.1%</span><span class="title">Unsatisfied</span><div class="slice"><div class="bar"></div><div class="fill"></div></div></div>
<div class="c100 p13 orange smaller-title"><span>13.6%</span><span class="title">Untested</span><div class="slice"><div class="bar"></div><div class="fill"></div></div></div>
</div>

<h2 id="statistics">Statistics</h2>

<table>
<tbody>
<tr><td><span></span></td><td>Units</td><td><span class="result result-ok">Satisfied</span></td><td><span class="result result-fail">Unsatisfied</span></td><td><span class="result result-error">Untested</span></td></tr>
<tr><td><center><strong>Requirements</strong></center></td><td><center>66</center></td><td><center>49</center></td><td><center>8</center></td><td><center>9</center></td></tr>
</tbody>
</table>

<h2 id="coverage">Coverage</h2>

<section class="requirement"><span class="requirement-inline"><i class="utf-icon color-fail">✘</i>RQ.SRS-023.ClickHouse.LightweightDelete.DeleteStatement</span></section>

<div class="requirement-description hidden">

<p><a target="_blank" rel="nofollow noopener noreferrer" href="https://clickhouse.yandex">ClickHouse</a> SHALL support standard <code>DELETE</code> statement to remove data that SHALL have the following syntax</p>

<div class="highlight"><pre><span></span><code><span class="k">DELETE</span> <span class="k">FROM</span> <span class="o">&lt;</span><span class="k">table</span><span class="o">&gt;</span> <span class="k">WHERE</span> <span class="o">&lt;</span><span class="n">condition</span><span class="o">&gt;</span>
</code></pre></div>

<p>where the <code>WHERE</code> condition SHALL be any condition expressible in a <code>WHERE</code> clause used in the <code>SELECT</code> statements
and all the rows that match the <code>WHERE</code> condition SHALL be removed.</p>

<p>Examples:</p>

<ul>
<li>Delete a child organization and its data
<code>sql
DELETE * FROM example_table WHERE mspOrganizationId = 123 and has(organizationIds,456)
</code></li>
<li>Delete all records for a specific Identity
<code>sql
DELETE * FROM example_table WHERE has(origin_ids, 123)
</code></li>
<li>Delete all records for certain types of destinations
<code>sql
DELETE * FROM example_table WHERE has(allCategories, 123)
</code></li>
</ul>

</div>

<div class="test"><span class="result result-inline result-error">Error</span><span class="time time-inline">3h 41m</span>/lightweight delete</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="kn">Module</span><span class="nn"> lightweight delete</span>
  Lightweight Delete regression.
<span class="k">  </span><span class="kn">Feature</span><span class="nn"> acceptance</span>
    Check that clickhouse supports lightweight delete operations applied to acceptance dataset.
<span class="ro">  OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> delete_query_0</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> acceptance concurrent select delete execution time</span>
        Check that clickhouse keeps reference dataset table usable while the delete reference queries
        are being executed concurrently with the select reference queries.
        No major degradation in query response time SHALL be seen.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> acceptance concurrent insert delete execution time</span>
        Check that clickhouse is not slow down or lockup data ingestion into the reference dataset table
        when delete reference queries are executed concurrently with the insert reference queries.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> acceptance delete execution time</span>
        Check that clickhouse execute each query in the delete reference queries
        set against the reference dataset table within 2 sec.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> acceptance insert execution time after delete</span>
        Check that clickhouse insert queries are not slow down after lightweight delete.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> delete_query_1</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> acceptance concurrent select delete execution time</span>
        Check that clickhouse keeps reference dataset table usable while the delete reference queries
        are being executed concurrently with the select reference queries.
        No major degradation in query response time SHALL be seen.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> acceptance concurrent insert delete execution time</span>
        Check that clickhouse is not slow down or lockup data ingestion into the reference dataset table
        when delete reference queries are executed concurrently with the insert reference queries.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> acceptance delete execution time</span>
        Check that clickhouse execute each query in the delete reference queries
        set against the reference dataset table within 2 sec.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> acceptance insert execution time after delete</span>
        Check that clickhouse insert queries are not slow down after lightweight delete.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> delete_query_2</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> acceptance concurrent select delete execution time</span>
        Check that clickhouse keeps reference dataset table usable while the delete reference queries
        are being executed concurrently with the select reference queries.
        No major degradation in query response time SHALL be seen.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> acceptance concurrent insert delete execution time</span>
        Check that clickhouse is not slow down or lockup data ingestion into the reference dataset table
        when delete reference queries are executed concurrently with the insert reference queries.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> acceptance delete execution time</span>
        Check that clickhouse execute each query in the delete reference queries
        set against the reference dataset table within 2 sec.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> acceptance insert execution time after delete</span>
        Check that clickhouse insert queries are not slow down after lightweight delete.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">  </span><span class="kn">Feature</span><span class="nn"> efficient physical data removal</span>
    Check that ClickHouse support efficient removal of physical data from the tables that
    had rows deleted using the DELETE statement.
<span class="ro">  OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> delete and check size of the table</span>
      Check that ClickHouse support efficient removal of physical data from the tables that
      had rows deleted using the DELETE statement by deleting from the table and checking table
      size in storage and in system.parts table.
<span class="rx">    XFail</span> delete and check size of the table, Does not match space requirements.
<span class="k">  </span><span class="kn">Feature</span><span class="nn"> multiple delete limitations</span>
    Check that clickhouse supports using multiple DELETE statements on the same table.
<span class="ro">  OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> MergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> multiple delete</span>
        Check that clickhouse supports using multiple DELETE statements on the same table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplacingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> multiple delete</span>
        Check that clickhouse supports using multiple DELETE statements on the same table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> SummingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> multiple delete</span>
        Check that clickhouse supports using multiple DELETE statements on the same table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> AggregatingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> multiple delete</span>
        Check that clickhouse supports using multiple DELETE statements on the same table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> CollapsingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> multiple delete</span>
        Check that clickhouse supports using multiple DELETE statements on the same table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> VersionedCollapsingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> multiple delete</span>
        Check that clickhouse supports using multiple DELETE statements on the same table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> GraphiteMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> multiple delete</span>
        Check that clickhouse supports using multiple DELETE statements on the same table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">  </span><span class="kn">Feature</span><span class="nn"> hard restart</span>
    Check that clickhouse either finish the DELETE or return the system
    to before the DELETE started after a hard restart.
<span class="ro">  OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> SIGKILL</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> hard restart</span>
        Check that clickhouse either completes DELETE operation or
        leaves data in the same state after a hard restart
        by using signal.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">  </span><span class="kn">Feature</span><span class="nn"> s3</span>
    Check that clickhouse support using DELETE on S3 disks.
<span class="ro">  OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> s3</span>
      Check that clickhouse support using DELETE on S3 disks.
<span class="ro">    OK</span><span class="k"></span>
<span class="k">  </span><span class="kn">Feature</span><span class="nn"> lack of disk space</span>
    Check that clickhouse reserve space to avoid breaking in the middle.
<span class="ro">  OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> lack of disk space</span>
      Check that clickhouse reserve space to avoid breaking in the middle.
      I fill the disk and delete insert the data in loop until the error and
      check the state of the table in the end when table stored on the disk.
<span class="ro">    OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> lack of disk space tiered storage</span>
      Check that clickhouse reserve space to avoid breaking in the middle.
      I fill the disk and delete insert the data in loop until the error and
      check the state of the table in the end when table stored on two disks.
<span class="ro">    OK</span><span class="k"></span>
<span class="k">  </span><span class="kn">Feature</span><span class="nn"> multi disk</span>
    Check ClickHouse supports policies with different number of
    disks in one volume, and with different disks configurations.
<span class="ro">  OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> multi disk volume</span>
      Check ClickHouse supports policies with different number of
      disks in one volume, and with different disks configurations.
<span class="ro">    OK</span><span class="k"></span>
<span class="k">  </span><span class="kn">Feature</span><span class="nn"> projections</span>
    Check that tables that have one or more projections work with delete.
<span class="ro">  OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> simple projection</span>
      Check delete on a table that has simple projection
      which optimizes query with a simple where clause.
<span class="rx">    XFail</span> simple projection, engine type not supported.
<span class="k">  </span><span class="kn">Feature</span><span class="nn"> drop empty part</span>
    Check that clickhouse schedules dropping the part if all of the rows are deleted from this part.
<span class="ro">  OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> drop empty part</span>
      Check that clickhouse schedules dropping the part if all of the rows are deleted from this part.
<span class="ro">    OK</span><span class="k"></span>
<span class="k">  </span><span class="kn">Feature</span><span class="nn"> views</span>
    Check that clickhouse DELETE statement is compatible with tables that have one or more views.
<span class="ro">  OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> live view</span>
      Check that clickhouse DELETE statement is compatible with tables that have one or more live views.
<span class="rx">    XFail</span> live view, not implemented
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> materialized view</span>
      Check that clickhouse DELETE statement is compatible with tables that have one or more normal views.
<span class="rx">    XFail</span> materialized view, not implemented
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> normal view</span>
      Check that clickhouse DELETE statement is compatible with tables that have one or more normal views.
<span class="ro">    OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> window view</span>
      Check that clickhouse DELETE statement is compatible with tables that have one or more window views.
<span class="rx">    XFail</span> window view, not implemented
<span class="k">  </span><span class="kn">Feature</span><span class="nn"> compatibility</span>
    Check that clickhouse support executing INSERT and DELETE statements concurrently.
<span class="ro">  OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> concurrent insert delete many parts</span>
      Check that clickhouse support executing INSERT and DELETE statements concurrently
      when INSERT creates many parts.
<span class="ro">    OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> concurrent insert delete the same data</span>
      Check that clickhouse support executing INSERT and DELETE statements concurrently
      on the same data.
<span class="ro">    OK</span><span class="k"></span>
<span class="k">  </span><span class="kn">Feature</span><span class="nn"> immutable parts and garbage collection</span>
    Check that parts affected by the DELETE statement are stay immutable and
    the deleted rows are garbage collected in a scheduled merge.
<span class="ro">  OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> MergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> immutable parts and garbage collection</span>
        Check that parts affected by the DELETE statement are stay immutable and
        the deleted rows are garbage collected in a scheduled merge.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplacingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> immutable parts and garbage collection</span>
        Check that parts affected by the DELETE statement are stay immutable and
        the deleted rows are garbage collected in a scheduled merge.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> SummingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> immutable parts and garbage collection</span>
        Check that parts affected by the DELETE statement are stay immutable and
        the deleted rows are garbage collected in a scheduled merge.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> AggregatingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> immutable parts and garbage collection</span>
        Check that parts affected by the DELETE statement are stay immutable and
        the deleted rows are garbage collected in a scheduled merge.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> CollapsingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> immutable parts and garbage collection</span>
        Check that parts affected by the DELETE statement are stay immutable and
        the deleted rows are garbage collected in a scheduled merge.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> VersionedCollapsingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> immutable parts and garbage collection</span>
        Check that parts affected by the DELETE statement are stay immutable and
        the deleted rows are garbage collected in a scheduled merge.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> GraphiteMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> immutable parts and garbage collection</span>
        Check that parts affected by the DELETE statement are stay immutable and
        the deleted rows are garbage collected in a scheduled merge.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">  </span><span class="kn">Feature</span><span class="nn"> replicated tables concurrent deletes</span>
    Check that delete operations replicate in an eventually consistent manner between replicas.
<span class="ro">  OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop with overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table by partitions on different nodes with overlap.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop with without overlap</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting some rows in the table by partitions on different nodes.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop without overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table by partitions on different nodes without overlap.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table on different nodes with overlap.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with without overlap</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting some rows in the table on different nodes.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table on different nodes without overlap.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedReplacingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop with overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table by partitions on different nodes with overlap.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop with without overlap</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting some rows in the table by partitions on different nodes.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop without overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table by partitions on different nodes without overlap.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table on different nodes with overlap.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with without overlap</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting some rows in the table on different nodes.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table on different nodes without overlap.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedSummingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop with overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table by partitions on different nodes with overlap.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop with without overlap</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting some rows in the table by partitions on different nodes.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop without overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table by partitions on different nodes without overlap.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table on different nodes with overlap.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with without overlap</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting some rows in the table on different nodes.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table on different nodes without overlap.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedAggregatingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop with overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table by partitions on different nodes with overlap.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop with without overlap</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting some rows in the table by partitions on different nodes.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop without overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table by partitions on different nodes without overlap.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table on different nodes with overlap.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with without overlap</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting some rows in the table on different nodes.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table on different nodes without overlap.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedCollapsingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop with overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table by partitions on different nodes with overlap.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop with without overlap</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting some rows in the table by partitions on different nodes.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop without overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table by partitions on different nodes without overlap.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table on different nodes with overlap.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with without overlap</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting some rows in the table on different nodes.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table on different nodes without overlap.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedVersionedCollapsingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop with overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table by partitions on different nodes with overlap.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop with without overlap</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting some rows in the table by partitions on different nodes.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop without overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table by partitions on different nodes without overlap.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table on different nodes with overlap.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with without overlap</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting some rows in the table on different nodes.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table on different nodes without overlap.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedGraphiteMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop with overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table by partitions on different nodes with overlap.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop with without overlap</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting some rows in the table by partitions on different nodes.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop without overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table by partitions on different nodes without overlap.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table on different nodes with overlap.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with without overlap</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting some rows in the table on different nodes.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table on different nodes without overlap.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">  </span><span class="kn">Feature</span><span class="nn"> replicated table with concurrent alter and delete</span>
    Check that delete operations replicate in an eventually consistent manner between replicas.
<span class="ro">  OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> concurrent add drop column and delete in replicated table on single node</span>
      Check that concurrent delete and add drop column perform
      correctly with replicated table on single node.
<span class="ro">    OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> concurrent add drop column and delete in replicated table on two nodes</span>
      Check that concurrent delete and add drop column perform
      correctly with replicated table on two nodes.
<span class="ro">    OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> concurrent clear update and delete in replicated table on single node</span>
      Check that concurrent delete and clear update+ column perform
      correctly with replicated table on single node.
<span class="ro">    OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> concurrent clear update and delete in replicated table on two nodes</span>
      Check that concurrent delete and clear update column perform
      correctly with replicated table on two nodes.
<span class="ro">    OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> concurrent delete attach detach partition in replicated table on single node</span>
      Check that concurrent delete detach partition and attach partition perform
      correctly with replicated table on single node.
<span class="ro">    OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> concurrent delete attach detach partition in replicated table on two nodes</span>
      Check that concurrent delete detach partition and attach partition perform
      correctly with replicated table on two nodes.
<span class="ro">    OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> concurrent modify column and delete in replicated table on single node</span>
      Check that concurrent delete and modify column perform
      correctly with replicated table on single node.
<span class="ro">    OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> concurrent modify column and delete in replicated table on two nodes</span>
      Check that concurrent delete and modify column perform
      correctly with replicated table on two nodes.
<span class="ro">    OK</span><span class="k"></span>
<span class="k">  </span><span class="kn">Feature</span><span class="nn"> replicated table with alter after delete on single node</span>
    Check that delete operations replicate in an eventually consistent manner between replicas.
<span class="ro">  OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> add column after delete</span>
        Check that add column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> attach partition after delete</span>
        Check that attach partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> clear column after delete</span>
        Check that clear column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> comment column after delete</span>
        Check that comment column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> detach partition after delete</span>
        Check that detach partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop column after delete</span>
        Check that drop column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop partition after delete</span>
        Check that drop partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> fetch partition after delete</span>
        Check that fetch partition after delete perform correctly with replicated table on single node.
<span class="rx">      XFail</span> fetch partition after delete, engine type not supported.
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> freeze partition after delete</span>
        Check that freeze partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> modify column after delete</span>
        Check that modify column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> unfreeze partition after delete</span>
        Check that unfreeze partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedReplacingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> add column after delete</span>
        Check that add column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> attach partition after delete</span>
        Check that attach partition after delete perform correctly with replicated table on single node.
<span class="rx">      XFail</span> attach partition after delete, engine type not supported.
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> clear column after delete</span>
        Check that clear column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> comment column after delete</span>
        Check that comment column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> detach partition after delete</span>
        Check that detach partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop column after delete</span>
        Check that drop column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop partition after delete</span>
        Check that drop partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> fetch partition after delete</span>
        Check that fetch partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> freeze partition after delete</span>
        Check that freeze partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> modify column after delete</span>
        Check that modify column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> unfreeze partition after delete</span>
        Check that unfreeze partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedSummingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> add column after delete</span>
        Check that add column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> attach partition after delete</span>
        Check that attach partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> clear column after delete</span>
        Check that clear column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> comment column after delete</span>
        Check that comment column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> detach partition after delete</span>
        Check that detach partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop column after delete</span>
        Check that drop column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop partition after delete</span>
        Check that drop partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> fetch partition after delete</span>
        Check that fetch partition after delete perform correctly with replicated table on single node.
<span class="rx">      XFail</span> fetch partition after delete, engine type not supported.
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> freeze partition after delete</span>
        Check that freeze partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> modify column after delete</span>
        Check that modify column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> unfreeze partition after delete</span>
        Check that unfreeze partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedAggregatingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> add column after delete</span>
        Check that add column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> attach partition after delete</span>
        Check that attach partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> clear column after delete</span>
        Check that clear column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> comment column after delete</span>
        Check that comment column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> detach partition after delete</span>
        Check that detach partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop column after delete</span>
        Check that drop column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop partition after delete</span>
        Check that drop partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> fetch partition after delete</span>
        Check that fetch partition after delete perform correctly with replicated table on single node.
<span class="rx">      XFail</span> fetch partition after delete, engine type not supported.
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> freeze partition after delete</span>
        Check that freeze partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> modify column after delete</span>
        Check that modify column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> unfreeze partition after delete</span>
        Check that unfreeze partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedCollapsingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> add column after delete</span>
        Check that add column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> attach partition after delete</span>
        Check that attach partition after delete perform correctly with replicated table on single node.
<span class="rx">      XFail</span> attach partition after delete, engine type not supported.
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> clear column after delete</span>
        Check that clear column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> comment column after delete</span>
        Check that comment column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> detach partition after delete</span>
        Check that detach partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop column after delete</span>
        Check that drop column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop partition after delete</span>
        Check that drop partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> fetch partition after delete</span>
        Check that fetch partition after delete perform correctly with replicated table on single node.
<span class="rx">      XFail</span> fetch partition after delete, engine type not supported.
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> freeze partition after delete</span>
        Check that freeze partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> modify column after delete</span>
        Check that modify column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> unfreeze partition after delete</span>
        Check that unfreeze partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedVersionedCollapsingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> add column after delete</span>
        Check that add column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> attach partition after delete</span>
        Check that attach partition after delete perform correctly with replicated table on single node.
<span class="rx">      XFail</span> attach partition after delete, engine type not supported.
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> clear column after delete</span>
        Check that clear column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> comment column after delete</span>
        Check that comment column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> detach partition after delete</span>
        Check that detach partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop column after delete</span>
        Check that drop column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop partition after delete</span>
        Check that drop partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> fetch partition after delete</span>
        Check that fetch partition after delete perform correctly with replicated table on single node.
<span class="rx">      XFail</span> fetch partition after delete, engine type not supported.
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> freeze partition after delete</span>
        Check that freeze partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> modify column after delete</span>
        Check that modify column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> unfreeze partition after delete</span>
        Check that unfreeze partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedGraphiteMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> add column after delete</span>
        Check that add column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> attach partition after delete</span>
        Check that attach partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> clear column after delete</span>
        Check that clear column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> comment column after delete</span>
        Check that comment column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> detach partition after delete</span>
        Check that detach partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop column after delete</span>
        Check that drop column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop partition after delete</span>
        Check that drop partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> fetch partition after delete</span>
        Check that fetch partition after delete perform correctly with replicated table on single node.
<span class="rx">      XFail</span> fetch partition after delete, engine type not supported.
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> freeze partition after delete</span>
        Check that freeze partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> modify column after delete</span>
        Check that modify column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> unfreeze partition after delete</span>
        Check that unfreeze partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">  </span><span class="kn">Feature</span><span class="nn"> non deterministic functions</span>
    Check that clickhouse support delete statement when where clause contains
    nondeterministic function.
<span class="ro">  OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> nondeterministic function</span>
      Check that clickhouse support delete statement when where clause contains
      nondeterministic function now().
<span class="ro">    OK</span><span class="k"></span>
<span class="k">  </span><span class="kn">Feature</span><span class="nn"> performance</span>
    Check that clickhouse lightweight delete statement has good performance.
<span class="ro">  OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> performance post delete select</span>
      Check that clickhouse select statement performance is not degrade or degrade insignificantly on
      tables that contain rows deleted using the DELETE statement.
<span class="ro">    OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> performance with primary key many partitions</span>
      Check that clickhouse have similar performance between delete and select statements with primary key.
<span class="ro">    OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> performance with primary key many parts</span>
      Check that clickhouse have similar performance between delete and select statements with primary key.
<span class="ro">    OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> performance without primary key</span>
      Check that clickhouse have similar performance between delete and select statements without primary key.
<span class="ro">    OK</span><span class="k"></span>
<span class="k">  </span><span class="kn">Feature</span><span class="nn"> distributed tables</span>
    Check that clickhouse supports delete statement with distributed tables.
<span class="ro">  OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> distributed table replicated</span>
      Check that ClickHouse supports delete statement for distributed tables
      when distributed table configuration contains 1 shard and 3 replicas.
<span class="rx">    XFail</span> distributed table replicated, engine type not supported.
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> distributed table sharded</span>
      Check that ClickHouse supports delete statement for distributed tables
      when distributed table configuration contains 3 shard 1 replica in each.
<span class="ro">    OK</span><span class="k"></span>
<span class="k">  </span><span class="kn">Feature</span><span class="nn"> replication queue</span>
    Check that clickhouse write delete statement in replication queue correctly.
<span class="ro">  OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replication queue</span>
        Check that clickhouse writes delete statement in replication queue correctly
        by creating replicated table, deleting from it and checking that DELETE statement
        appeared in system.replication_queue table.
<span class="rx">      XFail</span> replication queue, engine type not supported.
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedReplacingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replication queue</span>
        Check that clickhouse writes delete statement in replication queue correctly
        by creating replicated table, deleting from it and checking that DELETE statement
        appeared in system.replication_queue table.
<span class="rx">      XFail</span> replication queue, engine type not supported.
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedSummingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replication queue</span>
        Check that clickhouse writes delete statement in replication queue correctly
        by creating replicated table, deleting from it and checking that DELETE statement
        appeared in system.replication_queue table.
<span class="rx">      XFail</span> replication queue, engine type not supported.
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedAggregatingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replication queue</span>
        Check that clickhouse writes delete statement in replication queue correctly
        by creating replicated table, deleting from it and checking that DELETE statement
        appeared in system.replication_queue table.
<span class="rx">      XFail</span> replication queue, engine type not supported.
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedCollapsingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replication queue</span>
        Check that clickhouse writes delete statement in replication queue correctly
        by creating replicated table, deleting from it and checking that DELETE statement
        appeared in system.replication_queue table.
<span class="rx">      XFail</span> replication queue, engine type not supported.
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedVersionedCollapsingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replication queue</span>
        Check that clickhouse writes delete statement in replication queue correctly
        by creating replicated table, deleting from it and checking that DELETE statement
        appeared in system.replication_queue table.
<span class="rx">      XFail</span> replication queue, engine type not supported.
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedGraphiteMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replication queue</span>
        Check that clickhouse writes delete statement in replication queue correctly
        by creating replicated table, deleting from it and checking that DELETE statement
        appeared in system.replication_queue table.
<span class="rx">      XFail</span> replication queue, engine type not supported.
<span class="k">  </span><span class="kn">Feature</span><span class="nn"> replicated tables</span>
    Check that delete operations replicate in an eventually consistent manner between replicas.
<span class="ro">  OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap entire table</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with without overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap entire table</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedReplacingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap entire table</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with without overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap entire table</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedSummingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap entire table</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with without overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap entire table</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedAggregatingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap entire table</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with without overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap entire table</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedCollapsingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap entire table</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with without overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap entire table</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedVersionedCollapsingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap entire table</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with without overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap entire table</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedGraphiteMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap entire table</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with without overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap entire table</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">  </span><span class="kn">Feature</span><span class="nn"> delete and tiered storage ttl</span>
    Check that delete in table that uses tiered storage ttl perform correctly.
<span class="ro">  OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> delete with multi volume policy using ttl</span>
      Check that delete in table that uses tiered storage ttl perform correctly.
      I create parts on 2 volumes with 1 disk in each and delete some values in each volume.
      Using the following policy:
          volume0: disk local00
          volume1: disk local10
<span class="ro">    OK</span><span class="k"></span>
<span class="k">  </span><span class="kn">Feature</span><span class="nn"> alter after delete with stop merges</span>
    Check that clickhouse supports alter operations after delete with STOP MERGES.
<span class="ro">  OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> MergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> add column after delete</span>
        Check that alter add column after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> attach partition after delete</span>
        Check that attach partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> clear column after delete</span>
        Check that alter clear column after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> comment column after delete</span>
        Check that alter comment column after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> detach partition after delete</span>
        Check that detach partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop partition after delete</span>
        Check that drop partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> freeze partition after delete</span>
        Check that freeze partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> unfreeze partition after delete</span>
        Check that unfreeze partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplacingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> add column after delete</span>
        Check that alter add column after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> attach partition after delete</span>
        Check that attach partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> clear column after delete</span>
        Check that alter clear column after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> comment column after delete</span>
        Check that alter comment column after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> detach partition after delete</span>
        Check that detach partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop partition after delete</span>
        Check that drop partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> freeze partition after delete</span>
        Check that freeze partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> unfreeze partition after delete</span>
        Check that unfreeze partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> SummingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> add column after delete</span>
        Check that alter add column after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> attach partition after delete</span>
        Check that attach partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> clear column after delete</span>
        Check that alter clear column after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> comment column after delete</span>
        Check that alter comment column after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> detach partition after delete</span>
        Check that detach partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop partition after delete</span>
        Check that drop partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> freeze partition after delete</span>
        Check that freeze partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> unfreeze partition after delete</span>
        Check that unfreeze partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> AggregatingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> add column after delete</span>
        Check that alter add column after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> attach partition after delete</span>
        Check that attach partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> clear column after delete</span>
        Check that alter clear column after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> comment column after delete</span>
        Check that alter comment column after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> detach partition after delete</span>
        Check that detach partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop partition after delete</span>
        Check that drop partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> freeze partition after delete</span>
        Check that freeze partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> unfreeze partition after delete</span>
        Check that unfreeze partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> CollapsingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> add column after delete</span>
        Check that alter add column after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> attach partition after delete</span>
        Check that attach partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> clear column after delete</span>
        Check that alter clear column after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> comment column after delete</span>
        Check that alter comment column after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> detach partition after delete</span>
        Check that detach partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop partition after delete</span>
        Check that drop partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> freeze partition after delete</span>
        Check that freeze partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> unfreeze partition after delete</span>
        Check that unfreeze partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> VersionedCollapsingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> add column after delete</span>
        Check that alter add column after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> attach partition after delete</span>
        Check that attach partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> clear column after delete</span>
        Check that alter clear column after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> comment column after delete</span>
        Check that alter comment column after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> detach partition after delete</span>
        Check that detach partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop partition after delete</span>
        Check that drop partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> freeze partition after delete</span>
        Check that freeze partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> unfreeze partition after delete</span>
        Check that unfreeze partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> GraphiteMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> add column after delete</span>
        Check that alter add column after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> attach partition after delete</span>
        Check that attach partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> clear column after delete</span>
        Check that alter clear column after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> comment column after delete</span>
        Check that alter comment column after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> detach partition after delete</span>
        Check that detach partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop partition after delete</span>
        Check that drop partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> freeze partition after delete</span>
        Check that freeze partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> unfreeze partition after delete</span>
        Check that unfreeze partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">  </span><span class="kn">Feature</span><span class="nn"> encrypted disk</span>
    Check that lightweight delete in table that stored on encrypted disk perform correctly.
<span class="ro">  OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> encrypted disk</span>
      Check that lightweight delete in table that stored on encrypted disk perform correctly.
<span class="ro">    OK</span><span class="k"></span>
<span class="k">  </span><span class="kn">Feature</span><span class="nn"> delete and column ttl</span>
    Check that delete and column ttl together perform correctly.
<span class="ro">  OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> column ttl after delete</span>
      Check that column ttl after delete perform correctly.
<span class="ro">    OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> delete after column ttl</span>
      Check that delete statement after column ttl perform correctly.
<span class="ro">    OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> delete and column ttl concurrent</span>
      Check that concurrent lightweight delete and column ttl perform correctly.
<span class="ro">    OK</span><span class="k"></span>
<span class="k">  </span><span class="kn">Feature</span><span class="nn"> alter after delete</span>
    Check that clickhouse supports alter operations after lightweight delete.
<span class="ro">  OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> MergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> add column after delete</span>
        Check that add column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> attach partition after delete</span>
        Check that attach partition after delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> clear column after delete</span>
        Check that clear column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> comment column after delete</span>
        Check that alter comment column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> detach partition after delete</span>
        Check that detach partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop column after delete</span>
        Check that drop column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop partition after delete</span>
        Check that drop partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> freeze partition after delete</span>
        Check that freeze partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> modify column after delete</span>
        Check that modify column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> move partition after delete</span>
        Check that alter move partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replace partition after delete</span>
        Check that replace partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> unfreeze partition after delete</span>
        Check that unfreeze partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplacingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> add column after delete</span>
        Check that add column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> attach partition after delete</span>
        Check that attach partition after delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> clear column after delete</span>
        Check that clear column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> comment column after delete</span>
        Check that alter comment column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> detach partition after delete</span>
        Check that detach partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop column after delete</span>
        Check that drop column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop partition after delete</span>
        Check that drop partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> freeze partition after delete</span>
        Check that freeze partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> modify column after delete</span>
        Check that modify column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> move partition after delete</span>
        Check that alter move partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replace partition after delete</span>
        Check that replace partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> unfreeze partition after delete</span>
        Check that unfreeze partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> SummingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> add column after delete</span>
        Check that add column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> attach partition after delete</span>
        Check that attach partition after delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> clear column after delete</span>
        Check that clear column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> comment column after delete</span>
        Check that alter comment column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> detach partition after delete</span>
        Check that detach partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop column after delete</span>
        Check that drop column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop partition after delete</span>
        Check that drop partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> freeze partition after delete</span>
        Check that freeze partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> modify column after delete</span>
        Check that modify column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> move partition after delete</span>
        Check that alter move partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replace partition after delete</span>
        Check that replace partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> unfreeze partition after delete</span>
        Check that unfreeze partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> AggregatingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> add column after delete</span>
        Check that add column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> attach partition after delete</span>
        Check that attach partition after delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> clear column after delete</span>
        Check that clear column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> comment column after delete</span>
        Check that alter comment column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> detach partition after delete</span>
        Check that detach partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop column after delete</span>
        Check that drop column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop partition after delete</span>
        Check that drop partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> freeze partition after delete</span>
        Check that freeze partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> modify column after delete</span>
        Check that modify column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> move partition after delete</span>
        Check that alter move partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replace partition after delete</span>
        Check that replace partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> unfreeze partition after delete</span>
        Check that unfreeze partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> CollapsingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> add column after delete</span>
        Check that add column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> attach partition after delete</span>
        Check that attach partition after delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> clear column after delete</span>
        Check that clear column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> comment column after delete</span>
        Check that alter comment column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> detach partition after delete</span>
        Check that detach partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop column after delete</span>
        Check that drop column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop partition after delete</span>
        Check that drop partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> freeze partition after delete</span>
        Check that freeze partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> modify column after delete</span>
        Check that modify column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> move partition after delete</span>
        Check that alter move partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replace partition after delete</span>
        Check that replace partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> unfreeze partition after delete</span>
        Check that unfreeze partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> VersionedCollapsingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> add column after delete</span>
        Check that add column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> attach partition after delete</span>
        Check that attach partition after delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> clear column after delete</span>
        Check that clear column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> comment column after delete</span>
        Check that alter comment column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> detach partition after delete</span>
        Check that detach partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop column after delete</span>
        Check that drop column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop partition after delete</span>
        Check that drop partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> freeze partition after delete</span>
        Check that freeze partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> modify column after delete</span>
        Check that modify column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> move partition after delete</span>
        Check that alter move partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replace partition after delete</span>
        Check that replace partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> unfreeze partition after delete</span>
        Check that unfreeze partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> GraphiteMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> add column after delete</span>
        Check that add column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> attach partition after delete</span>
        Check that attach partition after delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> clear column after delete</span>
        Check that clear column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> comment column after delete</span>
        Check that alter comment column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> detach partition after delete</span>
        Check that detach partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop column after delete</span>
        Check that drop column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop partition after delete</span>
        Check that drop partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> freeze partition after delete</span>
        Check that freeze partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> modify column after delete</span>
        Check that modify column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> move partition after delete</span>
        Check that alter move partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replace partition after delete</span>
        Check that replace partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> unfreeze partition after delete</span>
        Check that unfreeze partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">  </span><span class="kn">Feature</span><span class="nn"> random concurrent alter</span>
    Check that clickhouse supports concurrent deletes with alter operations.
<span class="ro">  OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> random concurrent alter</span>
      Check that clickhouse supports concurrent deletes with alter operations
      when random alter operations perform in ransom order.
<span class="ro">    OK</span><span class="k"></span>
<span class="k">  </span><span class="kn">Feature</span><span class="nn"> concurrent alter and delete</span>
    Check that clickhouse supports concurrent deletes with alter operations.
<span class="ro">  OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> MergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent add drop column and delete</span>
        Check that concurrent delete and add drop column perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent clear update and delete</span>
        Check that concurrent clear column update column and delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete attach detach partition</span>
        Check that concurrent delete and attach detach partition perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete drop partition</span>
        Check that concurrent delete and drop partition perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete freeze partition</span>
        Check that concurrent delete and freeze partition perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent modify column and delete</span>
        Check that concurrent delete and add drop column perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplacingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent add drop column and delete</span>
        Check that concurrent delete and add drop column perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent clear update and delete</span>
        Check that concurrent clear column update column and delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete attach detach partition</span>
        Check that concurrent delete and attach detach partition perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete drop partition</span>
        Check that concurrent delete and drop partition perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete freeze partition</span>
        Check that concurrent delete and freeze partition perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent modify column and delete</span>
        Check that concurrent delete and add drop column perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> SummingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent add drop column and delete</span>
        Check that concurrent delete and add drop column perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent clear update and delete</span>
        Check that concurrent clear column update column and delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete attach detach partition</span>
        Check that concurrent delete and attach detach partition perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete drop partition</span>
        Check that concurrent delete and drop partition perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete freeze partition</span>
        Check that concurrent delete and freeze partition perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent modify column and delete</span>
        Check that concurrent delete and add drop column perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> AggregatingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent add drop column and delete</span>
        Check that concurrent delete and add drop column perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent clear update and delete</span>
        Check that concurrent clear column update column and delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete attach detach partition</span>
        Check that concurrent delete and attach detach partition perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete drop partition</span>
        Check that concurrent delete and drop partition perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete freeze partition</span>
        Check that concurrent delete and freeze partition perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent modify column and delete</span>
        Check that concurrent delete and add drop column perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> CollapsingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent add drop column and delete</span>
        Check that concurrent delete and add drop column perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent clear update and delete</span>
        Check that concurrent clear column update column and delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete attach detach partition</span>
        Check that concurrent delete and attach detach partition perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete drop partition</span>
        Check that concurrent delete and drop partition perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete freeze partition</span>
        Check that concurrent delete and freeze partition perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent modify column and delete</span>
        Check that concurrent delete and add drop column perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> VersionedCollapsingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent add drop column and delete</span>
        Check that concurrent delete and add drop column perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent clear update and delete</span>
        Check that concurrent clear column update column and delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete attach detach partition</span>
        Check that concurrent delete and attach detach partition perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete drop partition</span>
        Check that concurrent delete and drop partition perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete freeze partition</span>
        Check that concurrent delete and freeze partition perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent modify column and delete</span>
        Check that concurrent delete and add drop column perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> GraphiteMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent add drop column and delete</span>
        Check that concurrent delete and add drop column perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent clear update and delete</span>
        Check that concurrent clear column update column and delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete attach detach partition</span>
        Check that concurrent delete and attach detach partition perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete drop partition</span>
        Check that concurrent delete and drop partition perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete freeze partition</span>
        Check that concurrent delete and freeze partition perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent modify column and delete</span>
        Check that concurrent delete and add drop column perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">  </span><span class="kn">Feature</span><span class="nn"> concurrent delete</span>
    Check, that clickhouse DELETE statement SHALL perform correctly when there are
    multiple concurrent DELETE statements.
<span class="re">  Error</span> concurrent delete, TypeError
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> MergeTree</span><span class="re"></span>
<span class="re">    Error</span> MergeTree, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete with overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple concurrent DELETE statements targeting the same rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete with overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting the same rows.
<span class="re">      Error</span> concurrent delete with overlap with alter delete, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple concurrent DELETE statements targeting different rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete without overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting different rows.
<span class="re">      Error</span> concurrent delete without overlap with alter delete, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 25 percent of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting 25 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 25 percent of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting 25 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 75 percent of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting 75 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 75 percent of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting 75 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete entire table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting entire table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete entire table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting entire table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete half of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting half of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete half of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting half of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplacingMergeTree</span><span class="re"></span>
<span class="re">    Error</span> ReplacingMergeTree, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete with overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple concurrent DELETE statements targeting the same rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete with overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting the same rows.
<span class="re">      Error</span> concurrent delete with overlap with alter delete, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple concurrent DELETE statements targeting different rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete without overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting different rows.
<span class="re">      Error</span> concurrent delete without overlap with alter delete, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 25 percent of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting 25 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 25 percent of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting 25 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 75 percent of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting 75 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 75 percent of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting 75 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete entire table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting entire table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete entire table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting entire table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete half of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting half of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete half of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting half of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> SummingMergeTree</span><span class="re"></span>
<span class="re">    Error</span> SummingMergeTree, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete with overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple concurrent DELETE statements targeting the same rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete with overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting the same rows.
<span class="re">      Error</span> concurrent delete with overlap with alter delete, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple concurrent DELETE statements targeting different rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete without overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting different rows.
<span class="re">      Error</span> concurrent delete without overlap with alter delete, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 25 percent of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting 25 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 25 percent of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting 25 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 75 percent of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting 75 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 75 percent of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting 75 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete entire table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting entire table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete entire table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting entire table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete half of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting half of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete half of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting half of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> AggregatingMergeTree</span><span class="re"></span>
<span class="re">    Error</span> AggregatingMergeTree, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete with overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple concurrent DELETE statements targeting the same rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete with overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting the same rows.
<span class="re">      Error</span> concurrent delete with overlap with alter delete, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple concurrent DELETE statements targeting different rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete without overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting different rows.
<span class="re">      Error</span> concurrent delete without overlap with alter delete, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 25 percent of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting 25 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 25 percent of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting 25 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 75 percent of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting 75 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 75 percent of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting 75 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete entire table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting entire table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete entire table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting entire table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete half of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting half of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete half of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting half of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> CollapsingMergeTree</span><span class="re"></span>
<span class="re">    Error</span> CollapsingMergeTree, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete with overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple concurrent DELETE statements targeting the same rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete with overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting the same rows.
<span class="re">      Error</span> concurrent delete with overlap with alter delete, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple concurrent DELETE statements targeting different rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete without overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting different rows.
<span class="re">      Error</span> concurrent delete without overlap with alter delete, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 25 percent of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting 25 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 25 percent of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting 25 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 75 percent of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting 75 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 75 percent of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting 75 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete entire table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting entire table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete entire table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting entire table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete half of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting half of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete half of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting half of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> VersionedCollapsingMergeTree</span><span class="re"></span>
<span class="re">    Error</span> VersionedCollapsingMergeTree, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete with overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple concurrent DELETE statements targeting the same rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete with overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting the same rows.
<span class="re">      Error</span> concurrent delete with overlap with alter delete, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple concurrent DELETE statements targeting different rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete without overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting different rows.
<span class="re">      Error</span> concurrent delete without overlap with alter delete, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 25 percent of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting 25 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 25 percent of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting 25 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 75 percent of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting 75 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 75 percent of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting 75 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete entire table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting entire table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete entire table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting entire table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete half of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting half of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete half of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting half of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> GraphiteMergeTree</span><span class="re"></span>
<span class="re">    Error</span> GraphiteMergeTree, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete with overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple concurrent DELETE statements targeting the same rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete with overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting the same rows.
<span class="re">      Error</span> concurrent delete with overlap with alter delete, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple concurrent DELETE statements targeting different rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete without overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting different rows.
<span class="re">      Error</span> concurrent delete without overlap with alter delete, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 25 percent of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting 25 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 25 percent of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting 25 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 75 percent of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting 75 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 75 percent of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting 75 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete entire table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting entire table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete entire table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting entire table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete half of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting half of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete half of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting half of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">  </span><span class="kn">Feature</span><span class="nn"> invalid where clause</span>
    Check that clickhouse returns an error when using DELETE statement with invalid WHERE clause.
<span class="ro">  OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> MergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> empty where clause</span>
        Check that clickhouse returns an error when using DELETE statement with empty WHERE clause.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> no where</span>
        Check that clickhouse returns an error when using DELETE statement with no WHERE clause.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplacingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> empty where clause</span>
        Check that clickhouse returns an error when using DELETE statement with empty WHERE clause.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> no where</span>
        Check that clickhouse returns an error when using DELETE statement with no WHERE clause.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> SummingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> empty where clause</span>
        Check that clickhouse returns an error when using DELETE statement with empty WHERE clause.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> no where</span>
        Check that clickhouse returns an error when using DELETE statement with no WHERE clause.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> AggregatingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> empty where clause</span>
        Check that clickhouse returns an error when using DELETE statement with empty WHERE clause.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> no where</span>
        Check that clickhouse returns an error when using DELETE statement with no WHERE clause.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> CollapsingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> empty where clause</span>
        Check that clickhouse returns an error when using DELETE statement with empty WHERE clause.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> no where</span>
        Check that clickhouse returns an error when using DELETE statement with no WHERE clause.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> VersionedCollapsingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> empty where clause</span>
        Check that clickhouse returns an error when using DELETE statement with empty WHERE clause.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> no where</span>
        Check that clickhouse returns an error when using DELETE statement with no WHERE clause.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> GraphiteMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> empty where clause</span>
        Check that clickhouse returns an error when using DELETE statement with empty WHERE clause.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> no where</span>
        Check that clickhouse returns an error when using DELETE statement with no WHERE clause.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">  </span><span class="kn">Feature</span><span class="nn"> immediate removal</span>
    Check that clickhouse immediately remove all rows for subsequent SELECTs
    after DELETE statement is executed and the subsequent SELECT statements
    not apply the original WHERE conditions specified in the DELETE.
<span class="ro">  OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> MergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete most of the table</span>
        Check that clickhouse immediately remove all rows for subsequent SELECTs
        after DELETE statement is executed.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplacingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete most of the table</span>
        Check that clickhouse immediately remove all rows for subsequent SELECTs
        after DELETE statement is executed.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> SummingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete most of the table</span>
        Check that clickhouse immediately remove all rows for subsequent SELECTs
        after DELETE statement is executed.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> AggregatingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete most of the table</span>
        Check that clickhouse immediately remove all rows for subsequent SELECTs
        after DELETE statement is executed.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> CollapsingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete most of the table</span>
        Check that clickhouse immediately remove all rows for subsequent SELECTs
        after DELETE statement is executed.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> VersionedCollapsingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete most of the table</span>
        Check that clickhouse immediately remove all rows for subsequent SELECTs
        after DELETE statement is executed.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> GraphiteMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete most of the table</span>
        Check that clickhouse immediately remove all rows for subsequent SELECTs
        after DELETE statement is executed.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">  </span><span class="kn">Feature</span><span class="nn"> basic checks</span>
    Run basic checks for the DELETE statement in ClickHouse.
<span class="ro">  OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> one million datapoints</span>
      Check DELETE with a table that has one million entries.
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete all rows</span>
        Check that DELETE can remove all rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete all rows from half of parts</span>
        Check that DELETE can remove all rows from half of the parts.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete large subset</span>
        Check that DELETE can remove a large subset of rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete one row</span>
        Check that DELETE can remove one row.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete small subset</span>
        Check that DELETE can remove a small subset of rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete zero rows</span>
        Check that DELETE can remove zero rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> many partition mixed parts</span>
      Check DELETE with a table that has many partition, each with one large part and many small parts.
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete all rows</span>
        Check that DELETE can remove all rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete all rows from half of parts</span>
        Check that DELETE can remove all rows from half of the parts.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete large subset</span>
        Check that DELETE can remove a large subset of rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete one row</span>
        Check that DELETE can remove one row.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete small subset</span>
        Check that DELETE can remove a small subset of rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete zero rows</span>
        Check that DELETE can remove zero rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> many partition many parts</span>
      Check DELETE with a table that has many partition and many parts.
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete all rows</span>
        Check that DELETE can remove all rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete all rows from half of parts</span>
        Check that DELETE can remove all rows from half of the parts.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete large subset</span>
        Check that DELETE can remove a large subset of rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete one row</span>
        Check that DELETE can remove one row.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete small subset</span>
        Check that DELETE can remove a small subset of rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete zero rows</span>
        Check that DELETE can remove zero rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> many partition one part</span>
      Check DELETE with a table that has many partition and one part.
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete all rows</span>
        Check that DELETE can remove all rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete all rows from half of parts</span>
        Check that DELETE can remove all rows from half of the parts.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete large subset</span>
        Check that DELETE can remove a large subset of rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete one row</span>
        Check that DELETE can remove one row.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete small subset</span>
        Check that DELETE can remove a small subset of rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete zero rows</span>
        Check that DELETE can remove zero rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> one partition mixed parts</span>
      Check DELETE with a table that has one partition, one large part, and many small parts.
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete all rows</span>
        Check that DELETE can remove all rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete all rows from half of parts</span>
        Check that DELETE can remove all rows from half of the parts.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete large subset</span>
        Check that DELETE can remove a large subset of rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete one row</span>
        Check that DELETE can remove one row.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete small subset</span>
        Check that DELETE can remove a small subset of rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete zero rows</span>
        Check that DELETE can remove zero rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> one partition many parts</span>
      Check DELETE with a table that has one partition and many parts.
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete all rows</span>
        Check that DELETE can remove all rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete all rows from half of parts</span>
        Check that DELETE can remove all rows from half of the parts.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete large subset</span>
        Check that DELETE can remove a large subset of rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete one row</span>
        Check that DELETE can remove one row.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete small subset</span>
        Check that DELETE can remove a small subset of rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete zero rows</span>
        Check that DELETE can remove zero rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> one partition one part</span>
      Check DELETE with a table that has one partition and one part.
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete all rows</span>
        Check that DELETE can remove all rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete all rows from half of parts</span>
        Check that DELETE can remove all rows from half of the parts.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete large subset</span>
        Check that DELETE can remove a large subset of rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete one row</span>
        Check that DELETE can remove one row.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete small subset</span>
        Check that DELETE can remove a small subset of rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete zero rows</span>
        Check that DELETE can remove zero rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">  </span><span class="kn">Feature</span><span class="nn"> specific deletes</span>
    Check that clickhouse support random deletes and deletes with stop merges.
<span class="ro">  OK</span><span class="re"></span>
<span class="re">Error</span> lightweight delete, TypeError
  Traceback (most recent call last):
    File &quot;/usr/lib/python3.10/threading.py&quot;, line 966, in _bootstrap
      self._bootstrap_inner()
    File &quot;/usr/lib/python3.10/threading.py&quot;, line 1009, in _bootstrap_inner
      self.run()
    File &quot;/usr/lib/python3.10/threading.py&quot;, line 946, in run
      self._target(*self._args, **self._kwargs)
    File &quot;/usr/lib/python3.10/concurrent/futures/thread.py&quot;, line 58, in run
      result = self.fn(*self.args, **self.kwargs)
  TypeError: delete_odd() got an unexpected keyword argument &#39;check&#39;
</code></pre></div>


</div>

<section class="requirement"><span class="requirement-inline"><i class="utf-icon color-ok">✔</i>RQ.SRS-023.ClickHouse.LightweightDelete.DeleteZeroRows</span></section>

<div class="requirement-description hidden">

<p><a target="_blank" rel="nofollow noopener noreferrer" href="https://clickhouse.yandex">ClickHouse</a>'s <code>DELETE</code> statement SHALL remove zero rows if <code>WHERE</code> condition does not match any row.</p>

</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">17s 881ms</span>/lightweight delete/basic checks/one million datapoints/delete zero rows</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete zero rows</span>
        Check that DELETE can remove zero rows.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_ecddfc84_3423_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_ecddfc84_3423_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert one million entries
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_ecddfc84_3423_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmprfcwp1rg
            cat &quot;/tmp/tmprfcwp1rg&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I record the table data
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_ecddfc84_3423_11ed_b9de_572e856b5561 FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I delete zero rows from table_ecddfc84_3423_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_ecddfc84_3423_11ed_b9de_572e856b5561 WHERE id &lt; -1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check table_ecddfc84_3423_11ed_b9de_572e856b5561 is empty
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_ecddfc84_3423_11ed_b9de_572e856b5561 FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_ecddfc84_3423_11ed_b9de_572e856b5561 FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_ecddfc84_3423_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">18s 727ms</span>/lightweight delete/basic checks/many partition mixed parts/delete zero rows</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete zero rows</span>
        Check that DELETE can remove zero rows.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_25880c19_3424_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_25880c19_3424_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert one large part
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_25880c19_3424_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpazl78gf0
            cat &quot;/tmp/tmpazl78gf0&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;10000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I insert many small parts
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_25880c19_3424_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmp0zmolgbk
            cat &quot;/tmp/tmp0zmolgbk&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;10&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I record the table data
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_25880c19_3424_11ed_b9de_572e856b5561 FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I delete zero rows from table_25880c19_3424_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_25880c19_3424_11ed_b9de_572e856b5561 WHERE id &lt; -1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check table_25880c19_3424_11ed_b9de_572e856b5561 is empty
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_25880c19_3424_11ed_b9de_572e856b5561 FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_25880c19_3424_11ed_b9de_572e856b5561 FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_25880c19_3424_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">14s 90ms</span>/lightweight delete/basic checks/many partition many parts/delete zero rows</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete zero rows</span>
        Check that DELETE can remove zero rows.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_6e5be6ef_3424_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_6e5be6ef_3424_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert some data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_6e5be6ef_3424_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpetmwlncd
            cat &quot;/tmp/tmpetmwlncd&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I record the table data
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_6e5be6ef_3424_11ed_b9de_572e856b5561 FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I delete zero rows from table_6e5be6ef_3424_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_6e5be6ef_3424_11ed_b9de_572e856b5561 WHERE id &lt; -1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check table_6e5be6ef_3424_11ed_b9de_572e856b5561 is empty
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_6e5be6ef_3424_11ed_b9de_572e856b5561 FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_6e5be6ef_3424_11ed_b9de_572e856b5561 FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_6e5be6ef_3424_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">13s 469ms</span>/lightweight delete/basic checks/many partition one part/delete zero rows</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete zero rows</span>
        Check that DELETE can remove zero rows.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_a3fb88cd_3424_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_a3fb88cd_3424_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert some data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_a3fb88cd_3424_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmp5p2sy1fk
            cat &quot;/tmp/tmp5p2sy1fk&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I record the table data
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_a3fb88cd_3424_11ed_b9de_572e856b5561 FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I delete zero rows from table_a3fb88cd_3424_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_a3fb88cd_3424_11ed_b9de_572e856b5561 WHERE id &lt; -1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check table_a3fb88cd_3424_11ed_b9de_572e856b5561 is empty
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_a3fb88cd_3424_11ed_b9de_572e856b5561 FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_a3fb88cd_3424_11ed_b9de_572e856b5561 FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_a3fb88cd_3424_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">13s 484ms</span>/lightweight delete/basic checks/one partition mixed parts/delete zero rows</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete zero rows</span>
        Check that DELETE can remove zero rows.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_de827295_3424_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_de827295_3424_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert one large part
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_de827295_3424_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpj1s6ilna
            cat &quot;/tmp/tmpj1s6ilna&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I insert many small parts
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_de827295_3424_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpd_u1ue7f
            cat &quot;/tmp/tmpd_u1ue7f&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;10&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I record the table data
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_de827295_3424_11ed_b9de_572e856b5561 FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I delete zero rows from table_de827295_3424_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_de827295_3424_11ed_b9de_572e856b5561 WHERE id &lt; -1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check table_de827295_3424_11ed_b9de_572e856b5561 is empty
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_de827295_3424_11ed_b9de_572e856b5561 FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_de827295_3424_11ed_b9de_572e856b5561 FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_de827295_3424_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">13s 279ms</span>/lightweight delete/basic checks/one partition many parts/delete zero rows</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete zero rows</span>
        Check that DELETE can remove zero rows.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_181114e1_3425_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_181114e1_3425_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert some data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_181114e1_3425_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpe3ojcfab
            cat &quot;/tmp/tmpe3ojcfab&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I record the table data
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_181114e1_3425_11ed_b9de_572e856b5561 FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I delete zero rows from table_181114e1_3425_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_181114e1_3425_11ed_b9de_572e856b5561 WHERE id &lt; -1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check table_181114e1_3425_11ed_b9de_572e856b5561 is empty
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_181114e1_3425_11ed_b9de_572e856b5561 FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_181114e1_3425_11ed_b9de_572e856b5561 FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_181114e1_3425_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">19s 369ms</span>/lightweight delete/basic checks/one partition one part/delete zero rows</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete zero rows</span>
        Check that DELETE can remove zero rows.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_514d04bd_3425_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_514d04bd_3425_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert some data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_514d04bd_3425_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpyzabuch9
            cat &quot;/tmp/tmpyzabuch9&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I record the table data
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_514d04bd_3425_11ed_b9de_572e856b5561 FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I delete zero rows from table_514d04bd_3425_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_514d04bd_3425_11ed_b9de_572e856b5561 WHERE id &lt; -1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check table_514d04bd_3425_11ed_b9de_572e856b5561 is empty
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_514d04bd_3425_11ed_b9de_572e856b5561 FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_514d04bd_3425_11ed_b9de_572e856b5561 FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_514d04bd_3425_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<section class="requirement"><span class="requirement-inline"><i class="utf-icon color-ok">✔</i>RQ.SRS-023.ClickHouse.LightweightDelete.DeleteOneRow</span></section>

<div class="requirement-description hidden">

<p><a target="_blank" rel="nofollow noopener noreferrer" href="https://clickhouse.yandex">ClickHouse</a>'s <code>DELETE</code> statement SHALL remove one row if <code>WHERE</code> condition matches one specific row.</p>

</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">22s 439ms</span>/lightweight delete/basic checks/one million datapoints/delete one row</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete one row</span>
        Check that DELETE can remove one row.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_d3e48ccf_3423_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_d3e48ccf_3423_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert one million entries
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_d3e48ccf_3423_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpnci9rzt5
            cat &quot;/tmp/tmpnci9rzt5&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_d3e48ccf_3423_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> I have one distinct row
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO table_d3e48ccf_3423_11ed_b9de_572e856b5561 VALUES (-1,-1)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I delete the row
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_d3e48ccf_3423_11ed_b9de_572e856b5561 WHERE id &lt; 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check the table is the same as before the insert
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_d3e48ccf_3423_11ed_b9de_572e856b5561 WHERE id &lt; 0 ORDER BY id FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_d3e48ccf_3423_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_d3e48ccf_3423_11ed_b9de_572e856b5561 WHERE id &lt; 0 ORDER BY id FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_d3e48ccf_3423_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_d3e48ccf_3423_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">15s 864ms</span>/lightweight delete/basic checks/many partition mixed parts/delete one row</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete one row</span>
        Check that DELETE can remove one row.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_13f430d1_3424_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_13f430d1_3424_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert one large part
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_13f430d1_3424_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpxjrkxn1g
            cat &quot;/tmp/tmpxjrkxn1g&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;10000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I insert many small parts
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_13f430d1_3424_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpp__4ar8x
            cat &quot;/tmp/tmpp__4ar8x&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;10&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_13f430d1_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> I have one distinct row
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO table_13f430d1_3424_11ed_b9de_572e856b5561 VALUES (-1,-1)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I delete the row
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_13f430d1_3424_11ed_b9de_572e856b5561 WHERE id &lt; 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check the table is the same as before the insert
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_13f430d1_3424_11ed_b9de_572e856b5561 WHERE id &lt; 0 ORDER BY id FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_13f430d1_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_13f430d1_3424_11ed_b9de_572e856b5561 WHERE id &lt; 0 ORDER BY id FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_13f430d1_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_13f430d1_3424_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">16s 240ms</span>/lightweight delete/basic checks/many partition many parts/delete one row</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete one row</span>
        Check that DELETE can remove one row.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_56691a8f_3424_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_56691a8f_3424_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert some data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_56691a8f_3424_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpd6386k26
            cat &quot;/tmp/tmpd6386k26&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_56691a8f_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> I have one distinct row
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO table_56691a8f_3424_11ed_b9de_572e856b5561 VALUES (-1,-1)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I delete the row
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_56691a8f_3424_11ed_b9de_572e856b5561 WHERE id &lt; 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check the table is the same as before the insert
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_56691a8f_3424_11ed_b9de_572e856b5561 WHERE id &lt; 0 ORDER BY id FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_56691a8f_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_56691a8f_3424_11ed_b9de_572e856b5561 WHERE id &lt; 0 ORDER BY id FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_56691a8f_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_56691a8f_3424_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">18s 771ms</span>/lightweight delete/basic checks/many partition one part/delete one row</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete one row</span>
        Check that DELETE can remove one row.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_90ea1ae7_3424_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_90ea1ae7_3424_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert some data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_90ea1ae7_3424_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpyfix_1bj
            cat &quot;/tmp/tmpyfix_1bj&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_90ea1ae7_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> I have one distinct row
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO table_90ea1ae7_3424_11ed_b9de_572e856b5561 VALUES (-1,-1)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I delete the row
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_90ea1ae7_3424_11ed_b9de_572e856b5561 WHERE id &lt; 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check the table is the same as before the insert
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_90ea1ae7_3424_11ed_b9de_572e856b5561 WHERE id &lt; 0 ORDER BY id FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_90ea1ae7_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_90ea1ae7_3424_11ed_b9de_572e856b5561 WHERE id &lt; 0 ORDER BY id FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_90ea1ae7_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_90ea1ae7_3424_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">19s 286ms</span>/lightweight delete/basic checks/one partition mixed parts/delete one row</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete one row</span>
        Check that DELETE can remove one row.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_c95f0685_3424_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_c95f0685_3424_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert one large part
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_c95f0685_3424_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpfjm77fc9
            cat &quot;/tmp/tmpfjm77fc9&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I insert many small parts
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_c95f0685_3424_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpryhfx8dn
            cat &quot;/tmp/tmpryhfx8dn&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;10&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_c95f0685_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> I have one distinct row
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO table_c95f0685_3424_11ed_b9de_572e856b5561 VALUES (-1,-1)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I delete the row
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_c95f0685_3424_11ed_b9de_572e856b5561 WHERE id &lt; 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check the table is the same as before the insert
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_c95f0685_3424_11ed_b9de_572e856b5561 WHERE id &lt; 0 ORDER BY id FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_c95f0685_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_c95f0685_3424_11ed_b9de_572e856b5561 WHERE id &lt; 0 ORDER BY id FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_c95f0685_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_c95f0685_3424_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">13s 380ms</span>/lightweight delete/basic checks/one partition many parts/delete one row</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete one row</span>
        Check that DELETE can remove one row.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_06daaaaf_3425_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_06daaaaf_3425_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert some data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_06daaaaf_3425_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpqk8u7n19
            cat &quot;/tmp/tmpqk8u7n19&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_06daaaaf_3425_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> I have one distinct row
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO table_06daaaaf_3425_11ed_b9de_572e856b5561 VALUES (-1,-1)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I delete the row
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_06daaaaf_3425_11ed_b9de_572e856b5561 WHERE id &lt; 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check the table is the same as before the insert
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_06daaaaf_3425_11ed_b9de_572e856b5561 WHERE id &lt; 0 ORDER BY id FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_06daaaaf_3425_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_06daaaaf_3425_11ed_b9de_572e856b5561 WHERE id &lt; 0 ORDER BY id FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_06daaaaf_3425_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_06daaaaf_3425_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">13s 519ms</span>/lightweight delete/basic checks/one partition one part/delete one row</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete one row</span>
        Check that DELETE can remove one row.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_3ffbbe48_3425_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_3ffbbe48_3425_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert some data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_3ffbbe48_3425_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmp5z18ry8p
            cat &quot;/tmp/tmp5z18ry8p&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_3ffbbe48_3425_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> I have one distinct row
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO table_3ffbbe48_3425_11ed_b9de_572e856b5561 VALUES (-1,-1)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I delete the row
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_3ffbbe48_3425_11ed_b9de_572e856b5561 WHERE id &lt; 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check the table is the same as before the insert
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_3ffbbe48_3425_11ed_b9de_572e856b5561 WHERE id &lt; 0 ORDER BY id FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_3ffbbe48_3425_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_3ffbbe48_3425_11ed_b9de_572e856b5561 WHERE id &lt; 0 ORDER BY id FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_3ffbbe48_3425_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_3ffbbe48_3425_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<section class="requirement"><span class="requirement-inline"><i class="utf-icon color-ok">✔</i>RQ.SRS-023.ClickHouse.LightweightDelete.DeleteAllRows</span></section>

<div class="requirement-description hidden">

<p><a target="_blank" rel="nofollow noopener noreferrer" href="https://clickhouse.yandex">ClickHouse</a>'s <code>DELETE</code> statement SHALL all rows if <code>WHERE</code> condition matches every row.</p>

</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">35s 652ms</span>/lightweight delete/basic checks/one million datapoints/delete all rows</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete all rows</span>
        Check that DELETE can remove all rows.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_ab200497_3423_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_ab200497_3423_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert one million entries
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_ab200497_3423_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpzjvltl3u
            cat &quot;/tmp/tmpzjvltl3u&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I delete all rows from table_ab200497_3423_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_ab200497_3423_11ed_b9de_572e856b5561 WHERE id &gt; -1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check table_ab200497_3423_11ed_b9de_572e856b5561 is empty
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_ab200497_3423_11ed_b9de_572e856b5561 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_ab200497_3423_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="rf">            Fail</span> try #1, ClickHouse server is not healthy
            Retry try #2
<span class="rf">            Fail</span> try #2, ClickHouse server is not healthy
            Retry try #3
<span class="rf">            Fail</span> try #3, ClickHouse server is not healthy
            Retry try #4
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_ab200497_3423_11ed_b9de_572e856b5561 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_ab200497_3423_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_ab200497_3423_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">13s 925ms</span>/lightweight delete/basic checks/many partition mixed parts/delete all rows</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete all rows</span>
        Check that DELETE can remove all rows.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_f79f4f6e_3423_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_f79f4f6e_3423_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert one large part
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_f79f4f6e_3423_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmp2oypkms1
            cat &quot;/tmp/tmp2oypkms1&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;10000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I insert many small parts
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_f79f4f6e_3423_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmp833bj2hd
            cat &quot;/tmp/tmp833bj2hd&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;10&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I delete all rows from table_f79f4f6e_3423_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_f79f4f6e_3423_11ed_b9de_572e856b5561 WHERE id &gt; -1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check table_f79f4f6e_3423_11ed_b9de_572e856b5561 is empty
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_f79f4f6e_3423_11ed_b9de_572e856b5561 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_f79f4f6e_3423_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_f79f4f6e_3423_11ed_b9de_572e856b5561 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_f79f4f6e_3423_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_f79f4f6e_3423_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">18s 937ms</span>/lightweight delete/basic checks/many partition many parts/delete all rows</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete all rows</span>
        Check that DELETE can remove all rows.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_31681dca_3424_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_31681dca_3424_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert some data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_31681dca_3424_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpm97lkwfp
            cat &quot;/tmp/tmpm97lkwfp&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I delete all rows from table_31681dca_3424_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_31681dca_3424_11ed_b9de_572e856b5561 WHERE id &gt; -1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check table_31681dca_3424_11ed_b9de_572e856b5561 is empty
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_31681dca_3424_11ed_b9de_572e856b5561 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_31681dca_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_31681dca_3424_11ed_b9de_572e856b5561 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_31681dca_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_31681dca_3424_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">17s 915ms</span>/lightweight delete/basic checks/many partition one part/delete all rows</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete all rows</span>
        Check that DELETE can remove all rows.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_76d05cbf_3424_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_76d05cbf_3424_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert some data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_76d05cbf_3424_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmp47pp3c0k
            cat &quot;/tmp/tmp47pp3c0k&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I delete all rows from table_76d05cbf_3424_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_76d05cbf_3424_11ed_b9de_572e856b5561 WHERE id &gt; -1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check table_76d05cbf_3424_11ed_b9de_572e856b5561 is empty
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_76d05cbf_3424_11ed_b9de_572e856b5561 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_76d05cbf_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_76d05cbf_3424_11ed_b9de_572e856b5561 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_76d05cbf_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_76d05cbf_3424_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">20s 928ms</span>/lightweight delete/basic checks/one partition mixed parts/delete all rows</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete all rows</span>
        Check that DELETE can remove all rows.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_acc437cf_3424_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_acc437cf_3424_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert one large part
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_acc437cf_3424_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmp2pkqqqp0
            cat &quot;/tmp/tmp2pkqqqp0&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I insert many small parts
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_acc437cf_3424_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpa_p_p_lt
            cat &quot;/tmp/tmpa_p_p_lt&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;10&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I delete all rows from table_acc437cf_3424_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_acc437cf_3424_11ed_b9de_572e856b5561 WHERE id &gt; -1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check table_acc437cf_3424_11ed_b9de_572e856b5561 is empty
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_acc437cf_3424_11ed_b9de_572e856b5561 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_acc437cf_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_acc437cf_3424_11ed_b9de_572e856b5561 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_acc437cf_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_acc437cf_3424_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">19s 777ms</span>/lightweight delete/basic checks/one partition many parts/delete all rows</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete all rows</span>
        Check that DELETE can remove all rows.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_e735b59a_3424_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_e735b59a_3424_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert some data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_e735b59a_3424_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpzhxh3rcr
            cat &quot;/tmp/tmpzhxh3rcr&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I delete all rows from table_e735b59a_3424_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_e735b59a_3424_11ed_b9de_572e856b5561 WHERE id &gt; -1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check table_e735b59a_3424_11ed_b9de_572e856b5561 is empty
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_e735b59a_3424_11ed_b9de_572e856b5561 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_e735b59a_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_e735b59a_3424_11ed_b9de_572e856b5561 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_e735b59a_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_e735b59a_3424_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">18s 736ms</span>/lightweight delete/basic checks/one partition one part/delete all rows</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete all rows</span>
        Check that DELETE can remove all rows.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_1f449e83_3425_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_1f449e83_3425_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert some data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_1f449e83_3425_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpc9uykase
            cat &quot;/tmp/tmpc9uykase&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I delete all rows from table_1f449e83_3425_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_1f449e83_3425_11ed_b9de_572e856b5561 WHERE id &gt; -1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check table_1f449e83_3425_11ed_b9de_572e856b5561 is empty
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_1f449e83_3425_11ed_b9de_572e856b5561 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_1f449e83_3425_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_1f449e83_3425_11ed_b9de_572e856b5561 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_1f449e83_3425_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_1f449e83_3425_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<section class="requirement"><span class="requirement-inline"><i class="utf-icon color-ok">✔</i>RQ.SRS-023.ClickHouse.LightweightDelete.DeleteSmallSubsetOfRows</span></section>

<div class="requirement-description hidden">

<p><a target="_blank" rel="nofollow noopener noreferrer" href="https://clickhouse.yandex">ClickHouse</a>'s <code>DELETE</code> statement SHALL remove rows where the <code>WHERE</code> condition matches only matches small subset of rows.</p>

</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">18s 458ms</span>/lightweight delete/basic checks/one million datapoints/delete small subset</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete small subset</span>
        Check that DELETE can remove a small subset of rows.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_e14b1d6b_3423_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_e14b1d6b_3423_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert one million entries
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_e14b1d6b_3423_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpnw58hty7
            cat &quot;/tmp/tmpnw58hty7&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_e14b1d6b_3423_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_e14b1d6b_3423_11ed_b9de_572e856b5561 WHERE x &lt; 10&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        When</span> I delete all rows from table_e14b1d6b_3423_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_e14b1d6b_3423_11ed_b9de_572e856b5561 WHERE x &lt; 10&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check table_e14b1d6b_3423_11ed_b9de_572e856b5561 is empty
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_e14b1d6b_3423_11ed_b9de_572e856b5561 WHERE x &lt; 10 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_e14b1d6b_3423_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_e14b1d6b_3423_11ed_b9de_572e856b5561 WHERE x &lt; 10 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_e14b1d6b_3423_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_e14b1d6b_3423_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">13s 713ms</span>/lightweight delete/basic checks/many partition mixed parts/delete small subset</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete small subset</span>
        Check that DELETE can remove a small subset of rows.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_1d61707f_3424_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_1d61707f_3424_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert one large part
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_1d61707f_3424_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmposrbd02s
            cat &quot;/tmp/tmposrbd02s&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;10000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I insert many small parts
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_1d61707f_3424_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmp61dgm1b5
            cat &quot;/tmp/tmp61dgm1b5&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;10&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_1d61707f_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_1d61707f_3424_11ed_b9de_572e856b5561 WHERE x &lt; 10&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        When</span> I delete all rows from table_1d61707f_3424_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_1d61707f_3424_11ed_b9de_572e856b5561 WHERE x &lt; 10&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check table_1d61707f_3424_11ed_b9de_572e856b5561 is empty
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_1d61707f_3424_11ed_b9de_572e856b5561 WHERE x &lt; 10 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_1d61707f_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_1d61707f_3424_11ed_b9de_572e856b5561 WHERE x &lt; 10 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_1d61707f_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_1d61707f_3424_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">23s 943ms</span>/lightweight delete/basic checks/many partition many parts/delete small subset</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete small subset</span>
        Check that DELETE can remove a small subset of rows.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_6014fdd3_3424_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_6014fdd3_3424_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert some data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_6014fdd3_3424_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmp9pb3fu3r
            cat &quot;/tmp/tmp9pb3fu3r&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_6014fdd3_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_6014fdd3_3424_11ed_b9de_572e856b5561 WHERE x &lt; 10&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        When</span> I delete all rows from table_6014fdd3_3424_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_6014fdd3_3424_11ed_b9de_572e856b5561 WHERE x &lt; 10&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check table_6014fdd3_3424_11ed_b9de_572e856b5561 is empty
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_6014fdd3_3424_11ed_b9de_572e856b5561 WHERE x &lt; 10 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_6014fdd3_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_6014fdd3_3424_11ed_b9de_572e856b5561 WHERE x &lt; 10 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_6014fdd3_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_6014fdd3_3424_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">13s 180ms</span>/lightweight delete/basic checks/many partition one part/delete small subset</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete small subset</span>
        Check that DELETE can remove a small subset of rows.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_9c18fc03_3424_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_9c18fc03_3424_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert some data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_9c18fc03_3424_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpujligvel
            cat &quot;/tmp/tmpujligvel&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_9c18fc03_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_9c18fc03_3424_11ed_b9de_572e856b5561 WHERE x &lt; 10&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        When</span> I delete all rows from table_9c18fc03_3424_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_9c18fc03_3424_11ed_b9de_572e856b5561 WHERE x &lt; 10&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check table_9c18fc03_3424_11ed_b9de_572e856b5561 is empty
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_9c18fc03_3424_11ed_b9de_572e856b5561 WHERE x &lt; 10 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_9c18fc03_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_9c18fc03_3424_11ed_b9de_572e856b5561 WHERE x &lt; 10 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_9c18fc03_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_9c18fc03_3424_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">16s 166ms</span>/lightweight delete/basic checks/one partition mixed parts/delete small subset</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete small subset</span>
        Check that DELETE can remove a small subset of rows.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_d4e0a559_3424_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_d4e0a559_3424_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert one large part
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_d4e0a559_3424_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmp73z4vyto
            cat &quot;/tmp/tmp73z4vyto&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I insert many small parts
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_d4e0a559_3424_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpp_t8hwfj
            cat &quot;/tmp/tmpp_t8hwfj&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;10&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_d4e0a559_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_d4e0a559_3424_11ed_b9de_572e856b5561 WHERE x &lt; 10&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        When</span> I delete all rows from table_d4e0a559_3424_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_d4e0a559_3424_11ed_b9de_572e856b5561 WHERE x &lt; 10&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check table_d4e0a559_3424_11ed_b9de_572e856b5561 is empty
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_d4e0a559_3424_11ed_b9de_572e856b5561 WHERE x &lt; 10 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_d4e0a559_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_d4e0a559_3424_11ed_b9de_572e856b5561 WHERE x &lt; 10 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_d4e0a559_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_d4e0a559_3424_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">14s 247ms</span>/lightweight delete/basic checks/one partition many parts/delete small subset</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete small subset</span>
        Check that DELETE can remove a small subset of rows.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_0eded091_3425_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_0eded091_3425_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert some data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_0eded091_3425_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpi0t07p4e
            cat &quot;/tmp/tmpi0t07p4e&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_0eded091_3425_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_0eded091_3425_11ed_b9de_572e856b5561 WHERE x &lt; 10&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        When</span> I delete all rows from table_0eded091_3425_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_0eded091_3425_11ed_b9de_572e856b5561 WHERE x &lt; 10&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check table_0eded091_3425_11ed_b9de_572e856b5561 is empty
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_0eded091_3425_11ed_b9de_572e856b5561 WHERE x &lt; 10 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_0eded091_3425_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_0eded091_3425_11ed_b9de_572e856b5561 WHERE x &lt; 10 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_0eded091_3425_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_0eded091_3425_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">15s 620ms</span>/lightweight delete/basic checks/one partition one part/delete small subset</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete small subset</span>
        Check that DELETE can remove a small subset of rows.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_474855ab_3425_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_474855ab_3425_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert some data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_474855ab_3425_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpkb1l7r1e
            cat &quot;/tmp/tmpkb1l7r1e&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_474855ab_3425_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_474855ab_3425_11ed_b9de_572e856b5561 WHERE x &lt; 10&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        When</span> I delete all rows from table_474855ab_3425_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_474855ab_3425_11ed_b9de_572e856b5561 WHERE x &lt; 10&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check table_474855ab_3425_11ed_b9de_572e856b5561 is empty
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_474855ab_3425_11ed_b9de_572e856b5561 WHERE x &lt; 10 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_474855ab_3425_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_474855ab_3425_11ed_b9de_572e856b5561 WHERE x &lt; 10 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_474855ab_3425_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_474855ab_3425_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<section class="requirement"><span class="requirement-inline"><i class="utf-icon color-ok">✔</i>RQ.SRS-023.ClickHouse.LightweightDelete.DeleteLargeSubsetOfRows</span></section>

<div class="requirement-description hidden">

<p><a target="_blank" rel="nofollow noopener noreferrer" href="https://clickhouse.yandex">ClickHouse</a>'s <code>DELETE</code> statement SHALL remove rows where the <code>WHERE</code> condition matches only matches large subset of rows.</p>

</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">17s 327ms</span>/lightweight delete/basic checks/one million datapoints/delete large subset</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete large subset</span>
        Check that DELETE can remove a large subset of rows.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_ca46e9f3_3423_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_ca46e9f3_3423_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert one million entries
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_ca46e9f3_3423_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmp7rzf2q2h
            cat &quot;/tmp/tmp7rzf2q2h&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_ca46e9f3_3423_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_ca46e9f3_3423_11ed_b9de_572e856b5561 WHERE x &gt; 10&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        When</span> I delete all rows from table_ca46e9f3_3423_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_ca46e9f3_3423_11ed_b9de_572e856b5561 WHERE x &gt; 10&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check table_ca46e9f3_3423_11ed_b9de_572e856b5561 is empty
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_ca46e9f3_3423_11ed_b9de_572e856b5561 WHERE x &gt; 10 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_ca46e9f3_3423_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_ca46e9f3_3423_11ed_b9de_572e856b5561 WHERE x &gt; 10 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_ca46e9f3_3423_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_ca46e9f3_3423_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">19s 324ms</span>/lightweight delete/basic checks/many partition mixed parts/delete large subset</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete large subset</span>
        Check that DELETE can remove a large subset of rows.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_085c4f29_3424_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_085c4f29_3424_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert one large part
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_085c4f29_3424_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpze7gwgzb
            cat &quot;/tmp/tmpze7gwgzb&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;10000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I insert many small parts
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_085c4f29_3424_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpduw23tqm
            cat &quot;/tmp/tmpduw23tqm&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;10&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_085c4f29_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_085c4f29_3424_11ed_b9de_572e856b5561 WHERE x &gt; 10&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        When</span> I delete all rows from table_085c4f29_3424_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_085c4f29_3424_11ed_b9de_572e856b5561 WHERE x &gt; 10&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check table_085c4f29_3424_11ed_b9de_572e856b5561 is empty
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_085c4f29_3424_11ed_b9de_572e856b5561 WHERE x &gt; 10 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_085c4f29_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_085c4f29_3424_11ed_b9de_572e856b5561 WHERE x &gt; 10 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_085c4f29_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_085c4f29_3424_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">20s 843ms</span>/lightweight delete/basic checks/many partition many parts/delete large subset</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete large subset</span>
        Check that DELETE can remove a large subset of rows.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_4a70dee8_3424_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_4a70dee8_3424_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert some data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_4a70dee8_3424_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmp5l9pw1vf
            cat &quot;/tmp/tmp5l9pw1vf&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_4a70dee8_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_4a70dee8_3424_11ed_b9de_572e856b5561 WHERE x &gt; 10&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        When</span> I delete all rows from table_4a70dee8_3424_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_4a70dee8_3424_11ed_b9de_572e856b5561 WHERE x &gt; 10&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check table_4a70dee8_3424_11ed_b9de_572e856b5561 is empty
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_4a70dee8_3424_11ed_b9de_572e856b5561 WHERE x &gt; 10 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_4a70dee8_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_4a70dee8_3424_11ed_b9de_572e856b5561 WHERE x &gt; 10 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_4a70dee8_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_4a70dee8_3424_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">12s 163ms</span>/lightweight delete/basic checks/many partition one part/delete large subset</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete large subset</span>
        Check that DELETE can remove a large subset of rows.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_89adb6d5_3424_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_89adb6d5_3424_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert some data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_89adb6d5_3424_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmp4qhq7v20
            cat &quot;/tmp/tmp4qhq7v20&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_89adb6d5_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_89adb6d5_3424_11ed_b9de_572e856b5561 WHERE x &gt; 10&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        When</span> I delete all rows from table_89adb6d5_3424_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_89adb6d5_3424_11ed_b9de_572e856b5561 WHERE x &gt; 10&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check table_89adb6d5_3424_11ed_b9de_572e856b5561 is empty
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_89adb6d5_3424_11ed_b9de_572e856b5561 WHERE x &gt; 10 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_89adb6d5_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_89adb6d5_3424_11ed_b9de_572e856b5561 WHERE x &gt; 10 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_89adb6d5_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_89adb6d5_3424_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">13s 729ms</span>/lightweight delete/basic checks/one partition mixed parts/delete large subset</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete large subset</span>
        Check that DELETE can remove a large subset of rows.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_c1322023_3424_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_c1322023_3424_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert one large part
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_c1322023_3424_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpvpsfyuzr
            cat &quot;/tmp/tmpvpsfyuzr&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I insert many small parts
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_c1322023_3424_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpjlxzebzh
            cat &quot;/tmp/tmpjlxzebzh&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;10&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_c1322023_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_c1322023_3424_11ed_b9de_572e856b5561 WHERE x &gt; 10&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        When</span> I delete all rows from table_c1322023_3424_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_c1322023_3424_11ed_b9de_572e856b5561 WHERE x &gt; 10&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check table_c1322023_3424_11ed_b9de_572e856b5561 is empty
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_c1322023_3424_11ed_b9de_572e856b5561 WHERE x &gt; 10 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_c1322023_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_c1322023_3424_11ed_b9de_572e856b5561 WHERE x &gt; 10 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_c1322023_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_c1322023_3424_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">18s 405ms</span>/lightweight delete/basic checks/one partition many parts/delete large subset</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete large subset</span>
        Check that DELETE can remove a large subset of rows.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_fca1ee0f_3424_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_fca1ee0f_3424_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert some data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_fca1ee0f_3424_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpd8_qm2lm
            cat &quot;/tmp/tmpd8_qm2lm&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_fca1ee0f_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_fca1ee0f_3424_11ed_b9de_572e856b5561 WHERE x &gt; 10&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        When</span> I delete all rows from table_fca1ee0f_3424_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_fca1ee0f_3424_11ed_b9de_572e856b5561 WHERE x &gt; 10&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check table_fca1ee0f_3424_11ed_b9de_572e856b5561 is empty
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_fca1ee0f_3424_11ed_b9de_572e856b5561 WHERE x &gt; 10 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_fca1ee0f_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_fca1ee0f_3424_11ed_b9de_572e856b5561 WHERE x &gt; 10 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_fca1ee0f_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_fca1ee0f_3424_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">19s 163ms</span>/lightweight delete/basic checks/one partition one part/delete large subset</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete large subset</span>
        Check that DELETE can remove a large subset of rows.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_33c057ef_3425_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_33c057ef_3425_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert some data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_33c057ef_3425_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmptddly67c
            cat &quot;/tmp/tmptddly67c&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_33c057ef_3425_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_33c057ef_3425_11ed_b9de_572e856b5561 WHERE x &gt; 10&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        When</span> I delete all rows from table_33c057ef_3425_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_33c057ef_3425_11ed_b9de_572e856b5561 WHERE x &gt; 10&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check table_33c057ef_3425_11ed_b9de_572e856b5561 is empty
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_33c057ef_3425_11ed_b9de_572e856b5561 WHERE x &gt; 10 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_33c057ef_3425_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_33c057ef_3425_11ed_b9de_572e856b5561 WHERE x &gt; 10 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_33c057ef_3425_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_33c057ef_3425_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<section class="requirement"><span class="requirement-inline"><i class="utf-icon color-ok">✔</i>RQ.SRS-023.ClickHouse.LightweightDelete.OnePartitionWithPart</span></section>

<div class="requirement-description hidden">

<p><a target="_blank" rel="nofollow noopener noreferrer" href="https://clickhouse.yandex">ClickHouse</a> SHALL support <code>DELETE</code> removing data in a partition with one part.</p>

</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">1m 42s</span>/lightweight delete/basic checks/one partition one part</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">    </span><span class="kn">Feature</span><span class="nn"> one partition one part</span>
      Check DELETE with a table that has one partition and one part.
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete all rows</span>
        Check that DELETE can remove all rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete all rows from half of parts</span>
        Check that DELETE can remove all rows from half of the parts.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete large subset</span>
        Check that DELETE can remove a large subset of rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete one row</span>
        Check that DELETE can remove one row.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete small subset</span>
        Check that DELETE can remove a small subset of rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete zero rows</span>
        Check that DELETE can remove zero rows.
<span class="ro">      OK</span>
<span class="ro">    OK</span>
</code></pre></div>


</div>

<section class="requirement"><span class="requirement-inline"><i class="utf-icon color-ok">✔</i>RQ.SRS-023.ClickHouse.LightweightDelete.PartitionWithManyParts</span></section>

<div class="requirement-description hidden">

<p><a target="_blank" rel="nofollow noopener noreferrer" href="https://clickhouse.yandex">ClickHouse</a> SHALL support <code>DELETE</code> removing data in a partition with many small parts.</p>

</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">1m 35s</span>/lightweight delete/basic checks/one partition many parts</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">    </span><span class="kn">Feature</span><span class="nn"> one partition many parts</span>
      Check DELETE with a table that has one partition and many parts.
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete all rows</span>
        Check that DELETE can remove all rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete all rows from half of parts</span>
        Check that DELETE can remove all rows from half of the parts.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete large subset</span>
        Check that DELETE can remove a large subset of rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete one row</span>
        Check that DELETE can remove one row.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete small subset</span>
        Check that DELETE can remove a small subset of rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete zero rows</span>
        Check that DELETE can remove zero rows.
<span class="ro">      OK</span>
<span class="ro">    OK</span>
</code></pre></div>


</div>

<section class="requirement"><span class="requirement-inline"><i class="utf-icon color-ok">✔</i>RQ.SRS-023.ClickHouse.LightweightDelete.MultiplePartitionsAndOnePart</span></section>

<div class="requirement-description hidden">

<p><a target="_blank" rel="nofollow noopener noreferrer" href="https://clickhouse.yandex">ClickHouse</a> SHALL support <code>DELETE</code> removing data from multiple partitions with one part each.</p>

</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">1m 29s</span>/lightweight delete/basic checks/many partition one part</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">    </span><span class="kn">Feature</span><span class="nn"> many partition one part</span>
      Check DELETE with a table that has many partition and one part.
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete all rows</span>
        Check that DELETE can remove all rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete all rows from half of parts</span>
        Check that DELETE can remove all rows from half of the parts.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete large subset</span>
        Check that DELETE can remove a large subset of rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete one row</span>
        Check that DELETE can remove one row.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete small subset</span>
        Check that DELETE can remove a small subset of rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete zero rows</span>
        Check that DELETE can remove zero rows.
<span class="ro">      OK</span>
<span class="ro">    OK</span>
</code></pre></div>


</div>

<section class="requirement"><span class="requirement-inline"><i class="utf-icon color-ok">✔</i>RQ.SRS-023.ClickHouse.LightweightDelete.MultiplePartsAndPartitions</span></section>

<div class="requirement-description hidden">

<p><a target="_blank" rel="nofollow noopener noreferrer" href="https://clickhouse.yandex">ClickHouse</a> SHALL support <code>DELETE</code> removing data from multiple parts and partitions.</p>

</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">1m 57s</span>/lightweight delete/basic checks/many partition many parts</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">    </span><span class="kn">Feature</span><span class="nn"> many partition many parts</span>
      Check DELETE with a table that has many partition and many parts.
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete all rows</span>
        Check that DELETE can remove all rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete all rows from half of parts</span>
        Check that DELETE can remove all rows from half of the parts.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete large subset</span>
        Check that DELETE can remove a large subset of rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete one row</span>
        Check that DELETE can remove one row.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete small subset</span>
        Check that DELETE can remove a small subset of rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete zero rows</span>
        Check that DELETE can remove zero rows.
<span class="ro">      OK</span>
<span class="ro">    OK</span>
</code></pre></div>


</div>

<section class="requirement"><span class="requirement-inline"><i class="utf-icon color-ok">✔</i>RQ.SRS-023.ClickHouse.LightweightDelete.AllRowsFromHalfOfTheParts</span></section>

<div class="requirement-description hidden">

<p><a target="_blank" rel="nofollow noopener noreferrer" href="https://clickhouse.yandex">ClickHouse</a> SHALL support <code>DELETE</code> removing all rows from half of the parts.</p>

</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">16s 646ms</span>/lightweight delete/basic checks/one million datapoints/delete all rows from half of parts</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete all rows from half of parts</span>
        Check that DELETE can remove all rows from half of the parts.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_bfa91248_3423_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_bfa91248_3423_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert one million entries
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_bfa91248_3423_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpzjmtlhni
            cat &quot;/tmp/tmpzjmtlhni&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_bfa91248_3423_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_bfa91248_3423_11ed_b9de_572e856b5561 WHERE id &lt; 5&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        When</span> I delete all rows from table_bfa91248_3423_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_bfa91248_3423_11ed_b9de_572e856b5561 WHERE id &lt; 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check table_bfa91248_3423_11ed_b9de_572e856b5561 is empty
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_bfa91248_3423_11ed_b9de_572e856b5561 WHERE id &lt; 5 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_bfa91248_3423_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_bfa91248_3423_11ed_b9de_572e856b5561 WHERE id &lt; 5 ORDER BY id FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_bfa91248_3423_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_bfa91248_3423_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">15s 385ms</span>/lightweight delete/basic checks/many partition mixed parts/delete all rows from half of parts</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete all rows from half of parts</span>
        Check that DELETE can remove all rows from half of the parts.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_ffeb03b2_3423_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_ffeb03b2_3423_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert one large part
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_ffeb03b2_3423_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpgdjk6xwr
            cat &quot;/tmp/tmpgdjk6xwr&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;10000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I insert many small parts
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_ffeb03b2_3423_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpskubn2g7
            cat &quot;/tmp/tmpskubn2g7&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;10&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_ffeb03b2_3423_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_ffeb03b2_3423_11ed_b9de_572e856b5561 WHERE id &lt; 5&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        When</span> I delete all rows from table_ffeb03b2_3423_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_ffeb03b2_3423_11ed_b9de_572e856b5561 WHERE id &lt; 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check table_ffeb03b2_3423_11ed_b9de_572e856b5561 is empty
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_ffeb03b2_3423_11ed_b9de_572e856b5561 WHERE id &lt; 5 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_ffeb03b2_3423_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_ffeb03b2_3423_11ed_b9de_572e856b5561 WHERE id &lt; 5 ORDER BY id FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_ffeb03b2_3423_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_ffeb03b2_3423_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">23s 505ms</span>/lightweight delete/basic checks/many partition many parts/delete all rows from half of parts</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete all rows from half of parts</span>
        Check that DELETE can remove all rows from half of the parts.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_3cb88f9f_3424_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_3cb88f9f_3424_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert some data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_3cb88f9f_3424_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmp33rn765m
            cat &quot;/tmp/tmp33rn765m&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_3cb88f9f_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_3cb88f9f_3424_11ed_b9de_572e856b5561 WHERE id &lt; 5&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        When</span> I delete all rows from table_3cb88f9f_3424_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_3cb88f9f_3424_11ed_b9de_572e856b5561 WHERE id &lt; 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check table_3cb88f9f_3424_11ed_b9de_572e856b5561 is empty
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_3cb88f9f_3424_11ed_b9de_572e856b5561 WHERE id &lt; 5 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_3cb88f9f_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_3cb88f9f_3424_11ed_b9de_572e856b5561 WHERE id &lt; 5 ORDER BY id FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_3cb88f9f_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_3cb88f9f_3424_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">13s 732ms</span>/lightweight delete/basic checks/many partition one part/delete all rows from half of parts</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete all rows from half of parts</span>
        Check that DELETE can remove all rows from half of the parts.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_81814e95_3424_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_81814e95_3424_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert some data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_81814e95_3424_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmp40z54k87
            cat &quot;/tmp/tmp40z54k87&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_81814e95_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_81814e95_3424_11ed_b9de_572e856b5561 WHERE id &lt; 5&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        When</span> I delete all rows from table_81814e95_3424_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_81814e95_3424_11ed_b9de_572e856b5561 WHERE id &lt; 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check table_81814e95_3424_11ed_b9de_572e856b5561 is empty
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_81814e95_3424_11ed_b9de_572e856b5561 WHERE id &lt; 5 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_81814e95_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_81814e95_3424_11ed_b9de_572e856b5561 WHERE id &lt; 5 ORDER BY id FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_81814e95_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_81814e95_3424_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">14s 615ms</span>/lightweight delete/basic checks/one partition mixed parts/delete all rows from half of parts</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete all rows from half of parts</span>
        Check that DELETE can remove all rows from half of the parts.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_b944a638_3424_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_b944a638_3424_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert one large part
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_b944a638_3424_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmp7lljvnpx
            cat &quot;/tmp/tmp7lljvnpx&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I insert many small parts
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_b944a638_3424_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpz31jq3g6
            cat &quot;/tmp/tmpz31jq3g6&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;10&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_b944a638_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_b944a638_3424_11ed_b9de_572e856b5561 WHERE id &lt; 5&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        When</span> I delete all rows from table_b944a638_3424_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_b944a638_3424_11ed_b9de_572e856b5561 WHERE id &lt; 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check table_b944a638_3424_11ed_b9de_572e856b5561 is empty
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_b944a638_3424_11ed_b9de_572e856b5561 WHERE id &lt; 5 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_b944a638_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_b944a638_3424_11ed_b9de_572e856b5561 WHERE id &lt; 5 ORDER BY id FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_b944a638_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_b944a638_3424_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">16s 77ms</span>/lightweight delete/basic checks/one partition many parts/delete all rows from half of parts</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete all rows from half of parts</span>
        Check that DELETE can remove all rows from half of the parts.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_f3188098_3424_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_f3188098_3424_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert some data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_f3188098_3424_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpdrqvhd0r
            cat &quot;/tmp/tmpdrqvhd0r&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_f3188098_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_f3188098_3424_11ed_b9de_572e856b5561 WHERE id &lt; 5&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        When</span> I delete all rows from table_f3188098_3424_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_f3188098_3424_11ed_b9de_572e856b5561 WHERE id &lt; 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check table_f3188098_3424_11ed_b9de_572e856b5561 is empty
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_f3188098_3424_11ed_b9de_572e856b5561 WHERE id &lt; 5 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_f3188098_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_f3188098_3424_11ed_b9de_572e856b5561 WHERE id &lt; 5 ORDER BY id FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_f3188098_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_f3188098_3424_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">15s 702ms</span>/lightweight delete/basic checks/one partition one part/delete all rows from half of parts</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete all rows from half of parts</span>
        Check that DELETE can remove all rows from half of the parts.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_2b2687b9_3425_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_2b2687b9_3425_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert some data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_2b2687b9_3425_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpwl5fgzyv
            cat &quot;/tmp/tmpwl5fgzyv&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_2b2687b9_3425_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_2b2687b9_3425_11ed_b9de_572e856b5561 WHERE id &lt; 5&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        When</span> I delete all rows from table_2b2687b9_3425_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_2b2687b9_3425_11ed_b9de_572e856b5561 WHERE id &lt; 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check table_2b2687b9_3425_11ed_b9de_572e856b5561 is empty
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_2b2687b9_3425_11ed_b9de_572e856b5561 WHERE id &lt; 5 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_2b2687b9_3425_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_2b2687b9_3425_11ed_b9de_572e856b5561 WHERE id &lt; 5 ORDER BY id FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_2b2687b9_3425_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_2b2687b9_3425_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<section class="requirement"><span class="requirement-inline"><i class="utf-icon color-ok">✔</i>RQ.SRS-023.ClickHouse.LightweightDelete.VeryLargePart</span></section>

<div class="requirement-description hidden">

<p><a target="_blank" rel="nofollow noopener noreferrer" href="https://clickhouse.yandex">ClickHouse</a> SHALL support <code>DELETE</code> removing rows in a very large part.</p>

</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">1m 36s</span>/lightweight delete/basic checks/many partition mixed parts</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">    </span><span class="kn">Feature</span><span class="nn"> many partition mixed parts</span>
      Check DELETE with a table that has many partition, each with one large part and many small parts.
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete all rows</span>
        Check that DELETE can remove all rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete all rows from half of parts</span>
        Check that DELETE can remove all rows from half of the parts.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete large subset</span>
        Check that DELETE can remove a large subset of rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete one row</span>
        Check that DELETE can remove one row.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete small subset</span>
        Check that DELETE can remove a small subset of rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete zero rows</span>
        Check that DELETE can remove zero rows.
<span class="ro">      OK</span>
<span class="ro">    OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">1m 38s</span>/lightweight delete/basic checks/one partition mixed parts</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">    </span><span class="kn">Feature</span><span class="nn"> one partition mixed parts</span>
      Check DELETE with a table that has one partition, one large part, and many small parts.
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete all rows</span>
        Check that DELETE can remove all rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete all rows from half of parts</span>
        Check that DELETE can remove all rows from half of the parts.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete large subset</span>
        Check that DELETE can remove a large subset of rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete one row</span>
        Check that DELETE can remove one row.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete small subset</span>
        Check that DELETE can remove a small subset of rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete zero rows</span>
        Check that DELETE can remove zero rows.
<span class="ro">      OK</span>
<span class="ro">    OK</span>
</code></pre></div>


</div>

<section class="requirement"><span class="requirement-inline"><i class="utf-icon color-ok">✔</i>RQ.SRS-023.ClickHouse.LightweightDelete.VerySmallPart</span></section>

<div class="requirement-description hidden">

<p><a target="_blank" rel="nofollow noopener noreferrer" href="https://clickhouse.yandex">ClickHouse</a> SHALL support <code>DELETE</code> removing rows in a very small part.</p>

</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">1m 36s</span>/lightweight delete/basic checks/many partition mixed parts</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">    </span><span class="kn">Feature</span><span class="nn"> many partition mixed parts</span>
      Check DELETE with a table that has many partition, each with one large part and many small parts.
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete all rows</span>
        Check that DELETE can remove all rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete all rows from half of parts</span>
        Check that DELETE can remove all rows from half of the parts.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete large subset</span>
        Check that DELETE can remove a large subset of rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete one row</span>
        Check that DELETE can remove one row.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete small subset</span>
        Check that DELETE can remove a small subset of rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete zero rows</span>
        Check that DELETE can remove zero rows.
<span class="ro">      OK</span>
<span class="ro">    OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">1m 38s</span>/lightweight delete/basic checks/one partition mixed parts</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">    </span><span class="kn">Feature</span><span class="nn"> one partition mixed parts</span>
      Check DELETE with a table that has one partition, one large part, and many small parts.
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete all rows</span>
        Check that DELETE can remove all rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete all rows from half of parts</span>
        Check that DELETE can remove all rows from half of the parts.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete large subset</span>
        Check that DELETE can remove a large subset of rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete one row</span>
        Check that DELETE can remove one row.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete small subset</span>
        Check that DELETE can remove a small subset of rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete zero rows</span>
        Check that DELETE can remove zero rows.
<span class="ro">      OK</span>
<span class="ro">    OK</span>
</code></pre></div>


</div>

<section class="requirement"><span class="requirement-inline"><i class="utf-icon color-ok">✔</i>RQ.SRS-023.ClickHouse.LightweightDelete.EncryptedDisk</span></section>

<div class="requirement-description hidden">

<p><a target="_blank" rel="nofollow noopener noreferrer" href="https://clickhouse.yandex">ClickHouse</a> SHALL support <code>DELETE</code> removing rows from table which is stored on encrypted disk.</p>

</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">20s 249ms</span>/lightweight delete/encrypted disk/encrypted disk</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">    </span><span class="kn">Scenario</span><span class="nn"> encrypted disk</span>
      Check that lightweight delete in table that stored on encrypted disk perform correctly.
<span class="k">      Given</span> I create local disk folder on the server
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          mkdir &#39;/disk_local&#39;
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> exitcode should be 0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">      Given</span> I set up parameters
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      Given</span> I add storage configuration that uses encrypted disk
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        By</span> converting config file content to xml
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> adding xml config file to the server
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Given</span> encrypted_disk.xml
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> attempt #0
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> attempt #0
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          When</span> I add the config
            /etc/clickhouse-server/config.d/encrypted_disk.xml
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> config.xml should be updated
            timeout 300
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> I wait for config to be reloaded
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I close terminal to the node to be restarted
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            When</span> I stop ClickHouse to apply the config changes
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">              OK</span><span class="k"></span>
<span class="k">                By</span> executing command
                  ls /tmp/clickhouse-server.pid
<span class="ro">                OK</span><span class="k"></span>
<span class="k">                By</span> executing command
                  cat /tmp/clickhouse-server.pid
<span class="ro">                OK</span><span class="k"></span>
<span class="k">              By</span> checking pid does not exist
<span class="ro">              OK</span>
                Retry try #0
<span class="rf">                Fail</span> try #0, pid still alive
                Retry try #1
<span class="ro">                OK</span><span class="k"></span>
<span class="k">              By</span> deleting ClickHouse server pid file
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            When</span> I get the current log size
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                stat --format=%s /home/antip/job/github/clickhouse-regression/lightweight_delete/_instances/clickhouse1/logs/clickhouse-server.log
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            When</span> I start ClickHouse back up
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                ls /tmp/clickhouse-server.pid
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> starting ClickHouse server process
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> checking that ClickHouse server pid file was created
<span class="ro">              OK</span>
                Retry try #0
<span class="ro">                OK</span><span class="k"></span>
<span class="k">              By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">              OK</span>
                Retry try #0
<span class="rf">                Fail</span> try #0, ClickHouse server is not healthy
                Retry try #1
<span class="ro">                OK</span><span class="k"></span>
<span class="k">            Then</span> I tail the log file from using previous log size as the offset
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> I wait for config reload message in the log file
<span class="ro">            OK</span><span class="k"></span>
<span class="k">      Given</span> I create a table that uses encrypted disk
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;
          CREATE TABLE fbc7dc4f_341c_11ed_b9de_572e856b5561 
          (
              Id Int32,    Value String
          )
          ENGINE = MergeTree()
          ORDER BY Id
          SETTINGS storage_policy = &#39;local_encrypted&#39;&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">      When</span> I insert data into the table
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO fbc7dc4f_341c_11ed_b9de_572e856b5561 VALUES (1, &#39;hello&#39;),(2, &#39;there&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">      Then</span> I delete half of the table and check rows are deletes
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM fbc7dc4f_341c_11ed_b9de_572e856b5561 WHERE Value = &#39;there&#39;&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> I check rows are deleted
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count() FROM fbc7dc4f_341c_11ed_b9de_572e856b5561 WHERE Value = &#39;there&#39;&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">      Then</span> I check that the rest of the rows are not deleted
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM fbc7dc4f_341c_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">      Then</span> I expect all files has ENC header
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        By</span> finding all files inside the encrypted disk
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            for file in `find /disk_local -type f`
            do
            head -1 $file | cut -c 1,2,3
            done
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> checking that they all have encrypted header
<span class="ro">        OK</span><span class="k"></span>
<span class="k">      Finally</span> I clean up
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        Finally</span> I drop the table if exists
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS fbc7dc4f_341c_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I remove encrypted_disk.xml on clickhouse1
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> attempt #0
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> attempt #0
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> removing the config file
            /etc/clickhouse-server/config.d/encrypted_disk.xml
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              rm -rf /etc/clickhouse-server/config.d/encrypted_disk.xml
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Then</span> config.xml should be updated
            timeout 300
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> I wait for config to be reloaded
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I close terminal to the node to be restarted
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            When</span> I stop ClickHouse to apply the config changes
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">              OK</span><span class="k"></span>
<span class="k">                By</span> executing command
                  ls /tmp/clickhouse-server.pid
<span class="ro">                OK</span><span class="k"></span>
<span class="k">                By</span> executing command
                  cat /tmp/clickhouse-server.pid
<span class="ro">                OK</span><span class="k"></span>
<span class="k">              By</span> checking pid does not exist
<span class="ro">              OK</span>
                Retry try #0
<span class="rf">                Fail</span> try #0, pid still alive
                Retry try #1
<span class="ro">                OK</span><span class="k"></span>
<span class="k">              By</span> deleting ClickHouse server pid file
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            When</span> I get the current log size
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                stat --format=%s /home/antip/job/github/clickhouse-regression/lightweight_delete/_instances/clickhouse1/logs/clickhouse-server.log
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            When</span> I start ClickHouse back up
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                ls /tmp/clickhouse-server.pid
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> starting ClickHouse server process
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> checking that ClickHouse server pid file was created
<span class="ro">              OK</span>
                Retry try #0
<span class="ro">                OK</span><span class="k"></span>
<span class="k">              By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">              OK</span>
                Retry try #0
<span class="rf">                Fail</span> try #0, ClickHouse server is not healthy
                Retry try #1
<span class="ro">                OK</span><span class="k"></span>
<span class="k">            Then</span> I tail the log file from using previous log size as the offset
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> I wait for config reload message in the log file
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Finally</span> delete directory
          /disk_local
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            rm -rf &#39;/disk_local&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> exitcode should be 0
<span class="ro">          OK</span>
<span class="ro">    OK</span>
</code></pre></div>


</div>

<section class="requirement"><span class="requirement-inline"><i class="utf-icon color-ok">✔</i>RQ.SRS-023.ClickHouse.LightweightDelete.EventualConsistency</span></section>

<div class="requirement-description hidden">

<p><a target="_blank" rel="nofollow noopener noreferrer" href="https://clickhouse.yandex">ClickHouse</a> <code>DELETE</code> operations SHALL replicate in an eventually consistent manner between replicas.</p>

</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">1m 19s</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedMergeTree/replicated table deleting in loop with overlap entire table</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop with overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table by partitions on different nodes with overlap.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 40d26ce9_340a_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 40d26ce9_340a_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedMergeTree(&#39;/clickhouse/tables/shard0/40d26ce9_340a_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 40d26ce9_340a_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 40d26ce9_340a_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedMergeTree(&#39;/clickhouse/tables/shard0/40d26ce9_340a_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 40d26ce9_340a_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 40d26ce9_340a_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedMergeTree(&#39;/clickhouse/tables/shard0/40d26ce9_340a_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO 40d26ce9_340a_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0,6),(0...&quot; &gt; /tmp/tmpodmf6xvk
                cat &quot;/tmp/tmpodmf6xvk&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 40d26ce9_340a_11ed_b9de_572e856b5561 WHERE NOT(x&lt;50 OR (x&gt;25 AND x&lt;75) OR x&gt;50)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse1
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 40d26ce9_340a_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse2
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 40d26ce9_340a_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse3
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 40d26ce9_340a_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 40d26ce9_340a_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 40d26ce9_340a_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 40d26ce9_340a_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 40d26ce9_340a_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 40d26ce9_340a_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 40d26ce9_340a_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 40d26ce9_340a_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 40d26ce9_340a_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 40d26ce9_340a_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 40d26ce9_340a_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 40d26ce9_340a_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 40d26ce9_340a_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 40d26ce9_340a_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 40d26ce9_340a_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 40d26ce9_340a_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 40d26ce9_340a_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 40d26ce9_340a_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 40d26ce9_340a_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 40d26ce9_340a_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 40d26ce9_340a_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 40d26ce9_340a_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 40d26ce9_340a_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 40d26ce9_340a_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 40d26ce9_340a_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 40d26ce9_340a_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 40d26ce9_340a_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 40d26ce9_340a_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 40d26ce9_340a_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 40d26ce9_340a_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 40d26ce9_340a_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 40d26ce9_340a_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 40d26ce9_340a_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 40d26ce9_340a_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">47s 371ms</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedMergeTree/replicated table deleting in loop with without overlap</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop with without overlap</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting some rows in the table by partitions on different nodes.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 700dfb64_340a_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 700dfb64_340a_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedMergeTree(&#39;/clickhouse/tables/shard0/700dfb64_340a_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 700dfb64_340a_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 700dfb64_340a_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedMergeTree(&#39;/clickhouse/tables/shard0/700dfb64_340a_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 700dfb64_340a_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 700dfb64_340a_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedMergeTree(&#39;/clickhouse/tables/shard0/700dfb64_340a_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO 700dfb64_340a_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0,6),(0...&quot; &gt; /tmp/tmpz0c7hzai
                cat &quot;/tmp/tmpz0c7hzai&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 700dfb64_340a_11ed_b9de_572e856b5561 WHERE NOT((x % 2 == 0 AND id &lt; 50) OR (x % 2 == 0 AND id &lt; 75 AND id &gt; 24))&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Step</span> delete odd rows from clickhouse1 by partitions
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 700dfb64_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          Step</span> delete odd rows from clickhouse2 by partitions
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 700dfb64_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 700dfb64_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 700dfb64_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 700dfb64_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 700dfb64_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 700dfb64_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 700dfb64_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 700dfb64_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 700dfb64_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 700dfb64_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 700dfb64_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 700dfb64_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 700dfb64_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 700dfb64_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 700dfb64_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 700dfb64_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 700dfb64_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 700dfb64_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 700dfb64_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 700dfb64_340a_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 700dfb64_340a_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 700dfb64_340a_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 700dfb64_340a_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 700dfb64_340a_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 700dfb64_340a_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">1m 5s</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedMergeTree/replicated table deleting in loop without overlap entire table</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop without overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table by partitions on different nodes without overlap.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 8b864ebe_340a_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 8b864ebe_340a_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedMergeTree(&#39;/clickhouse/tables/shard0/8b864ebe_340a_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 8b864ebe_340a_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 8b864ebe_340a_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedMergeTree(&#39;/clickhouse/tables/shard0/8b864ebe_340a_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 8b864ebe_340a_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 8b864ebe_340a_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedMergeTree(&#39;/clickhouse/tables/shard0/8b864ebe_340a_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO 8b864ebe_340a_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0,6),(0...&quot; &gt; /tmp/tmp0jwqs7q2
                cat &quot;/tmp/tmp0jwqs7q2&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 8b864ebe_340a_11ed_b9de_572e856b5561 WHERE NOT(x&lt;33 OR (x&gt;32 AND x&lt;68) OR x&gt;67)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse1 by partitions
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8b864ebe_340a_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse2 by partitions
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8b864ebe_340a_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse3 by partitions
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8b864ebe_340a_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8b864ebe_340a_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8b864ebe_340a_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8b864ebe_340a_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8b864ebe_340a_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8b864ebe_340a_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8b864ebe_340a_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8b864ebe_340a_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8b864ebe_340a_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8b864ebe_340a_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8b864ebe_340a_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8b864ebe_340a_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8b864ebe_340a_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8b864ebe_340a_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8b864ebe_340a_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8b864ebe_340a_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8b864ebe_340a_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8b864ebe_340a_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8b864ebe_340a_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8b864ebe_340a_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8b864ebe_340a_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8b864ebe_340a_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8b864ebe_340a_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8b864ebe_340a_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8b864ebe_340a_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8b864ebe_340a_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8b864ebe_340a_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8b864ebe_340a_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 8b864ebe_340a_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 8b864ebe_340a_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 8b864ebe_340a_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 8b864ebe_340a_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 8b864ebe_340a_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 8b864ebe_340a_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">16s 434ms</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedMergeTree/replicated table deleting with overlap entire table</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table on different nodes with overlap.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table b25bd220_340a_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE b25bd220_340a_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedMergeTree(&#39;/clickhouse/tables/shard0/b25bd220_340a_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table b25bd220_340a_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE b25bd220_340a_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedMergeTree(&#39;/clickhouse/tables/shard0/b25bd220_340a_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table b25bd220_340a_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE b25bd220_340a_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedMergeTree(&#39;/clickhouse/tables/shard0/b25bd220_340a_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO b25bd220_340a_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0,6),(0...&quot; &gt; /tmp/tmp9vr1q0vg
                cat &quot;/tmp/tmp9vr1q0vg&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM b25bd220_340a_11ed_b9de_572e856b5561 WHERE NOT(x&lt;50 OR (x&gt;25 AND x&lt;75) OR x&gt;50)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse1
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM b25bd220_340a_11ed_b9de_572e856b5561 WHERE x &lt; 50&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse2
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM b25bd220_340a_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse3
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM b25bd220_340a_11ed_b9de_572e856b5561 WHERE x &gt; 50&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM b25bd220_340a_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM b25bd220_340a_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM b25bd220_340a_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS b25bd220_340a_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS b25bd220_340a_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS b25bd220_340a_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">17s 910ms</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedMergeTree/replicated table deleting with without overlap</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with without overlap</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting some rows in the table on different nodes.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table bceceb48_340a_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE bceceb48_340a_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedMergeTree(&#39;/clickhouse/tables/shard0/bceceb48_340a_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table bceceb48_340a_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE bceceb48_340a_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedMergeTree(&#39;/clickhouse/tables/shard0/bceceb48_340a_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table bceceb48_340a_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE bceceb48_340a_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedMergeTree(&#39;/clickhouse/tables/shard0/bceceb48_340a_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO bceceb48_340a_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0,6),(0...&quot; &gt; /tmp/tmpqg62j6_1
                cat &quot;/tmp/tmpqg62j6_1&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM bceceb48_340a_11ed_b9de_572e856b5561 WHERE NOT((x % 2 == 0 AND id &lt; 50) OR (x % 2 == 0 AND id &lt; 75 AND id &gt; 24))&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Step</span> delete odd rows from clickhouse1
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM bceceb48_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          Step</span> delete odd rows from clickhouse2
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM bceceb48_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM bceceb48_340a_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM bceceb48_340a_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM bceceb48_340a_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS bceceb48_340a_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS bceceb48_340a_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS bceceb48_340a_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">13s 498ms</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedMergeTree/replicated table deleting without overlap entire table</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table on different nodes without overlap.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table c704885a_340a_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE c704885a_340a_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedMergeTree(&#39;/clickhouse/tables/shard0/c704885a_340a_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table c704885a_340a_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE c704885a_340a_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedMergeTree(&#39;/clickhouse/tables/shard0/c704885a_340a_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table c704885a_340a_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE c704885a_340a_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedMergeTree(&#39;/clickhouse/tables/shard0/c704885a_340a_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO c704885a_340a_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0,6),(0...&quot; &gt; /tmp/tmps_in1nrm
                cat &quot;/tmp/tmps_in1nrm&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM c704885a_340a_11ed_b9de_572e856b5561 WHERE NOT(x&lt;33 OR (x&gt;32 AND x&lt;68) OR x&gt;67)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse1
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM c704885a_340a_11ed_b9de_572e856b5561 WHERE x &lt; 33&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse2
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM c704885a_340a_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse3
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM c704885a_340a_11ed_b9de_572e856b5561 WHERE x &gt; 67&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM c704885a_340a_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM c704885a_340a_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM c704885a_340a_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS c704885a_340a_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS c704885a_340a_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS c704885a_340a_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">1m 8s</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedReplacingMergeTree/replicated table deleting in loop with overlap entire table</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop with overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table by partitions on different nodes with overlap.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated replacing merge tree table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table cfa56245_340a_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE cfa56245_340a_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedReplacingMergeTree(&#39;/clickhouse/tables/shard0/cfa56245_340a_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table cfa56245_340a_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE cfa56245_340a_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedReplacingMergeTree(&#39;/clickhouse/tables/shard0/cfa56245_340a_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table cfa56245_340a_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE cfa56245_340a_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedReplacingMergeTree(&#39;/clickhouse/tables/shard0/cfa56245_340a_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO cfa56245_340a_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0,6),(0...&quot; &gt; /tmp/tmp_59hc_3p
                cat &quot;/tmp/tmp_59hc_3p&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM cfa56245_340a_11ed_b9de_572e856b5561 WHERE NOT(x&lt;50 OR (x&gt;25 AND x&lt;75) OR x&gt;50)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse1
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM cfa56245_340a_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse2
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM cfa56245_340a_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse3
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM cfa56245_340a_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM cfa56245_340a_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM cfa56245_340a_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM cfa56245_340a_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM cfa56245_340a_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM cfa56245_340a_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM cfa56245_340a_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM cfa56245_340a_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM cfa56245_340a_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM cfa56245_340a_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM cfa56245_340a_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM cfa56245_340a_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM cfa56245_340a_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM cfa56245_340a_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM cfa56245_340a_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM cfa56245_340a_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM cfa56245_340a_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM cfa56245_340a_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM cfa56245_340a_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM cfa56245_340a_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM cfa56245_340a_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM cfa56245_340a_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM cfa56245_340a_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM cfa56245_340a_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM cfa56245_340a_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM cfa56245_340a_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM cfa56245_340a_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM cfa56245_340a_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM cfa56245_340a_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM cfa56245_340a_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM cfa56245_340a_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS cfa56245_340a_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS cfa56245_340a_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS cfa56245_340a_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">55s 940ms</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedReplacingMergeTree/replicated table deleting in loop with without overlap</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop with without overlap</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting some rows in the table by partitions on different nodes.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated replacing merge tree table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table f80906ed_340a_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE f80906ed_340a_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedReplacingMergeTree(&#39;/clickhouse/tables/shard0/f80906ed_340a_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table f80906ed_340a_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE f80906ed_340a_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedReplacingMergeTree(&#39;/clickhouse/tables/shard0/f80906ed_340a_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table f80906ed_340a_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE f80906ed_340a_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedReplacingMergeTree(&#39;/clickhouse/tables/shard0/f80906ed_340a_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO f80906ed_340a_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0,6),(0...&quot; &gt; /tmp/tmpwxyafav1
                cat &quot;/tmp/tmpwxyafav1&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM f80906ed_340a_11ed_b9de_572e856b5561 WHERE NOT((x % 2 == 0 AND id &lt; 50) OR (x % 2 == 0 AND id &lt; 75 AND id &gt; 24))&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Step</span> delete odd rows from clickhouse1 by partitions
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM f80906ed_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          Step</span> delete odd rows from clickhouse2 by partitions
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM f80906ed_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM f80906ed_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM f80906ed_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM f80906ed_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM f80906ed_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM f80906ed_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM f80906ed_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM f80906ed_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM f80906ed_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM f80906ed_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM f80906ed_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM f80906ed_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM f80906ed_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM f80906ed_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM f80906ed_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM f80906ed_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM f80906ed_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM f80906ed_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM f80906ed_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM f80906ed_340a_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM f80906ed_340a_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM f80906ed_340a_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS f80906ed_340a_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS f80906ed_340a_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS f80906ed_340a_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">1m 5s</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedReplacingMergeTree/replicated table deleting in loop without overlap entire table</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop without overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table by partitions on different nodes without overlap.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated replacing merge tree table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 19e9b13c_340b_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 19e9b13c_340b_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedReplacingMergeTree(&#39;/clickhouse/tables/shard0/19e9b13c_340b_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 19e9b13c_340b_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 19e9b13c_340b_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedReplacingMergeTree(&#39;/clickhouse/tables/shard0/19e9b13c_340b_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 19e9b13c_340b_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 19e9b13c_340b_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedReplacingMergeTree(&#39;/clickhouse/tables/shard0/19e9b13c_340b_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO 19e9b13c_340b_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0,6),(0...&quot; &gt; /tmp/tmpbk9r0hqz
                cat &quot;/tmp/tmpbk9r0hqz&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 19e9b13c_340b_11ed_b9de_572e856b5561 WHERE NOT(x&lt;33 OR (x&gt;32 AND x&lt;68) OR x&gt;67)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse1 by partitions
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 19e9b13c_340b_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse2 by partitions
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 19e9b13c_340b_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse3 by partitions
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 19e9b13c_340b_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 19e9b13c_340b_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 19e9b13c_340b_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 19e9b13c_340b_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 19e9b13c_340b_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 19e9b13c_340b_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 19e9b13c_340b_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 19e9b13c_340b_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 19e9b13c_340b_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 19e9b13c_340b_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 19e9b13c_340b_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 19e9b13c_340b_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 19e9b13c_340b_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 19e9b13c_340b_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 19e9b13c_340b_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 19e9b13c_340b_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 19e9b13c_340b_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 19e9b13c_340b_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 19e9b13c_340b_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 19e9b13c_340b_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 19e9b13c_340b_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 19e9b13c_340b_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 19e9b13c_340b_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 19e9b13c_340b_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 19e9b13c_340b_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 19e9b13c_340b_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 19e9b13c_340b_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 19e9b13c_340b_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 19e9b13c_340b_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 19e9b13c_340b_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 19e9b13c_340b_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 19e9b13c_340b_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 19e9b13c_340b_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 19e9b13c_340b_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">15s 154ms</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedReplacingMergeTree/replicated table deleting with overlap entire table</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table on different nodes with overlap.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated replacing merge tree table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 400f5ccc_340b_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 400f5ccc_340b_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedReplacingMergeTree(&#39;/clickhouse/tables/shard0/400f5ccc_340b_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 400f5ccc_340b_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 400f5ccc_340b_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedReplacingMergeTree(&#39;/clickhouse/tables/shard0/400f5ccc_340b_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 400f5ccc_340b_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 400f5ccc_340b_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedReplacingMergeTree(&#39;/clickhouse/tables/shard0/400f5ccc_340b_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO 400f5ccc_340b_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0,6),(0...&quot; &gt; /tmp/tmp1c5n66zm
                cat &quot;/tmp/tmp1c5n66zm&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 400f5ccc_340b_11ed_b9de_572e856b5561 WHERE NOT(x&lt;50 OR (x&gt;25 AND x&lt;75) OR x&gt;50)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse1
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 400f5ccc_340b_11ed_b9de_572e856b5561 WHERE x &lt; 50&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse2
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 400f5ccc_340b_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse3
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 400f5ccc_340b_11ed_b9de_572e856b5561 WHERE x &gt; 50&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 400f5ccc_340b_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 400f5ccc_340b_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 400f5ccc_340b_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 400f5ccc_340b_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 400f5ccc_340b_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 400f5ccc_340b_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">20s 288ms</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedReplacingMergeTree/replicated table deleting with without overlap</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with without overlap</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting some rows in the table on different nodes.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated replacing merge tree table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 49457a06_340b_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 49457a06_340b_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedReplacingMergeTree(&#39;/clickhouse/tables/shard0/49457a06_340b_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 49457a06_340b_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 49457a06_340b_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedReplacingMergeTree(&#39;/clickhouse/tables/shard0/49457a06_340b_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 49457a06_340b_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 49457a06_340b_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedReplacingMergeTree(&#39;/clickhouse/tables/shard0/49457a06_340b_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO 49457a06_340b_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0,6),(0...&quot; &gt; /tmp/tmpeom2fk6b
                cat &quot;/tmp/tmpeom2fk6b&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 49457a06_340b_11ed_b9de_572e856b5561 WHERE NOT((x % 2 == 0 AND id &lt; 50) OR (x % 2 == 0 AND id &lt; 75 AND id &gt; 24))&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Step</span> delete odd rows from clickhouse1
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 49457a06_340b_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          Step</span> delete odd rows from clickhouse2
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 49457a06_340b_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 49457a06_340b_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 49457a06_340b_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 49457a06_340b_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 49457a06_340b_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 49457a06_340b_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 49457a06_340b_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">15s 324ms</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedReplacingMergeTree/replicated table deleting without overlap entire table</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table on different nodes without overlap.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated replacing merge tree table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 5548148a_340b_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 5548148a_340b_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedReplacingMergeTree(&#39;/clickhouse/tables/shard0/5548148a_340b_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 5548148a_340b_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 5548148a_340b_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedReplacingMergeTree(&#39;/clickhouse/tables/shard0/5548148a_340b_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 5548148a_340b_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 5548148a_340b_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedReplacingMergeTree(&#39;/clickhouse/tables/shard0/5548148a_340b_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO 5548148a_340b_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0,6),(0...&quot; &gt; /tmp/tmp3gik1msi
                cat &quot;/tmp/tmp3gik1msi&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 5548148a_340b_11ed_b9de_572e856b5561 WHERE NOT(x&lt;33 OR (x&gt;32 AND x&lt;68) OR x&gt;67)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse1
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 5548148a_340b_11ed_b9de_572e856b5561 WHERE x &lt; 33&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse2
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 5548148a_340b_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse3
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 5548148a_340b_11ed_b9de_572e856b5561 WHERE x &gt; 67&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 5548148a_340b_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 5548148a_340b_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 5548148a_340b_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 5548148a_340b_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 5548148a_340b_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 5548148a_340b_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">1m 0s</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedSummingMergeTree/replicated table deleting in loop with overlap entire table</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop with overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table by partitions on different nodes with overlap.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated summing merge tree table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 5f17e803_340b_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 5f17e803_340b_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedSummingMergeTree(&#39;/clickhouse/tables/shard0/5f17e803_340b_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;, x) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 5f17e803_340b_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 5f17e803_340b_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedSummingMergeTree(&#39;/clickhouse/tables/shard0/5f17e803_340b_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;, x) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 5f17e803_340b_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 5f17e803_340b_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedSummingMergeTree(&#39;/clickhouse/tables/shard0/5f17e803_340b_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;, x) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO 5f17e803_340b_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0,6),(0...&quot; &gt; /tmp/tmpnflbjhp2
                cat &quot;/tmp/tmpnflbjhp2&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 5f17e803_340b_11ed_b9de_572e856b5561 WHERE NOT(x&lt;50 OR (x&gt;25 AND x&lt;75) OR x&gt;50)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse1
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 5f17e803_340b_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse2
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 5f17e803_340b_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse3
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 5f17e803_340b_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 5f17e803_340b_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 5f17e803_340b_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 5f17e803_340b_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 5f17e803_340b_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 5f17e803_340b_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 5f17e803_340b_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 5f17e803_340b_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 5f17e803_340b_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 5f17e803_340b_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 5f17e803_340b_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 5f17e803_340b_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 5f17e803_340b_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 5f17e803_340b_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 5f17e803_340b_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 5f17e803_340b_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 5f17e803_340b_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 5f17e803_340b_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 5f17e803_340b_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 5f17e803_340b_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 5f17e803_340b_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 5f17e803_340b_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 5f17e803_340b_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 5f17e803_340b_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 5f17e803_340b_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 5f17e803_340b_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 5f17e803_340b_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 5f17e803_340b_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 5f17e803_340b_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 5f17e803_340b_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 5f17e803_340b_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 5f17e803_340b_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 5f17e803_340b_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 5f17e803_340b_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">50s 680ms</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedSummingMergeTree/replicated table deleting in loop with without overlap</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop with without overlap</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting some rows in the table by partitions on different nodes.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated summing merge tree table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 835facac_340b_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 835facac_340b_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedSummingMergeTree(&#39;/clickhouse/tables/shard0/835facac_340b_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;, x) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 835facac_340b_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 835facac_340b_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedSummingMergeTree(&#39;/clickhouse/tables/shard0/835facac_340b_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;, x) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 835facac_340b_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 835facac_340b_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedSummingMergeTree(&#39;/clickhouse/tables/shard0/835facac_340b_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;, x) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO 835facac_340b_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0,6),(0...&quot; &gt; /tmp/tmpbgc1ebh8
                cat &quot;/tmp/tmpbgc1ebh8&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 835facac_340b_11ed_b9de_572e856b5561 WHERE NOT((x % 2 == 0 AND id &lt; 50) OR (x % 2 == 0 AND id &lt; 75 AND id &gt; 24))&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Step</span> delete odd rows from clickhouse1 by partitions
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 835facac_340b_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          Step</span> delete odd rows from clickhouse2 by partitions
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 835facac_340b_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 835facac_340b_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 835facac_340b_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 835facac_340b_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 835facac_340b_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 835facac_340b_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 835facac_340b_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 835facac_340b_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 835facac_340b_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 835facac_340b_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 835facac_340b_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 835facac_340b_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 835facac_340b_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 835facac_340b_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 835facac_340b_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 835facac_340b_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 835facac_340b_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 835facac_340b_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 835facac_340b_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 835facac_340b_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 835facac_340b_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 835facac_340b_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 835facac_340b_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 835facac_340b_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 835facac_340b_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">1m 4s</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedSummingMergeTree/replicated table deleting in loop without overlap entire table</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop without overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table by partitions on different nodes without overlap.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated summing merge tree table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table a0cc6050_340b_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE a0cc6050_340b_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedSummingMergeTree(&#39;/clickhouse/tables/shard0/a0cc6050_340b_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;, x) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table a0cc6050_340b_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE a0cc6050_340b_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedSummingMergeTree(&#39;/clickhouse/tables/shard0/a0cc6050_340b_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;, x) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table a0cc6050_340b_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE a0cc6050_340b_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedSummingMergeTree(&#39;/clickhouse/tables/shard0/a0cc6050_340b_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;, x) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO a0cc6050_340b_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0,6),(0...&quot; &gt; /tmp/tmpg1u4mxsl
                cat &quot;/tmp/tmpg1u4mxsl&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM a0cc6050_340b_11ed_b9de_572e856b5561 WHERE NOT(x&lt;33 OR (x&gt;32 AND x&lt;68) OR x&gt;67)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse1 by partitions
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc6050_340b_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse2 by partitions
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc6050_340b_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse3 by partitions
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc6050_340b_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc6050_340b_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc6050_340b_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc6050_340b_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc6050_340b_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc6050_340b_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc6050_340b_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc6050_340b_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc6050_340b_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc6050_340b_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc6050_340b_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc6050_340b_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc6050_340b_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc6050_340b_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc6050_340b_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc6050_340b_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc6050_340b_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc6050_340b_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc6050_340b_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc6050_340b_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc6050_340b_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc6050_340b_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc6050_340b_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc6050_340b_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc6050_340b_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc6050_340b_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc6050_340b_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc6050_340b_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM a0cc6050_340b_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM a0cc6050_340b_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM a0cc6050_340b_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS a0cc6050_340b_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS a0cc6050_340b_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS a0cc6050_340b_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">15s 849ms</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedSummingMergeTree/replicated table deleting with overlap entire table</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table on different nodes with overlap.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated summing merge tree table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table c83b1ef6_340b_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE c83b1ef6_340b_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedSummingMergeTree(&#39;/clickhouse/tables/shard0/c83b1ef6_340b_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;, x) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table c83b1ef6_340b_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE c83b1ef6_340b_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedSummingMergeTree(&#39;/clickhouse/tables/shard0/c83b1ef6_340b_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;, x) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table c83b1ef6_340b_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE c83b1ef6_340b_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedSummingMergeTree(&#39;/clickhouse/tables/shard0/c83b1ef6_340b_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;, x) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO c83b1ef6_340b_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0,6),(0...&quot; &gt; /tmp/tmp9e2u69ja
                cat &quot;/tmp/tmp9e2u69ja&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM c83b1ef6_340b_11ed_b9de_572e856b5561 WHERE NOT(x&lt;50 OR (x&gt;25 AND x&lt;75) OR x&gt;50)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse1
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM c83b1ef6_340b_11ed_b9de_572e856b5561 WHERE x &lt; 50&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse2
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM c83b1ef6_340b_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse3
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM c83b1ef6_340b_11ed_b9de_572e856b5561 WHERE x &gt; 50&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM c83b1ef6_340b_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM c83b1ef6_340b_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM c83b1ef6_340b_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS c83b1ef6_340b_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS c83b1ef6_340b_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS c83b1ef6_340b_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">16s 791ms</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedSummingMergeTree/replicated table deleting with without overlap</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with without overlap</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting some rows in the table on different nodes.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated summing merge tree table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table d0fffff2_340b_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE d0fffff2_340b_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedSummingMergeTree(&#39;/clickhouse/tables/shard0/d0fffff2_340b_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;, x) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table d0fffff2_340b_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE d0fffff2_340b_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedSummingMergeTree(&#39;/clickhouse/tables/shard0/d0fffff2_340b_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;, x) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table d0fffff2_340b_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE d0fffff2_340b_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedSummingMergeTree(&#39;/clickhouse/tables/shard0/d0fffff2_340b_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;, x) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO d0fffff2_340b_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0,6),(0...&quot; &gt; /tmp/tmpzry1t9gb
                cat &quot;/tmp/tmpzry1t9gb&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM d0fffff2_340b_11ed_b9de_572e856b5561 WHERE NOT((x % 2 == 0 AND id &lt; 50) OR (x % 2 == 0 AND id &lt; 75 AND id &gt; 24))&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Step</span> delete odd rows from clickhouse1
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM d0fffff2_340b_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          Step</span> delete odd rows from clickhouse2
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM d0fffff2_340b_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM d0fffff2_340b_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM d0fffff2_340b_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM d0fffff2_340b_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS d0fffff2_340b_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS d0fffff2_340b_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS d0fffff2_340b_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">11s 580ms</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedSummingMergeTree/replicated table deleting without overlap entire table</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table on different nodes without overlap.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated summing merge tree table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table dbafbf3c_340b_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE dbafbf3c_340b_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedSummingMergeTree(&#39;/clickhouse/tables/shard0/dbafbf3c_340b_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;, x) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table dbafbf3c_340b_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE dbafbf3c_340b_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedSummingMergeTree(&#39;/clickhouse/tables/shard0/dbafbf3c_340b_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;, x) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table dbafbf3c_340b_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE dbafbf3c_340b_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedSummingMergeTree(&#39;/clickhouse/tables/shard0/dbafbf3c_340b_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;, x) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO dbafbf3c_340b_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0,6),(0...&quot; &gt; /tmp/tmpb00ji3x4
                cat &quot;/tmp/tmpb00ji3x4&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM dbafbf3c_340b_11ed_b9de_572e856b5561 WHERE NOT(x&lt;33 OR (x&gt;32 AND x&lt;68) OR x&gt;67)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse1
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM dbafbf3c_340b_11ed_b9de_572e856b5561 WHERE x &lt; 33&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse2
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM dbafbf3c_340b_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse3
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM dbafbf3c_340b_11ed_b9de_572e856b5561 WHERE x &gt; 67&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM dbafbf3c_340b_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM dbafbf3c_340b_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM dbafbf3c_340b_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS dbafbf3c_340b_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS dbafbf3c_340b_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS dbafbf3c_340b_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">1m 30s</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedAggregatingMergeTree/replicated table deleting in loop with overlap entire table</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop with overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table by partitions on different nodes with overlap.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated aggregating merge tree table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table e2208d12_340b_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE e2208d12_340b_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedAggregatingMergeTree(&#39;/clickhouse/tables/shard0/e2208d12_340b_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table e2208d12_340b_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE e2208d12_340b_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedAggregatingMergeTree(&#39;/clickhouse/tables/shard0/e2208d12_340b_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table e2208d12_340b_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE e2208d12_340b_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedAggregatingMergeTree(&#39;/clickhouse/tables/shard0/e2208d12_340b_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO e2208d12_340b_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0,6),(0...&quot; &gt; /tmp/tmpxqy2_65q
                cat &quot;/tmp/tmpxqy2_65q&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM e2208d12_340b_11ed_b9de_572e856b5561 WHERE NOT(x&lt;50 OR (x&gt;25 AND x&lt;75) OR x&gt;50)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse1
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM e2208d12_340b_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse2
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM e2208d12_340b_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse3
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM e2208d12_340b_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM e2208d12_340b_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM e2208d12_340b_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM e2208d12_340b_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM e2208d12_340b_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM e2208d12_340b_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM e2208d12_340b_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM e2208d12_340b_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM e2208d12_340b_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM e2208d12_340b_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM e2208d12_340b_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM e2208d12_340b_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM e2208d12_340b_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM e2208d12_340b_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM e2208d12_340b_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM e2208d12_340b_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM e2208d12_340b_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM e2208d12_340b_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM e2208d12_340b_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM e2208d12_340b_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM e2208d12_340b_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM e2208d12_340b_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM e2208d12_340b_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM e2208d12_340b_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM e2208d12_340b_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM e2208d12_340b_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM e2208d12_340b_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM e2208d12_340b_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM e2208d12_340b_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM e2208d12_340b_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM e2208d12_340b_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS e2208d12_340b_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS e2208d12_340b_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS e2208d12_340b_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">58s 282ms</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedAggregatingMergeTree/replicated table deleting in loop with without overlap</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop with without overlap</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting some rows in the table by partitions on different nodes.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated aggregating merge tree table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 187f3e56_340c_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 187f3e56_340c_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedAggregatingMergeTree(&#39;/clickhouse/tables/shard0/187f3e56_340c_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 187f3e56_340c_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 187f3e56_340c_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedAggregatingMergeTree(&#39;/clickhouse/tables/shard0/187f3e56_340c_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 187f3e56_340c_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 187f3e56_340c_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedAggregatingMergeTree(&#39;/clickhouse/tables/shard0/187f3e56_340c_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO 187f3e56_340c_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0,6),(0...&quot; &gt; /tmp/tmpod4c1nl8
                cat &quot;/tmp/tmpod4c1nl8&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 187f3e56_340c_11ed_b9de_572e856b5561 WHERE NOT((x % 2 == 0 AND id &lt; 50) OR (x % 2 == 0 AND id &lt; 75 AND id &gt; 24))&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Step</span> delete odd rows from clickhouse1 by partitions
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 187f3e56_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          Step</span> delete odd rows from clickhouse2 by partitions
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 187f3e56_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 187f3e56_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 187f3e56_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 187f3e56_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 187f3e56_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 187f3e56_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 187f3e56_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 187f3e56_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 187f3e56_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 187f3e56_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 187f3e56_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 187f3e56_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 187f3e56_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 187f3e56_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 187f3e56_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 187f3e56_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 187f3e56_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 187f3e56_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 187f3e56_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 187f3e56_340c_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 187f3e56_340c_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 187f3e56_340c_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 187f3e56_340c_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 187f3e56_340c_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 187f3e56_340c_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">1m 0s</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedAggregatingMergeTree/replicated table deleting in loop without overlap entire table</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop without overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table by partitions on different nodes without overlap.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated aggregating merge tree table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 3a6cc0e2_340c_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 3a6cc0e2_340c_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedAggregatingMergeTree(&#39;/clickhouse/tables/shard0/3a6cc0e2_340c_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 3a6cc0e2_340c_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 3a6cc0e2_340c_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedAggregatingMergeTree(&#39;/clickhouse/tables/shard0/3a6cc0e2_340c_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 3a6cc0e2_340c_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 3a6cc0e2_340c_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedAggregatingMergeTree(&#39;/clickhouse/tables/shard0/3a6cc0e2_340c_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO 3a6cc0e2_340c_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0,6),(0...&quot; &gt; /tmp/tmp9xms0lz7
                cat &quot;/tmp/tmp9xms0lz7&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 3a6cc0e2_340c_11ed_b9de_572e856b5561 WHERE NOT(x&lt;33 OR (x&gt;32 AND x&lt;68) OR x&gt;67)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse1 by partitions
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 3a6cc0e2_340c_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse2 by partitions
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 3a6cc0e2_340c_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse3 by partitions
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 3a6cc0e2_340c_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 3a6cc0e2_340c_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 3a6cc0e2_340c_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 3a6cc0e2_340c_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 3a6cc0e2_340c_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 3a6cc0e2_340c_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 3a6cc0e2_340c_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 3a6cc0e2_340c_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 3a6cc0e2_340c_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 3a6cc0e2_340c_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 3a6cc0e2_340c_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 3a6cc0e2_340c_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 3a6cc0e2_340c_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 3a6cc0e2_340c_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 3a6cc0e2_340c_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 3a6cc0e2_340c_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 3a6cc0e2_340c_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 3a6cc0e2_340c_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 3a6cc0e2_340c_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 3a6cc0e2_340c_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 3a6cc0e2_340c_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 3a6cc0e2_340c_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 3a6cc0e2_340c_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 3a6cc0e2_340c_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 3a6cc0e2_340c_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 3a6cc0e2_340c_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 3a6cc0e2_340c_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 3a6cc0e2_340c_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 3a6cc0e2_340c_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 3a6cc0e2_340c_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 3a6cc0e2_340c_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 3a6cc0e2_340c_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 3a6cc0e2_340c_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 3a6cc0e2_340c_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">18s 237ms</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedAggregatingMergeTree/replicated table deleting with overlap entire table</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table on different nodes with overlap.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated aggregating merge tree table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 5e3c963c_340c_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 5e3c963c_340c_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedAggregatingMergeTree(&#39;/clickhouse/tables/shard0/5e3c963c_340c_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 5e3c963c_340c_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 5e3c963c_340c_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedAggregatingMergeTree(&#39;/clickhouse/tables/shard0/5e3c963c_340c_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 5e3c963c_340c_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 5e3c963c_340c_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedAggregatingMergeTree(&#39;/clickhouse/tables/shard0/5e3c963c_340c_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO 5e3c963c_340c_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0,6),(0...&quot; &gt; /tmp/tmpm3l4nq03
                cat &quot;/tmp/tmpm3l4nq03&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 5e3c963c_340c_11ed_b9de_572e856b5561 WHERE NOT(x&lt;50 OR (x&gt;25 AND x&lt;75) OR x&gt;50)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse1
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 5e3c963c_340c_11ed_b9de_572e856b5561 WHERE x &lt; 50&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse2
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 5e3c963c_340c_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse3
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 5e3c963c_340c_11ed_b9de_572e856b5561 WHERE x &gt; 50&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 5e3c963c_340c_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 5e3c963c_340c_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 5e3c963c_340c_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 5e3c963c_340c_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 5e3c963c_340c_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 5e3c963c_340c_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">12s 375ms</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedAggregatingMergeTree/replicated table deleting with without overlap</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with without overlap</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting some rows in the table on different nodes.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated aggregating merge tree table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 6923f270_340c_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 6923f270_340c_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedAggregatingMergeTree(&#39;/clickhouse/tables/shard0/6923f270_340c_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 6923f270_340c_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 6923f270_340c_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedAggregatingMergeTree(&#39;/clickhouse/tables/shard0/6923f270_340c_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 6923f270_340c_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 6923f270_340c_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedAggregatingMergeTree(&#39;/clickhouse/tables/shard0/6923f270_340c_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO 6923f270_340c_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0,6),(0...&quot; &gt; /tmp/tmpq7vnwe_t
                cat &quot;/tmp/tmpq7vnwe_t&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 6923f270_340c_11ed_b9de_572e856b5561 WHERE NOT((x % 2 == 0 AND id &lt; 50) OR (x % 2 == 0 AND id &lt; 75 AND id &gt; 24))&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Step</span> delete odd rows from clickhouse1
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 6923f270_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          Step</span> delete odd rows from clickhouse2
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 6923f270_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 6923f270_340c_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 6923f270_340c_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 6923f270_340c_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 6923f270_340c_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 6923f270_340c_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 6923f270_340c_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">13s 218ms</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedAggregatingMergeTree/replicated table deleting without overlap entire table</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table on different nodes without overlap.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated aggregating merge tree table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 70a0e058_340c_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 70a0e058_340c_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedAggregatingMergeTree(&#39;/clickhouse/tables/shard0/70a0e058_340c_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 70a0e058_340c_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 70a0e058_340c_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedAggregatingMergeTree(&#39;/clickhouse/tables/shard0/70a0e058_340c_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 70a0e058_340c_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 70a0e058_340c_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedAggregatingMergeTree(&#39;/clickhouse/tables/shard0/70a0e058_340c_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO 70a0e058_340c_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0,6),(0...&quot; &gt; /tmp/tmpkj2niu60
                cat &quot;/tmp/tmpkj2niu60&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 70a0e058_340c_11ed_b9de_572e856b5561 WHERE NOT(x&lt;33 OR (x&gt;32 AND x&lt;68) OR x&gt;67)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse1
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 70a0e058_340c_11ed_b9de_572e856b5561 WHERE x &lt; 33&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse2
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 70a0e058_340c_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse3
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 70a0e058_340c_11ed_b9de_572e856b5561 WHERE x &gt; 67&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 70a0e058_340c_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 70a0e058_340c_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 70a0e058_340c_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 70a0e058_340c_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 70a0e058_340c_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 70a0e058_340c_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">1m 6s</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedCollapsingMergeTree/replicated table deleting in loop with overlap entire table</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop with overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table by partitions on different nodes with overlap.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated collapsing merge tree table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 7856dfe9_340c_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 7856dfe9_340c_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = ReplicatedCollapsingMergeTree(&#39;/clickhouse/tables/shard0/7856dfe9_340c_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;, Sign) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 7856dfe9_340c_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 7856dfe9_340c_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = ReplicatedCollapsingMergeTree(&#39;/clickhouse/tables/shard0/7856dfe9_340c_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;, Sign) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 7856dfe9_340c_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 7856dfe9_340c_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = ReplicatedCollapsingMergeTree(&#39;/clickhouse/tables/shard0/7856dfe9_340c_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;, Sign) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO 7856dfe9_340c_11ed_b9de_572e856b5561 VALUES (0,0,1),(0,1,1),(0,2,1),(0,3,1),(0,4,1),(0,5...&quot; &gt; /tmp/tmpuzw_r0d1
                cat &quot;/tmp/tmpuzw_r0d1&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 7856dfe9_340c_11ed_b9de_572e856b5561 WHERE NOT(x&lt;50 OR (x&gt;25 AND x&lt;75) OR x&gt;50)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse1
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 7856dfe9_340c_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse2
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 7856dfe9_340c_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse3
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 7856dfe9_340c_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 7856dfe9_340c_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 7856dfe9_340c_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 7856dfe9_340c_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 7856dfe9_340c_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 7856dfe9_340c_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 7856dfe9_340c_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 7856dfe9_340c_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 7856dfe9_340c_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 7856dfe9_340c_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 7856dfe9_340c_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 7856dfe9_340c_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 7856dfe9_340c_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 7856dfe9_340c_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 7856dfe9_340c_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 7856dfe9_340c_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 7856dfe9_340c_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 7856dfe9_340c_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 7856dfe9_340c_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 7856dfe9_340c_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 7856dfe9_340c_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 7856dfe9_340c_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 7856dfe9_340c_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 7856dfe9_340c_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 7856dfe9_340c_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 7856dfe9_340c_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 7856dfe9_340c_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 7856dfe9_340c_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 7856dfe9_340c_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 7856dfe9_340c_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 7856dfe9_340c_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 7856dfe9_340c_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 7856dfe9_340c_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 7856dfe9_340c_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">1m 0s</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedCollapsingMergeTree/replicated table deleting in loop with without overlap</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop with without overlap</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting some rows in the table by partitions on different nodes.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated collapsing merge tree table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table a0cc3818_340c_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE a0cc3818_340c_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = ReplicatedCollapsingMergeTree(&#39;/clickhouse/tables/shard0/a0cc3818_340c_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;, Sign) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table a0cc3818_340c_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE a0cc3818_340c_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = ReplicatedCollapsingMergeTree(&#39;/clickhouse/tables/shard0/a0cc3818_340c_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;, Sign) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table a0cc3818_340c_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE a0cc3818_340c_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = ReplicatedCollapsingMergeTree(&#39;/clickhouse/tables/shard0/a0cc3818_340c_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;, Sign) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO a0cc3818_340c_11ed_b9de_572e856b5561 VALUES (0,0,1),(0,1,1),(0,2,1),(0,3,1),(0,4,1),(0,5...&quot; &gt; /tmp/tmpw6hto9ef
                cat &quot;/tmp/tmpw6hto9ef&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM a0cc3818_340c_11ed_b9de_572e856b5561 WHERE NOT((x % 2 == 0 AND id &lt; 50) OR (x % 2 == 0 AND id &lt; 75 AND id &gt; 24))&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Step</span> delete odd rows from clickhouse1 by partitions
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc3818_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          Step</span> delete odd rows from clickhouse2 by partitions
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc3818_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc3818_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc3818_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc3818_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc3818_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc3818_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc3818_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc3818_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc3818_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc3818_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc3818_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc3818_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc3818_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc3818_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc3818_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc3818_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc3818_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc3818_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc3818_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM a0cc3818_340c_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM a0cc3818_340c_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM a0cc3818_340c_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS a0cc3818_340c_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS a0cc3818_340c_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS a0cc3818_340c_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">55s 987ms</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedCollapsingMergeTree/replicated table deleting in loop without overlap entire table</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop without overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table by partitions on different nodes without overlap.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated collapsing merge tree table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table c46539f9_340c_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE c46539f9_340c_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = ReplicatedCollapsingMergeTree(&#39;/clickhouse/tables/shard0/c46539f9_340c_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;, Sign) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table c46539f9_340c_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE c46539f9_340c_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = ReplicatedCollapsingMergeTree(&#39;/clickhouse/tables/shard0/c46539f9_340c_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;, Sign) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table c46539f9_340c_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE c46539f9_340c_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = ReplicatedCollapsingMergeTree(&#39;/clickhouse/tables/shard0/c46539f9_340c_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;, Sign) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO c46539f9_340c_11ed_b9de_572e856b5561 VALUES (0,0,1),(0,1,1),(0,2,1),(0,3,1),(0,4,1),(0,5...&quot; &gt; /tmp/tmpctzve_du
                cat &quot;/tmp/tmpctzve_du&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM c46539f9_340c_11ed_b9de_572e856b5561 WHERE NOT(x&lt;33 OR (x&gt;32 AND x&lt;68) OR x&gt;67)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse1 by partitions
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM c46539f9_340c_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse2 by partitions
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM c46539f9_340c_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse3 by partitions
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM c46539f9_340c_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM c46539f9_340c_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM c46539f9_340c_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM c46539f9_340c_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM c46539f9_340c_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM c46539f9_340c_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM c46539f9_340c_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM c46539f9_340c_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM c46539f9_340c_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM c46539f9_340c_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM c46539f9_340c_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM c46539f9_340c_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM c46539f9_340c_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM c46539f9_340c_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM c46539f9_340c_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM c46539f9_340c_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM c46539f9_340c_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM c46539f9_340c_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM c46539f9_340c_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM c46539f9_340c_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM c46539f9_340c_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM c46539f9_340c_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM c46539f9_340c_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM c46539f9_340c_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM c46539f9_340c_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM c46539f9_340c_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM c46539f9_340c_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM c46539f9_340c_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM c46539f9_340c_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM c46539f9_340c_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM c46539f9_340c_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS c46539f9_340c_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS c46539f9_340c_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS c46539f9_340c_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">17s 259ms</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedCollapsingMergeTree/replicated table deleting with overlap entire table</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table on different nodes with overlap.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated collapsing merge tree table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table e6265182_340c_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE e6265182_340c_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = ReplicatedCollapsingMergeTree(&#39;/clickhouse/tables/shard0/e6265182_340c_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;, Sign) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table e6265182_340c_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE e6265182_340c_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = ReplicatedCollapsingMergeTree(&#39;/clickhouse/tables/shard0/e6265182_340c_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;, Sign) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table e6265182_340c_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE e6265182_340c_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = ReplicatedCollapsingMergeTree(&#39;/clickhouse/tables/shard0/e6265182_340c_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;, Sign) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO e6265182_340c_11ed_b9de_572e856b5561 VALUES (0,0,1),(0,1,1),(0,2,1),(0,3,1),(0,4,1),(0,5...&quot; &gt; /tmp/tmp5tu21cd5
                cat &quot;/tmp/tmp5tu21cd5&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM e6265182_340c_11ed_b9de_572e856b5561 WHERE NOT(x&lt;50 OR (x&gt;25 AND x&lt;75) OR x&gt;50)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse1
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM e6265182_340c_11ed_b9de_572e856b5561 WHERE x &lt; 50&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse2
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM e6265182_340c_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse3
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM e6265182_340c_11ed_b9de_572e856b5561 WHERE x &gt; 50&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM e6265182_340c_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM e6265182_340c_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM e6265182_340c_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS e6265182_340c_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS e6265182_340c_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS e6265182_340c_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">14s 199ms</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedCollapsingMergeTree/replicated table deleting with without overlap</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with without overlap</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting some rows in the table on different nodes.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated collapsing merge tree table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table efaa730a_340c_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE efaa730a_340c_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = ReplicatedCollapsingMergeTree(&#39;/clickhouse/tables/shard0/efaa730a_340c_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;, Sign) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table efaa730a_340c_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE efaa730a_340c_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = ReplicatedCollapsingMergeTree(&#39;/clickhouse/tables/shard0/efaa730a_340c_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;, Sign) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table efaa730a_340c_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE efaa730a_340c_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = ReplicatedCollapsingMergeTree(&#39;/clickhouse/tables/shard0/efaa730a_340c_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;, Sign) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO efaa730a_340c_11ed_b9de_572e856b5561 VALUES (0,0,1),(0,1,1),(0,2,1),(0,3,1),(0,4,1),(0,5...&quot; &gt; /tmp/tmpgqotn1u5
                cat &quot;/tmp/tmpgqotn1u5&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM efaa730a_340c_11ed_b9de_572e856b5561 WHERE NOT((x % 2 == 0 AND id &lt; 50) OR (x % 2 == 0 AND id &lt; 75 AND id &gt; 24))&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Step</span> delete odd rows from clickhouse1
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM efaa730a_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          Step</span> delete odd rows from clickhouse2
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM efaa730a_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM efaa730a_340c_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM efaa730a_340c_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM efaa730a_340c_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS efaa730a_340c_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS efaa730a_340c_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS efaa730a_340c_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">13s 655ms</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedCollapsingMergeTree/replicated table deleting without overlap entire table</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table on different nodes without overlap.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated collapsing merge tree table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table f8017b66_340c_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE f8017b66_340c_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = ReplicatedCollapsingMergeTree(&#39;/clickhouse/tables/shard0/f8017b66_340c_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;, Sign) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table f8017b66_340c_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE f8017b66_340c_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = ReplicatedCollapsingMergeTree(&#39;/clickhouse/tables/shard0/f8017b66_340c_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;, Sign) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table f8017b66_340c_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE f8017b66_340c_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = ReplicatedCollapsingMergeTree(&#39;/clickhouse/tables/shard0/f8017b66_340c_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;, Sign) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO f8017b66_340c_11ed_b9de_572e856b5561 VALUES (0,0,1),(0,1,1),(0,2,1),(0,3,1),(0,4,1),(0,5...&quot; &gt; /tmp/tmpol8w1dkc
                cat &quot;/tmp/tmpol8w1dkc&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM f8017b66_340c_11ed_b9de_572e856b5561 WHERE NOT(x&lt;33 OR (x&gt;32 AND x&lt;68) OR x&gt;67)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse1
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM f8017b66_340c_11ed_b9de_572e856b5561 WHERE x &lt; 33&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse2
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM f8017b66_340c_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse3
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM f8017b66_340c_11ed_b9de_572e856b5561 WHERE x &gt; 67&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM f8017b66_340c_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM f8017b66_340c_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM f8017b66_340c_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS f8017b66_340c_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS f8017b66_340c_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS f8017b66_340c_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">58s 197ms</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedVersionedCollapsingMergeTree/replicated table deleting in loop with overlap entire table</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop with overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table by partitions on different nodes with overlap.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated versioned collapsing merge tree table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 008d26d9_340d_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 008d26d9_340d_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = ReplicatedVersionedCollapsingMergeTree(&#39;/clickhouse/tables/shard0/008d26d9_340d_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;, Sign, id) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 008d26d9_340d_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 008d26d9_340d_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = ReplicatedVersionedCollapsingMergeTree(&#39;/clickhouse/tables/shard0/008d26d9_340d_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;, Sign, id) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 008d26d9_340d_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 008d26d9_340d_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = ReplicatedVersionedCollapsingMergeTree(&#39;/clickhouse/tables/shard0/008d26d9_340d_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;, Sign, id) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO 008d26d9_340d_11ed_b9de_572e856b5561 VALUES (0,0,1),(0,1,1),(0,2,1),(0,3,1),(0,4,1),(0,5...&quot; &gt; /tmp/tmpk41quivl
                cat &quot;/tmp/tmpk41quivl&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 008d26d9_340d_11ed_b9de_572e856b5561 WHERE NOT(x&lt;50 OR (x&gt;25 AND x&lt;75) OR x&gt;50)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse1
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 008d26d9_340d_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse2
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 008d26d9_340d_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse3
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 008d26d9_340d_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 008d26d9_340d_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 008d26d9_340d_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 008d26d9_340d_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 008d26d9_340d_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 008d26d9_340d_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 008d26d9_340d_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 008d26d9_340d_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 008d26d9_340d_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 008d26d9_340d_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 008d26d9_340d_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 008d26d9_340d_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 008d26d9_340d_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 008d26d9_340d_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 008d26d9_340d_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 008d26d9_340d_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 008d26d9_340d_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 008d26d9_340d_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 008d26d9_340d_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 008d26d9_340d_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 008d26d9_340d_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 008d26d9_340d_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 008d26d9_340d_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 008d26d9_340d_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 008d26d9_340d_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 008d26d9_340d_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 008d26d9_340d_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 008d26d9_340d_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 008d26d9_340d_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 008d26d9_340d_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 008d26d9_340d_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 008d26d9_340d_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 008d26d9_340d_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 008d26d9_340d_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">55s 29ms</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedVersionedCollapsingMergeTree/replicated table deleting in loop with without overlap</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop with without overlap</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting some rows in the table by partitions on different nodes.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated versioned collapsing merge tree table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 22ba2cb8_340d_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 22ba2cb8_340d_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = ReplicatedVersionedCollapsingMergeTree(&#39;/clickhouse/tables/shard0/22ba2cb8_340d_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;, Sign, id) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 22ba2cb8_340d_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 22ba2cb8_340d_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = ReplicatedVersionedCollapsingMergeTree(&#39;/clickhouse/tables/shard0/22ba2cb8_340d_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;, Sign, id) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 22ba2cb8_340d_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 22ba2cb8_340d_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = ReplicatedVersionedCollapsingMergeTree(&#39;/clickhouse/tables/shard0/22ba2cb8_340d_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;, Sign, id) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO 22ba2cb8_340d_11ed_b9de_572e856b5561 VALUES (0,0,1),(0,1,1),(0,2,1),(0,3,1),(0,4,1),(0,5...&quot; &gt; /tmp/tmpi0i6p8k1
                cat &quot;/tmp/tmpi0i6p8k1&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 22ba2cb8_340d_11ed_b9de_572e856b5561 WHERE NOT((x % 2 == 0 AND id &lt; 50) OR (x % 2 == 0 AND id &lt; 75 AND id &gt; 24))&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Step</span> delete odd rows from clickhouse1 by partitions
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 22ba2cb8_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          Step</span> delete odd rows from clickhouse2 by partitions
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 22ba2cb8_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 22ba2cb8_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 22ba2cb8_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 22ba2cb8_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 22ba2cb8_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 22ba2cb8_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 22ba2cb8_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 22ba2cb8_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 22ba2cb8_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 22ba2cb8_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 22ba2cb8_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 22ba2cb8_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 22ba2cb8_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 22ba2cb8_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 22ba2cb8_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 22ba2cb8_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 22ba2cb8_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 22ba2cb8_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 22ba2cb8_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 22ba2cb8_340d_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 22ba2cb8_340d_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 22ba2cb8_340d_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 22ba2cb8_340d_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 22ba2cb8_340d_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 22ba2cb8_340d_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">1m 12s</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedVersionedCollapsingMergeTree/replicated table deleting in loop without overlap entire table</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop without overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table by partitions on different nodes without overlap.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated versioned collapsing merge tree table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 4392c288_340d_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 4392c288_340d_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = ReplicatedVersionedCollapsingMergeTree(&#39;/clickhouse/tables/shard0/4392c288_340d_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;, Sign, id) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 4392c288_340d_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 4392c288_340d_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = ReplicatedVersionedCollapsingMergeTree(&#39;/clickhouse/tables/shard0/4392c288_340d_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;, Sign, id) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 4392c288_340d_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 4392c288_340d_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = ReplicatedVersionedCollapsingMergeTree(&#39;/clickhouse/tables/shard0/4392c288_340d_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;, Sign, id) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO 4392c288_340d_11ed_b9de_572e856b5561 VALUES (0,0,1),(0,1,1),(0,2,1),(0,3,1),(0,4,1),(0,5...&quot; &gt; /tmp/tmpbpjhtrgi
                cat &quot;/tmp/tmpbpjhtrgi&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 4392c288_340d_11ed_b9de_572e856b5561 WHERE NOT(x&lt;33 OR (x&gt;32 AND x&lt;68) OR x&gt;67)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse1 by partitions
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 4392c288_340d_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse2 by partitions
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 4392c288_340d_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse3 by partitions
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 4392c288_340d_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 4392c288_340d_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 4392c288_340d_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 4392c288_340d_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 4392c288_340d_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 4392c288_340d_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 4392c288_340d_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 4392c288_340d_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 4392c288_340d_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 4392c288_340d_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 4392c288_340d_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 4392c288_340d_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 4392c288_340d_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 4392c288_340d_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 4392c288_340d_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 4392c288_340d_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 4392c288_340d_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 4392c288_340d_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 4392c288_340d_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 4392c288_340d_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 4392c288_340d_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 4392c288_340d_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 4392c288_340d_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 4392c288_340d_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 4392c288_340d_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 4392c288_340d_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 4392c288_340d_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 4392c288_340d_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 4392c288_340d_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 4392c288_340d_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 4392c288_340d_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 4392c288_340d_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 4392c288_340d_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 4392c288_340d_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">16s 592ms</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedVersionedCollapsingMergeTree/replicated table deleting with overlap entire table</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table on different nodes with overlap.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated versioned collapsing merge tree table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 6ffa378e_340d_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 6ffa378e_340d_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = ReplicatedVersionedCollapsingMergeTree(&#39;/clickhouse/tables/shard0/6ffa378e_340d_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;, Sign, id) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 6ffa378e_340d_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 6ffa378e_340d_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = ReplicatedVersionedCollapsingMergeTree(&#39;/clickhouse/tables/shard0/6ffa378e_340d_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;, Sign, id) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 6ffa378e_340d_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 6ffa378e_340d_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = ReplicatedVersionedCollapsingMergeTree(&#39;/clickhouse/tables/shard0/6ffa378e_340d_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;, Sign, id) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO 6ffa378e_340d_11ed_b9de_572e856b5561 VALUES (0,0,1),(0,1,1),(0,2,1),(0,3,1),(0,4,1),(0,5...&quot; &gt; /tmp/tmpyge4owjm
                cat &quot;/tmp/tmpyge4owjm&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 6ffa378e_340d_11ed_b9de_572e856b5561 WHERE NOT(x&lt;50 OR (x&gt;25 AND x&lt;75) OR x&gt;50)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse1
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 6ffa378e_340d_11ed_b9de_572e856b5561 WHERE x &lt; 50&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse2
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 6ffa378e_340d_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse3
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 6ffa378e_340d_11ed_b9de_572e856b5561 WHERE x &gt; 50&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 6ffa378e_340d_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 6ffa378e_340d_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 6ffa378e_340d_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 6ffa378e_340d_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 6ffa378e_340d_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 6ffa378e_340d_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">13s 159ms</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedVersionedCollapsingMergeTree/replicated table deleting with without overlap</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with without overlap</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting some rows in the table on different nodes.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated versioned collapsing merge tree table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 792dbaec_340d_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 792dbaec_340d_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = ReplicatedVersionedCollapsingMergeTree(&#39;/clickhouse/tables/shard0/792dbaec_340d_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;, Sign, id) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 792dbaec_340d_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 792dbaec_340d_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = ReplicatedVersionedCollapsingMergeTree(&#39;/clickhouse/tables/shard0/792dbaec_340d_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;, Sign, id) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 792dbaec_340d_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 792dbaec_340d_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = ReplicatedVersionedCollapsingMergeTree(&#39;/clickhouse/tables/shard0/792dbaec_340d_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;, Sign, id) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO 792dbaec_340d_11ed_b9de_572e856b5561 VALUES (0,0,1),(0,1,1),(0,2,1),(0,3,1),(0,4,1),(0,5...&quot; &gt; /tmp/tmprdo_70sf
                cat &quot;/tmp/tmprdo_70sf&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 792dbaec_340d_11ed_b9de_572e856b5561 WHERE NOT((x % 2 == 0 AND id &lt; 50) OR (x % 2 == 0 AND id &lt; 75 AND id &gt; 24))&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Step</span> delete odd rows from clickhouse1
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 792dbaec_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          Step</span> delete odd rows from clickhouse2
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 792dbaec_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 792dbaec_340d_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 792dbaec_340d_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 792dbaec_340d_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 792dbaec_340d_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 792dbaec_340d_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 792dbaec_340d_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">20s 899ms</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedVersionedCollapsingMergeTree/replicated table deleting without overlap entire table</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table on different nodes without overlap.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated versioned collapsing merge tree table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 815da2f3_340d_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 815da2f3_340d_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = ReplicatedVersionedCollapsingMergeTree(&#39;/clickhouse/tables/shard0/815da2f3_340d_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;, Sign, id) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 815da2f3_340d_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 815da2f3_340d_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = ReplicatedVersionedCollapsingMergeTree(&#39;/clickhouse/tables/shard0/815da2f3_340d_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;, Sign, id) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 815da2f3_340d_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 815da2f3_340d_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = ReplicatedVersionedCollapsingMergeTree(&#39;/clickhouse/tables/shard0/815da2f3_340d_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;, Sign, id) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO 815da2f3_340d_11ed_b9de_572e856b5561 VALUES (0,0,1),(0,1,1),(0,2,1),(0,3,1),(0,4,1),(0,5...&quot; &gt; /tmp/tmpi_lcvy8o
                cat &quot;/tmp/tmpi_lcvy8o&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 815da2f3_340d_11ed_b9de_572e856b5561 WHERE NOT(x&lt;33 OR (x&gt;32 AND x&lt;68) OR x&gt;67)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse1
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 815da2f3_340d_11ed_b9de_572e856b5561 WHERE x &lt; 33&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse2
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 815da2f3_340d_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse3
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 815da2f3_340d_11ed_b9de_572e856b5561 WHERE x &gt; 67&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 815da2f3_340d_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 815da2f3_340d_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 815da2f3_340d_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 815da2f3_340d_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 815da2f3_340d_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 815da2f3_340d_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">1m 0s</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedGraphiteMergeTree/replicated table deleting in loop with overlap entire table</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop with overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table by partitions on different nodes with overlap.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated graphite merge tree table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 8e2b2293_340d_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 8e2b2293_340d_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Path String, Time DateTime, Value Int64, Timestamp Int64) Engine = ReplicatedGraphiteMergeTree(&#39;/clickhouse/tables/shard0/8e2b2293_340d_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;, &#39;graphite_rollup_example&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 8e2b2293_340d_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 8e2b2293_340d_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Path String, Time DateTime, Value Int64, Timestamp Int64) Engine = ReplicatedGraphiteMergeTree(&#39;/clickhouse/tables/shard0/8e2b2293_340d_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;, &#39;graphite_rollup_example&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 8e2b2293_340d_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 8e2b2293_340d_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Path String, Time DateTime, Value Int64, Timestamp Int64) Engine = ReplicatedGraphiteMergeTree(&#39;/clickhouse/tables/shard0/8e2b2293_340d_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;, &#39;graphite_rollup_example&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO 8e2b2293_340d_11ed_b9de_572e856b5561 VALUES (0,0, &#39;1&#39;, toDateTime(10), 10, 10),(0,1, &#39;1&#39;...&quot; &gt; /tmp/tmpx8ccgigu
                cat &quot;/tmp/tmpx8ccgigu&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 8e2b2293_340d_11ed_b9de_572e856b5561 WHERE NOT(x&lt;50 OR (x&gt;25 AND x&lt;75) OR x&gt;50)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse1
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8e2b2293_340d_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse2
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8e2b2293_340d_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse3
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8e2b2293_340d_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8e2b2293_340d_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8e2b2293_340d_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8e2b2293_340d_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8e2b2293_340d_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8e2b2293_340d_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8e2b2293_340d_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8e2b2293_340d_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8e2b2293_340d_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8e2b2293_340d_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8e2b2293_340d_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8e2b2293_340d_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8e2b2293_340d_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8e2b2293_340d_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8e2b2293_340d_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8e2b2293_340d_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8e2b2293_340d_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8e2b2293_340d_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8e2b2293_340d_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8e2b2293_340d_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8e2b2293_340d_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8e2b2293_340d_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8e2b2293_340d_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8e2b2293_340d_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8e2b2293_340d_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8e2b2293_340d_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8e2b2293_340d_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8e2b2293_340d_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 8e2b2293_340d_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 8e2b2293_340d_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 8e2b2293_340d_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 8e2b2293_340d_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 8e2b2293_340d_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 8e2b2293_340d_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">52s 294ms</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedGraphiteMergeTree/replicated table deleting in loop with without overlap</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop with without overlap</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting some rows in the table by partitions on different nodes.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated graphite merge tree table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table b1f063e8_340d_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE b1f063e8_340d_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Path String, Time DateTime, Value Int64, Timestamp Int64) Engine = ReplicatedGraphiteMergeTree(&#39;/clickhouse/tables/shard0/b1f063e8_340d_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;, &#39;graphite_rollup_example&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table b1f063e8_340d_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE b1f063e8_340d_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Path String, Time DateTime, Value Int64, Timestamp Int64) Engine = ReplicatedGraphiteMergeTree(&#39;/clickhouse/tables/shard0/b1f063e8_340d_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;, &#39;graphite_rollup_example&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table b1f063e8_340d_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE b1f063e8_340d_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Path String, Time DateTime, Value Int64, Timestamp Int64) Engine = ReplicatedGraphiteMergeTree(&#39;/clickhouse/tables/shard0/b1f063e8_340d_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;, &#39;graphite_rollup_example&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO b1f063e8_340d_11ed_b9de_572e856b5561 VALUES (0,0, &#39;1&#39;, toDateTime(10), 10, 10),(0,1, &#39;1&#39;...&quot; &gt; /tmp/tmplecnfi7d
                cat &quot;/tmp/tmplecnfi7d&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM b1f063e8_340d_11ed_b9de_572e856b5561 WHERE NOT((x % 2 == 0 AND id &lt; 50) OR (x % 2 == 0 AND id &lt; 75 AND id &gt; 24))&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Step</span> delete odd rows from clickhouse1 by partitions
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM b1f063e8_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          Step</span> delete odd rows from clickhouse2 by partitions
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM b1f063e8_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM b1f063e8_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM b1f063e8_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM b1f063e8_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM b1f063e8_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM b1f063e8_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM b1f063e8_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM b1f063e8_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM b1f063e8_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM b1f063e8_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM b1f063e8_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM b1f063e8_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM b1f063e8_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM b1f063e8_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM b1f063e8_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM b1f063e8_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM b1f063e8_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM b1f063e8_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM b1f063e8_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM b1f063e8_340d_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM b1f063e8_340d_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM b1f063e8_340d_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS b1f063e8_340d_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS b1f063e8_340d_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS b1f063e8_340d_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">1m 6s</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedGraphiteMergeTree/replicated table deleting in loop without overlap entire table</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop without overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table by partitions on different nodes without overlap.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated graphite merge tree table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table d05792e8_340d_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE d05792e8_340d_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Path String, Time DateTime, Value Int64, Timestamp Int64) Engine = ReplicatedGraphiteMergeTree(&#39;/clickhouse/tables/shard0/d05792e8_340d_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;, &#39;graphite_rollup_example&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table d05792e8_340d_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE d05792e8_340d_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Path String, Time DateTime, Value Int64, Timestamp Int64) Engine = ReplicatedGraphiteMergeTree(&#39;/clickhouse/tables/shard0/d05792e8_340d_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;, &#39;graphite_rollup_example&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table d05792e8_340d_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE d05792e8_340d_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Path String, Time DateTime, Value Int64, Timestamp Int64) Engine = ReplicatedGraphiteMergeTree(&#39;/clickhouse/tables/shard0/d05792e8_340d_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;, &#39;graphite_rollup_example&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO d05792e8_340d_11ed_b9de_572e856b5561 VALUES (0,0, &#39;1&#39;, toDateTime(10), 10, 10),(0,1, &#39;1&#39;...&quot; &gt; /tmp/tmpxjubwxh5
                cat &quot;/tmp/tmpxjubwxh5&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM d05792e8_340d_11ed_b9de_572e856b5561 WHERE NOT(x&lt;33 OR (x&gt;32 AND x&lt;68) OR x&gt;67)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse1 by partitions
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM d05792e8_340d_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse2 by partitions
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM d05792e8_340d_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse3 by partitions
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM d05792e8_340d_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM d05792e8_340d_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM d05792e8_340d_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM d05792e8_340d_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM d05792e8_340d_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM d05792e8_340d_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM d05792e8_340d_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM d05792e8_340d_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM d05792e8_340d_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM d05792e8_340d_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM d05792e8_340d_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM d05792e8_340d_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM d05792e8_340d_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM d05792e8_340d_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM d05792e8_340d_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM d05792e8_340d_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM d05792e8_340d_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM d05792e8_340d_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM d05792e8_340d_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM d05792e8_340d_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM d05792e8_340d_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM d05792e8_340d_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM d05792e8_340d_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM d05792e8_340d_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM d05792e8_340d_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM d05792e8_340d_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM d05792e8_340d_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM d05792e8_340d_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM d05792e8_340d_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM d05792e8_340d_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM d05792e8_340d_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS d05792e8_340d_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS d05792e8_340d_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS d05792e8_340d_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">16s 221ms</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedGraphiteMergeTree/replicated table deleting with overlap entire table</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table on different nodes with overlap.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated graphite merge tree table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table f862aa1f_340d_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE f862aa1f_340d_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Path String, Time DateTime, Value Int64, Timestamp Int64) Engine = ReplicatedGraphiteMergeTree(&#39;/clickhouse/tables/shard0/f862aa1f_340d_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;, &#39;graphite_rollup_example&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table f862aa1f_340d_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE f862aa1f_340d_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Path String, Time DateTime, Value Int64, Timestamp Int64) Engine = ReplicatedGraphiteMergeTree(&#39;/clickhouse/tables/shard0/f862aa1f_340d_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;, &#39;graphite_rollup_example&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table f862aa1f_340d_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE f862aa1f_340d_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Path String, Time DateTime, Value Int64, Timestamp Int64) Engine = ReplicatedGraphiteMergeTree(&#39;/clickhouse/tables/shard0/f862aa1f_340d_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;, &#39;graphite_rollup_example&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO f862aa1f_340d_11ed_b9de_572e856b5561 VALUES (0,0, &#39;1&#39;, toDateTime(10), 10, 10),(0,1, &#39;1&#39;...&quot; &gt; /tmp/tmp8sv1hu0u
                cat &quot;/tmp/tmp8sv1hu0u&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM f862aa1f_340d_11ed_b9de_572e856b5561 WHERE NOT(x&lt;50 OR (x&gt;25 AND x&lt;75) OR x&gt;50)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse1
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM f862aa1f_340d_11ed_b9de_572e856b5561 WHERE x &lt; 50&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse2
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM f862aa1f_340d_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse3
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM f862aa1f_340d_11ed_b9de_572e856b5561 WHERE x &gt; 50&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM f862aa1f_340d_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM f862aa1f_340d_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM f862aa1f_340d_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS f862aa1f_340d_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS f862aa1f_340d_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS f862aa1f_340d_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">11s 139ms</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedGraphiteMergeTree/replicated table deleting with without overlap</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with without overlap</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting some rows in the table on different nodes.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated graphite merge tree table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 0260a838_340e_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 0260a838_340e_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Path String, Time DateTime, Value Int64, Timestamp Int64) Engine = ReplicatedGraphiteMergeTree(&#39;/clickhouse/tables/shard0/0260a838_340e_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;, &#39;graphite_rollup_example&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 0260a838_340e_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 0260a838_340e_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Path String, Time DateTime, Value Int64, Timestamp Int64) Engine = ReplicatedGraphiteMergeTree(&#39;/clickhouse/tables/shard0/0260a838_340e_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;, &#39;graphite_rollup_example&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 0260a838_340e_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 0260a838_340e_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Path String, Time DateTime, Value Int64, Timestamp Int64) Engine = ReplicatedGraphiteMergeTree(&#39;/clickhouse/tables/shard0/0260a838_340e_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;, &#39;graphite_rollup_example&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO 0260a838_340e_11ed_b9de_572e856b5561 VALUES (0,0, &#39;1&#39;, toDateTime(10), 10, 10),(0,1, &#39;1&#39;...&quot; &gt; /tmp/tmp6yw0rs_8
                cat &quot;/tmp/tmp6yw0rs_8&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 0260a838_340e_11ed_b9de_572e856b5561 WHERE NOT((x % 2 == 0 AND id &lt; 50) OR (x % 2 == 0 AND id &lt; 75 AND id &gt; 24))&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Step</span> delete odd rows from clickhouse1
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 0260a838_340e_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          Step</span> delete odd rows from clickhouse2
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 0260a838_340e_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 0260a838_340e_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 0260a838_340e_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 0260a838_340e_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 0260a838_340e_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 0260a838_340e_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 0260a838_340e_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">13s 882ms</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedGraphiteMergeTree/replicated table deleting without overlap entire table</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table on different nodes without overlap.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated graphite merge tree table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 09003118_340e_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 09003118_340e_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Path String, Time DateTime, Value Int64, Timestamp Int64) Engine = ReplicatedGraphiteMergeTree(&#39;/clickhouse/tables/shard0/09003118_340e_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;, &#39;graphite_rollup_example&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 09003118_340e_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 09003118_340e_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Path String, Time DateTime, Value Int64, Timestamp Int64) Engine = ReplicatedGraphiteMergeTree(&#39;/clickhouse/tables/shard0/09003118_340e_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;, &#39;graphite_rollup_example&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 09003118_340e_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 09003118_340e_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Path String, Time DateTime, Value Int64, Timestamp Int64) Engine = ReplicatedGraphiteMergeTree(&#39;/clickhouse/tables/shard0/09003118_340e_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;, &#39;graphite_rollup_example&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO 09003118_340e_11ed_b9de_572e856b5561 VALUES (0,0, &#39;1&#39;, toDateTime(10), 10, 10),(0,1, &#39;1&#39;...&quot; &gt; /tmp/tmpbbvb3n9u
                cat &quot;/tmp/tmpbbvb3n9u&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 09003118_340e_11ed_b9de_572e856b5561 WHERE NOT(x&lt;33 OR (x&gt;32 AND x&lt;68) OR x&gt;67)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse1
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 09003118_340e_11ed_b9de_572e856b5561 WHERE x &lt; 33&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse2
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 09003118_340e_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse3
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 09003118_340e_11ed_b9de_572e856b5561 WHERE x &gt; 67&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 09003118_340e_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 09003118_340e_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 09003118_340e_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 09003118_340e_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 09003118_340e_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 09003118_340e_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">1h 6m</span>/lightweight delete/replicated table with alter after delete on single node</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">  </span><span class="kn">Feature</span><span class="nn"> replicated table with alter after delete on single node</span>
    Check that delete operations replicate in an eventually consistent manner between replicas.
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> add column after delete</span>
        Check that add column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> attach partition after delete</span>
        Check that attach partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> clear column after delete</span>
        Check that clear column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> comment column after delete</span>
        Check that comment column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> detach partition after delete</span>
        Check that detach partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop column after delete</span>
        Check that drop column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop partition after delete</span>
        Check that drop partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> fetch partition after delete</span>
        Check that fetch partition after delete perform correctly with replicated table on single node.
<span class="rx">      XFail</span> fetch partition after delete, engine type not supported.
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> freeze partition after delete</span>
        Check that freeze partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> modify column after delete</span>
        Check that modify column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> unfreeze partition after delete</span>
        Check that unfreeze partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedReplacingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> add column after delete</span>
        Check that add column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> attach partition after delete</span>
        Check that attach partition after delete perform correctly with replicated table on single node.
<span class="rx">      XFail</span> attach partition after delete, engine type not supported.
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> clear column after delete</span>
        Check that clear column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> comment column after delete</span>
        Check that comment column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> detach partition after delete</span>
        Check that detach partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop column after delete</span>
        Check that drop column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop partition after delete</span>
        Check that drop partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> fetch partition after delete</span>
        Check that fetch partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> freeze partition after delete</span>
        Check that freeze partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> modify column after delete</span>
        Check that modify column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> unfreeze partition after delete</span>
        Check that unfreeze partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedSummingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> add column after delete</span>
        Check that add column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> attach partition after delete</span>
        Check that attach partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> clear column after delete</span>
        Check that clear column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> comment column after delete</span>
        Check that comment column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> detach partition after delete</span>
        Check that detach partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop column after delete</span>
        Check that drop column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop partition after delete</span>
        Check that drop partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> fetch partition after delete</span>
        Check that fetch partition after delete perform correctly with replicated table on single node.
<span class="rx">      XFail</span> fetch partition after delete, engine type not supported.
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> freeze partition after delete</span>
        Check that freeze partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> modify column after delete</span>
        Check that modify column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> unfreeze partition after delete</span>
        Check that unfreeze partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedAggregatingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> add column after delete</span>
        Check that add column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> attach partition after delete</span>
        Check that attach partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> clear column after delete</span>
        Check that clear column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> comment column after delete</span>
        Check that comment column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> detach partition after delete</span>
        Check that detach partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop column after delete</span>
        Check that drop column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop partition after delete</span>
        Check that drop partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> fetch partition after delete</span>
        Check that fetch partition after delete perform correctly with replicated table on single node.
<span class="rx">      XFail</span> fetch partition after delete, engine type not supported.
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> freeze partition after delete</span>
        Check that freeze partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> modify column after delete</span>
        Check that modify column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> unfreeze partition after delete</span>
        Check that unfreeze partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedCollapsingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> add column after delete</span>
        Check that add column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> attach partition after delete</span>
        Check that attach partition after delete perform correctly with replicated table on single node.
<span class="rx">      XFail</span> attach partition after delete, engine type not supported.
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> clear column after delete</span>
        Check that clear column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> comment column after delete</span>
        Check that comment column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> detach partition after delete</span>
        Check that detach partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop column after delete</span>
        Check that drop column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop partition after delete</span>
        Check that drop partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> fetch partition after delete</span>
        Check that fetch partition after delete perform correctly with replicated table on single node.
<span class="rx">      XFail</span> fetch partition after delete, engine type not supported.
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> freeze partition after delete</span>
        Check that freeze partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> modify column after delete</span>
        Check that modify column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> unfreeze partition after delete</span>
        Check that unfreeze partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedVersionedCollapsingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> add column after delete</span>
        Check that add column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> attach partition after delete</span>
        Check that attach partition after delete perform correctly with replicated table on single node.
<span class="rx">      XFail</span> attach partition after delete, engine type not supported.
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> clear column after delete</span>
        Check that clear column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> comment column after delete</span>
        Check that comment column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> detach partition after delete</span>
        Check that detach partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop column after delete</span>
        Check that drop column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop partition after delete</span>
        Check that drop partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> fetch partition after delete</span>
        Check that fetch partition after delete perform correctly with replicated table on single node.
<span class="rx">      XFail</span> fetch partition after delete, engine type not supported.
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> freeze partition after delete</span>
        Check that freeze partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> modify column after delete</span>
        Check that modify column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> unfreeze partition after delete</span>
        Check that unfreeze partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedGraphiteMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> add column after delete</span>
        Check that add column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> attach partition after delete</span>
        Check that attach partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> clear column after delete</span>
        Check that clear column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> comment column after delete</span>
        Check that comment column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> detach partition after delete</span>
        Check that detach partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop column after delete</span>
        Check that drop column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop partition after delete</span>
        Check that drop partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> fetch partition after delete</span>
        Check that fetch partition after delete perform correctly with replicated table on single node.
<span class="rx">      XFail</span> fetch partition after delete, engine type not supported.
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> freeze partition after delete</span>
        Check that freeze partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> modify column after delete</span>
        Check that modify column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> unfreeze partition after delete</span>
        Check that unfreeze partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span>
<span class="ro">  OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">25s 832ms</span>/lightweight delete/distributed tables</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">  </span><span class="kn">Feature</span><span class="nn"> distributed tables</span>
    Check that clickhouse supports delete statement with distributed tables.
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> distributed table replicated</span>
      Check that ClickHouse supports delete statement for distributed tables
      when distributed table configuration contains 1 shard and 3 replicas.
<span class="rx">    XFail</span> distributed table replicated, engine type not supported.
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> distributed table sharded</span>
      Check that ClickHouse supports delete statement for distributed tables
      when distributed table configuration contains 3 shard 1 replica in each.
<span class="ro">    OK</span>
<span class="ro">  OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">13m 55s</span>/lightweight delete/replicated tables</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">  </span><span class="kn">Feature</span><span class="nn"> replicated tables</span>
    Check that delete operations replicate in an eventually consistent manner between replicas.
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap entire table</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with without overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap entire table</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedReplacingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap entire table</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with without overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap entire table</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedSummingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap entire table</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with without overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap entire table</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedAggregatingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap entire table</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with without overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap entire table</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedCollapsingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap entire table</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with without overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap entire table</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedVersionedCollapsingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap entire table</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with without overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap entire table</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedGraphiteMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap entire table</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with without overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap entire table</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span>
<span class="ro">  OK</span>
</code></pre></div>


</div>

<section class="requirement"><span class="requirement-inline"><i class="utf-icon color-ok">✔</i>RQ.SRS-023.ClickHouse.LightweightDelete.RowsRemovedFromReplica</span></section>

<div class="requirement-description hidden">

<p><a target="_blank" rel="nofollow noopener noreferrer" href="https://clickhouse.yandex">ClickHouse</a> SHALL support <code>DELETE</code> removing rows from a part where the rows have already
been removed from another replica.</p>

</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">1m 19s</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedMergeTree/replicated table deleting in loop with overlap entire table</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop with overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table by partitions on different nodes with overlap.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 40d26ce9_340a_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 40d26ce9_340a_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedMergeTree(&#39;/clickhouse/tables/shard0/40d26ce9_340a_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 40d26ce9_340a_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 40d26ce9_340a_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedMergeTree(&#39;/clickhouse/tables/shard0/40d26ce9_340a_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 40d26ce9_340a_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 40d26ce9_340a_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedMergeTree(&#39;/clickhouse/tables/shard0/40d26ce9_340a_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO 40d26ce9_340a_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0,6),(0...&quot; &gt; /tmp/tmpodmf6xvk
                cat &quot;/tmp/tmpodmf6xvk&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 40d26ce9_340a_11ed_b9de_572e856b5561 WHERE NOT(x&lt;50 OR (x&gt;25 AND x&lt;75) OR x&gt;50)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse1
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 40d26ce9_340a_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse2
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 40d26ce9_340a_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse3
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 40d26ce9_340a_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 40d26ce9_340a_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 40d26ce9_340a_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 40d26ce9_340a_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 40d26ce9_340a_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 40d26ce9_340a_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 40d26ce9_340a_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 40d26ce9_340a_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 40d26ce9_340a_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 40d26ce9_340a_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 40d26ce9_340a_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 40d26ce9_340a_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 40d26ce9_340a_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 40d26ce9_340a_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 40d26ce9_340a_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 40d26ce9_340a_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 40d26ce9_340a_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 40d26ce9_340a_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 40d26ce9_340a_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 40d26ce9_340a_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 40d26ce9_340a_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 40d26ce9_340a_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 40d26ce9_340a_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 40d26ce9_340a_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 40d26ce9_340a_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 40d26ce9_340a_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 40d26ce9_340a_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 40d26ce9_340a_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 40d26ce9_340a_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 40d26ce9_340a_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 40d26ce9_340a_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 40d26ce9_340a_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 40d26ce9_340a_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 40d26ce9_340a_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">47s 371ms</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedMergeTree/replicated table deleting in loop with without overlap</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop with without overlap</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting some rows in the table by partitions on different nodes.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 700dfb64_340a_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 700dfb64_340a_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedMergeTree(&#39;/clickhouse/tables/shard0/700dfb64_340a_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 700dfb64_340a_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 700dfb64_340a_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedMergeTree(&#39;/clickhouse/tables/shard0/700dfb64_340a_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 700dfb64_340a_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 700dfb64_340a_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedMergeTree(&#39;/clickhouse/tables/shard0/700dfb64_340a_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO 700dfb64_340a_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0,6),(0...&quot; &gt; /tmp/tmpz0c7hzai
                cat &quot;/tmp/tmpz0c7hzai&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 700dfb64_340a_11ed_b9de_572e856b5561 WHERE NOT((x % 2 == 0 AND id &lt; 50) OR (x % 2 == 0 AND id &lt; 75 AND id &gt; 24))&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Step</span> delete odd rows from clickhouse1 by partitions
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 700dfb64_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          Step</span> delete odd rows from clickhouse2 by partitions
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 700dfb64_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 700dfb64_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 700dfb64_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 700dfb64_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 700dfb64_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 700dfb64_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 700dfb64_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 700dfb64_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 700dfb64_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 700dfb64_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 700dfb64_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 700dfb64_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 700dfb64_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 700dfb64_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 700dfb64_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 700dfb64_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 700dfb64_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 700dfb64_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 700dfb64_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 700dfb64_340a_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 700dfb64_340a_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 700dfb64_340a_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 700dfb64_340a_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 700dfb64_340a_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 700dfb64_340a_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">1m 5s</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedMergeTree/replicated table deleting in loop without overlap entire table</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop without overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table by partitions on different nodes without overlap.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 8b864ebe_340a_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 8b864ebe_340a_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedMergeTree(&#39;/clickhouse/tables/shard0/8b864ebe_340a_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 8b864ebe_340a_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 8b864ebe_340a_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedMergeTree(&#39;/clickhouse/tables/shard0/8b864ebe_340a_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 8b864ebe_340a_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 8b864ebe_340a_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedMergeTree(&#39;/clickhouse/tables/shard0/8b864ebe_340a_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO 8b864ebe_340a_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0,6),(0...&quot; &gt; /tmp/tmp0jwqs7q2
                cat &quot;/tmp/tmp0jwqs7q2&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 8b864ebe_340a_11ed_b9de_572e856b5561 WHERE NOT(x&lt;33 OR (x&gt;32 AND x&lt;68) OR x&gt;67)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse1 by partitions
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8b864ebe_340a_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse2 by partitions
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8b864ebe_340a_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse3 by partitions
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8b864ebe_340a_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8b864ebe_340a_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8b864ebe_340a_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8b864ebe_340a_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8b864ebe_340a_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8b864ebe_340a_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8b864ebe_340a_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8b864ebe_340a_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8b864ebe_340a_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8b864ebe_340a_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8b864ebe_340a_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8b864ebe_340a_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8b864ebe_340a_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8b864ebe_340a_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8b864ebe_340a_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8b864ebe_340a_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8b864ebe_340a_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8b864ebe_340a_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8b864ebe_340a_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8b864ebe_340a_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8b864ebe_340a_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8b864ebe_340a_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8b864ebe_340a_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8b864ebe_340a_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8b864ebe_340a_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8b864ebe_340a_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8b864ebe_340a_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8b864ebe_340a_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 8b864ebe_340a_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 8b864ebe_340a_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 8b864ebe_340a_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 8b864ebe_340a_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 8b864ebe_340a_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 8b864ebe_340a_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">16s 434ms</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedMergeTree/replicated table deleting with overlap entire table</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table on different nodes with overlap.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table b25bd220_340a_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE b25bd220_340a_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedMergeTree(&#39;/clickhouse/tables/shard0/b25bd220_340a_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table b25bd220_340a_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE b25bd220_340a_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedMergeTree(&#39;/clickhouse/tables/shard0/b25bd220_340a_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table b25bd220_340a_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE b25bd220_340a_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedMergeTree(&#39;/clickhouse/tables/shard0/b25bd220_340a_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO b25bd220_340a_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0,6),(0...&quot; &gt; /tmp/tmp9vr1q0vg
                cat &quot;/tmp/tmp9vr1q0vg&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM b25bd220_340a_11ed_b9de_572e856b5561 WHERE NOT(x&lt;50 OR (x&gt;25 AND x&lt;75) OR x&gt;50)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse1
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM b25bd220_340a_11ed_b9de_572e856b5561 WHERE x &lt; 50&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse2
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM b25bd220_340a_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse3
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM b25bd220_340a_11ed_b9de_572e856b5561 WHERE x &gt; 50&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM b25bd220_340a_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM b25bd220_340a_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM b25bd220_340a_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS b25bd220_340a_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS b25bd220_340a_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS b25bd220_340a_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">17s 910ms</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedMergeTree/replicated table deleting with without overlap</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with without overlap</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting some rows in the table on different nodes.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table bceceb48_340a_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE bceceb48_340a_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedMergeTree(&#39;/clickhouse/tables/shard0/bceceb48_340a_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table bceceb48_340a_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE bceceb48_340a_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedMergeTree(&#39;/clickhouse/tables/shard0/bceceb48_340a_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table bceceb48_340a_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE bceceb48_340a_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedMergeTree(&#39;/clickhouse/tables/shard0/bceceb48_340a_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO bceceb48_340a_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0,6),(0...&quot; &gt; /tmp/tmpqg62j6_1
                cat &quot;/tmp/tmpqg62j6_1&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM bceceb48_340a_11ed_b9de_572e856b5561 WHERE NOT((x % 2 == 0 AND id &lt; 50) OR (x % 2 == 0 AND id &lt; 75 AND id &gt; 24))&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Step</span> delete odd rows from clickhouse1
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM bceceb48_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          Step</span> delete odd rows from clickhouse2
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM bceceb48_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM bceceb48_340a_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM bceceb48_340a_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM bceceb48_340a_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS bceceb48_340a_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS bceceb48_340a_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS bceceb48_340a_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">13s 498ms</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedMergeTree/replicated table deleting without overlap entire table</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table on different nodes without overlap.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table c704885a_340a_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE c704885a_340a_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedMergeTree(&#39;/clickhouse/tables/shard0/c704885a_340a_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table c704885a_340a_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE c704885a_340a_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedMergeTree(&#39;/clickhouse/tables/shard0/c704885a_340a_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table c704885a_340a_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE c704885a_340a_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedMergeTree(&#39;/clickhouse/tables/shard0/c704885a_340a_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO c704885a_340a_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0,6),(0...&quot; &gt; /tmp/tmps_in1nrm
                cat &quot;/tmp/tmps_in1nrm&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM c704885a_340a_11ed_b9de_572e856b5561 WHERE NOT(x&lt;33 OR (x&gt;32 AND x&lt;68) OR x&gt;67)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse1
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM c704885a_340a_11ed_b9de_572e856b5561 WHERE x &lt; 33&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse2
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM c704885a_340a_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse3
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM c704885a_340a_11ed_b9de_572e856b5561 WHERE x &gt; 67&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM c704885a_340a_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM c704885a_340a_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM c704885a_340a_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS c704885a_340a_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS c704885a_340a_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS c704885a_340a_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">1m 8s</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedReplacingMergeTree/replicated table deleting in loop with overlap entire table</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop with overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table by partitions on different nodes with overlap.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated replacing merge tree table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table cfa56245_340a_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE cfa56245_340a_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedReplacingMergeTree(&#39;/clickhouse/tables/shard0/cfa56245_340a_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table cfa56245_340a_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE cfa56245_340a_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedReplacingMergeTree(&#39;/clickhouse/tables/shard0/cfa56245_340a_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table cfa56245_340a_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE cfa56245_340a_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedReplacingMergeTree(&#39;/clickhouse/tables/shard0/cfa56245_340a_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO cfa56245_340a_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0,6),(0...&quot; &gt; /tmp/tmp_59hc_3p
                cat &quot;/tmp/tmp_59hc_3p&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM cfa56245_340a_11ed_b9de_572e856b5561 WHERE NOT(x&lt;50 OR (x&gt;25 AND x&lt;75) OR x&gt;50)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse1
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM cfa56245_340a_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse2
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM cfa56245_340a_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse3
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM cfa56245_340a_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM cfa56245_340a_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM cfa56245_340a_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM cfa56245_340a_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM cfa56245_340a_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM cfa56245_340a_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM cfa56245_340a_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM cfa56245_340a_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM cfa56245_340a_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM cfa56245_340a_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM cfa56245_340a_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM cfa56245_340a_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM cfa56245_340a_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM cfa56245_340a_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM cfa56245_340a_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM cfa56245_340a_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM cfa56245_340a_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM cfa56245_340a_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM cfa56245_340a_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM cfa56245_340a_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM cfa56245_340a_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM cfa56245_340a_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM cfa56245_340a_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM cfa56245_340a_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM cfa56245_340a_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM cfa56245_340a_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM cfa56245_340a_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM cfa56245_340a_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM cfa56245_340a_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM cfa56245_340a_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM cfa56245_340a_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS cfa56245_340a_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS cfa56245_340a_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS cfa56245_340a_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">55s 940ms</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedReplacingMergeTree/replicated table deleting in loop with without overlap</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop with without overlap</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting some rows in the table by partitions on different nodes.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated replacing merge tree table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table f80906ed_340a_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE f80906ed_340a_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedReplacingMergeTree(&#39;/clickhouse/tables/shard0/f80906ed_340a_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table f80906ed_340a_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE f80906ed_340a_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedReplacingMergeTree(&#39;/clickhouse/tables/shard0/f80906ed_340a_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table f80906ed_340a_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE f80906ed_340a_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedReplacingMergeTree(&#39;/clickhouse/tables/shard0/f80906ed_340a_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO f80906ed_340a_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0,6),(0...&quot; &gt; /tmp/tmpwxyafav1
                cat &quot;/tmp/tmpwxyafav1&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM f80906ed_340a_11ed_b9de_572e856b5561 WHERE NOT((x % 2 == 0 AND id &lt; 50) OR (x % 2 == 0 AND id &lt; 75 AND id &gt; 24))&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Step</span> delete odd rows from clickhouse1 by partitions
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM f80906ed_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          Step</span> delete odd rows from clickhouse2 by partitions
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM f80906ed_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM f80906ed_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM f80906ed_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM f80906ed_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM f80906ed_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM f80906ed_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM f80906ed_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM f80906ed_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM f80906ed_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM f80906ed_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM f80906ed_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM f80906ed_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM f80906ed_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM f80906ed_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM f80906ed_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM f80906ed_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM f80906ed_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM f80906ed_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM f80906ed_340a_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM f80906ed_340a_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM f80906ed_340a_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM f80906ed_340a_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS f80906ed_340a_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS f80906ed_340a_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS f80906ed_340a_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">1m 5s</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedReplacingMergeTree/replicated table deleting in loop without overlap entire table</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop without overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table by partitions on different nodes without overlap.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated replacing merge tree table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 19e9b13c_340b_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 19e9b13c_340b_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedReplacingMergeTree(&#39;/clickhouse/tables/shard0/19e9b13c_340b_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 19e9b13c_340b_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 19e9b13c_340b_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedReplacingMergeTree(&#39;/clickhouse/tables/shard0/19e9b13c_340b_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 19e9b13c_340b_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 19e9b13c_340b_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedReplacingMergeTree(&#39;/clickhouse/tables/shard0/19e9b13c_340b_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO 19e9b13c_340b_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0,6),(0...&quot; &gt; /tmp/tmpbk9r0hqz
                cat &quot;/tmp/tmpbk9r0hqz&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 19e9b13c_340b_11ed_b9de_572e856b5561 WHERE NOT(x&lt;33 OR (x&gt;32 AND x&lt;68) OR x&gt;67)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse1 by partitions
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 19e9b13c_340b_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse2 by partitions
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 19e9b13c_340b_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse3 by partitions
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 19e9b13c_340b_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 19e9b13c_340b_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 19e9b13c_340b_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 19e9b13c_340b_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 19e9b13c_340b_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 19e9b13c_340b_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 19e9b13c_340b_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 19e9b13c_340b_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 19e9b13c_340b_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 19e9b13c_340b_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 19e9b13c_340b_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 19e9b13c_340b_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 19e9b13c_340b_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 19e9b13c_340b_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 19e9b13c_340b_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 19e9b13c_340b_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 19e9b13c_340b_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 19e9b13c_340b_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 19e9b13c_340b_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 19e9b13c_340b_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 19e9b13c_340b_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 19e9b13c_340b_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 19e9b13c_340b_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 19e9b13c_340b_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 19e9b13c_340b_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 19e9b13c_340b_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 19e9b13c_340b_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 19e9b13c_340b_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 19e9b13c_340b_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 19e9b13c_340b_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 19e9b13c_340b_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 19e9b13c_340b_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 19e9b13c_340b_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 19e9b13c_340b_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">15s 154ms</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedReplacingMergeTree/replicated table deleting with overlap entire table</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table on different nodes with overlap.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated replacing merge tree table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 400f5ccc_340b_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 400f5ccc_340b_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedReplacingMergeTree(&#39;/clickhouse/tables/shard0/400f5ccc_340b_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 400f5ccc_340b_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 400f5ccc_340b_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedReplacingMergeTree(&#39;/clickhouse/tables/shard0/400f5ccc_340b_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 400f5ccc_340b_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 400f5ccc_340b_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedReplacingMergeTree(&#39;/clickhouse/tables/shard0/400f5ccc_340b_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO 400f5ccc_340b_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0,6),(0...&quot; &gt; /tmp/tmp1c5n66zm
                cat &quot;/tmp/tmp1c5n66zm&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 400f5ccc_340b_11ed_b9de_572e856b5561 WHERE NOT(x&lt;50 OR (x&gt;25 AND x&lt;75) OR x&gt;50)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse1
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 400f5ccc_340b_11ed_b9de_572e856b5561 WHERE x &lt; 50&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse2
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 400f5ccc_340b_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse3
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 400f5ccc_340b_11ed_b9de_572e856b5561 WHERE x &gt; 50&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 400f5ccc_340b_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 400f5ccc_340b_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 400f5ccc_340b_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 400f5ccc_340b_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 400f5ccc_340b_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 400f5ccc_340b_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">20s 288ms</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedReplacingMergeTree/replicated table deleting with without overlap</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with without overlap</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting some rows in the table on different nodes.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated replacing merge tree table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 49457a06_340b_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 49457a06_340b_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedReplacingMergeTree(&#39;/clickhouse/tables/shard0/49457a06_340b_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 49457a06_340b_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 49457a06_340b_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedReplacingMergeTree(&#39;/clickhouse/tables/shard0/49457a06_340b_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 49457a06_340b_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 49457a06_340b_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedReplacingMergeTree(&#39;/clickhouse/tables/shard0/49457a06_340b_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO 49457a06_340b_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0,6),(0...&quot; &gt; /tmp/tmpeom2fk6b
                cat &quot;/tmp/tmpeom2fk6b&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 49457a06_340b_11ed_b9de_572e856b5561 WHERE NOT((x % 2 == 0 AND id &lt; 50) OR (x % 2 == 0 AND id &lt; 75 AND id &gt; 24))&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Step</span> delete odd rows from clickhouse1
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 49457a06_340b_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          Step</span> delete odd rows from clickhouse2
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 49457a06_340b_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 49457a06_340b_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 49457a06_340b_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 49457a06_340b_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 49457a06_340b_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 49457a06_340b_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 49457a06_340b_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">15s 324ms</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedReplacingMergeTree/replicated table deleting without overlap entire table</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table on different nodes without overlap.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated replacing merge tree table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 5548148a_340b_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 5548148a_340b_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedReplacingMergeTree(&#39;/clickhouse/tables/shard0/5548148a_340b_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 5548148a_340b_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 5548148a_340b_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedReplacingMergeTree(&#39;/clickhouse/tables/shard0/5548148a_340b_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 5548148a_340b_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 5548148a_340b_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedReplacingMergeTree(&#39;/clickhouse/tables/shard0/5548148a_340b_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO 5548148a_340b_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0,6),(0...&quot; &gt; /tmp/tmp3gik1msi
                cat &quot;/tmp/tmp3gik1msi&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 5548148a_340b_11ed_b9de_572e856b5561 WHERE NOT(x&lt;33 OR (x&gt;32 AND x&lt;68) OR x&gt;67)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse1
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 5548148a_340b_11ed_b9de_572e856b5561 WHERE x &lt; 33&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse2
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 5548148a_340b_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse3
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 5548148a_340b_11ed_b9de_572e856b5561 WHERE x &gt; 67&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 5548148a_340b_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 5548148a_340b_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 5548148a_340b_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 5548148a_340b_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 5548148a_340b_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 5548148a_340b_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">1m 0s</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedSummingMergeTree/replicated table deleting in loop with overlap entire table</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop with overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table by partitions on different nodes with overlap.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated summing merge tree table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 5f17e803_340b_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 5f17e803_340b_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedSummingMergeTree(&#39;/clickhouse/tables/shard0/5f17e803_340b_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;, x) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 5f17e803_340b_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 5f17e803_340b_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedSummingMergeTree(&#39;/clickhouse/tables/shard0/5f17e803_340b_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;, x) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 5f17e803_340b_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 5f17e803_340b_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedSummingMergeTree(&#39;/clickhouse/tables/shard0/5f17e803_340b_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;, x) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO 5f17e803_340b_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0,6),(0...&quot; &gt; /tmp/tmpnflbjhp2
                cat &quot;/tmp/tmpnflbjhp2&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 5f17e803_340b_11ed_b9de_572e856b5561 WHERE NOT(x&lt;50 OR (x&gt;25 AND x&lt;75) OR x&gt;50)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse1
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 5f17e803_340b_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse2
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 5f17e803_340b_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse3
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 5f17e803_340b_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 5f17e803_340b_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 5f17e803_340b_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 5f17e803_340b_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 5f17e803_340b_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 5f17e803_340b_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 5f17e803_340b_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 5f17e803_340b_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 5f17e803_340b_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 5f17e803_340b_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 5f17e803_340b_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 5f17e803_340b_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 5f17e803_340b_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 5f17e803_340b_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 5f17e803_340b_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 5f17e803_340b_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 5f17e803_340b_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 5f17e803_340b_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 5f17e803_340b_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 5f17e803_340b_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 5f17e803_340b_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 5f17e803_340b_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 5f17e803_340b_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 5f17e803_340b_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 5f17e803_340b_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 5f17e803_340b_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 5f17e803_340b_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 5f17e803_340b_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 5f17e803_340b_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 5f17e803_340b_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 5f17e803_340b_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 5f17e803_340b_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 5f17e803_340b_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 5f17e803_340b_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">50s 680ms</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedSummingMergeTree/replicated table deleting in loop with without overlap</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop with without overlap</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting some rows in the table by partitions on different nodes.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated summing merge tree table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 835facac_340b_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 835facac_340b_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedSummingMergeTree(&#39;/clickhouse/tables/shard0/835facac_340b_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;, x) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 835facac_340b_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 835facac_340b_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedSummingMergeTree(&#39;/clickhouse/tables/shard0/835facac_340b_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;, x) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 835facac_340b_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 835facac_340b_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedSummingMergeTree(&#39;/clickhouse/tables/shard0/835facac_340b_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;, x) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO 835facac_340b_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0,6),(0...&quot; &gt; /tmp/tmpbgc1ebh8
                cat &quot;/tmp/tmpbgc1ebh8&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 835facac_340b_11ed_b9de_572e856b5561 WHERE NOT((x % 2 == 0 AND id &lt; 50) OR (x % 2 == 0 AND id &lt; 75 AND id &gt; 24))&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Step</span> delete odd rows from clickhouse1 by partitions
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 835facac_340b_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          Step</span> delete odd rows from clickhouse2 by partitions
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 835facac_340b_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 835facac_340b_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 835facac_340b_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 835facac_340b_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 835facac_340b_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 835facac_340b_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 835facac_340b_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 835facac_340b_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 835facac_340b_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 835facac_340b_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 835facac_340b_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 835facac_340b_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 835facac_340b_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 835facac_340b_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 835facac_340b_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 835facac_340b_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 835facac_340b_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 835facac_340b_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 835facac_340b_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 835facac_340b_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 835facac_340b_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 835facac_340b_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 835facac_340b_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 835facac_340b_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 835facac_340b_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">1m 4s</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedSummingMergeTree/replicated table deleting in loop without overlap entire table</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop without overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table by partitions on different nodes without overlap.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated summing merge tree table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table a0cc6050_340b_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE a0cc6050_340b_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedSummingMergeTree(&#39;/clickhouse/tables/shard0/a0cc6050_340b_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;, x) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table a0cc6050_340b_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE a0cc6050_340b_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedSummingMergeTree(&#39;/clickhouse/tables/shard0/a0cc6050_340b_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;, x) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table a0cc6050_340b_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE a0cc6050_340b_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedSummingMergeTree(&#39;/clickhouse/tables/shard0/a0cc6050_340b_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;, x) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO a0cc6050_340b_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0,6),(0...&quot; &gt; /tmp/tmpg1u4mxsl
                cat &quot;/tmp/tmpg1u4mxsl&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM a0cc6050_340b_11ed_b9de_572e856b5561 WHERE NOT(x&lt;33 OR (x&gt;32 AND x&lt;68) OR x&gt;67)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse1 by partitions
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc6050_340b_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse2 by partitions
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc6050_340b_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse3 by partitions
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc6050_340b_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc6050_340b_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc6050_340b_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc6050_340b_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc6050_340b_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc6050_340b_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc6050_340b_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc6050_340b_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc6050_340b_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc6050_340b_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc6050_340b_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc6050_340b_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc6050_340b_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc6050_340b_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc6050_340b_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc6050_340b_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc6050_340b_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc6050_340b_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc6050_340b_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc6050_340b_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc6050_340b_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc6050_340b_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc6050_340b_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc6050_340b_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc6050_340b_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc6050_340b_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc6050_340b_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc6050_340b_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM a0cc6050_340b_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM a0cc6050_340b_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM a0cc6050_340b_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS a0cc6050_340b_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS a0cc6050_340b_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS a0cc6050_340b_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">15s 849ms</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedSummingMergeTree/replicated table deleting with overlap entire table</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table on different nodes with overlap.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated summing merge tree table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table c83b1ef6_340b_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE c83b1ef6_340b_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedSummingMergeTree(&#39;/clickhouse/tables/shard0/c83b1ef6_340b_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;, x) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table c83b1ef6_340b_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE c83b1ef6_340b_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedSummingMergeTree(&#39;/clickhouse/tables/shard0/c83b1ef6_340b_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;, x) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table c83b1ef6_340b_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE c83b1ef6_340b_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedSummingMergeTree(&#39;/clickhouse/tables/shard0/c83b1ef6_340b_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;, x) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO c83b1ef6_340b_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0,6),(0...&quot; &gt; /tmp/tmp9e2u69ja
                cat &quot;/tmp/tmp9e2u69ja&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM c83b1ef6_340b_11ed_b9de_572e856b5561 WHERE NOT(x&lt;50 OR (x&gt;25 AND x&lt;75) OR x&gt;50)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse1
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM c83b1ef6_340b_11ed_b9de_572e856b5561 WHERE x &lt; 50&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse2
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM c83b1ef6_340b_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse3
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM c83b1ef6_340b_11ed_b9de_572e856b5561 WHERE x &gt; 50&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM c83b1ef6_340b_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM c83b1ef6_340b_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM c83b1ef6_340b_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS c83b1ef6_340b_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS c83b1ef6_340b_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS c83b1ef6_340b_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">16s 791ms</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedSummingMergeTree/replicated table deleting with without overlap</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with without overlap</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting some rows in the table on different nodes.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated summing merge tree table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table d0fffff2_340b_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE d0fffff2_340b_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedSummingMergeTree(&#39;/clickhouse/tables/shard0/d0fffff2_340b_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;, x) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table d0fffff2_340b_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE d0fffff2_340b_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedSummingMergeTree(&#39;/clickhouse/tables/shard0/d0fffff2_340b_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;, x) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table d0fffff2_340b_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE d0fffff2_340b_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedSummingMergeTree(&#39;/clickhouse/tables/shard0/d0fffff2_340b_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;, x) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO d0fffff2_340b_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0,6),(0...&quot; &gt; /tmp/tmpzry1t9gb
                cat &quot;/tmp/tmpzry1t9gb&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM d0fffff2_340b_11ed_b9de_572e856b5561 WHERE NOT((x % 2 == 0 AND id &lt; 50) OR (x % 2 == 0 AND id &lt; 75 AND id &gt; 24))&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Step</span> delete odd rows from clickhouse1
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM d0fffff2_340b_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          Step</span> delete odd rows from clickhouse2
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM d0fffff2_340b_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM d0fffff2_340b_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM d0fffff2_340b_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM d0fffff2_340b_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS d0fffff2_340b_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS d0fffff2_340b_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS d0fffff2_340b_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">11s 580ms</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedSummingMergeTree/replicated table deleting without overlap entire table</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table on different nodes without overlap.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated summing merge tree table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table dbafbf3c_340b_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE dbafbf3c_340b_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedSummingMergeTree(&#39;/clickhouse/tables/shard0/dbafbf3c_340b_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;, x) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table dbafbf3c_340b_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE dbafbf3c_340b_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedSummingMergeTree(&#39;/clickhouse/tables/shard0/dbafbf3c_340b_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;, x) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table dbafbf3c_340b_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE dbafbf3c_340b_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedSummingMergeTree(&#39;/clickhouse/tables/shard0/dbafbf3c_340b_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;, x) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO dbafbf3c_340b_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0,6),(0...&quot; &gt; /tmp/tmpb00ji3x4
                cat &quot;/tmp/tmpb00ji3x4&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM dbafbf3c_340b_11ed_b9de_572e856b5561 WHERE NOT(x&lt;33 OR (x&gt;32 AND x&lt;68) OR x&gt;67)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse1
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM dbafbf3c_340b_11ed_b9de_572e856b5561 WHERE x &lt; 33&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse2
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM dbafbf3c_340b_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse3
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM dbafbf3c_340b_11ed_b9de_572e856b5561 WHERE x &gt; 67&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM dbafbf3c_340b_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM dbafbf3c_340b_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM dbafbf3c_340b_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS dbafbf3c_340b_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS dbafbf3c_340b_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS dbafbf3c_340b_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">1m 30s</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedAggregatingMergeTree/replicated table deleting in loop with overlap entire table</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop with overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table by partitions on different nodes with overlap.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated aggregating merge tree table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table e2208d12_340b_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE e2208d12_340b_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedAggregatingMergeTree(&#39;/clickhouse/tables/shard0/e2208d12_340b_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table e2208d12_340b_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE e2208d12_340b_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedAggregatingMergeTree(&#39;/clickhouse/tables/shard0/e2208d12_340b_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table e2208d12_340b_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE e2208d12_340b_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedAggregatingMergeTree(&#39;/clickhouse/tables/shard0/e2208d12_340b_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO e2208d12_340b_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0,6),(0...&quot; &gt; /tmp/tmpxqy2_65q
                cat &quot;/tmp/tmpxqy2_65q&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM e2208d12_340b_11ed_b9de_572e856b5561 WHERE NOT(x&lt;50 OR (x&gt;25 AND x&lt;75) OR x&gt;50)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse1
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM e2208d12_340b_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse2
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM e2208d12_340b_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse3
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM e2208d12_340b_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM e2208d12_340b_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM e2208d12_340b_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM e2208d12_340b_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM e2208d12_340b_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM e2208d12_340b_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM e2208d12_340b_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM e2208d12_340b_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM e2208d12_340b_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM e2208d12_340b_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM e2208d12_340b_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM e2208d12_340b_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM e2208d12_340b_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM e2208d12_340b_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM e2208d12_340b_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM e2208d12_340b_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM e2208d12_340b_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM e2208d12_340b_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM e2208d12_340b_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM e2208d12_340b_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM e2208d12_340b_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM e2208d12_340b_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM e2208d12_340b_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM e2208d12_340b_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM e2208d12_340b_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM e2208d12_340b_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM e2208d12_340b_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM e2208d12_340b_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM e2208d12_340b_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM e2208d12_340b_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM e2208d12_340b_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS e2208d12_340b_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS e2208d12_340b_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS e2208d12_340b_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">58s 282ms</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedAggregatingMergeTree/replicated table deleting in loop with without overlap</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop with without overlap</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting some rows in the table by partitions on different nodes.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated aggregating merge tree table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 187f3e56_340c_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 187f3e56_340c_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedAggregatingMergeTree(&#39;/clickhouse/tables/shard0/187f3e56_340c_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 187f3e56_340c_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 187f3e56_340c_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedAggregatingMergeTree(&#39;/clickhouse/tables/shard0/187f3e56_340c_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 187f3e56_340c_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 187f3e56_340c_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedAggregatingMergeTree(&#39;/clickhouse/tables/shard0/187f3e56_340c_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO 187f3e56_340c_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0,6),(0...&quot; &gt; /tmp/tmpod4c1nl8
                cat &quot;/tmp/tmpod4c1nl8&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 187f3e56_340c_11ed_b9de_572e856b5561 WHERE NOT((x % 2 == 0 AND id &lt; 50) OR (x % 2 == 0 AND id &lt; 75 AND id &gt; 24))&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Step</span> delete odd rows from clickhouse1 by partitions
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 187f3e56_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          Step</span> delete odd rows from clickhouse2 by partitions
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 187f3e56_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 187f3e56_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 187f3e56_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 187f3e56_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 187f3e56_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 187f3e56_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 187f3e56_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 187f3e56_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 187f3e56_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 187f3e56_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 187f3e56_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 187f3e56_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 187f3e56_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 187f3e56_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 187f3e56_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 187f3e56_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 187f3e56_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 187f3e56_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 187f3e56_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 187f3e56_340c_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 187f3e56_340c_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 187f3e56_340c_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 187f3e56_340c_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 187f3e56_340c_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 187f3e56_340c_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">1m 0s</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedAggregatingMergeTree/replicated table deleting in loop without overlap entire table</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop without overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table by partitions on different nodes without overlap.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated aggregating merge tree table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 3a6cc0e2_340c_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 3a6cc0e2_340c_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedAggregatingMergeTree(&#39;/clickhouse/tables/shard0/3a6cc0e2_340c_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 3a6cc0e2_340c_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 3a6cc0e2_340c_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedAggregatingMergeTree(&#39;/clickhouse/tables/shard0/3a6cc0e2_340c_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 3a6cc0e2_340c_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 3a6cc0e2_340c_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedAggregatingMergeTree(&#39;/clickhouse/tables/shard0/3a6cc0e2_340c_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO 3a6cc0e2_340c_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0,6),(0...&quot; &gt; /tmp/tmp9xms0lz7
                cat &quot;/tmp/tmp9xms0lz7&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 3a6cc0e2_340c_11ed_b9de_572e856b5561 WHERE NOT(x&lt;33 OR (x&gt;32 AND x&lt;68) OR x&gt;67)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse1 by partitions
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 3a6cc0e2_340c_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse2 by partitions
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 3a6cc0e2_340c_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse3 by partitions
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 3a6cc0e2_340c_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 3a6cc0e2_340c_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 3a6cc0e2_340c_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 3a6cc0e2_340c_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 3a6cc0e2_340c_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 3a6cc0e2_340c_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 3a6cc0e2_340c_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 3a6cc0e2_340c_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 3a6cc0e2_340c_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 3a6cc0e2_340c_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 3a6cc0e2_340c_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 3a6cc0e2_340c_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 3a6cc0e2_340c_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 3a6cc0e2_340c_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 3a6cc0e2_340c_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 3a6cc0e2_340c_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 3a6cc0e2_340c_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 3a6cc0e2_340c_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 3a6cc0e2_340c_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 3a6cc0e2_340c_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 3a6cc0e2_340c_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 3a6cc0e2_340c_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 3a6cc0e2_340c_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 3a6cc0e2_340c_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 3a6cc0e2_340c_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 3a6cc0e2_340c_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 3a6cc0e2_340c_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 3a6cc0e2_340c_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 3a6cc0e2_340c_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 3a6cc0e2_340c_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 3a6cc0e2_340c_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 3a6cc0e2_340c_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 3a6cc0e2_340c_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 3a6cc0e2_340c_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">18s 237ms</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedAggregatingMergeTree/replicated table deleting with overlap entire table</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table on different nodes with overlap.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated aggregating merge tree table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 5e3c963c_340c_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 5e3c963c_340c_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedAggregatingMergeTree(&#39;/clickhouse/tables/shard0/5e3c963c_340c_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 5e3c963c_340c_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 5e3c963c_340c_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedAggregatingMergeTree(&#39;/clickhouse/tables/shard0/5e3c963c_340c_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 5e3c963c_340c_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 5e3c963c_340c_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedAggregatingMergeTree(&#39;/clickhouse/tables/shard0/5e3c963c_340c_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO 5e3c963c_340c_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0,6),(0...&quot; &gt; /tmp/tmpm3l4nq03
                cat &quot;/tmp/tmpm3l4nq03&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 5e3c963c_340c_11ed_b9de_572e856b5561 WHERE NOT(x&lt;50 OR (x&gt;25 AND x&lt;75) OR x&gt;50)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse1
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 5e3c963c_340c_11ed_b9de_572e856b5561 WHERE x &lt; 50&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse2
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 5e3c963c_340c_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse3
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 5e3c963c_340c_11ed_b9de_572e856b5561 WHERE x &gt; 50&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 5e3c963c_340c_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 5e3c963c_340c_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 5e3c963c_340c_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 5e3c963c_340c_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 5e3c963c_340c_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 5e3c963c_340c_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">12s 375ms</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedAggregatingMergeTree/replicated table deleting with without overlap</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with without overlap</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting some rows in the table on different nodes.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated aggregating merge tree table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 6923f270_340c_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 6923f270_340c_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedAggregatingMergeTree(&#39;/clickhouse/tables/shard0/6923f270_340c_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 6923f270_340c_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 6923f270_340c_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedAggregatingMergeTree(&#39;/clickhouse/tables/shard0/6923f270_340c_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 6923f270_340c_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 6923f270_340c_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedAggregatingMergeTree(&#39;/clickhouse/tables/shard0/6923f270_340c_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO 6923f270_340c_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0,6),(0...&quot; &gt; /tmp/tmpq7vnwe_t
                cat &quot;/tmp/tmpq7vnwe_t&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 6923f270_340c_11ed_b9de_572e856b5561 WHERE NOT((x % 2 == 0 AND id &lt; 50) OR (x % 2 == 0 AND id &lt; 75 AND id &gt; 24))&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Step</span> delete odd rows from clickhouse1
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 6923f270_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          Step</span> delete odd rows from clickhouse2
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 6923f270_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 6923f270_340c_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 6923f270_340c_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 6923f270_340c_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 6923f270_340c_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 6923f270_340c_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 6923f270_340c_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">13s 218ms</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedAggregatingMergeTree/replicated table deleting without overlap entire table</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table on different nodes without overlap.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated aggregating merge tree table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 70a0e058_340c_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 70a0e058_340c_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedAggregatingMergeTree(&#39;/clickhouse/tables/shard0/70a0e058_340c_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 70a0e058_340c_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 70a0e058_340c_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedAggregatingMergeTree(&#39;/clickhouse/tables/shard0/70a0e058_340c_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 70a0e058_340c_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 70a0e058_340c_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedAggregatingMergeTree(&#39;/clickhouse/tables/shard0/70a0e058_340c_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO 70a0e058_340c_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0,6),(0...&quot; &gt; /tmp/tmpkj2niu60
                cat &quot;/tmp/tmpkj2niu60&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 70a0e058_340c_11ed_b9de_572e856b5561 WHERE NOT(x&lt;33 OR (x&gt;32 AND x&lt;68) OR x&gt;67)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse1
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 70a0e058_340c_11ed_b9de_572e856b5561 WHERE x &lt; 33&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse2
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 70a0e058_340c_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse3
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 70a0e058_340c_11ed_b9de_572e856b5561 WHERE x &gt; 67&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 70a0e058_340c_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 70a0e058_340c_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 70a0e058_340c_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 70a0e058_340c_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 70a0e058_340c_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 70a0e058_340c_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">1m 6s</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedCollapsingMergeTree/replicated table deleting in loop with overlap entire table</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop with overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table by partitions on different nodes with overlap.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated collapsing merge tree table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 7856dfe9_340c_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 7856dfe9_340c_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = ReplicatedCollapsingMergeTree(&#39;/clickhouse/tables/shard0/7856dfe9_340c_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;, Sign) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 7856dfe9_340c_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 7856dfe9_340c_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = ReplicatedCollapsingMergeTree(&#39;/clickhouse/tables/shard0/7856dfe9_340c_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;, Sign) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 7856dfe9_340c_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 7856dfe9_340c_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = ReplicatedCollapsingMergeTree(&#39;/clickhouse/tables/shard0/7856dfe9_340c_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;, Sign) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO 7856dfe9_340c_11ed_b9de_572e856b5561 VALUES (0,0,1),(0,1,1),(0,2,1),(0,3,1),(0,4,1),(0,5...&quot; &gt; /tmp/tmpuzw_r0d1
                cat &quot;/tmp/tmpuzw_r0d1&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 7856dfe9_340c_11ed_b9de_572e856b5561 WHERE NOT(x&lt;50 OR (x&gt;25 AND x&lt;75) OR x&gt;50)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse1
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 7856dfe9_340c_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse2
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 7856dfe9_340c_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse3
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 7856dfe9_340c_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 7856dfe9_340c_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 7856dfe9_340c_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 7856dfe9_340c_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 7856dfe9_340c_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 7856dfe9_340c_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 7856dfe9_340c_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 7856dfe9_340c_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 7856dfe9_340c_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 7856dfe9_340c_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 7856dfe9_340c_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 7856dfe9_340c_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 7856dfe9_340c_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 7856dfe9_340c_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 7856dfe9_340c_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 7856dfe9_340c_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 7856dfe9_340c_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 7856dfe9_340c_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 7856dfe9_340c_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 7856dfe9_340c_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 7856dfe9_340c_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 7856dfe9_340c_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 7856dfe9_340c_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 7856dfe9_340c_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 7856dfe9_340c_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 7856dfe9_340c_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 7856dfe9_340c_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 7856dfe9_340c_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 7856dfe9_340c_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 7856dfe9_340c_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 7856dfe9_340c_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 7856dfe9_340c_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 7856dfe9_340c_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 7856dfe9_340c_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">1m 0s</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedCollapsingMergeTree/replicated table deleting in loop with without overlap</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop with without overlap</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting some rows in the table by partitions on different nodes.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated collapsing merge tree table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table a0cc3818_340c_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE a0cc3818_340c_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = ReplicatedCollapsingMergeTree(&#39;/clickhouse/tables/shard0/a0cc3818_340c_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;, Sign) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table a0cc3818_340c_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE a0cc3818_340c_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = ReplicatedCollapsingMergeTree(&#39;/clickhouse/tables/shard0/a0cc3818_340c_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;, Sign) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table a0cc3818_340c_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE a0cc3818_340c_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = ReplicatedCollapsingMergeTree(&#39;/clickhouse/tables/shard0/a0cc3818_340c_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;, Sign) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO a0cc3818_340c_11ed_b9de_572e856b5561 VALUES (0,0,1),(0,1,1),(0,2,1),(0,3,1),(0,4,1),(0,5...&quot; &gt; /tmp/tmpw6hto9ef
                cat &quot;/tmp/tmpw6hto9ef&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM a0cc3818_340c_11ed_b9de_572e856b5561 WHERE NOT((x % 2 == 0 AND id &lt; 50) OR (x % 2 == 0 AND id &lt; 75 AND id &gt; 24))&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Step</span> delete odd rows from clickhouse1 by partitions
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc3818_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          Step</span> delete odd rows from clickhouse2 by partitions
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc3818_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc3818_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc3818_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc3818_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc3818_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc3818_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc3818_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc3818_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc3818_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc3818_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc3818_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc3818_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc3818_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc3818_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc3818_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc3818_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc3818_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc3818_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM a0cc3818_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM a0cc3818_340c_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM a0cc3818_340c_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM a0cc3818_340c_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS a0cc3818_340c_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS a0cc3818_340c_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS a0cc3818_340c_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">55s 987ms</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedCollapsingMergeTree/replicated table deleting in loop without overlap entire table</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop without overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table by partitions on different nodes without overlap.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated collapsing merge tree table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table c46539f9_340c_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE c46539f9_340c_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = ReplicatedCollapsingMergeTree(&#39;/clickhouse/tables/shard0/c46539f9_340c_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;, Sign) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table c46539f9_340c_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE c46539f9_340c_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = ReplicatedCollapsingMergeTree(&#39;/clickhouse/tables/shard0/c46539f9_340c_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;, Sign) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table c46539f9_340c_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE c46539f9_340c_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = ReplicatedCollapsingMergeTree(&#39;/clickhouse/tables/shard0/c46539f9_340c_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;, Sign) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO c46539f9_340c_11ed_b9de_572e856b5561 VALUES (0,0,1),(0,1,1),(0,2,1),(0,3,1),(0,4,1),(0,5...&quot; &gt; /tmp/tmpctzve_du
                cat &quot;/tmp/tmpctzve_du&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM c46539f9_340c_11ed_b9de_572e856b5561 WHERE NOT(x&lt;33 OR (x&gt;32 AND x&lt;68) OR x&gt;67)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse1 by partitions
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM c46539f9_340c_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse2 by partitions
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM c46539f9_340c_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse3 by partitions
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM c46539f9_340c_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM c46539f9_340c_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM c46539f9_340c_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM c46539f9_340c_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM c46539f9_340c_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM c46539f9_340c_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM c46539f9_340c_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM c46539f9_340c_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM c46539f9_340c_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM c46539f9_340c_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM c46539f9_340c_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM c46539f9_340c_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM c46539f9_340c_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM c46539f9_340c_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM c46539f9_340c_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM c46539f9_340c_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM c46539f9_340c_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM c46539f9_340c_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM c46539f9_340c_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM c46539f9_340c_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM c46539f9_340c_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM c46539f9_340c_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM c46539f9_340c_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM c46539f9_340c_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM c46539f9_340c_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM c46539f9_340c_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM c46539f9_340c_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM c46539f9_340c_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM c46539f9_340c_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM c46539f9_340c_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM c46539f9_340c_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS c46539f9_340c_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS c46539f9_340c_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS c46539f9_340c_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">17s 259ms</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedCollapsingMergeTree/replicated table deleting with overlap entire table</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table on different nodes with overlap.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated collapsing merge tree table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table e6265182_340c_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE e6265182_340c_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = ReplicatedCollapsingMergeTree(&#39;/clickhouse/tables/shard0/e6265182_340c_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;, Sign) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table e6265182_340c_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE e6265182_340c_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = ReplicatedCollapsingMergeTree(&#39;/clickhouse/tables/shard0/e6265182_340c_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;, Sign) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table e6265182_340c_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE e6265182_340c_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = ReplicatedCollapsingMergeTree(&#39;/clickhouse/tables/shard0/e6265182_340c_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;, Sign) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO e6265182_340c_11ed_b9de_572e856b5561 VALUES (0,0,1),(0,1,1),(0,2,1),(0,3,1),(0,4,1),(0,5...&quot; &gt; /tmp/tmp5tu21cd5
                cat &quot;/tmp/tmp5tu21cd5&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM e6265182_340c_11ed_b9de_572e856b5561 WHERE NOT(x&lt;50 OR (x&gt;25 AND x&lt;75) OR x&gt;50)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse1
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM e6265182_340c_11ed_b9de_572e856b5561 WHERE x &lt; 50&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse2
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM e6265182_340c_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse3
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM e6265182_340c_11ed_b9de_572e856b5561 WHERE x &gt; 50&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM e6265182_340c_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM e6265182_340c_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM e6265182_340c_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS e6265182_340c_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS e6265182_340c_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS e6265182_340c_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">14s 199ms</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedCollapsingMergeTree/replicated table deleting with without overlap</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with without overlap</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting some rows in the table on different nodes.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated collapsing merge tree table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table efaa730a_340c_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE efaa730a_340c_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = ReplicatedCollapsingMergeTree(&#39;/clickhouse/tables/shard0/efaa730a_340c_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;, Sign) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table efaa730a_340c_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE efaa730a_340c_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = ReplicatedCollapsingMergeTree(&#39;/clickhouse/tables/shard0/efaa730a_340c_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;, Sign) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table efaa730a_340c_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE efaa730a_340c_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = ReplicatedCollapsingMergeTree(&#39;/clickhouse/tables/shard0/efaa730a_340c_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;, Sign) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO efaa730a_340c_11ed_b9de_572e856b5561 VALUES (0,0,1),(0,1,1),(0,2,1),(0,3,1),(0,4,1),(0,5...&quot; &gt; /tmp/tmpgqotn1u5
                cat &quot;/tmp/tmpgqotn1u5&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM efaa730a_340c_11ed_b9de_572e856b5561 WHERE NOT((x % 2 == 0 AND id &lt; 50) OR (x % 2 == 0 AND id &lt; 75 AND id &gt; 24))&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Step</span> delete odd rows from clickhouse1
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM efaa730a_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          Step</span> delete odd rows from clickhouse2
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM efaa730a_340c_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM efaa730a_340c_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM efaa730a_340c_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM efaa730a_340c_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS efaa730a_340c_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS efaa730a_340c_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS efaa730a_340c_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">13s 655ms</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedCollapsingMergeTree/replicated table deleting without overlap entire table</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table on different nodes without overlap.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated collapsing merge tree table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table f8017b66_340c_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE f8017b66_340c_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = ReplicatedCollapsingMergeTree(&#39;/clickhouse/tables/shard0/f8017b66_340c_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;, Sign) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table f8017b66_340c_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE f8017b66_340c_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = ReplicatedCollapsingMergeTree(&#39;/clickhouse/tables/shard0/f8017b66_340c_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;, Sign) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table f8017b66_340c_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE f8017b66_340c_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = ReplicatedCollapsingMergeTree(&#39;/clickhouse/tables/shard0/f8017b66_340c_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;, Sign) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO f8017b66_340c_11ed_b9de_572e856b5561 VALUES (0,0,1),(0,1,1),(0,2,1),(0,3,1),(0,4,1),(0,5...&quot; &gt; /tmp/tmpol8w1dkc
                cat &quot;/tmp/tmpol8w1dkc&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM f8017b66_340c_11ed_b9de_572e856b5561 WHERE NOT(x&lt;33 OR (x&gt;32 AND x&lt;68) OR x&gt;67)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse1
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM f8017b66_340c_11ed_b9de_572e856b5561 WHERE x &lt; 33&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse2
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM f8017b66_340c_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse3
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM f8017b66_340c_11ed_b9de_572e856b5561 WHERE x &gt; 67&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM f8017b66_340c_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM f8017b66_340c_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM f8017b66_340c_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS f8017b66_340c_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS f8017b66_340c_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS f8017b66_340c_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">58s 197ms</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedVersionedCollapsingMergeTree/replicated table deleting in loop with overlap entire table</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop with overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table by partitions on different nodes with overlap.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated versioned collapsing merge tree table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 008d26d9_340d_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 008d26d9_340d_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = ReplicatedVersionedCollapsingMergeTree(&#39;/clickhouse/tables/shard0/008d26d9_340d_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;, Sign, id) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 008d26d9_340d_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 008d26d9_340d_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = ReplicatedVersionedCollapsingMergeTree(&#39;/clickhouse/tables/shard0/008d26d9_340d_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;, Sign, id) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 008d26d9_340d_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 008d26d9_340d_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = ReplicatedVersionedCollapsingMergeTree(&#39;/clickhouse/tables/shard0/008d26d9_340d_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;, Sign, id) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO 008d26d9_340d_11ed_b9de_572e856b5561 VALUES (0,0,1),(0,1,1),(0,2,1),(0,3,1),(0,4,1),(0,5...&quot; &gt; /tmp/tmpk41quivl
                cat &quot;/tmp/tmpk41quivl&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 008d26d9_340d_11ed_b9de_572e856b5561 WHERE NOT(x&lt;50 OR (x&gt;25 AND x&lt;75) OR x&gt;50)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse1
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 008d26d9_340d_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse2
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 008d26d9_340d_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse3
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 008d26d9_340d_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 008d26d9_340d_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 008d26d9_340d_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 008d26d9_340d_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 008d26d9_340d_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 008d26d9_340d_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 008d26d9_340d_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 008d26d9_340d_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 008d26d9_340d_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 008d26d9_340d_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 008d26d9_340d_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 008d26d9_340d_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 008d26d9_340d_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 008d26d9_340d_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 008d26d9_340d_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 008d26d9_340d_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 008d26d9_340d_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 008d26d9_340d_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 008d26d9_340d_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 008d26d9_340d_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 008d26d9_340d_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 008d26d9_340d_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 008d26d9_340d_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 008d26d9_340d_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 008d26d9_340d_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 008d26d9_340d_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 008d26d9_340d_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 008d26d9_340d_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 008d26d9_340d_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 008d26d9_340d_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 008d26d9_340d_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 008d26d9_340d_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 008d26d9_340d_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 008d26d9_340d_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">55s 29ms</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedVersionedCollapsingMergeTree/replicated table deleting in loop with without overlap</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop with without overlap</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting some rows in the table by partitions on different nodes.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated versioned collapsing merge tree table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 22ba2cb8_340d_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 22ba2cb8_340d_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = ReplicatedVersionedCollapsingMergeTree(&#39;/clickhouse/tables/shard0/22ba2cb8_340d_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;, Sign, id) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 22ba2cb8_340d_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 22ba2cb8_340d_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = ReplicatedVersionedCollapsingMergeTree(&#39;/clickhouse/tables/shard0/22ba2cb8_340d_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;, Sign, id) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 22ba2cb8_340d_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 22ba2cb8_340d_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = ReplicatedVersionedCollapsingMergeTree(&#39;/clickhouse/tables/shard0/22ba2cb8_340d_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;, Sign, id) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO 22ba2cb8_340d_11ed_b9de_572e856b5561 VALUES (0,0,1),(0,1,1),(0,2,1),(0,3,1),(0,4,1),(0,5...&quot; &gt; /tmp/tmpi0i6p8k1
                cat &quot;/tmp/tmpi0i6p8k1&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 22ba2cb8_340d_11ed_b9de_572e856b5561 WHERE NOT((x % 2 == 0 AND id &lt; 50) OR (x % 2 == 0 AND id &lt; 75 AND id &gt; 24))&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Step</span> delete odd rows from clickhouse1 by partitions
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 22ba2cb8_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          Step</span> delete odd rows from clickhouse2 by partitions
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 22ba2cb8_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 22ba2cb8_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 22ba2cb8_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 22ba2cb8_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 22ba2cb8_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 22ba2cb8_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 22ba2cb8_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 22ba2cb8_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 22ba2cb8_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 22ba2cb8_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 22ba2cb8_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 22ba2cb8_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 22ba2cb8_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 22ba2cb8_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 22ba2cb8_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 22ba2cb8_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 22ba2cb8_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 22ba2cb8_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 22ba2cb8_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 22ba2cb8_340d_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 22ba2cb8_340d_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 22ba2cb8_340d_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 22ba2cb8_340d_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 22ba2cb8_340d_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 22ba2cb8_340d_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">1m 12s</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedVersionedCollapsingMergeTree/replicated table deleting in loop without overlap entire table</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop without overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table by partitions on different nodes without overlap.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated versioned collapsing merge tree table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 4392c288_340d_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 4392c288_340d_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = ReplicatedVersionedCollapsingMergeTree(&#39;/clickhouse/tables/shard0/4392c288_340d_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;, Sign, id) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 4392c288_340d_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 4392c288_340d_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = ReplicatedVersionedCollapsingMergeTree(&#39;/clickhouse/tables/shard0/4392c288_340d_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;, Sign, id) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 4392c288_340d_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 4392c288_340d_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = ReplicatedVersionedCollapsingMergeTree(&#39;/clickhouse/tables/shard0/4392c288_340d_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;, Sign, id) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO 4392c288_340d_11ed_b9de_572e856b5561 VALUES (0,0,1),(0,1,1),(0,2,1),(0,3,1),(0,4,1),(0,5...&quot; &gt; /tmp/tmpbpjhtrgi
                cat &quot;/tmp/tmpbpjhtrgi&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 4392c288_340d_11ed_b9de_572e856b5561 WHERE NOT(x&lt;33 OR (x&gt;32 AND x&lt;68) OR x&gt;67)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse1 by partitions
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 4392c288_340d_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse2 by partitions
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 4392c288_340d_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse3 by partitions
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 4392c288_340d_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 4392c288_340d_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 4392c288_340d_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 4392c288_340d_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 4392c288_340d_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 4392c288_340d_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 4392c288_340d_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 4392c288_340d_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 4392c288_340d_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 4392c288_340d_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 4392c288_340d_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 4392c288_340d_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 4392c288_340d_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 4392c288_340d_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 4392c288_340d_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 4392c288_340d_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 4392c288_340d_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 4392c288_340d_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 4392c288_340d_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 4392c288_340d_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 4392c288_340d_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 4392c288_340d_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 4392c288_340d_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 4392c288_340d_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 4392c288_340d_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 4392c288_340d_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 4392c288_340d_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 4392c288_340d_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 4392c288_340d_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 4392c288_340d_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 4392c288_340d_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 4392c288_340d_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 4392c288_340d_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 4392c288_340d_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">16s 592ms</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedVersionedCollapsingMergeTree/replicated table deleting with overlap entire table</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table on different nodes with overlap.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated versioned collapsing merge tree table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 6ffa378e_340d_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 6ffa378e_340d_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = ReplicatedVersionedCollapsingMergeTree(&#39;/clickhouse/tables/shard0/6ffa378e_340d_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;, Sign, id) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 6ffa378e_340d_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 6ffa378e_340d_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = ReplicatedVersionedCollapsingMergeTree(&#39;/clickhouse/tables/shard0/6ffa378e_340d_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;, Sign, id) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 6ffa378e_340d_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 6ffa378e_340d_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = ReplicatedVersionedCollapsingMergeTree(&#39;/clickhouse/tables/shard0/6ffa378e_340d_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;, Sign, id) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO 6ffa378e_340d_11ed_b9de_572e856b5561 VALUES (0,0,1),(0,1,1),(0,2,1),(0,3,1),(0,4,1),(0,5...&quot; &gt; /tmp/tmpyge4owjm
                cat &quot;/tmp/tmpyge4owjm&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 6ffa378e_340d_11ed_b9de_572e856b5561 WHERE NOT(x&lt;50 OR (x&gt;25 AND x&lt;75) OR x&gt;50)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse1
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 6ffa378e_340d_11ed_b9de_572e856b5561 WHERE x &lt; 50&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse2
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 6ffa378e_340d_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse3
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 6ffa378e_340d_11ed_b9de_572e856b5561 WHERE x &gt; 50&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 6ffa378e_340d_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 6ffa378e_340d_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 6ffa378e_340d_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 6ffa378e_340d_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 6ffa378e_340d_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 6ffa378e_340d_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">13s 159ms</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedVersionedCollapsingMergeTree/replicated table deleting with without overlap</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with without overlap</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting some rows in the table on different nodes.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated versioned collapsing merge tree table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 792dbaec_340d_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 792dbaec_340d_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = ReplicatedVersionedCollapsingMergeTree(&#39;/clickhouse/tables/shard0/792dbaec_340d_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;, Sign, id) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 792dbaec_340d_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 792dbaec_340d_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = ReplicatedVersionedCollapsingMergeTree(&#39;/clickhouse/tables/shard0/792dbaec_340d_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;, Sign, id) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 792dbaec_340d_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 792dbaec_340d_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = ReplicatedVersionedCollapsingMergeTree(&#39;/clickhouse/tables/shard0/792dbaec_340d_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;, Sign, id) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO 792dbaec_340d_11ed_b9de_572e856b5561 VALUES (0,0,1),(0,1,1),(0,2,1),(0,3,1),(0,4,1),(0,5...&quot; &gt; /tmp/tmprdo_70sf
                cat &quot;/tmp/tmprdo_70sf&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 792dbaec_340d_11ed_b9de_572e856b5561 WHERE NOT((x % 2 == 0 AND id &lt; 50) OR (x % 2 == 0 AND id &lt; 75 AND id &gt; 24))&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Step</span> delete odd rows from clickhouse1
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 792dbaec_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          Step</span> delete odd rows from clickhouse2
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 792dbaec_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 792dbaec_340d_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 792dbaec_340d_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 792dbaec_340d_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 792dbaec_340d_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 792dbaec_340d_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 792dbaec_340d_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">20s 899ms</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedVersionedCollapsingMergeTree/replicated table deleting without overlap entire table</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table on different nodes without overlap.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated versioned collapsing merge tree table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 815da2f3_340d_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 815da2f3_340d_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = ReplicatedVersionedCollapsingMergeTree(&#39;/clickhouse/tables/shard0/815da2f3_340d_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;, Sign, id) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 815da2f3_340d_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 815da2f3_340d_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = ReplicatedVersionedCollapsingMergeTree(&#39;/clickhouse/tables/shard0/815da2f3_340d_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;, Sign, id) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 815da2f3_340d_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 815da2f3_340d_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = ReplicatedVersionedCollapsingMergeTree(&#39;/clickhouse/tables/shard0/815da2f3_340d_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;, Sign, id) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO 815da2f3_340d_11ed_b9de_572e856b5561 VALUES (0,0,1),(0,1,1),(0,2,1),(0,3,1),(0,4,1),(0,5...&quot; &gt; /tmp/tmpi_lcvy8o
                cat &quot;/tmp/tmpi_lcvy8o&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 815da2f3_340d_11ed_b9de_572e856b5561 WHERE NOT(x&lt;33 OR (x&gt;32 AND x&lt;68) OR x&gt;67)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse1
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 815da2f3_340d_11ed_b9de_572e856b5561 WHERE x &lt; 33&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse2
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 815da2f3_340d_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse3
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 815da2f3_340d_11ed_b9de_572e856b5561 WHERE x &gt; 67&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 815da2f3_340d_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 815da2f3_340d_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 815da2f3_340d_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 815da2f3_340d_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 815da2f3_340d_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 815da2f3_340d_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">1m 0s</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedGraphiteMergeTree/replicated table deleting in loop with overlap entire table</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop with overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table by partitions on different nodes with overlap.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated graphite merge tree table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 8e2b2293_340d_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 8e2b2293_340d_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Path String, Time DateTime, Value Int64, Timestamp Int64) Engine = ReplicatedGraphiteMergeTree(&#39;/clickhouse/tables/shard0/8e2b2293_340d_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;, &#39;graphite_rollup_example&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 8e2b2293_340d_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 8e2b2293_340d_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Path String, Time DateTime, Value Int64, Timestamp Int64) Engine = ReplicatedGraphiteMergeTree(&#39;/clickhouse/tables/shard0/8e2b2293_340d_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;, &#39;graphite_rollup_example&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 8e2b2293_340d_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 8e2b2293_340d_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Path String, Time DateTime, Value Int64, Timestamp Int64) Engine = ReplicatedGraphiteMergeTree(&#39;/clickhouse/tables/shard0/8e2b2293_340d_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;, &#39;graphite_rollup_example&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO 8e2b2293_340d_11ed_b9de_572e856b5561 VALUES (0,0, &#39;1&#39;, toDateTime(10), 10, 10),(0,1, &#39;1&#39;...&quot; &gt; /tmp/tmpx8ccgigu
                cat &quot;/tmp/tmpx8ccgigu&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 8e2b2293_340d_11ed_b9de_572e856b5561 WHERE NOT(x&lt;50 OR (x&gt;25 AND x&lt;75) OR x&gt;50)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse1
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8e2b2293_340d_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse2
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8e2b2293_340d_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse3
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8e2b2293_340d_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8e2b2293_340d_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8e2b2293_340d_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8e2b2293_340d_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8e2b2293_340d_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8e2b2293_340d_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8e2b2293_340d_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8e2b2293_340d_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8e2b2293_340d_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8e2b2293_340d_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8e2b2293_340d_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8e2b2293_340d_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8e2b2293_340d_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8e2b2293_340d_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8e2b2293_340d_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8e2b2293_340d_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8e2b2293_340d_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8e2b2293_340d_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8e2b2293_340d_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8e2b2293_340d_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8e2b2293_340d_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8e2b2293_340d_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8e2b2293_340d_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8e2b2293_340d_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8e2b2293_340d_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8e2b2293_340d_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8e2b2293_340d_11ed_b9de_572e856b5561 WHERE x &lt; 50 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8e2b2293_340d_11ed_b9de_572e856b5561 WHERE x &gt; 50 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 8e2b2293_340d_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 8e2b2293_340d_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 8e2b2293_340d_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 8e2b2293_340d_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 8e2b2293_340d_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 8e2b2293_340d_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">52s 294ms</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedGraphiteMergeTree/replicated table deleting in loop with without overlap</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop with without overlap</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting some rows in the table by partitions on different nodes.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated graphite merge tree table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table b1f063e8_340d_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE b1f063e8_340d_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Path String, Time DateTime, Value Int64, Timestamp Int64) Engine = ReplicatedGraphiteMergeTree(&#39;/clickhouse/tables/shard0/b1f063e8_340d_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;, &#39;graphite_rollup_example&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table b1f063e8_340d_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE b1f063e8_340d_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Path String, Time DateTime, Value Int64, Timestamp Int64) Engine = ReplicatedGraphiteMergeTree(&#39;/clickhouse/tables/shard0/b1f063e8_340d_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;, &#39;graphite_rollup_example&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table b1f063e8_340d_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE b1f063e8_340d_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Path String, Time DateTime, Value Int64, Timestamp Int64) Engine = ReplicatedGraphiteMergeTree(&#39;/clickhouse/tables/shard0/b1f063e8_340d_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;, &#39;graphite_rollup_example&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO b1f063e8_340d_11ed_b9de_572e856b5561 VALUES (0,0, &#39;1&#39;, toDateTime(10), 10, 10),(0,1, &#39;1&#39;...&quot; &gt; /tmp/tmplecnfi7d
                cat &quot;/tmp/tmplecnfi7d&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM b1f063e8_340d_11ed_b9de_572e856b5561 WHERE NOT((x % 2 == 0 AND id &lt; 50) OR (x % 2 == 0 AND id &lt; 75 AND id &gt; 24))&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Step</span> delete odd rows from clickhouse1 by partitions
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM b1f063e8_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          Step</span> delete odd rows from clickhouse2 by partitions
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM b1f063e8_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM b1f063e8_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM b1f063e8_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM b1f063e8_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM b1f063e8_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM b1f063e8_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM b1f063e8_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM b1f063e8_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM b1f063e8_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM b1f063e8_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM b1f063e8_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM b1f063e8_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM b1f063e8_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM b1f063e8_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM b1f063e8_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM b1f063e8_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM b1f063e8_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM b1f063e8_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM b1f063e8_340d_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM b1f063e8_340d_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM b1f063e8_340d_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM b1f063e8_340d_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS b1f063e8_340d_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS b1f063e8_340d_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS b1f063e8_340d_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">1m 6s</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedGraphiteMergeTree/replicated table deleting in loop without overlap entire table</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop without overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table by partitions on different nodes without overlap.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated graphite merge tree table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table d05792e8_340d_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE d05792e8_340d_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Path String, Time DateTime, Value Int64, Timestamp Int64) Engine = ReplicatedGraphiteMergeTree(&#39;/clickhouse/tables/shard0/d05792e8_340d_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;, &#39;graphite_rollup_example&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table d05792e8_340d_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE d05792e8_340d_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Path String, Time DateTime, Value Int64, Timestamp Int64) Engine = ReplicatedGraphiteMergeTree(&#39;/clickhouse/tables/shard0/d05792e8_340d_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;, &#39;graphite_rollup_example&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table d05792e8_340d_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE d05792e8_340d_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Path String, Time DateTime, Value Int64, Timestamp Int64) Engine = ReplicatedGraphiteMergeTree(&#39;/clickhouse/tables/shard0/d05792e8_340d_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;, &#39;graphite_rollup_example&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO d05792e8_340d_11ed_b9de_572e856b5561 VALUES (0,0, &#39;1&#39;, toDateTime(10), 10, 10),(0,1, &#39;1&#39;...&quot; &gt; /tmp/tmpxjubwxh5
                cat &quot;/tmp/tmpxjubwxh5&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM d05792e8_340d_11ed_b9de_572e856b5561 WHERE NOT(x&lt;33 OR (x&gt;32 AND x&lt;68) OR x&gt;67)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse1 by partitions
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM d05792e8_340d_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse2 by partitions
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM d05792e8_340d_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse3 by partitions
            Delete in loop by partitions.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM d05792e8_340d_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM d05792e8_340d_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM d05792e8_340d_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM d05792e8_340d_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM d05792e8_340d_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM d05792e8_340d_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM d05792e8_340d_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 2&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM d05792e8_340d_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM d05792e8_340d_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM d05792e8_340d_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 3&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM d05792e8_340d_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM d05792e8_340d_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM d05792e8_340d_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 4&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM d05792e8_340d_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM d05792e8_340d_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM d05792e8_340d_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM d05792e8_340d_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM d05792e8_340d_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM d05792e8_340d_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 6&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM d05792e8_340d_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM d05792e8_340d_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM d05792e8_340d_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 7&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM d05792e8_340d_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM d05792e8_340d_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM d05792e8_340d_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 8&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM d05792e8_340d_11ed_b9de_572e856b5561 WHERE x &gt; 67 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM d05792e8_340d_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM d05792e8_340d_11ed_b9de_572e856b5561 WHERE x &lt; 33 AND id = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM d05792e8_340d_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM d05792e8_340d_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM d05792e8_340d_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS d05792e8_340d_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS d05792e8_340d_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS d05792e8_340d_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">16s 221ms</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedGraphiteMergeTree/replicated table deleting with overlap entire table</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table on different nodes with overlap.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated graphite merge tree table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table f862aa1f_340d_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE f862aa1f_340d_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Path String, Time DateTime, Value Int64, Timestamp Int64) Engine = ReplicatedGraphiteMergeTree(&#39;/clickhouse/tables/shard0/f862aa1f_340d_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;, &#39;graphite_rollup_example&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table f862aa1f_340d_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE f862aa1f_340d_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Path String, Time DateTime, Value Int64, Timestamp Int64) Engine = ReplicatedGraphiteMergeTree(&#39;/clickhouse/tables/shard0/f862aa1f_340d_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;, &#39;graphite_rollup_example&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table f862aa1f_340d_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE f862aa1f_340d_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Path String, Time DateTime, Value Int64, Timestamp Int64) Engine = ReplicatedGraphiteMergeTree(&#39;/clickhouse/tables/shard0/f862aa1f_340d_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;, &#39;graphite_rollup_example&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO f862aa1f_340d_11ed_b9de_572e856b5561 VALUES (0,0, &#39;1&#39;, toDateTime(10), 10, 10),(0,1, &#39;1&#39;...&quot; &gt; /tmp/tmp8sv1hu0u
                cat &quot;/tmp/tmp8sv1hu0u&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM f862aa1f_340d_11ed_b9de_572e856b5561 WHERE NOT(x&lt;50 OR (x&gt;25 AND x&lt;75) OR x&gt;50)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse1
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM f862aa1f_340d_11ed_b9de_572e856b5561 WHERE x &lt; 50&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse2
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM f862aa1f_340d_11ed_b9de_572e856b5561 WHERE x &gt; 25 AND x &lt; 75&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting from clickhouse3
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM f862aa1f_340d_11ed_b9de_572e856b5561 WHERE x &gt; 50&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM f862aa1f_340d_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM f862aa1f_340d_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM f862aa1f_340d_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS f862aa1f_340d_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS f862aa1f_340d_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS f862aa1f_340d_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">11s 139ms</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedGraphiteMergeTree/replicated table deleting with without overlap</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with without overlap</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting some rows in the table on different nodes.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated graphite merge tree table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 0260a838_340e_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 0260a838_340e_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Path String, Time DateTime, Value Int64, Timestamp Int64) Engine = ReplicatedGraphiteMergeTree(&#39;/clickhouse/tables/shard0/0260a838_340e_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;, &#39;graphite_rollup_example&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 0260a838_340e_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 0260a838_340e_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Path String, Time DateTime, Value Int64, Timestamp Int64) Engine = ReplicatedGraphiteMergeTree(&#39;/clickhouse/tables/shard0/0260a838_340e_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;, &#39;graphite_rollup_example&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 0260a838_340e_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 0260a838_340e_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Path String, Time DateTime, Value Int64, Timestamp Int64) Engine = ReplicatedGraphiteMergeTree(&#39;/clickhouse/tables/shard0/0260a838_340e_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;, &#39;graphite_rollup_example&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO 0260a838_340e_11ed_b9de_572e856b5561 VALUES (0,0, &#39;1&#39;, toDateTime(10), 10, 10),(0,1, &#39;1&#39;...&quot; &gt; /tmp/tmp6yw0rs_8
                cat &quot;/tmp/tmp6yw0rs_8&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 0260a838_340e_11ed_b9de_572e856b5561 WHERE NOT((x % 2 == 0 AND id &lt; 50) OR (x % 2 == 0 AND id &lt; 75 AND id &gt; 24))&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Step</span> delete odd rows from clickhouse1
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 0260a838_340e_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 50&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          Step</span> delete odd rows from clickhouse2
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 0260a838_340e_11ed_b9de_572e856b5561 WHERE x % 2 == 0 AND id &lt; 75 AND id &gt; 24&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 0260a838_340e_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 0260a838_340e_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 0260a838_340e_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 0260a838_340e_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 0260a838_340e_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 0260a838_340e_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">13s 882ms</span>/lightweight delete/replicated tables concurrent deletes/ReplicatedGraphiteMergeTree/replicated table deleting without overlap entire table</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table on different nodes without overlap.
<span class="k">        When</span> create table
          Create table with engine specifying.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated graphite merge tree table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 09003118_340e_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 09003118_340e_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Path String, Time DateTime, Value Int64, Timestamp Int64) Engine = ReplicatedGraphiteMergeTree(&#39;/clickhouse/tables/shard0/09003118_340e_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;, &#39;graphite_rollup_example&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 09003118_340e_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 09003118_340e_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Path String, Time DateTime, Value Int64, Timestamp Int64) Engine = ReplicatedGraphiteMergeTree(&#39;/clickhouse/tables/shard0/09003118_340e_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;, &#39;graphite_rollup_example&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 09003118_340e_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 09003118_340e_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Path String, Time DateTime, Value Int64, Timestamp Int64) Engine = ReplicatedGraphiteMergeTree(&#39;/clickhouse/tables/shard0/09003118_340e_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;, &#39;graphite_rollup_example&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> insert replicated
          Insert data into replicated table.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO 09003118_340e_11ed_b9de_572e856b5561 VALUES (0,0, &#39;1&#39;, toDateTime(10), 10, 10),(0,1, &#39;1&#39;...&quot; &gt; /tmp/tmpbbvb3n9u
                cat &quot;/tmp/tmpbbvb3n9u&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 09003118_340e_11ed_b9de_572e856b5561 WHERE NOT(x&lt;33 OR (x&gt;32 AND x&lt;68) OR x&gt;67)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse1
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 09003118_340e_11ed_b9de_572e856b5561 WHERE x &lt; 33&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse2
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 09003118_340e_11ed_b9de_572e856b5561 WHERE x &gt; 32 AND x &lt; 68&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Step</span> delete from clickhouse3
            Delete rows from table that match the condition.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 09003118_340e_11ed_b9de_572e856b5561 WHERE x &gt; 67&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Then</span> check query on all nodes
            Run query on all nodes and compare its result with `output`
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 09003118_340e_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse2 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 09003118_340e_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> I expect data is correct on clickhouse3 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 09003118_340e_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 09003118_340e_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 09003118_340e_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 09003118_340e_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">25s 832ms</span>/lightweight delete/distributed tables</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">  </span><span class="kn">Feature</span><span class="nn"> distributed tables</span>
    Check that clickhouse supports delete statement with distributed tables.
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> distributed table replicated</span>
      Check that ClickHouse supports delete statement for distributed tables
      when distributed table configuration contains 1 shard and 3 replicas.
<span class="rx">    XFail</span> distributed table replicated, engine type not supported.
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> distributed table sharded</span>
      Check that ClickHouse supports delete statement for distributed tables
      when distributed table configuration contains 3 shard 1 replica in each.
<span class="ro">    OK</span>
<span class="ro">  OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">13m 55s</span>/lightweight delete/replicated tables</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">  </span><span class="kn">Feature</span><span class="nn"> replicated tables</span>
    Check that delete operations replicate in an eventually consistent manner between replicas.
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap entire table</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with without overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap entire table</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedReplacingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap entire table</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with without overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap entire table</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedSummingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap entire table</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with without overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap entire table</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedAggregatingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap entire table</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with without overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap entire table</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedCollapsingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap entire table</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with without overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap entire table</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedVersionedCollapsingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap entire table</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with without overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap entire table</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedGraphiteMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap entire table</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with without overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap entire table</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span>
<span class="ro">  OK</span>
</code></pre></div>


</div>

<section class="requirement"><span class="requirement-inline"><i class="utf-icon color-ok">✔</i>RQ.SRS-023.ClickHouse.LightweightDelete.MultipleReplicas</span></section>

<div class="requirement-description hidden">

<p><a target="_blank" rel="nofollow noopener noreferrer" href="https://clickhouse.yandex">ClickHouse</a> SHALL support <code>DELETE</code> removing data from multiple replicas.</p>

</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">13m 55s</span>/lightweight delete/replicated tables</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">  </span><span class="kn">Feature</span><span class="nn"> replicated tables</span>
    Check that delete operations replicate in an eventually consistent manner between replicas.
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap entire table</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with without overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap entire table</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedReplacingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap entire table</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with without overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap entire table</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedSummingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap entire table</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with without overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap entire table</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedAggregatingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap entire table</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with without overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap entire table</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedCollapsingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap entire table</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with without overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap entire table</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedVersionedCollapsingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap entire table</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with without overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap entire table</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedGraphiteMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap entire table</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with without overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap entire table</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span>
<span class="ro">  OK</span>
</code></pre></div>


</div>

<section class="requirement"><span class="requirement-inline"><i class="utf-icon color-fail">✘</i>RQ.SRS-023.ClickHouse.LightweightDelete.ReplicationQueue</span></section>

<div class="requirement-description hidden">

<p><a target="_blank" rel="nofollow noopener noreferrer" href="https://clickhouse.yandex">ClickHouse</a> SHALL push <code>DELETE</code> statements to the replication queue.</p>

</div>

<div class="test"><span class="result result-inline result-xfail">XFail</span><span class="time time-inline">1m 7s</span>/lightweight delete/replication queue/ReplicatedMergeTree/replication queue</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replication queue</span>
        Check that clickhouse writes delete statement in replication queue correctly
        by creating replicated table, deleting from it and checking that DELETE statement
        appeared in system.replication_queue table.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 26c8e280_3419_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 26c8e280_3419_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedMergeTree(&#39;/clickhouse/tables/shard0/26c8e280_3419_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 26c8e280_3419_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 26c8e280_3419_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedMergeTree(&#39;/clickhouse/tables/shard0/26c8e280_3419_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 26c8e280_3419_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 26c8e280_3419_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedMergeTree(&#39;/clickhouse/tables/shard0/26c8e280_3419_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I insert data in the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO 26c8e280_3419_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0,6),(0...&quot; &gt; /tmp/tmpnefk6zh7
                cat &quot;/tmp/tmpnefk6zh7&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 26c8e280_3419_11ed_b9de_572e856b5561 WHERE NOT(x % 2 == 0)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I delete odd rows from table on clickhouse1 node
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I delete odd rows from table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 26c8e280_3419_11ed_b9de_572e856b5561 WHERE x % 2 == 0&quot; | clickhouse client -n --mutations_sync &quot;0&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check replication queue
<span class="rf">        Fail</span> I check replication queue, AssertionError
          Retry try #0
<span class="rf">          Fail</span> try #0, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT create_time FROM system.replication_queue WHERE table=&#39;26c8e280_3419_11ed_b9de_572e856b5561&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #1
<span class="rf">          Fail</span> try #1, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT create_time FROM system.replication_queue WHERE table=&#39;26c8e280_3419_11ed_b9de_572e856b5561&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #2
<span class="rf">          Fail</span> try #2, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT create_time FROM system.replication_queue WHERE table=&#39;26c8e280_3419_11ed_b9de_572e856b5561&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT create_time FROM system.replication_queue WHERE table=&#39;26c8e280_3419_11ed_b9de_572e856b5561&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #0
<span class="rf">          Fail</span> try #0, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%26c8e280_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #1
<span class="rf">          Fail</span> try #1, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%26c8e280_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #2
<span class="rf">          Fail</span> try #2, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%26c8e280_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #3
<span class="rf">          Fail</span> try #3, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%26c8e280_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #4
<span class="rf">          Fail</span> try #4, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%26c8e280_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #5
<span class="rf">          Fail</span> try #5, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%26c8e280_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #6
<span class="rf">          Fail</span> try #6, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%26c8e280_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #7
<span class="rf">          Fail</span> try #7, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%26c8e280_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #8
<span class="rf">          Fail</span> try #8, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%26c8e280_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #9
<span class="rf">          Fail</span> try #9, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%26c8e280_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #10
<span class="rf">          Fail</span> try #10, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%26c8e280_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #11
<span class="rf">          Fail</span> try #11, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%26c8e280_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #12
<span class="rf">          Fail</span> try #12, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%26c8e280_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #13
<span class="rf">          Fail</span> try #13, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%26c8e280_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #14
<span class="rf">          Fail</span> try #14, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%26c8e280_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #15
<span class="rf">          Fail</span> try #15, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%26c8e280_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #16
<span class="rf">          Fail</span> try #16, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%26c8e280_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #17
<span class="rf">          Fail</span> try #17, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%26c8e280_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #18
<span class="rf">          Fail</span> try #18, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%26c8e280_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #19
<span class="rf">          Fail</span> try #19, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%26c8e280_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #20
<span class="rf">          Fail</span> try #20, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%26c8e280_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #21
<span class="rf">          Fail</span> try #21, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%26c8e280_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #22
<span class="rf">          Fail</span> try #22, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%26c8e280_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #23
<span class="rf">          Fail</span> try #23, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%26c8e280_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #24
<span class="rf">          Fail</span> try #24, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%26c8e280_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #25
<span class="rf">          Fail</span> try #25, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%26c8e280_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 26c8e280_3419_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 26c8e280_3419_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 26c8e280_3419_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="rx"></span>
<span class="rx">      XFail</span> replication queue, engine type not supported.
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-xfail">XFail</span><span class="time time-inline">1m 46s</span>/lightweight delete/replication queue/ReplicatedReplacingMergeTree/replication queue</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replication queue</span>
        Check that clickhouse writes delete statement in replication queue correctly
        by creating replicated table, deleting from it and checking that DELETE statement
        appeared in system.replication_queue table.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated replacing merge tree table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 4f02c58d_3419_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 4f02c58d_3419_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedReplacingMergeTree(&#39;/clickhouse/tables/shard0/4f02c58d_3419_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 4f02c58d_3419_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 4f02c58d_3419_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedReplacingMergeTree(&#39;/clickhouse/tables/shard0/4f02c58d_3419_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 4f02c58d_3419_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 4f02c58d_3419_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedReplacingMergeTree(&#39;/clickhouse/tables/shard0/4f02c58d_3419_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I insert data in the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO 4f02c58d_3419_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0,6),(0...&quot; &gt; /tmp/tmp1rj6kena
                cat &quot;/tmp/tmp1rj6kena&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 4f02c58d_3419_11ed_b9de_572e856b5561 WHERE NOT(x % 2 == 0)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I delete odd rows from table on clickhouse1 node
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I delete odd rows from table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 4f02c58d_3419_11ed_b9de_572e856b5561 WHERE x % 2 == 0&quot; | clickhouse client -n --mutations_sync &quot;0&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check replication queue
<span class="rf">        Fail</span> I check replication queue, AssertionError
          Retry try #0
<span class="rf">          Fail</span> try #0, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT create_time FROM system.replication_queue WHERE table=&#39;4f02c58d_3419_11ed_b9de_572e856b5561&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #1
<span class="rf">          Fail</span> try #1, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT create_time FROM system.replication_queue WHERE table=&#39;4f02c58d_3419_11ed_b9de_572e856b5561&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #2
<span class="rf">          Fail</span> try #2, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT create_time FROM system.replication_queue WHERE table=&#39;4f02c58d_3419_11ed_b9de_572e856b5561&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT create_time FROM system.replication_queue WHERE table=&#39;4f02c58d_3419_11ed_b9de_572e856b5561&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #0
<span class="rf">          Fail</span> try #0, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%4f02c58d_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #1
<span class="rf">          Fail</span> try #1, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%4f02c58d_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #2
<span class="rf">          Fail</span> try #2, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%4f02c58d_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #3
<span class="rf">          Fail</span> try #3, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%4f02c58d_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #4
<span class="rf">          Fail</span> try #4, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%4f02c58d_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #5
<span class="rf">          Fail</span> try #5, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%4f02c58d_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #6
<span class="rf">          Fail</span> try #6, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%4f02c58d_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #7
<span class="rf">          Fail</span> try #7, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%4f02c58d_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #8
<span class="rf">          Fail</span> try #8, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%4f02c58d_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #9
<span class="rf">          Fail</span> try #9, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%4f02c58d_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #10
<span class="rf">          Fail</span> try #10, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%4f02c58d_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #11
<span class="rf">          Fail</span> try #11, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%4f02c58d_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #12
<span class="rf">          Fail</span> try #12, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%4f02c58d_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #13
<span class="rf">          Fail</span> try #13, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%4f02c58d_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #14
<span class="rf">          Fail</span> try #14, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%4f02c58d_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #15
<span class="rf">          Fail</span> try #15, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%4f02c58d_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #16
<span class="rf">          Fail</span> try #16, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%4f02c58d_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #17
<span class="rf">          Fail</span> try #17, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%4f02c58d_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #18
<span class="rf">          Fail</span> try #18, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%4f02c58d_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #19
<span class="rf">          Fail</span> try #19, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%4f02c58d_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #20
<span class="rf">          Fail</span> try #20, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%4f02c58d_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #21
<span class="rf">          Fail</span> try #21, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%4f02c58d_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #22
<span class="rf">          Fail</span> try #22, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%4f02c58d_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #23
<span class="rf">          Fail</span> try #23, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%4f02c58d_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #24
<span class="rf">          Fail</span> try #24, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%4f02c58d_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 4f02c58d_3419_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 4f02c58d_3419_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 4f02c58d_3419_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="rx"></span>
<span class="rx">      XFail</span> replication queue, engine type not supported.
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-xfail">XFail</span><span class="time time-inline">1m 4s</span>/lightweight delete/replication queue/ReplicatedSummingMergeTree/replication queue</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replication queue</span>
        Check that clickhouse writes delete statement in replication queue correctly
        by creating replicated table, deleting from it and checking that DELETE statement
        appeared in system.replication_queue table.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated summing merge tree table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 8e5480ff_3419_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 8e5480ff_3419_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedSummingMergeTree(&#39;/clickhouse/tables/shard0/8e5480ff_3419_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;, x) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 8e5480ff_3419_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 8e5480ff_3419_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedSummingMergeTree(&#39;/clickhouse/tables/shard0/8e5480ff_3419_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;, x) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 8e5480ff_3419_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 8e5480ff_3419_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedSummingMergeTree(&#39;/clickhouse/tables/shard0/8e5480ff_3419_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;, x) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I insert data in the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO 8e5480ff_3419_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0,6),(0...&quot; &gt; /tmp/tmp7apowsr2
                cat &quot;/tmp/tmp7apowsr2&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 8e5480ff_3419_11ed_b9de_572e856b5561 WHERE NOT(x % 2 == 0)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I delete odd rows from table on clickhouse1 node
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I delete odd rows from table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 8e5480ff_3419_11ed_b9de_572e856b5561 WHERE x % 2 == 0&quot; | clickhouse client -n --mutations_sync &quot;0&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check replication queue
<span class="rf">        Fail</span> I check replication queue, AssertionError
          Retry try #0
<span class="rf">          Fail</span> try #0, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT create_time FROM system.replication_queue WHERE table=&#39;8e5480ff_3419_11ed_b9de_572e856b5561&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #1
<span class="rf">          Fail</span> try #1, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT create_time FROM system.replication_queue WHERE table=&#39;8e5480ff_3419_11ed_b9de_572e856b5561&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #2
<span class="rf">          Fail</span> try #2, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT create_time FROM system.replication_queue WHERE table=&#39;8e5480ff_3419_11ed_b9de_572e856b5561&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT create_time FROM system.replication_queue WHERE table=&#39;8e5480ff_3419_11ed_b9de_572e856b5561&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #0
<span class="rf">          Fail</span> try #0, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%8e5480ff_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #1
<span class="rf">          Fail</span> try #1, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%8e5480ff_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #2
<span class="rf">          Fail</span> try #2, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%8e5480ff_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #3
<span class="rf">          Fail</span> try #3, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%8e5480ff_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #4
<span class="rf">          Fail</span> try #4, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%8e5480ff_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #5
<span class="rf">          Fail</span> try #5, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%8e5480ff_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #6
<span class="rf">          Fail</span> try #6, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%8e5480ff_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #7
<span class="rf">          Fail</span> try #7, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%8e5480ff_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #8
<span class="rf">          Fail</span> try #8, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%8e5480ff_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #9
<span class="rf">          Fail</span> try #9, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%8e5480ff_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #10
<span class="rf">          Fail</span> try #10, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%8e5480ff_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #11
<span class="rf">          Fail</span> try #11, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%8e5480ff_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #12
<span class="rf">          Fail</span> try #12, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%8e5480ff_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #13
<span class="rf">          Fail</span> try #13, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%8e5480ff_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #14
<span class="rf">          Fail</span> try #14, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%8e5480ff_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #15
<span class="rf">          Fail</span> try #15, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%8e5480ff_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #16
<span class="rf">          Fail</span> try #16, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%8e5480ff_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #17
<span class="rf">          Fail</span> try #17, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%8e5480ff_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #18
<span class="rf">          Fail</span> try #18, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%8e5480ff_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #19
<span class="rf">          Fail</span> try #19, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%8e5480ff_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #20
<span class="rf">          Fail</span> try #20, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%8e5480ff_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #21
<span class="rf">          Fail</span> try #21, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%8e5480ff_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #22
<span class="rf">          Fail</span> try #22, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%8e5480ff_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #23
<span class="rf">          Fail</span> try #23, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%8e5480ff_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #24
<span class="rf">          Fail</span> try #24, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%8e5480ff_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 8e5480ff_3419_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 8e5480ff_3419_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 8e5480ff_3419_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="rx"></span>
<span class="rx">      XFail</span> replication queue, engine type not supported.
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-xfail">XFail</span><span class="time time-inline">1m 16s</span>/lightweight delete/replication queue/ReplicatedAggregatingMergeTree/replication queue</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replication queue</span>
        Check that clickhouse writes delete statement in replication queue correctly
        by creating replicated table, deleting from it and checking that DELETE statement
        appeared in system.replication_queue table.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated aggregating merge tree table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table b5048137_3419_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE b5048137_3419_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedAggregatingMergeTree(&#39;/clickhouse/tables/shard0/b5048137_3419_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table b5048137_3419_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE b5048137_3419_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedAggregatingMergeTree(&#39;/clickhouse/tables/shard0/b5048137_3419_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table b5048137_3419_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE b5048137_3419_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedAggregatingMergeTree(&#39;/clickhouse/tables/shard0/b5048137_3419_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I insert data in the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO b5048137_3419_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0,6),(0...&quot; &gt; /tmp/tmp_b4a2zms
                cat &quot;/tmp/tmp_b4a2zms&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM b5048137_3419_11ed_b9de_572e856b5561 WHERE NOT(x % 2 == 0)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I delete odd rows from table on clickhouse1 node
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I delete odd rows from table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM b5048137_3419_11ed_b9de_572e856b5561 WHERE x % 2 == 0&quot; | clickhouse client -n --mutations_sync &quot;0&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check replication queue
<span class="rf">        Fail</span> I check replication queue, AssertionError
          Retry try #0
<span class="rf">          Fail</span> try #0, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT create_time FROM system.replication_queue WHERE table=&#39;b5048137_3419_11ed_b9de_572e856b5561&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #1
<span class="rf">          Fail</span> try #1, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT create_time FROM system.replication_queue WHERE table=&#39;b5048137_3419_11ed_b9de_572e856b5561&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #2
<span class="rf">          Fail</span> try #2, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT create_time FROM system.replication_queue WHERE table=&#39;b5048137_3419_11ed_b9de_572e856b5561&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #3
<span class="rf">          Fail</span> try #3, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT create_time FROM system.replication_queue WHERE table=&#39;b5048137_3419_11ed_b9de_572e856b5561&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #4
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT create_time FROM system.replication_queue WHERE table=&#39;b5048137_3419_11ed_b9de_572e856b5561&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #0
<span class="rf">          Fail</span> try #0, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%b5048137_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #1
<span class="rf">          Fail</span> try #1, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%b5048137_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #2
<span class="rf">          Fail</span> try #2, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%b5048137_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #3
<span class="rf">          Fail</span> try #3, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%b5048137_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #4
<span class="rf">          Fail</span> try #4, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%b5048137_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #5
<span class="rf">          Fail</span> try #5, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%b5048137_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #6
<span class="rf">          Fail</span> try #6, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%b5048137_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #7
<span class="rf">          Fail</span> try #7, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%b5048137_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #8
<span class="rf">          Fail</span> try #8, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%b5048137_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #9
<span class="rf">          Fail</span> try #9, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%b5048137_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #10
<span class="rf">          Fail</span> try #10, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%b5048137_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #11
<span class="rf">          Fail</span> try #11, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%b5048137_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #12
<span class="rf">          Fail</span> try #12, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%b5048137_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #13
<span class="rf">          Fail</span> try #13, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%b5048137_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #14
<span class="rf">          Fail</span> try #14, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%b5048137_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #15
<span class="rf">          Fail</span> try #15, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%b5048137_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #16
<span class="rf">          Fail</span> try #16, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%b5048137_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #17
<span class="rf">          Fail</span> try #17, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%b5048137_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #18
<span class="rf">          Fail</span> try #18, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%b5048137_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #19
<span class="rf">          Fail</span> try #19, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%b5048137_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #20
<span class="rf">          Fail</span> try #20, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%b5048137_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #21
<span class="rf">          Fail</span> try #21, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%b5048137_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #22
<span class="rf">          Fail</span> try #22, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%b5048137_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #23
<span class="rf">          Fail</span> try #23, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%b5048137_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #24
<span class="rf">          Fail</span> try #24, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%b5048137_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #25
<span class="rf">          Fail</span> try #25, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%b5048137_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #26
<span class="rf">          Fail</span> try #26, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%b5048137_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #27
<span class="rf">          Fail</span> try #27, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%b5048137_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS b5048137_3419_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS b5048137_3419_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS b5048137_3419_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="rx"></span>
<span class="rx">      XFail</span> replication queue, engine type not supported.
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-xfail">XFail</span><span class="time time-inline">1m 46s</span>/lightweight delete/replication queue/ReplicatedCollapsingMergeTree/replication queue</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replication queue</span>
        Check that clickhouse writes delete statement in replication queue correctly
        by creating replicated table, deleting from it and checking that DELETE statement
        appeared in system.replication_queue table.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated collapsing merge tree table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table e2b02587_3419_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE e2b02587_3419_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = ReplicatedCollapsingMergeTree(&#39;/clickhouse/tables/shard0/e2b02587_3419_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;, Sign) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table e2b02587_3419_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE e2b02587_3419_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = ReplicatedCollapsingMergeTree(&#39;/clickhouse/tables/shard0/e2b02587_3419_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;, Sign) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table e2b02587_3419_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE e2b02587_3419_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = ReplicatedCollapsingMergeTree(&#39;/clickhouse/tables/shard0/e2b02587_3419_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;, Sign) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I insert data in the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO e2b02587_3419_11ed_b9de_572e856b5561 VALUES (0,0,1),(0,1,1),(0,2,1),(0,3,1),(0,4,1),(0,5...&quot; &gt; /tmp/tmpfufqxbuy
                cat &quot;/tmp/tmpfufqxbuy&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM e2b02587_3419_11ed_b9de_572e856b5561 WHERE NOT(x % 2 == 0)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I delete odd rows from table on clickhouse1 node
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I delete odd rows from table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM e2b02587_3419_11ed_b9de_572e856b5561 WHERE x % 2 == 0&quot; | clickhouse client -n --mutations_sync &quot;0&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check replication queue
<span class="rf">        Fail</span> I check replication queue, AssertionError
          Retry try #0
<span class="rf">          Fail</span> try #0, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT create_time FROM system.replication_queue WHERE table=&#39;e2b02587_3419_11ed_b9de_572e856b5561&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT create_time FROM system.replication_queue WHERE table=&#39;e2b02587_3419_11ed_b9de_572e856b5561&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #0
<span class="rf">          Fail</span> try #0, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%e2b02587_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #1
<span class="rf">          Fail</span> try #1, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%e2b02587_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #2
<span class="rf">          Fail</span> try #2, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%e2b02587_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #3
<span class="rf">          Fail</span> try #3, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%e2b02587_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #4
<span class="rf">          Fail</span> try #4, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%e2b02587_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #5
<span class="rf">          Fail</span> try #5, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%e2b02587_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #6
<span class="rf">          Fail</span> try #6, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%e2b02587_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #7
<span class="rf">          Fail</span> try #7, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%e2b02587_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #8
<span class="rf">          Fail</span> try #8, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%e2b02587_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #9
<span class="rf">          Fail</span> try #9, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%e2b02587_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #10
<span class="rf">          Fail</span> try #10, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%e2b02587_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #11
<span class="rf">          Fail</span> try #11, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%e2b02587_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #12
<span class="rf">          Fail</span> try #12, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%e2b02587_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #13
<span class="rf">          Fail</span> try #13, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%e2b02587_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #14
<span class="rf">          Fail</span> try #14, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%e2b02587_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #15
<span class="rf">          Fail</span> try #15, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%e2b02587_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #16
<span class="rf">          Fail</span> try #16, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%e2b02587_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #17
<span class="rf">          Fail</span> try #17, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%e2b02587_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #18
<span class="rf">          Fail</span> try #18, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%e2b02587_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #19
<span class="rf">          Fail</span> try #19, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%e2b02587_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #20
<span class="rf">          Fail</span> try #20, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%e2b02587_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #21
<span class="rf">          Fail</span> try #21, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%e2b02587_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #22
<span class="rf">          Fail</span> try #22, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%e2b02587_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #23
<span class="rf">          Fail</span> try #23, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%e2b02587_3419_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS e2b02587_3419_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS e2b02587_3419_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS e2b02587_3419_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="rx"></span>
<span class="rx">      XFail</span> replication queue, engine type not supported.
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-xfail">XFail</span><span class="time time-inline">1m 7s</span>/lightweight delete/replication queue/ReplicatedVersionedCollapsingMergeTree/replication queue</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replication queue</span>
        Check that clickhouse writes delete statement in replication queue correctly
        by creating replicated table, deleting from it and checking that DELETE statement
        appeared in system.replication_queue table.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated versioned collapsing merge tree table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 21f563ab_341a_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 21f563ab_341a_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = ReplicatedVersionedCollapsingMergeTree(&#39;/clickhouse/tables/shard0/21f563ab_341a_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;, Sign, id) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 21f563ab_341a_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 21f563ab_341a_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = ReplicatedVersionedCollapsingMergeTree(&#39;/clickhouse/tables/shard0/21f563ab_341a_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;, Sign, id) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 21f563ab_341a_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 21f563ab_341a_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = ReplicatedVersionedCollapsingMergeTree(&#39;/clickhouse/tables/shard0/21f563ab_341a_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;, Sign, id) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I insert data in the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO 21f563ab_341a_11ed_b9de_572e856b5561 VALUES (0,0,1),(0,1,1),(0,2,1),(0,3,1),(0,4,1),(0,5...&quot; &gt; /tmp/tmp37iw1gkq
                cat &quot;/tmp/tmp37iw1gkq&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 21f563ab_341a_11ed_b9de_572e856b5561 WHERE NOT(x % 2 == 0)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I delete odd rows from table on clickhouse1 node
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I delete odd rows from table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 21f563ab_341a_11ed_b9de_572e856b5561 WHERE x % 2 == 0&quot; | clickhouse client -n --mutations_sync &quot;0&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check replication queue
<span class="rf">        Fail</span> I check replication queue, AssertionError
          Retry try #0
<span class="rf">          Fail</span> try #0, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT create_time FROM system.replication_queue WHERE table=&#39;21f563ab_341a_11ed_b9de_572e856b5561&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #1
<span class="rf">          Fail</span> try #1, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT create_time FROM system.replication_queue WHERE table=&#39;21f563ab_341a_11ed_b9de_572e856b5561&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #2
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT create_time FROM system.replication_queue WHERE table=&#39;21f563ab_341a_11ed_b9de_572e856b5561&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #0
<span class="rf">          Fail</span> try #0, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%21f563ab_341a_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #1
<span class="rf">          Fail</span> try #1, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%21f563ab_341a_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #2
<span class="rf">          Fail</span> try #2, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%21f563ab_341a_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #3
<span class="rf">          Fail</span> try #3, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%21f563ab_341a_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #4
<span class="rf">          Fail</span> try #4, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%21f563ab_341a_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #5
<span class="rf">          Fail</span> try #5, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%21f563ab_341a_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #6
<span class="rf">          Fail</span> try #6, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%21f563ab_341a_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #7
<span class="rf">          Fail</span> try #7, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%21f563ab_341a_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #8
<span class="rf">          Fail</span> try #8, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%21f563ab_341a_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #9
<span class="rf">          Fail</span> try #9, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%21f563ab_341a_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #10
<span class="rf">          Fail</span> try #10, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%21f563ab_341a_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #11
<span class="rf">          Fail</span> try #11, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%21f563ab_341a_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #12
<span class="rf">          Fail</span> try #12, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%21f563ab_341a_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #13
<span class="rf">          Fail</span> try #13, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%21f563ab_341a_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #14
<span class="rf">          Fail</span> try #14, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%21f563ab_341a_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #15
<span class="rf">          Fail</span> try #15, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%21f563ab_341a_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #16
<span class="rf">          Fail</span> try #16, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%21f563ab_341a_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #17
<span class="rf">          Fail</span> try #17, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%21f563ab_341a_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #18
<span class="rf">          Fail</span> try #18, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%21f563ab_341a_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #19
<span class="rf">          Fail</span> try #19, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%21f563ab_341a_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #20
<span class="rf">          Fail</span> try #20, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%21f563ab_341a_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #21
<span class="rf">          Fail</span> try #21, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%21f563ab_341a_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #22
<span class="rf">          Fail</span> try #22, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%21f563ab_341a_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #23
<span class="rf">          Fail</span> try #23, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%21f563ab_341a_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #24
<span class="rf">          Fail</span> try #24, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%21f563ab_341a_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #25
<span class="rf">          Fail</span> try #25, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%21f563ab_341a_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #26
<span class="rf">          Fail</span> try #26, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%21f563ab_341a_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #27
<span class="rf">          Fail</span> try #27, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%21f563ab_341a_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #28
<span class="rf">          Fail</span> try #28, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%21f563ab_341a_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 21f563ab_341a_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 21f563ab_341a_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 21f563ab_341a_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="rx"></span>
<span class="rx">      XFail</span> replication queue, engine type not supported.
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-xfail">XFail</span><span class="time time-inline">1m 14s</span>/lightweight delete/replication queue/ReplicatedGraphiteMergeTree/replication queue</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replication queue</span>
        Check that clickhouse writes delete statement in replication queue correctly
        by creating replicated table, deleting from it and checking that DELETE statement
        appeared in system.replication_queue table.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I create replicated graphite merge tree table on cluster
            Using the following cluster configuration containing 1 shard with 3 replicas:
                shard0: 
                    replica0: clickhouse1
                    replica1: clickhouse2
                    replica2: clickhouse3
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 49f4c828_341a_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 49f4c828_341a_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Path String, Time DateTime, Value Int64, Timestamp Int64) Engine = ReplicatedGraphiteMergeTree(&#39;/clickhouse/tables/shard0/49f4c828_341a_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;, &#39;graphite_rollup_example&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 49f4c828_341a_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 49f4c828_341a_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Path String, Time DateTime, Value Int64, Timestamp Int64) Engine = ReplicatedGraphiteMergeTree(&#39;/clickhouse/tables/shard0/49f4c828_341a_11ed_b9de_572e856b5561&#39;, &#39;replica1&#39;, &#39;graphite_rollup_example&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Given</span> I have a table 49f4c828_341a_11ed_b9de_572e856b5561
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 49f4c828_341a_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Path String, Time DateTime, Value Int64, Timestamp Int64) Engine = ReplicatedGraphiteMergeTree(&#39;/clickhouse/tables/shard0/49f4c828_341a_11ed_b9de_572e856b5561&#39;, &#39;replica2&#39;, &#39;graphite_rollup_example&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I insert data in the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I insert into table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I insert into table on clickhouse1 node
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                echo -e &quot;INSERT INTO 49f4c828_341a_11ed_b9de_572e856b5561 VALUES (0,0, &#39;1&#39;, toDateTime(10), 10, 10),(0,1, &#39;1&#39;...&quot; &gt; /tmp/tmp998x62sl
                cat &quot;/tmp/tmp998x62sl&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> check if output has exception
<span class="ro">              OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 49f4c828_341a_11ed_b9de_572e856b5561 WHERE NOT(x % 2 == 0)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I delete odd rows from table on clickhouse1 node
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          When</span> I delete odd rows from table on clickhouse1 node
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 49f4c828_341a_11ed_b9de_572e856b5561 WHERE x % 2 == 0&quot; | clickhouse client -n --mutations_sync &quot;0&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check replication queue
<span class="rf">        Fail</span> I check replication queue, AssertionError
          Retry try #0
<span class="rf">          Fail</span> try #0, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT create_time FROM system.replication_queue WHERE table=&#39;49f4c828_341a_11ed_b9de_572e856b5561&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT create_time FROM system.replication_queue WHERE table=&#39;49f4c828_341a_11ed_b9de_572e856b5561&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #0
<span class="rf">          Fail</span> try #0, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%49f4c828_341a_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #1
<span class="rf">          Fail</span> try #1, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%49f4c828_341a_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #2
<span class="rf">          Fail</span> try #2, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%49f4c828_341a_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #3
<span class="rf">          Fail</span> try #3, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%49f4c828_341a_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #4
<span class="rf">          Fail</span> try #4, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%49f4c828_341a_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #5
<span class="rf">          Fail</span> try #5, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%49f4c828_341a_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #6
<span class="rf">          Fail</span> try #6, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%49f4c828_341a_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #7
<span class="rf">          Fail</span> try #7, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%49f4c828_341a_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #8
<span class="rf">          Fail</span> try #8, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%49f4c828_341a_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #9
<span class="rf">          Fail</span> try #9, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%49f4c828_341a_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #10
<span class="rf">          Fail</span> try #10, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%49f4c828_341a_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #11
<span class="rf">          Fail</span> try #11, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%49f4c828_341a_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #12
<span class="rf">          Fail</span> try #12, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%49f4c828_341a_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #13
<span class="rf">          Fail</span> try #13, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%49f4c828_341a_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #14
<span class="rf">          Fail</span> try #14, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%49f4c828_341a_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #15
<span class="rf">          Fail</span> try #15, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%49f4c828_341a_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #16
<span class="rf">          Fail</span> try #16, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%49f4c828_341a_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #17
<span class="rf">          Fail</span> try #17, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%49f4c828_341a_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #18
<span class="rf">          Fail</span> try #18, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%49f4c828_341a_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #19
<span class="rf">          Fail</span> try #19, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%49f4c828_341a_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #20
<span class="rf">          Fail</span> try #20, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%49f4c828_341a_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #21
<span class="rf">          Fail</span> try #21, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%49f4c828_341a_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #22
<span class="rf">          Fail</span> try #22, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%49f4c828_341a_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #23
<span class="rf">          Fail</span> try #23, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%49f4c828_341a_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #24
<span class="rf">          Fail</span> try #24, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%49f4c828_341a_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
          Retry try #25
<span class="rf">          Fail</span> try #25, AssertionError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT event_time FROM system.query_log WHERE query like &#39;%49f4c828_341a_11ed_b9de_572e856b5561%DELETE%&#39; LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 49f4c828_341a_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 49f4c828_341a_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 49f4c828_341a_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="rx"></span>
<span class="rx">      XFail</span> replication queue, engine type not supported.
</code></pre></div>


</div>

<section class="requirement"><span class="requirement-inline"><i class="utf-icon color-error">✎</i>RQ.SRS-023.ClickHouse.LightweightDelete.ReplicationStuck</span></section>

<div class="requirement-description hidden">

<p><a target="_blank" rel="nofollow noopener noreferrer" href="https://clickhouse.yandex">ClickHouse</a> SHALL reject new <code>DELETE</code> statements when the replication queue is full or connection to zookeeper is lost.</p>

</div>

<div class="no-tests">
<span class="result-inline">✎</span>
No tests
</div>

<section class="requirement"><span class="requirement-inline"><i class="utf-icon color-ok">✔</i>RQ.SRS-023.ClickHouse.LightweightDelete.MultipleShards</span></section>

<div class="requirement-description hidden">

<p><a target="_blank" rel="nofollow noopener noreferrer" href="https://clickhouse.yandex">ClickHouse</a> SHALL support <code>DELETE</code> removing data from multiple shards.</p>

</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">13s 77ms</span>/lightweight delete/distributed tables/distributed table sharded</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">    </span><span class="kn">Scenario</span><span class="nn"> distributed table sharded</span>
      Check that ClickHouse supports delete statement for distributed tables
      when distributed table configuration contains 3 shard 1 replica in each.
<span class="k">      Given</span> I create replicated table on cluster
        Using the following cluster configuration containing 1 shard with 3 replicas:
            shard0:
                replica0: clickhouse1
            shard1:
                replica0: clickhouse2
            shard1:
                replica0: clickhouse3
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        Given</span> I have a table 1efced20_3419_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 1efced20_3419_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedMergeTree(&#39;/clickhouse/tables/shard0/1efced20_3419_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Given</span> I have a table 1efced20_3419_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 1efced20_3419_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedMergeTree(&#39;/clickhouse/tables/shard1/1efced20_3419_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Given</span> I have a table 1efced20_3419_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 1efced20_3419_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplicatedMergeTree(&#39;/clickhouse/tables/shard2/1efced20_3419_11ed_b9de_572e856b5561&#39;, &#39;replica0&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">      When</span> I create distributed table
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        Given</span> I have a table 1efced20_3419_11ed_b9de_572e856b5561_distributed
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE 1efced20_3419_11ed_b9de_572e856b5561_distributed ON CLUSTER sharded_cluster (id Int64, x Int64) Engine = Distributed(&#39;sharded_cluster&#39;, default, 1efced20_3419_11ed_b9de_572e856b5561, rand(), &#39;default&#39;)    &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">      When</span> I insert into table on clickhouse1 node
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        When</span> I insert into distributed table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO 1efced20_3419_11ed_b9de_572e856b5561_distributed VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0...&quot; &gt; /tmp/tmp4nbi0g02
            cat &quot;/tmp/tmp4nbi0g02&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --insert_distributed_sync &quot;1&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">      Then</span> I expect i can select from replicated table on any node
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        Then</span> I expect data is successfully inserted on clickhouse1 node
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 1efced20_3419_11ed_b9de_572e856b5561_distributed&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I expect data is successfully inserted on clickhouse2 node
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 1efced20_3419_11ed_b9de_572e856b5561_distributed&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I expect data is successfully inserted on clickhouse3 node
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 1efced20_3419_11ed_b9de_572e856b5561_distributed&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">      Then</span> I delete odd rows from table on clickhouse1 node
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        When</span> I delete odd rows from table on clickhouse1 node
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 1efced20_3419_11ed_b9de_572e856b5561 WHERE x % 2 == 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">      Then</span> I expect data is deleted from distributed table
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        Then</span> I expect data is successfully deleted on clickhouse1 node
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 1efced20_3419_11ed_b9de_572e856b5561_distributed&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I expect data is successfully deleted on clickhouse2 node
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 1efced20_3419_11ed_b9de_572e856b5561_distributed&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I expect data is successfully deleted on clickhouse3 node
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 1efced20_3419_11ed_b9de_572e856b5561_distributed&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">      Finally</span> I clean up
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        Finally</span> I remove the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 1efced20_3419_11ed_b9de_572e856b5561_distributed SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I remove the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 1efced20_3419_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I remove the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 1efced20_3419_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I remove the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 1efced20_3419_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
<span class="ro">    OK</span>
</code></pre></div>


</div>

<section class="requirement"><span class="requirement-inline"><i class="utf-icon color-ok">✔</i>RQ.SRS-023.ClickHouse.LightweightDelete.AlterTableWithParts&Partitions</span></section>

<div class="requirement-description hidden">

<p><a target="_blank" rel="nofollow noopener noreferrer" href="https://clickhouse.yandex">ClickHouse</a> SHALL support using parts with deleted rows in all <code>ALTER TABLE</code> operations that target parts or partitions.
<code>ALTER TABLE</code> operations:</p>

<ul>
<li><code>DETACH PART|PARTITION</code></li>
<li><code>DROP PART|PARTITION</code></li>
<li><code>DROP DETACHED PART|PARTITION</code></li>
<li><code>ATTACH PART|PARTITION</code></li>
<li><code>REPLACE PARTITION</code></li>
<li><code>FREEZE PARTITION</code></li>
<li><code>UNFREEZE PARTITION</code></li>
<li><code>FETCH PART|PARTITION</code></li>
<li><code>MOVE PART|PARTITION</code></li>
<li><code>UPDATE IN PARTITION</code></li>
<li><code>DELETE IN PARTITION</code></li>
<li><code>ADD|DROP|CLEAR|COMMENT|MODIFY COLUMN</code></li>
</ul>

</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">3m 43s</span>/lightweight delete/alter after delete with stop merges</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">  </span><span class="kn">Feature</span><span class="nn"> alter after delete with stop merges</span>
    Check that clickhouse supports alter operations after delete with STOP MERGES.
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> MergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> add column after delete</span>
        Check that alter add column after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> attach partition after delete</span>
        Check that attach partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> clear column after delete</span>
        Check that alter clear column after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> comment column after delete</span>
        Check that alter comment column after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> detach partition after delete</span>
        Check that detach partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop partition after delete</span>
        Check that drop partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> freeze partition after delete</span>
        Check that freeze partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> unfreeze partition after delete</span>
        Check that unfreeze partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplacingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> add column after delete</span>
        Check that alter add column after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> attach partition after delete</span>
        Check that attach partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> clear column after delete</span>
        Check that alter clear column after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> comment column after delete</span>
        Check that alter comment column after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> detach partition after delete</span>
        Check that detach partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop partition after delete</span>
        Check that drop partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> freeze partition after delete</span>
        Check that freeze partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> unfreeze partition after delete</span>
        Check that unfreeze partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> SummingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> add column after delete</span>
        Check that alter add column after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> attach partition after delete</span>
        Check that attach partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> clear column after delete</span>
        Check that alter clear column after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> comment column after delete</span>
        Check that alter comment column after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> detach partition after delete</span>
        Check that detach partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop partition after delete</span>
        Check that drop partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> freeze partition after delete</span>
        Check that freeze partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> unfreeze partition after delete</span>
        Check that unfreeze partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> AggregatingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> add column after delete</span>
        Check that alter add column after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> attach partition after delete</span>
        Check that attach partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> clear column after delete</span>
        Check that alter clear column after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> comment column after delete</span>
        Check that alter comment column after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> detach partition after delete</span>
        Check that detach partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop partition after delete</span>
        Check that drop partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> freeze partition after delete</span>
        Check that freeze partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> unfreeze partition after delete</span>
        Check that unfreeze partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> CollapsingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> add column after delete</span>
        Check that alter add column after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> attach partition after delete</span>
        Check that attach partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> clear column after delete</span>
        Check that alter clear column after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> comment column after delete</span>
        Check that alter comment column after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> detach partition after delete</span>
        Check that detach partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop partition after delete</span>
        Check that drop partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> freeze partition after delete</span>
        Check that freeze partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> unfreeze partition after delete</span>
        Check that unfreeze partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> VersionedCollapsingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> add column after delete</span>
        Check that alter add column after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> attach partition after delete</span>
        Check that attach partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> clear column after delete</span>
        Check that alter clear column after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> comment column after delete</span>
        Check that alter comment column after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> detach partition after delete</span>
        Check that detach partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop partition after delete</span>
        Check that drop partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> freeze partition after delete</span>
        Check that freeze partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> unfreeze partition after delete</span>
        Check that unfreeze partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> GraphiteMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> add column after delete</span>
        Check that alter add column after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> attach partition after delete</span>
        Check that attach partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> clear column after delete</span>
        Check that alter clear column after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> comment column after delete</span>
        Check that alter comment column after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> detach partition after delete</span>
        Check that detach partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop partition after delete</span>
        Check that drop partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> freeze partition after delete</span>
        Check that freeze partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> unfreeze partition after delete</span>
        Check that unfreeze partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span>
<span class="ro">  OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">6m 57s</span>/lightweight delete/alter after delete</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">  </span><span class="kn">Feature</span><span class="nn"> alter after delete</span>
    Check that clickhouse supports alter operations after lightweight delete.
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> MergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> add column after delete</span>
        Check that add column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> attach partition after delete</span>
        Check that attach partition after delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> clear column after delete</span>
        Check that clear column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> comment column after delete</span>
        Check that alter comment column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> detach partition after delete</span>
        Check that detach partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop column after delete</span>
        Check that drop column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop partition after delete</span>
        Check that drop partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> freeze partition after delete</span>
        Check that freeze partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> modify column after delete</span>
        Check that modify column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> move partition after delete</span>
        Check that alter move partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replace partition after delete</span>
        Check that replace partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> unfreeze partition after delete</span>
        Check that unfreeze partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplacingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> add column after delete</span>
        Check that add column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> attach partition after delete</span>
        Check that attach partition after delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> clear column after delete</span>
        Check that clear column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> comment column after delete</span>
        Check that alter comment column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> detach partition after delete</span>
        Check that detach partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop column after delete</span>
        Check that drop column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop partition after delete</span>
        Check that drop partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> freeze partition after delete</span>
        Check that freeze partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> modify column after delete</span>
        Check that modify column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> move partition after delete</span>
        Check that alter move partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replace partition after delete</span>
        Check that replace partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> unfreeze partition after delete</span>
        Check that unfreeze partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> SummingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> add column after delete</span>
        Check that add column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> attach partition after delete</span>
        Check that attach partition after delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> clear column after delete</span>
        Check that clear column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> comment column after delete</span>
        Check that alter comment column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> detach partition after delete</span>
        Check that detach partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop column after delete</span>
        Check that drop column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop partition after delete</span>
        Check that drop partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> freeze partition after delete</span>
        Check that freeze partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> modify column after delete</span>
        Check that modify column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> move partition after delete</span>
        Check that alter move partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replace partition after delete</span>
        Check that replace partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> unfreeze partition after delete</span>
        Check that unfreeze partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> AggregatingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> add column after delete</span>
        Check that add column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> attach partition after delete</span>
        Check that attach partition after delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> clear column after delete</span>
        Check that clear column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> comment column after delete</span>
        Check that alter comment column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> detach partition after delete</span>
        Check that detach partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop column after delete</span>
        Check that drop column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop partition after delete</span>
        Check that drop partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> freeze partition after delete</span>
        Check that freeze partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> modify column after delete</span>
        Check that modify column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> move partition after delete</span>
        Check that alter move partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replace partition after delete</span>
        Check that replace partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> unfreeze partition after delete</span>
        Check that unfreeze partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> CollapsingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> add column after delete</span>
        Check that add column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> attach partition after delete</span>
        Check that attach partition after delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> clear column after delete</span>
        Check that clear column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> comment column after delete</span>
        Check that alter comment column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> detach partition after delete</span>
        Check that detach partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop column after delete</span>
        Check that drop column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop partition after delete</span>
        Check that drop partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> freeze partition after delete</span>
        Check that freeze partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> modify column after delete</span>
        Check that modify column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> move partition after delete</span>
        Check that alter move partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replace partition after delete</span>
        Check that replace partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> unfreeze partition after delete</span>
        Check that unfreeze partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> VersionedCollapsingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> add column after delete</span>
        Check that add column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> attach partition after delete</span>
        Check that attach partition after delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> clear column after delete</span>
        Check that clear column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> comment column after delete</span>
        Check that alter comment column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> detach partition after delete</span>
        Check that detach partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop column after delete</span>
        Check that drop column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop partition after delete</span>
        Check that drop partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> freeze partition after delete</span>
        Check that freeze partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> modify column after delete</span>
        Check that modify column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> move partition after delete</span>
        Check that alter move partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replace partition after delete</span>
        Check that replace partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> unfreeze partition after delete</span>
        Check that unfreeze partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> GraphiteMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> add column after delete</span>
        Check that add column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> attach partition after delete</span>
        Check that attach partition after delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> clear column after delete</span>
        Check that clear column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> comment column after delete</span>
        Check that alter comment column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> detach partition after delete</span>
        Check that detach partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop column after delete</span>
        Check that drop column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop partition after delete</span>
        Check that drop partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> freeze partition after delete</span>
        Check that freeze partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> modify column after delete</span>
        Check that modify column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> move partition after delete</span>
        Check that alter move partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replace partition after delete</span>
        Check that replace partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> unfreeze partition after delete</span>
        Check that unfreeze partition after lightweight delete perform correctly.
<span class="ro">      OK</span>
<span class="ro">  OK</span>
</code></pre></div>


</div>

<section class="requirement"><span class="requirement-inline"><i class="utf-icon color-ok">✔</i>RQ.SRS-023.ClickHouse.LightweightDelete.TTL</span></section>

<div class="requirement-description hidden">

<p><a target="_blank" rel="nofollow noopener noreferrer" href="https://clickhouse.yandex">ClickHouse</a> SHALL support using parts with deleted rows in tiered storage TTL moves and deletes.</p>

</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">17s 490ms</span>/lightweight delete/delete and tiered storage ttl/delete with multi volume policy using ttl</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">    </span><span class="kn">Scenario</span><span class="nn"> delete with multi volume policy using ttl</span>
      Check that delete in table that uses tiered storage ttl perform correctly.
      I create parts on 2 volumes with 1 disk in each and delete some values in each volume.
      Using the following policy:
          volume0: disk local00
          volume1: disk local10
<span class="k">      Given</span> I create directories
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        Given</span> I create local disk folders on the server
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            mkdir &#39;/disk_local00/&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> exitcode should be 0
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            mkdir &#39;/disk_local10/&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> exitcode should be 0
<span class="ro">          OK</span><span class="k"></span>
<span class="k">      Given</span> I add configuration file
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        Given</span> I set up parameters
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Given</span> I add storage configuration that uses encrypted disk
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> converting config file content to xml
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> adding xml config file to the server
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Given</span> encrypted_disk.xml
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> attempt #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> attempt #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            When</span> I add the config
              /etc/clickhouse-server/config.d/encrypted_disk.xml
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> config.xml should be updated
              timeout 300
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> I wait for config to be reloaded
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              When</span> I close terminal to the node to be restarted
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              When</span> I stop ClickHouse to apply the config changes
<span class="ro">              OK</span><span class="k"></span>
<span class="k">                By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">                OK</span><span class="k"></span>
<span class="k">                  By</span> executing command
                    ls /tmp/clickhouse-server.pid
<span class="ro">                  OK</span><span class="k"></span>
<span class="k">                  By</span> executing command
                    cat /tmp/clickhouse-server.pid
<span class="ro">                  OK</span><span class="k"></span>
<span class="k">                By</span> checking pid does not exist
<span class="ro">                OK</span>
                  Retry try #0
<span class="rf">                  Fail</span> try #0, pid still alive
                  Retry try #1
<span class="rf">                  Fail</span> try #1, pid still alive
                  Retry try #2
<span class="ro">                  OK</span><span class="k"></span>
<span class="k">                By</span> deleting ClickHouse server pid file
<span class="ro">                OK</span><span class="k"></span>
<span class="k">              When</span> I get the current log size
<span class="ro">              OK</span><span class="k"></span>
<span class="k">                By</span> executing command
                  stat --format=%s /home/antip/job/github/clickhouse-regression/lightweight_delete/_instances/clickhouse1/logs/clickhouse-server.log
<span class="ro">                OK</span><span class="k"></span>
<span class="k">              When</span> I start ClickHouse back up
<span class="ro">              OK</span><span class="k"></span>
<span class="k">                By</span> executing command
                  ls /tmp/clickhouse-server.pid
<span class="ro">                OK</span><span class="k"></span>
<span class="k">                By</span> starting ClickHouse server process
<span class="ro">                OK</span><span class="k"></span>
<span class="k">                By</span> checking that ClickHouse server pid file was created
<span class="ro">                OK</span>
                  Retry try #0
<span class="ro">                  OK</span><span class="k"></span>
<span class="k">                By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">                OK</span>
                  Retry try #0
<span class="rf">                  Fail</span> try #0, ClickHouse server is not healthy
                  Retry try #1
<span class="ro">                  OK</span><span class="k"></span>
<span class="k">              Then</span> I tail the log file from using previous log size as the offset
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              Then</span> I wait for config reload message in the log file
<span class="ro">              OK</span><span class="k"></span>
<span class="k">      Given</span> I create a table that uses tiered storage ttl
        TTL Date TO VOLUME &#39;volume0&#39;,
        Date + INTERVAL 1 HOUR TO VOLUME &#39;volume1&#39;,
        Date + INTERVAL 2 HOUR DELETE
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;
          CREATE TABLE 6deac65c_341c_11ed_b9de_572e856b5561 
          (
              Id Int32,
              Date DateTime,
              Value String
          )
          ENGINE = MergeTree()
          ORDER BY Id
          TTL Date TO VOLUME &#39;volume0&#39;,
              Date + INTERVAL 1 HOUR TO VOLUME &#39;volume1&#39;,
              Date + INTERVAL 2 HOUR DELETE

          SETTINGS storage_policy = &#39;local_encrypted&#39;,merge_with_ttl_timeout = 10
          &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">      When</span> I insert data into the table
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO 6deac65c_341c_11ed_b9de_572e856b5561 VALUES (0, toDateTime(1663153224.1372783), &#39;00&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO 6deac65c_341c_11ed_b9de_572e856b5561 VALUES (1, toDateTime(1663151364.1372783), &#39;11&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO 6deac65c_341c_11ed_b9de_572e856b5561 VALUES (2, toDateTime(1663149504.1372783), &#39;22&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO 6deac65c_341c_11ed_b9de_572e856b5561 VALUES (3, toDateTime(1663147644.1372783), &#39;33&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO 6deac65c_341c_11ed_b9de_572e856b5561 VALUES (4, toDateTime(1663145784.1372783), &#39;44&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO 6deac65c_341c_11ed_b9de_572e856b5561 VALUES (5, toDateTime(1663143924.1372783), &#39;55&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">      By</span> executing command
        (set -o pipefail &amp;&amp; echo -e &quot;SELECT Id, Date as Seconds, Value FROM 6deac65c_341c_11ed_b9de_572e856b5561 ORDER BY Id FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      Then</span> check if output has exception
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      Then</span> I compute expected output
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      Then</span> I expect data is successfully inserted
<span class="ro">      OK</span>
        Retry try #0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">      Then</span> I check part are on different disks
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT COUNT(*) FROM (SELECT DISTINCT disk_name FROM system.parts WHERE table = &#39;6deac65c_341c_11ed_b9de_572e856b5561&#39;)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">      Then</span> I delete odd rows and check rows are deleted
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM 6deac65c_341c_11ed_b9de_572e856b5561 WHERE Id % 2 = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> I check rows are deleted
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count() FROM 6deac65c_341c_11ed_b9de_572e856b5561 WHERE Id % 2 = 0&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">      Then</span> I check rows are deleted
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM 6deac65c_341c_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">      Finally</span> I clean up
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        Finally</span> I drop the table if exists
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS 6deac65c_341c_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I remove encrypted_disk.xml on clickhouse1
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> attempt #0
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> attempt #0
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> removing the config file
            /etc/clickhouse-server/config.d/encrypted_disk.xml
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              rm -rf /etc/clickhouse-server/config.d/encrypted_disk.xml
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Then</span> config.xml should be updated
            timeout 300
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> I wait for config to be reloaded
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            When</span> I close terminal to the node to be restarted
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            When</span> I stop ClickHouse to apply the config changes
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">              OK</span><span class="k"></span>
<span class="k">                By</span> executing command
                  ls /tmp/clickhouse-server.pid
<span class="ro">                OK</span><span class="k"></span>
<span class="k">                By</span> executing command
                  cat /tmp/clickhouse-server.pid
<span class="ro">                OK</span><span class="k"></span>
<span class="k">              By</span> checking pid does not exist
<span class="ro">              OK</span>
                Retry try #0
<span class="rf">                Fail</span> try #0, pid still alive
                Retry try #1
<span class="ro">                OK</span><span class="k"></span>
<span class="k">              By</span> deleting ClickHouse server pid file
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            When</span> I get the current log size
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                stat --format=%s /home/antip/job/github/clickhouse-regression/lightweight_delete/_instances/clickhouse1/logs/clickhouse-server.log
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            When</span> I start ClickHouse back up
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> executing command
                ls /tmp/clickhouse-server.pid
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> starting ClickHouse server process
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> checking that ClickHouse server pid file was created
<span class="ro">              OK</span>
                Retry try #0
<span class="ro">                OK</span><span class="k"></span>
<span class="k">              By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">              OK</span>
                Retry try #0
<span class="rf">                Fail</span> try #0, ClickHouse server is not healthy
                Retry try #1
<span class="ro">                OK</span><span class="k"></span>
<span class="k">            Then</span> I tail the log file from using previous log size as the offset
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> I wait for config reload message in the log file
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Finally</span> delete directory
          /disk_local10/
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            rm -rf &#39;/disk_local10/&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> exitcode should be 0
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> delete directory
          /disk_local00/
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            rm -rf &#39;/disk_local00/&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> exitcode should be 0
<span class="ro">          OK</span>
<span class="ro">    OK</span>
</code></pre></div>


</div>

<section class="requirement"><span class="requirement-inline"><i class="utf-icon color-ok">✔</i>RQ.SRS-023.ClickHouse.LightweightDelete.ColumnTTL</span></section>

<div class="requirement-description hidden">

<p><a target="_blank" rel="nofollow noopener noreferrer" href="https://clickhouse.yandex">ClickHouse</a> SHALL support using parts with deleted rows in column TTL operations.</p>

</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">1m 17s</span>/lightweight delete/delete and column ttl</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">  </span><span class="kn">Feature</span><span class="nn"> delete and column ttl</span>
    Check that delete and column ttl together perform correctly.
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> column ttl after delete</span>
      Check that column ttl after delete perform correctly.
<span class="ro">    OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> delete after column ttl</span>
      Check that delete statement after column ttl perform correctly.
<span class="ro">    OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> delete and column ttl concurrent</span>
      Check that concurrent lightweight delete and column ttl perform correctly.
<span class="ro">    OK</span>
<span class="ro">  OK</span>
</code></pre></div>


</div>

<section class="requirement"><span class="requirement-inline"><i class="utf-icon color-ok">✔</i>RQ.SRS-023.ClickHouse.LightweightDelete.InvalidSyntax.NoWhere</span></section>

<div class="requirement-description hidden">

<p><a target="_blank" rel="nofollow noopener noreferrer" href="https://clickhouse.yandex">ClickHouse</a> SHALL return an error when using <code>DELETE</code> statement with no <code>WHERE</code> clause.</p>

</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">947ms</span>/lightweight delete/invalid where clause/MergeTree/no where</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> no where</span>
        Check that clickhouse returns an error when using DELETE statement with no WHERE clause.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_60fe8b2a_3423_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_60fe8b2a_3423_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert some data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_60fe8b2a_3423_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmp_eykoh9m
            cat &quot;/tmp/tmp_eykoh9m&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I try to delete from table_60fe8b2a_3423_11ed_b9de_572e856b5561 without WHERE clause
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_60fe8b2a_3423_11ed_b9de_572e856b5561 WHERE &quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check that exitcode is not 0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_60fe8b2a_3423_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">815ms</span>/lightweight delete/invalid where clause/ReplacingMergeTree/no where</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> no where</span>
        Check that clickhouse returns an error when using DELETE statement with no WHERE clause.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_62324a4a_3423_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_62324a4a_3423_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplacingMergeTree() PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert some data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_62324a4a_3423_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmp59toq3f2
            cat &quot;/tmp/tmp59toq3f2&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I try to delete from table_62324a4a_3423_11ed_b9de_572e856b5561 without WHERE clause
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_62324a4a_3423_11ed_b9de_572e856b5561 WHERE &quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check that exitcode is not 0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_62324a4a_3423_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">854ms</span>/lightweight delete/invalid where clause/SummingMergeTree/no where</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> no where</span>
        Check that clickhouse returns an error when using DELETE statement with no WHERE clause.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_6344ce80_3423_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_6344ce80_3423_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = SummingMergeTree(x) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert some data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_6344ce80_3423_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpnh_o5vkh
            cat &quot;/tmp/tmpnh_o5vkh&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I try to delete from table_6344ce80_3423_11ed_b9de_572e856b5561 without WHERE clause
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_6344ce80_3423_11ed_b9de_572e856b5561 WHERE &quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check that exitcode is not 0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_6344ce80_3423_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">866ms</span>/lightweight delete/invalid where clause/AggregatingMergeTree/no where</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> no where</span>
        Check that clickhouse returns an error when using DELETE statement with no WHERE clause.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_6479ebbe_3423_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_6479ebbe_3423_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = AggregatingMergeTree() PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert some data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_6479ebbe_3423_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpljpkm3th
            cat &quot;/tmp/tmpljpkm3th&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I try to delete from table_6479ebbe_3423_11ed_b9de_572e856b5561 without WHERE clause
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_6479ebbe_3423_11ed_b9de_572e856b5561 WHERE &quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check that exitcode is not 0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_6479ebbe_3423_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">857ms</span>/lightweight delete/invalid where clause/CollapsingMergeTree/no where</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> no where</span>
        Check that clickhouse returns an error when using DELETE statement with no WHERE clause.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_65d33ab1_3423_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_65d33ab1_3423_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = CollapsingMergeTree(Sign) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert some data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_65d33ab1_3423_11ed_b9de_572e856b5561 VALUES (0,0,1),(0,1,1),(0,2,1),(0,3,1),(0,4,1...&quot; &gt; /tmp/tmpylx6w9h4
            cat &quot;/tmp/tmpylx6w9h4&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I try to delete from table_65d33ab1_3423_11ed_b9de_572e856b5561 without WHERE clause
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_65d33ab1_3423_11ed_b9de_572e856b5561 WHERE &quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check that exitcode is not 0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_65d33ab1_3423_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">978ms</span>/lightweight delete/invalid where clause/VersionedCollapsingMergeTree/no where</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> no where</span>
        Check that clickhouse returns an error when using DELETE statement with no WHERE clause.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_66ee82ed_3423_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_66ee82ed_3423_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = VersionedCollapsingMergeTree(Sign, id) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert some data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_66ee82ed_3423_11ed_b9de_572e856b5561 VALUES (0,0,1),(0,1,1),(0,2,1),(0,3,1),(0,4,1...&quot; &gt; /tmp/tmpuioncr82
            cat &quot;/tmp/tmpuioncr82&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I try to delete from table_66ee82ed_3423_11ed_b9de_572e856b5561 without WHERE clause
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_66ee82ed_3423_11ed_b9de_572e856b5561 WHERE &quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check that exitcode is not 0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_66ee82ed_3423_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">896ms</span>/lightweight delete/invalid where clause/GraphiteMergeTree/no where</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> no where</span>
        Check that clickhouse returns an error when using DELETE statement with no WHERE clause.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_680f9365_3423_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_680f9365_3423_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Path String, Time DateTime, Value Int64, Timestamp Int64) Engine = GraphiteMergeTree(&#39;graphite_rollup_example&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert some data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_680f9365_3423_11ed_b9de_572e856b5561 VALUES (0,0, &#39;1&#39;, toDateTime(10), 10, 10),(0,...&quot; &gt; /tmp/tmp749a_j23
            cat &quot;/tmp/tmp749a_j23&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I try to delete from table_680f9365_3423_11ed_b9de_572e856b5561 without WHERE clause
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_680f9365_3423_11ed_b9de_572e856b5561 WHERE &quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check that exitcode is not 0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_680f9365_3423_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<section class="requirement"><span class="requirement-inline"><i class="utf-icon color-ok">✔</i>RQ.SRS-023.ClickHouse.LightweightDelete.InvalidSyntax.EmptyWhere</span></section>

<div class="requirement-description hidden">

<p><a target="_blank" rel="nofollow noopener noreferrer" href="https://clickhouse.yandex">ClickHouse</a> SHALL return an error when using <code>DELETE</code> statement with empty <code>WHERE</code> clause.</p>

</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">1s 28ms</span>/lightweight delete/invalid where clause/MergeTree/empty where clause</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> empty where clause</span>
        Check that clickhouse returns an error when using DELETE statement with empty WHERE clause.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_60fe8afc_3423_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_60fe8afc_3423_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert some data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_60fe8afc_3423_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmp18j7pq0u
            cat &quot;/tmp/tmp18j7pq0u&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I try to delete from table_60fe8afc_3423_11ed_b9de_572e856b5561 with empty WHERE clause
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_60fe8afc_3423_11ed_b9de_572e856b5561 WHERE &quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check that exitcode is not 0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_60fe8afc_3423_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">982ms</span>/lightweight delete/invalid where clause/ReplacingMergeTree/empty where clause</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> empty where clause</span>
        Check that clickhouse returns an error when using DELETE statement with empty WHERE clause.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_62324a1c_3423_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_62324a1c_3423_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplacingMergeTree() PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert some data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_62324a1c_3423_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpkzsb0yfh
            cat &quot;/tmp/tmpkzsb0yfh&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I try to delete from table_62324a1c_3423_11ed_b9de_572e856b5561 with empty WHERE clause
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_62324a1c_3423_11ed_b9de_572e856b5561 WHERE &quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check that exitcode is not 0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_62324a1c_3423_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">813ms</span>/lightweight delete/invalid where clause/SummingMergeTree/empty where clause</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> empty where clause</span>
        Check that clickhouse returns an error when using DELETE statement with empty WHERE clause.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_6344ce52_3423_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_6344ce52_3423_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = SummingMergeTree(x) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert some data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_6344ce52_3423_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpdmgmqys5
            cat &quot;/tmp/tmpdmgmqys5&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I try to delete from table_6344ce52_3423_11ed_b9de_572e856b5561 with empty WHERE clause
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_6344ce52_3423_11ed_b9de_572e856b5561 WHERE &quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check that exitcode is not 0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_6344ce52_3423_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">945ms</span>/lightweight delete/invalid where clause/AggregatingMergeTree/empty where clause</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> empty where clause</span>
        Check that clickhouse returns an error when using DELETE statement with empty WHERE clause.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_6344ceb1_3423_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_6344ceb1_3423_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = AggregatingMergeTree() PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert some data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_6344ceb1_3423_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmp6pks91al
            cat &quot;/tmp/tmp6pks91al&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I try to delete from table_6344ceb1_3423_11ed_b9de_572e856b5561 with empty WHERE clause
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_6344ceb1_3423_11ed_b9de_572e856b5561 WHERE &quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check that exitcode is not 0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_6344ceb1_3423_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">845ms</span>/lightweight delete/invalid where clause/CollapsingMergeTree/empty where clause</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> empty where clause</span>
        Check that clickhouse returns an error when using DELETE statement with empty WHERE clause.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_6479ebef_3423_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_6479ebef_3423_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = CollapsingMergeTree(Sign) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert some data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_6479ebef_3423_11ed_b9de_572e856b5561 VALUES (0,0,1),(0,1,1),(0,2,1),(0,3,1),(0,4,1...&quot; &gt; /tmp/tmpe3ir902s
            cat &quot;/tmp/tmpe3ir902s&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I try to delete from table_6479ebef_3423_11ed_b9de_572e856b5561 with empty WHERE clause
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_6479ebef_3423_11ed_b9de_572e856b5561 WHERE &quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check that exitcode is not 0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_6479ebef_3423_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">980ms</span>/lightweight delete/invalid where clause/VersionedCollapsingMergeTree/empty where clause</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> empty where clause</span>
        Check that clickhouse returns an error when using DELETE statement with empty WHERE clause.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_65d33ae2_3423_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_65d33ae2_3423_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = VersionedCollapsingMergeTree(Sign, id) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert some data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_65d33ae2_3423_11ed_b9de_572e856b5561 VALUES (0,0,1),(0,1,1),(0,2,1),(0,3,1),(0,4,1...&quot; &gt; /tmp/tmpcn8kbt0v
            cat &quot;/tmp/tmpcn8kbt0v&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I try to delete from table_65d33ae2_3423_11ed_b9de_572e856b5561 with empty WHERE clause
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_65d33ae2_3423_11ed_b9de_572e856b5561 WHERE &quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check that exitcode is not 0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_65d33ae2_3423_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">892ms</span>/lightweight delete/invalid where clause/GraphiteMergeTree/empty where clause</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> empty where clause</span>
        Check that clickhouse returns an error when using DELETE statement with empty WHERE clause.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_66ee831e_3423_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_66ee831e_3423_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Path String, Time DateTime, Value Int64, Timestamp Int64) Engine = GraphiteMergeTree(&#39;graphite_rollup_example&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert some data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_66ee831e_3423_11ed_b9de_572e856b5561 VALUES (0,0, &#39;1&#39;, toDateTime(10), 10, 10),(0,...&quot; &gt; /tmp/tmp_qxcrzp2
            cat &quot;/tmp/tmp_qxcrzp2&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I try to delete from table_66ee831e_3423_11ed_b9de_572e856b5561 with empty WHERE clause
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_66ee831e_3423_11ed_b9de_572e856b5561 WHERE &quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check that exitcode is not 0
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_66ee831e_3423_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<section class="requirement"><span class="requirement-inline"><i class="utf-icon color-fail">✘</i>RQ.SRS-023.ClickHouse.LightweightDelete.SupportedTableEngines</span></section>

<div class="requirement-description hidden">

<p><a target="_blank" rel="nofollow noopener noreferrer" href="https://clickhouse.yandex">ClickHouse</a> SHALL support using the <code>DELETE</code> statement on all MergeTree table engines:</p>

<ul>
<li>MergeTree</li>
<li>ReplacingMergeTree</li>
<li>SummingMergeTree</li>
<li>AggregatingMergeTree</li>
<li>CollapsingMergeTree</li>
<li>VersionedCollapsingMergeTree</li>
<li>GraphiteMergeTree</li>
<li>ReplicatedMergeTree</li>
<li>ReplicatedSummingMergeTree</li>
<li>ReplicatedReplacingMergeTree</li>
<li>ReplicatedAggregatingMergeTree</li>
<li>ReplicatedCollapsingMergeTree</li>
<li>ReplicatedVersionedCollapsingMergeTree</li>
<li>ReplicatedGraphiteMergeTree</li>
</ul>

</div>

<div class="test"><span class="result result-inline result-error">Error</span><span class="time time-inline">3h 41m</span>/lightweight delete</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="kn">Module</span><span class="nn"> lightweight delete</span>
  Lightweight Delete regression.
<span class="k">  </span><span class="kn">Feature</span><span class="nn"> acceptance</span>
    Check that clickhouse supports lightweight delete operations applied to acceptance dataset.
<span class="ro">  OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> delete_query_0</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> acceptance concurrent select delete execution time</span>
        Check that clickhouse keeps reference dataset table usable while the delete reference queries
        are being executed concurrently with the select reference queries.
        No major degradation in query response time SHALL be seen.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> acceptance concurrent insert delete execution time</span>
        Check that clickhouse is not slow down or lockup data ingestion into the reference dataset table
        when delete reference queries are executed concurrently with the insert reference queries.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> acceptance delete execution time</span>
        Check that clickhouse execute each query in the delete reference queries
        set against the reference dataset table within 2 sec.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> acceptance insert execution time after delete</span>
        Check that clickhouse insert queries are not slow down after lightweight delete.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> delete_query_1</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> acceptance concurrent select delete execution time</span>
        Check that clickhouse keeps reference dataset table usable while the delete reference queries
        are being executed concurrently with the select reference queries.
        No major degradation in query response time SHALL be seen.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> acceptance concurrent insert delete execution time</span>
        Check that clickhouse is not slow down or lockup data ingestion into the reference dataset table
        when delete reference queries are executed concurrently with the insert reference queries.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> acceptance delete execution time</span>
        Check that clickhouse execute each query in the delete reference queries
        set against the reference dataset table within 2 sec.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> acceptance insert execution time after delete</span>
        Check that clickhouse insert queries are not slow down after lightweight delete.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> delete_query_2</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> acceptance concurrent select delete execution time</span>
        Check that clickhouse keeps reference dataset table usable while the delete reference queries
        are being executed concurrently with the select reference queries.
        No major degradation in query response time SHALL be seen.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> acceptance concurrent insert delete execution time</span>
        Check that clickhouse is not slow down or lockup data ingestion into the reference dataset table
        when delete reference queries are executed concurrently with the insert reference queries.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> acceptance delete execution time</span>
        Check that clickhouse execute each query in the delete reference queries
        set against the reference dataset table within 2 sec.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> acceptance insert execution time after delete</span>
        Check that clickhouse insert queries are not slow down after lightweight delete.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">  </span><span class="kn">Feature</span><span class="nn"> efficient physical data removal</span>
    Check that ClickHouse support efficient removal of physical data from the tables that
    had rows deleted using the DELETE statement.
<span class="ro">  OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> delete and check size of the table</span>
      Check that ClickHouse support efficient removal of physical data from the tables that
      had rows deleted using the DELETE statement by deleting from the table and checking table
      size in storage and in system.parts table.
<span class="rx">    XFail</span> delete and check size of the table, Does not match space requirements.
<span class="k">  </span><span class="kn">Feature</span><span class="nn"> multiple delete limitations</span>
    Check that clickhouse supports using multiple DELETE statements on the same table.
<span class="ro">  OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> MergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> multiple delete</span>
        Check that clickhouse supports using multiple DELETE statements on the same table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplacingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> multiple delete</span>
        Check that clickhouse supports using multiple DELETE statements on the same table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> SummingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> multiple delete</span>
        Check that clickhouse supports using multiple DELETE statements on the same table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> AggregatingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> multiple delete</span>
        Check that clickhouse supports using multiple DELETE statements on the same table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> CollapsingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> multiple delete</span>
        Check that clickhouse supports using multiple DELETE statements on the same table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> VersionedCollapsingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> multiple delete</span>
        Check that clickhouse supports using multiple DELETE statements on the same table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> GraphiteMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> multiple delete</span>
        Check that clickhouse supports using multiple DELETE statements on the same table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">  </span><span class="kn">Feature</span><span class="nn"> hard restart</span>
    Check that clickhouse either finish the DELETE or return the system
    to before the DELETE started after a hard restart.
<span class="ro">  OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> SIGKILL</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> hard restart</span>
        Check that clickhouse either completes DELETE operation or
        leaves data in the same state after a hard restart
        by using signal.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">  </span><span class="kn">Feature</span><span class="nn"> s3</span>
    Check that clickhouse support using DELETE on S3 disks.
<span class="ro">  OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> s3</span>
      Check that clickhouse support using DELETE on S3 disks.
<span class="ro">    OK</span><span class="k"></span>
<span class="k">  </span><span class="kn">Feature</span><span class="nn"> lack of disk space</span>
    Check that clickhouse reserve space to avoid breaking in the middle.
<span class="ro">  OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> lack of disk space</span>
      Check that clickhouse reserve space to avoid breaking in the middle.
      I fill the disk and delete insert the data in loop until the error and
      check the state of the table in the end when table stored on the disk.
<span class="ro">    OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> lack of disk space tiered storage</span>
      Check that clickhouse reserve space to avoid breaking in the middle.
      I fill the disk and delete insert the data in loop until the error and
      check the state of the table in the end when table stored on two disks.
<span class="ro">    OK</span><span class="k"></span>
<span class="k">  </span><span class="kn">Feature</span><span class="nn"> multi disk</span>
    Check ClickHouse supports policies with different number of
    disks in one volume, and with different disks configurations.
<span class="ro">  OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> multi disk volume</span>
      Check ClickHouse supports policies with different number of
      disks in one volume, and with different disks configurations.
<span class="ro">    OK</span><span class="k"></span>
<span class="k">  </span><span class="kn">Feature</span><span class="nn"> projections</span>
    Check that tables that have one or more projections work with delete.
<span class="ro">  OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> simple projection</span>
      Check delete on a table that has simple projection
      which optimizes query with a simple where clause.
<span class="rx">    XFail</span> simple projection, engine type not supported.
<span class="k">  </span><span class="kn">Feature</span><span class="nn"> drop empty part</span>
    Check that clickhouse schedules dropping the part if all of the rows are deleted from this part.
<span class="ro">  OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> drop empty part</span>
      Check that clickhouse schedules dropping the part if all of the rows are deleted from this part.
<span class="ro">    OK</span><span class="k"></span>
<span class="k">  </span><span class="kn">Feature</span><span class="nn"> views</span>
    Check that clickhouse DELETE statement is compatible with tables that have one or more views.
<span class="ro">  OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> live view</span>
      Check that clickhouse DELETE statement is compatible with tables that have one or more live views.
<span class="rx">    XFail</span> live view, not implemented
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> materialized view</span>
      Check that clickhouse DELETE statement is compatible with tables that have one or more normal views.
<span class="rx">    XFail</span> materialized view, not implemented
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> normal view</span>
      Check that clickhouse DELETE statement is compatible with tables that have one or more normal views.
<span class="ro">    OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> window view</span>
      Check that clickhouse DELETE statement is compatible with tables that have one or more window views.
<span class="rx">    XFail</span> window view, not implemented
<span class="k">  </span><span class="kn">Feature</span><span class="nn"> compatibility</span>
    Check that clickhouse support executing INSERT and DELETE statements concurrently.
<span class="ro">  OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> concurrent insert delete many parts</span>
      Check that clickhouse support executing INSERT and DELETE statements concurrently
      when INSERT creates many parts.
<span class="ro">    OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> concurrent insert delete the same data</span>
      Check that clickhouse support executing INSERT and DELETE statements concurrently
      on the same data.
<span class="ro">    OK</span><span class="k"></span>
<span class="k">  </span><span class="kn">Feature</span><span class="nn"> immutable parts and garbage collection</span>
    Check that parts affected by the DELETE statement are stay immutable and
    the deleted rows are garbage collected in a scheduled merge.
<span class="ro">  OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> MergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> immutable parts and garbage collection</span>
        Check that parts affected by the DELETE statement are stay immutable and
        the deleted rows are garbage collected in a scheduled merge.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplacingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> immutable parts and garbage collection</span>
        Check that parts affected by the DELETE statement are stay immutable and
        the deleted rows are garbage collected in a scheduled merge.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> SummingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> immutable parts and garbage collection</span>
        Check that parts affected by the DELETE statement are stay immutable and
        the deleted rows are garbage collected in a scheduled merge.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> AggregatingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> immutable parts and garbage collection</span>
        Check that parts affected by the DELETE statement are stay immutable and
        the deleted rows are garbage collected in a scheduled merge.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> CollapsingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> immutable parts and garbage collection</span>
        Check that parts affected by the DELETE statement are stay immutable and
        the deleted rows are garbage collected in a scheduled merge.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> VersionedCollapsingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> immutable parts and garbage collection</span>
        Check that parts affected by the DELETE statement are stay immutable and
        the deleted rows are garbage collected in a scheduled merge.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> GraphiteMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> immutable parts and garbage collection</span>
        Check that parts affected by the DELETE statement are stay immutable and
        the deleted rows are garbage collected in a scheduled merge.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">  </span><span class="kn">Feature</span><span class="nn"> replicated tables concurrent deletes</span>
    Check that delete operations replicate in an eventually consistent manner between replicas.
<span class="ro">  OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop with overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table by partitions on different nodes with overlap.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop with without overlap</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting some rows in the table by partitions on different nodes.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop without overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table by partitions on different nodes without overlap.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table on different nodes with overlap.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with without overlap</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting some rows in the table on different nodes.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table on different nodes without overlap.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedReplacingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop with overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table by partitions on different nodes with overlap.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop with without overlap</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting some rows in the table by partitions on different nodes.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop without overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table by partitions on different nodes without overlap.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table on different nodes with overlap.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with without overlap</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting some rows in the table on different nodes.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table on different nodes without overlap.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedSummingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop with overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table by partitions on different nodes with overlap.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop with without overlap</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting some rows in the table by partitions on different nodes.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop without overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table by partitions on different nodes without overlap.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table on different nodes with overlap.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with without overlap</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting some rows in the table on different nodes.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table on different nodes without overlap.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedAggregatingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop with overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table by partitions on different nodes with overlap.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop with without overlap</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting some rows in the table by partitions on different nodes.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop without overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table by partitions on different nodes without overlap.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table on different nodes with overlap.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with without overlap</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting some rows in the table on different nodes.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table on different nodes without overlap.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedCollapsingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop with overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table by partitions on different nodes with overlap.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop with without overlap</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting some rows in the table by partitions on different nodes.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop without overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table by partitions on different nodes without overlap.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table on different nodes with overlap.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with without overlap</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting some rows in the table on different nodes.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table on different nodes without overlap.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedVersionedCollapsingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop with overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table by partitions on different nodes with overlap.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop with without overlap</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting some rows in the table by partitions on different nodes.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop without overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table by partitions on different nodes without overlap.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table on different nodes with overlap.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with without overlap</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting some rows in the table on different nodes.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table on different nodes without overlap.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedGraphiteMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop with overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table by partitions on different nodes with overlap.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop with without overlap</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting some rows in the table by partitions on different nodes.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting in loop without overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table by partitions on different nodes without overlap.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table on different nodes with overlap.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with without overlap</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting some rows in the table on different nodes.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap entire table</span>
        Check that clickhouse support concurrent DELETE statement which is related to replicated table
        by creating replicated table and deleting all rows in the table on different nodes without overlap.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">  </span><span class="kn">Feature</span><span class="nn"> replicated table with concurrent alter and delete</span>
    Check that delete operations replicate in an eventually consistent manner between replicas.
<span class="ro">  OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> concurrent add drop column and delete in replicated table on single node</span>
      Check that concurrent delete and add drop column perform
      correctly with replicated table on single node.
<span class="ro">    OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> concurrent add drop column and delete in replicated table on two nodes</span>
      Check that concurrent delete and add drop column perform
      correctly with replicated table on two nodes.
<span class="ro">    OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> concurrent clear update and delete in replicated table on single node</span>
      Check that concurrent delete and clear update+ column perform
      correctly with replicated table on single node.
<span class="ro">    OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> concurrent clear update and delete in replicated table on two nodes</span>
      Check that concurrent delete and clear update column perform
      correctly with replicated table on two nodes.
<span class="ro">    OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> concurrent delete attach detach partition in replicated table on single node</span>
      Check that concurrent delete detach partition and attach partition perform
      correctly with replicated table on single node.
<span class="ro">    OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> concurrent delete attach detach partition in replicated table on two nodes</span>
      Check that concurrent delete detach partition and attach partition perform
      correctly with replicated table on two nodes.
<span class="ro">    OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> concurrent modify column and delete in replicated table on single node</span>
      Check that concurrent delete and modify column perform
      correctly with replicated table on single node.
<span class="ro">    OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> concurrent modify column and delete in replicated table on two nodes</span>
      Check that concurrent delete and modify column perform
      correctly with replicated table on two nodes.
<span class="ro">    OK</span><span class="k"></span>
<span class="k">  </span><span class="kn">Feature</span><span class="nn"> replicated table with alter after delete on single node</span>
    Check that delete operations replicate in an eventually consistent manner between replicas.
<span class="ro">  OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> add column after delete</span>
        Check that add column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> attach partition after delete</span>
        Check that attach partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> clear column after delete</span>
        Check that clear column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> comment column after delete</span>
        Check that comment column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> detach partition after delete</span>
        Check that detach partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop column after delete</span>
        Check that drop column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop partition after delete</span>
        Check that drop partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> fetch partition after delete</span>
        Check that fetch partition after delete perform correctly with replicated table on single node.
<span class="rx">      XFail</span> fetch partition after delete, engine type not supported.
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> freeze partition after delete</span>
        Check that freeze partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> modify column after delete</span>
        Check that modify column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> unfreeze partition after delete</span>
        Check that unfreeze partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedReplacingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> add column after delete</span>
        Check that add column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> attach partition after delete</span>
        Check that attach partition after delete perform correctly with replicated table on single node.
<span class="rx">      XFail</span> attach partition after delete, engine type not supported.
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> clear column after delete</span>
        Check that clear column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> comment column after delete</span>
        Check that comment column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> detach partition after delete</span>
        Check that detach partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop column after delete</span>
        Check that drop column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop partition after delete</span>
        Check that drop partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> fetch partition after delete</span>
        Check that fetch partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> freeze partition after delete</span>
        Check that freeze partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> modify column after delete</span>
        Check that modify column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> unfreeze partition after delete</span>
        Check that unfreeze partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedSummingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> add column after delete</span>
        Check that add column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> attach partition after delete</span>
        Check that attach partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> clear column after delete</span>
        Check that clear column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> comment column after delete</span>
        Check that comment column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> detach partition after delete</span>
        Check that detach partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop column after delete</span>
        Check that drop column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop partition after delete</span>
        Check that drop partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> fetch partition after delete</span>
        Check that fetch partition after delete perform correctly with replicated table on single node.
<span class="rx">      XFail</span> fetch partition after delete, engine type not supported.
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> freeze partition after delete</span>
        Check that freeze partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> modify column after delete</span>
        Check that modify column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> unfreeze partition after delete</span>
        Check that unfreeze partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedAggregatingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> add column after delete</span>
        Check that add column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> attach partition after delete</span>
        Check that attach partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> clear column after delete</span>
        Check that clear column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> comment column after delete</span>
        Check that comment column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> detach partition after delete</span>
        Check that detach partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop column after delete</span>
        Check that drop column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop partition after delete</span>
        Check that drop partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> fetch partition after delete</span>
        Check that fetch partition after delete perform correctly with replicated table on single node.
<span class="rx">      XFail</span> fetch partition after delete, engine type not supported.
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> freeze partition after delete</span>
        Check that freeze partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> modify column after delete</span>
        Check that modify column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> unfreeze partition after delete</span>
        Check that unfreeze partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedCollapsingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> add column after delete</span>
        Check that add column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> attach partition after delete</span>
        Check that attach partition after delete perform correctly with replicated table on single node.
<span class="rx">      XFail</span> attach partition after delete, engine type not supported.
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> clear column after delete</span>
        Check that clear column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> comment column after delete</span>
        Check that comment column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> detach partition after delete</span>
        Check that detach partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop column after delete</span>
        Check that drop column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop partition after delete</span>
        Check that drop partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> fetch partition after delete</span>
        Check that fetch partition after delete perform correctly with replicated table on single node.
<span class="rx">      XFail</span> fetch partition after delete, engine type not supported.
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> freeze partition after delete</span>
        Check that freeze partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> modify column after delete</span>
        Check that modify column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> unfreeze partition after delete</span>
        Check that unfreeze partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedVersionedCollapsingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> add column after delete</span>
        Check that add column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> attach partition after delete</span>
        Check that attach partition after delete perform correctly with replicated table on single node.
<span class="rx">      XFail</span> attach partition after delete, engine type not supported.
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> clear column after delete</span>
        Check that clear column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> comment column after delete</span>
        Check that comment column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> detach partition after delete</span>
        Check that detach partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop column after delete</span>
        Check that drop column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop partition after delete</span>
        Check that drop partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> fetch partition after delete</span>
        Check that fetch partition after delete perform correctly with replicated table on single node.
<span class="rx">      XFail</span> fetch partition after delete, engine type not supported.
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> freeze partition after delete</span>
        Check that freeze partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> modify column after delete</span>
        Check that modify column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> unfreeze partition after delete</span>
        Check that unfreeze partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedGraphiteMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> add column after delete</span>
        Check that add column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> attach partition after delete</span>
        Check that attach partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> clear column after delete</span>
        Check that clear column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> comment column after delete</span>
        Check that comment column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> detach partition after delete</span>
        Check that detach partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop column after delete</span>
        Check that drop column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop partition after delete</span>
        Check that drop partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> fetch partition after delete</span>
        Check that fetch partition after delete perform correctly with replicated table on single node.
<span class="rx">      XFail</span> fetch partition after delete, engine type not supported.
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> freeze partition after delete</span>
        Check that freeze partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> modify column after delete</span>
        Check that modify column after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> unfreeze partition after delete</span>
        Check that unfreeze partition after delete perform correctly with replicated table on single node.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">  </span><span class="kn">Feature</span><span class="nn"> non deterministic functions</span>
    Check that clickhouse support delete statement when where clause contains
    nondeterministic function.
<span class="ro">  OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> nondeterministic function</span>
      Check that clickhouse support delete statement when where clause contains
      nondeterministic function now().
<span class="ro">    OK</span><span class="k"></span>
<span class="k">  </span><span class="kn">Feature</span><span class="nn"> performance</span>
    Check that clickhouse lightweight delete statement has good performance.
<span class="ro">  OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> performance post delete select</span>
      Check that clickhouse select statement performance is not degrade or degrade insignificantly on
      tables that contain rows deleted using the DELETE statement.
<span class="ro">    OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> performance with primary key many partitions</span>
      Check that clickhouse have similar performance between delete and select statements with primary key.
<span class="ro">    OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> performance with primary key many parts</span>
      Check that clickhouse have similar performance between delete and select statements with primary key.
<span class="ro">    OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> performance without primary key</span>
      Check that clickhouse have similar performance between delete and select statements without primary key.
<span class="ro">    OK</span><span class="k"></span>
<span class="k">  </span><span class="kn">Feature</span><span class="nn"> distributed tables</span>
    Check that clickhouse supports delete statement with distributed tables.
<span class="ro">  OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> distributed table replicated</span>
      Check that ClickHouse supports delete statement for distributed tables
      when distributed table configuration contains 1 shard and 3 replicas.
<span class="rx">    XFail</span> distributed table replicated, engine type not supported.
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> distributed table sharded</span>
      Check that ClickHouse supports delete statement for distributed tables
      when distributed table configuration contains 3 shard 1 replica in each.
<span class="ro">    OK</span><span class="k"></span>
<span class="k">  </span><span class="kn">Feature</span><span class="nn"> replication queue</span>
    Check that clickhouse write delete statement in replication queue correctly.
<span class="ro">  OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replication queue</span>
        Check that clickhouse writes delete statement in replication queue correctly
        by creating replicated table, deleting from it and checking that DELETE statement
        appeared in system.replication_queue table.
<span class="rx">      XFail</span> replication queue, engine type not supported.
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedReplacingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replication queue</span>
        Check that clickhouse writes delete statement in replication queue correctly
        by creating replicated table, deleting from it and checking that DELETE statement
        appeared in system.replication_queue table.
<span class="rx">      XFail</span> replication queue, engine type not supported.
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedSummingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replication queue</span>
        Check that clickhouse writes delete statement in replication queue correctly
        by creating replicated table, deleting from it and checking that DELETE statement
        appeared in system.replication_queue table.
<span class="rx">      XFail</span> replication queue, engine type not supported.
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedAggregatingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replication queue</span>
        Check that clickhouse writes delete statement in replication queue correctly
        by creating replicated table, deleting from it and checking that DELETE statement
        appeared in system.replication_queue table.
<span class="rx">      XFail</span> replication queue, engine type not supported.
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedCollapsingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replication queue</span>
        Check that clickhouse writes delete statement in replication queue correctly
        by creating replicated table, deleting from it and checking that DELETE statement
        appeared in system.replication_queue table.
<span class="rx">      XFail</span> replication queue, engine type not supported.
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedVersionedCollapsingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replication queue</span>
        Check that clickhouse writes delete statement in replication queue correctly
        by creating replicated table, deleting from it and checking that DELETE statement
        appeared in system.replication_queue table.
<span class="rx">      XFail</span> replication queue, engine type not supported.
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedGraphiteMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replication queue</span>
        Check that clickhouse writes delete statement in replication queue correctly
        by creating replicated table, deleting from it and checking that DELETE statement
        appeared in system.replication_queue table.
<span class="rx">      XFail</span> replication queue, engine type not supported.
<span class="k">  </span><span class="kn">Feature</span><span class="nn"> replicated tables</span>
    Check that delete operations replicate in an eventually consistent manner between replicas.
<span class="ro">  OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap entire table</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with without overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap entire table</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedReplacingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap entire table</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with without overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap entire table</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedSummingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap entire table</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with without overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap entire table</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedAggregatingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap entire table</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with without overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap entire table</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedCollapsingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap entire table</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with without overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap entire table</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedVersionedCollapsingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap entire table</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with without overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap entire table</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplicatedGraphiteMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with overlap entire table</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting with without overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replicated table deleting without overlap entire table</span>
        Check that clickhouse support DELETE statement which is related to replicated table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">  </span><span class="kn">Feature</span><span class="nn"> delete and tiered storage ttl</span>
    Check that delete in table that uses tiered storage ttl perform correctly.
<span class="ro">  OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> delete with multi volume policy using ttl</span>
      Check that delete in table that uses tiered storage ttl perform correctly.
      I create parts on 2 volumes with 1 disk in each and delete some values in each volume.
      Using the following policy:
          volume0: disk local00
          volume1: disk local10
<span class="ro">    OK</span><span class="k"></span>
<span class="k">  </span><span class="kn">Feature</span><span class="nn"> alter after delete with stop merges</span>
    Check that clickhouse supports alter operations after delete with STOP MERGES.
<span class="ro">  OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> MergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> add column after delete</span>
        Check that alter add column after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> attach partition after delete</span>
        Check that attach partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> clear column after delete</span>
        Check that alter clear column after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> comment column after delete</span>
        Check that alter comment column after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> detach partition after delete</span>
        Check that detach partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop partition after delete</span>
        Check that drop partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> freeze partition after delete</span>
        Check that freeze partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> unfreeze partition after delete</span>
        Check that unfreeze partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplacingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> add column after delete</span>
        Check that alter add column after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> attach partition after delete</span>
        Check that attach partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> clear column after delete</span>
        Check that alter clear column after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> comment column after delete</span>
        Check that alter comment column after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> detach partition after delete</span>
        Check that detach partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop partition after delete</span>
        Check that drop partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> freeze partition after delete</span>
        Check that freeze partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> unfreeze partition after delete</span>
        Check that unfreeze partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> SummingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> add column after delete</span>
        Check that alter add column after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> attach partition after delete</span>
        Check that attach partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> clear column after delete</span>
        Check that alter clear column after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> comment column after delete</span>
        Check that alter comment column after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> detach partition after delete</span>
        Check that detach partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop partition after delete</span>
        Check that drop partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> freeze partition after delete</span>
        Check that freeze partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> unfreeze partition after delete</span>
        Check that unfreeze partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> AggregatingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> add column after delete</span>
        Check that alter add column after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> attach partition after delete</span>
        Check that attach partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> clear column after delete</span>
        Check that alter clear column after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> comment column after delete</span>
        Check that alter comment column after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> detach partition after delete</span>
        Check that detach partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop partition after delete</span>
        Check that drop partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> freeze partition after delete</span>
        Check that freeze partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> unfreeze partition after delete</span>
        Check that unfreeze partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> CollapsingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> add column after delete</span>
        Check that alter add column after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> attach partition after delete</span>
        Check that attach partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> clear column after delete</span>
        Check that alter clear column after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> comment column after delete</span>
        Check that alter comment column after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> detach partition after delete</span>
        Check that detach partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop partition after delete</span>
        Check that drop partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> freeze partition after delete</span>
        Check that freeze partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> unfreeze partition after delete</span>
        Check that unfreeze partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> VersionedCollapsingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> add column after delete</span>
        Check that alter add column after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> attach partition after delete</span>
        Check that attach partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> clear column after delete</span>
        Check that alter clear column after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> comment column after delete</span>
        Check that alter comment column after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> detach partition after delete</span>
        Check that detach partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop partition after delete</span>
        Check that drop partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> freeze partition after delete</span>
        Check that freeze partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> unfreeze partition after delete</span>
        Check that unfreeze partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> GraphiteMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> add column after delete</span>
        Check that alter add column after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> attach partition after delete</span>
        Check that attach partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> clear column after delete</span>
        Check that alter clear column after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> comment column after delete</span>
        Check that alter comment column after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> detach partition after delete</span>
        Check that detach partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop partition after delete</span>
        Check that drop partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> freeze partition after delete</span>
        Check that freeze partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> unfreeze partition after delete</span>
        Check that unfreeze partition after lightweight delete with STOP MERGES perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">  </span><span class="kn">Feature</span><span class="nn"> encrypted disk</span>
    Check that lightweight delete in table that stored on encrypted disk perform correctly.
<span class="ro">  OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> encrypted disk</span>
      Check that lightweight delete in table that stored on encrypted disk perform correctly.
<span class="ro">    OK</span><span class="k"></span>
<span class="k">  </span><span class="kn">Feature</span><span class="nn"> delete and column ttl</span>
    Check that delete and column ttl together perform correctly.
<span class="ro">  OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> column ttl after delete</span>
      Check that column ttl after delete perform correctly.
<span class="ro">    OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> delete after column ttl</span>
      Check that delete statement after column ttl perform correctly.
<span class="ro">    OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> delete and column ttl concurrent</span>
      Check that concurrent lightweight delete and column ttl perform correctly.
<span class="ro">    OK</span><span class="k"></span>
<span class="k">  </span><span class="kn">Feature</span><span class="nn"> alter after delete</span>
    Check that clickhouse supports alter operations after lightweight delete.
<span class="ro">  OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> MergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> add column after delete</span>
        Check that add column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> attach partition after delete</span>
        Check that attach partition after delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> clear column after delete</span>
        Check that clear column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> comment column after delete</span>
        Check that alter comment column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> detach partition after delete</span>
        Check that detach partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop column after delete</span>
        Check that drop column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop partition after delete</span>
        Check that drop partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> freeze partition after delete</span>
        Check that freeze partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> modify column after delete</span>
        Check that modify column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> move partition after delete</span>
        Check that alter move partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replace partition after delete</span>
        Check that replace partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> unfreeze partition after delete</span>
        Check that unfreeze partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplacingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> add column after delete</span>
        Check that add column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> attach partition after delete</span>
        Check that attach partition after delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> clear column after delete</span>
        Check that clear column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> comment column after delete</span>
        Check that alter comment column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> detach partition after delete</span>
        Check that detach partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop column after delete</span>
        Check that drop column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop partition after delete</span>
        Check that drop partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> freeze partition after delete</span>
        Check that freeze partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> modify column after delete</span>
        Check that modify column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> move partition after delete</span>
        Check that alter move partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replace partition after delete</span>
        Check that replace partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> unfreeze partition after delete</span>
        Check that unfreeze partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> SummingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> add column after delete</span>
        Check that add column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> attach partition after delete</span>
        Check that attach partition after delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> clear column after delete</span>
        Check that clear column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> comment column after delete</span>
        Check that alter comment column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> detach partition after delete</span>
        Check that detach partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop column after delete</span>
        Check that drop column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop partition after delete</span>
        Check that drop partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> freeze partition after delete</span>
        Check that freeze partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> modify column after delete</span>
        Check that modify column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> move partition after delete</span>
        Check that alter move partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replace partition after delete</span>
        Check that replace partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> unfreeze partition after delete</span>
        Check that unfreeze partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> AggregatingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> add column after delete</span>
        Check that add column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> attach partition after delete</span>
        Check that attach partition after delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> clear column after delete</span>
        Check that clear column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> comment column after delete</span>
        Check that alter comment column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> detach partition after delete</span>
        Check that detach partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop column after delete</span>
        Check that drop column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop partition after delete</span>
        Check that drop partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> freeze partition after delete</span>
        Check that freeze partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> modify column after delete</span>
        Check that modify column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> move partition after delete</span>
        Check that alter move partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replace partition after delete</span>
        Check that replace partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> unfreeze partition after delete</span>
        Check that unfreeze partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> CollapsingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> add column after delete</span>
        Check that add column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> attach partition after delete</span>
        Check that attach partition after delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> clear column after delete</span>
        Check that clear column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> comment column after delete</span>
        Check that alter comment column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> detach partition after delete</span>
        Check that detach partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop column after delete</span>
        Check that drop column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop partition after delete</span>
        Check that drop partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> freeze partition after delete</span>
        Check that freeze partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> modify column after delete</span>
        Check that modify column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> move partition after delete</span>
        Check that alter move partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replace partition after delete</span>
        Check that replace partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> unfreeze partition after delete</span>
        Check that unfreeze partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> VersionedCollapsingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> add column after delete</span>
        Check that add column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> attach partition after delete</span>
        Check that attach partition after delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> clear column after delete</span>
        Check that clear column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> comment column after delete</span>
        Check that alter comment column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> detach partition after delete</span>
        Check that detach partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop column after delete</span>
        Check that drop column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop partition after delete</span>
        Check that drop partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> freeze partition after delete</span>
        Check that freeze partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> modify column after delete</span>
        Check that modify column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> move partition after delete</span>
        Check that alter move partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replace partition after delete</span>
        Check that replace partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> unfreeze partition after delete</span>
        Check that unfreeze partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> GraphiteMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> add column after delete</span>
        Check that add column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> attach partition after delete</span>
        Check that attach partition after delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> clear column after delete</span>
        Check that clear column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> comment column after delete</span>
        Check that alter comment column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> detach partition after delete</span>
        Check that detach partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop column after delete</span>
        Check that drop column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> drop partition after delete</span>
        Check that drop partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> freeze partition after delete</span>
        Check that freeze partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> modify column after delete</span>
        Check that modify column after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> move partition after delete</span>
        Check that alter move partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> replace partition after delete</span>
        Check that replace partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> unfreeze partition after delete</span>
        Check that unfreeze partition after lightweight delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">  </span><span class="kn">Feature</span><span class="nn"> random concurrent alter</span>
    Check that clickhouse supports concurrent deletes with alter operations.
<span class="ro">  OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> random concurrent alter</span>
      Check that clickhouse supports concurrent deletes with alter operations
      when random alter operations perform in ransom order.
<span class="ro">    OK</span><span class="k"></span>
<span class="k">  </span><span class="kn">Feature</span><span class="nn"> concurrent alter and delete</span>
    Check that clickhouse supports concurrent deletes with alter operations.
<span class="ro">  OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> MergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent add drop column and delete</span>
        Check that concurrent delete and add drop column perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent clear update and delete</span>
        Check that concurrent clear column update column and delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete attach detach partition</span>
        Check that concurrent delete and attach detach partition perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete drop partition</span>
        Check that concurrent delete and drop partition perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete freeze partition</span>
        Check that concurrent delete and freeze partition perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent modify column and delete</span>
        Check that concurrent delete and add drop column perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplacingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent add drop column and delete</span>
        Check that concurrent delete and add drop column perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent clear update and delete</span>
        Check that concurrent clear column update column and delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete attach detach partition</span>
        Check that concurrent delete and attach detach partition perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete drop partition</span>
        Check that concurrent delete and drop partition perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete freeze partition</span>
        Check that concurrent delete and freeze partition perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent modify column and delete</span>
        Check that concurrent delete and add drop column perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> SummingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent add drop column and delete</span>
        Check that concurrent delete and add drop column perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent clear update and delete</span>
        Check that concurrent clear column update column and delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete attach detach partition</span>
        Check that concurrent delete and attach detach partition perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete drop partition</span>
        Check that concurrent delete and drop partition perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete freeze partition</span>
        Check that concurrent delete and freeze partition perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent modify column and delete</span>
        Check that concurrent delete and add drop column perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> AggregatingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent add drop column and delete</span>
        Check that concurrent delete and add drop column perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent clear update and delete</span>
        Check that concurrent clear column update column and delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete attach detach partition</span>
        Check that concurrent delete and attach detach partition perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete drop partition</span>
        Check that concurrent delete and drop partition perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete freeze partition</span>
        Check that concurrent delete and freeze partition perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent modify column and delete</span>
        Check that concurrent delete and add drop column perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> CollapsingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent add drop column and delete</span>
        Check that concurrent delete and add drop column perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent clear update and delete</span>
        Check that concurrent clear column update column and delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete attach detach partition</span>
        Check that concurrent delete and attach detach partition perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete drop partition</span>
        Check that concurrent delete and drop partition perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete freeze partition</span>
        Check that concurrent delete and freeze partition perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent modify column and delete</span>
        Check that concurrent delete and add drop column perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> VersionedCollapsingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent add drop column and delete</span>
        Check that concurrent delete and add drop column perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent clear update and delete</span>
        Check that concurrent clear column update column and delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete attach detach partition</span>
        Check that concurrent delete and attach detach partition perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete drop partition</span>
        Check that concurrent delete and drop partition perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete freeze partition</span>
        Check that concurrent delete and freeze partition perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent modify column and delete</span>
        Check that concurrent delete and add drop column perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> GraphiteMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent add drop column and delete</span>
        Check that concurrent delete and add drop column perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent clear update and delete</span>
        Check that concurrent clear column update column and delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete attach detach partition</span>
        Check that concurrent delete and attach detach partition perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete drop partition</span>
        Check that concurrent delete and drop partition perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete freeze partition</span>
        Check that concurrent delete and freeze partition perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent modify column and delete</span>
        Check that concurrent delete and add drop column perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">  </span><span class="kn">Feature</span><span class="nn"> concurrent delete</span>
    Check, that clickhouse DELETE statement SHALL perform correctly when there are
    multiple concurrent DELETE statements.
<span class="re">  Error</span> concurrent delete, TypeError
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> MergeTree</span><span class="re"></span>
<span class="re">    Error</span> MergeTree, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete with overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple concurrent DELETE statements targeting the same rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete with overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting the same rows.
<span class="re">      Error</span> concurrent delete with overlap with alter delete, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple concurrent DELETE statements targeting different rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete without overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting different rows.
<span class="re">      Error</span> concurrent delete without overlap with alter delete, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 25 percent of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting 25 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 25 percent of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting 25 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 75 percent of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting 75 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 75 percent of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting 75 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete entire table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting entire table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete entire table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting entire table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete half of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting half of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete half of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting half of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplacingMergeTree</span><span class="re"></span>
<span class="re">    Error</span> ReplacingMergeTree, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete with overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple concurrent DELETE statements targeting the same rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete with overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting the same rows.
<span class="re">      Error</span> concurrent delete with overlap with alter delete, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple concurrent DELETE statements targeting different rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete without overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting different rows.
<span class="re">      Error</span> concurrent delete without overlap with alter delete, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 25 percent of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting 25 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 25 percent of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting 25 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 75 percent of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting 75 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 75 percent of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting 75 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete entire table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting entire table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete entire table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting entire table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete half of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting half of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete half of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting half of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> SummingMergeTree</span><span class="re"></span>
<span class="re">    Error</span> SummingMergeTree, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete with overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple concurrent DELETE statements targeting the same rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete with overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting the same rows.
<span class="re">      Error</span> concurrent delete with overlap with alter delete, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple concurrent DELETE statements targeting different rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete without overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting different rows.
<span class="re">      Error</span> concurrent delete without overlap with alter delete, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 25 percent of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting 25 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 25 percent of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting 25 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 75 percent of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting 75 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 75 percent of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting 75 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete entire table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting entire table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete entire table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting entire table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete half of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting half of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete half of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting half of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> AggregatingMergeTree</span><span class="re"></span>
<span class="re">    Error</span> AggregatingMergeTree, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete with overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple concurrent DELETE statements targeting the same rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete with overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting the same rows.
<span class="re">      Error</span> concurrent delete with overlap with alter delete, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple concurrent DELETE statements targeting different rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete without overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting different rows.
<span class="re">      Error</span> concurrent delete without overlap with alter delete, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 25 percent of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting 25 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 25 percent of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting 25 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 75 percent of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting 75 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 75 percent of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting 75 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete entire table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting entire table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete entire table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting entire table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete half of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting half of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete half of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting half of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> CollapsingMergeTree</span><span class="re"></span>
<span class="re">    Error</span> CollapsingMergeTree, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete with overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple concurrent DELETE statements targeting the same rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete with overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting the same rows.
<span class="re">      Error</span> concurrent delete with overlap with alter delete, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple concurrent DELETE statements targeting different rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete without overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting different rows.
<span class="re">      Error</span> concurrent delete without overlap with alter delete, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 25 percent of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting 25 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 25 percent of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting 25 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 75 percent of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting 75 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 75 percent of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting 75 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete entire table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting entire table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete entire table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting entire table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete half of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting half of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete half of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting half of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> VersionedCollapsingMergeTree</span><span class="re"></span>
<span class="re">    Error</span> VersionedCollapsingMergeTree, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete with overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple concurrent DELETE statements targeting the same rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete with overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting the same rows.
<span class="re">      Error</span> concurrent delete with overlap with alter delete, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple concurrent DELETE statements targeting different rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete without overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting different rows.
<span class="re">      Error</span> concurrent delete without overlap with alter delete, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 25 percent of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting 25 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 25 percent of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting 25 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 75 percent of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting 75 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 75 percent of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting 75 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete entire table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting entire table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete entire table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting entire table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete half of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting half of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete half of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting half of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> GraphiteMergeTree</span><span class="re"></span>
<span class="re">    Error</span> GraphiteMergeTree, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete with overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple concurrent DELETE statements targeting the same rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete with overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting the same rows.
<span class="re">      Error</span> concurrent delete with overlap with alter delete, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple concurrent DELETE statements targeting different rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete without overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting different rows.
<span class="re">      Error</span> concurrent delete without overlap with alter delete, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 25 percent of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting 25 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 25 percent of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting 25 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 75 percent of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting 75 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 75 percent of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting 75 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete entire table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting entire table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete entire table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting entire table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete half of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting half of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete half of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting half of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">  </span><span class="kn">Feature</span><span class="nn"> invalid where clause</span>
    Check that clickhouse returns an error when using DELETE statement with invalid WHERE clause.
<span class="ro">  OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> MergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> empty where clause</span>
        Check that clickhouse returns an error when using DELETE statement with empty WHERE clause.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> no where</span>
        Check that clickhouse returns an error when using DELETE statement with no WHERE clause.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplacingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> empty where clause</span>
        Check that clickhouse returns an error when using DELETE statement with empty WHERE clause.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> no where</span>
        Check that clickhouse returns an error when using DELETE statement with no WHERE clause.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> SummingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> empty where clause</span>
        Check that clickhouse returns an error when using DELETE statement with empty WHERE clause.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> no where</span>
        Check that clickhouse returns an error when using DELETE statement with no WHERE clause.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> AggregatingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> empty where clause</span>
        Check that clickhouse returns an error when using DELETE statement with empty WHERE clause.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> no where</span>
        Check that clickhouse returns an error when using DELETE statement with no WHERE clause.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> CollapsingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> empty where clause</span>
        Check that clickhouse returns an error when using DELETE statement with empty WHERE clause.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> no where</span>
        Check that clickhouse returns an error when using DELETE statement with no WHERE clause.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> VersionedCollapsingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> empty where clause</span>
        Check that clickhouse returns an error when using DELETE statement with empty WHERE clause.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> no where</span>
        Check that clickhouse returns an error when using DELETE statement with no WHERE clause.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> GraphiteMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> empty where clause</span>
        Check that clickhouse returns an error when using DELETE statement with empty WHERE clause.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> no where</span>
        Check that clickhouse returns an error when using DELETE statement with no WHERE clause.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">  </span><span class="kn">Feature</span><span class="nn"> immediate removal</span>
    Check that clickhouse immediately remove all rows for subsequent SELECTs
    after DELETE statement is executed and the subsequent SELECT statements
    not apply the original WHERE conditions specified in the DELETE.
<span class="ro">  OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> MergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete most of the table</span>
        Check that clickhouse immediately remove all rows for subsequent SELECTs
        after DELETE statement is executed.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplacingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete most of the table</span>
        Check that clickhouse immediately remove all rows for subsequent SELECTs
        after DELETE statement is executed.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> SummingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete most of the table</span>
        Check that clickhouse immediately remove all rows for subsequent SELECTs
        after DELETE statement is executed.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> AggregatingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete most of the table</span>
        Check that clickhouse immediately remove all rows for subsequent SELECTs
        after DELETE statement is executed.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> CollapsingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete most of the table</span>
        Check that clickhouse immediately remove all rows for subsequent SELECTs
        after DELETE statement is executed.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> VersionedCollapsingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete most of the table</span>
        Check that clickhouse immediately remove all rows for subsequent SELECTs
        after DELETE statement is executed.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> GraphiteMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete most of the table</span>
        Check that clickhouse immediately remove all rows for subsequent SELECTs
        after DELETE statement is executed.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">  </span><span class="kn">Feature</span><span class="nn"> basic checks</span>
    Run basic checks for the DELETE statement in ClickHouse.
<span class="ro">  OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> one million datapoints</span>
      Check DELETE with a table that has one million entries.
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete all rows</span>
        Check that DELETE can remove all rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete all rows from half of parts</span>
        Check that DELETE can remove all rows from half of the parts.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete large subset</span>
        Check that DELETE can remove a large subset of rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete one row</span>
        Check that DELETE can remove one row.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete small subset</span>
        Check that DELETE can remove a small subset of rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete zero rows</span>
        Check that DELETE can remove zero rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> many partition mixed parts</span>
      Check DELETE with a table that has many partition, each with one large part and many small parts.
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete all rows</span>
        Check that DELETE can remove all rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete all rows from half of parts</span>
        Check that DELETE can remove all rows from half of the parts.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete large subset</span>
        Check that DELETE can remove a large subset of rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete one row</span>
        Check that DELETE can remove one row.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete small subset</span>
        Check that DELETE can remove a small subset of rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete zero rows</span>
        Check that DELETE can remove zero rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> many partition many parts</span>
      Check DELETE with a table that has many partition and many parts.
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete all rows</span>
        Check that DELETE can remove all rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete all rows from half of parts</span>
        Check that DELETE can remove all rows from half of the parts.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete large subset</span>
        Check that DELETE can remove a large subset of rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete one row</span>
        Check that DELETE can remove one row.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete small subset</span>
        Check that DELETE can remove a small subset of rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete zero rows</span>
        Check that DELETE can remove zero rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> many partition one part</span>
      Check DELETE with a table that has many partition and one part.
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete all rows</span>
        Check that DELETE can remove all rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete all rows from half of parts</span>
        Check that DELETE can remove all rows from half of the parts.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete large subset</span>
        Check that DELETE can remove a large subset of rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete one row</span>
        Check that DELETE can remove one row.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete small subset</span>
        Check that DELETE can remove a small subset of rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete zero rows</span>
        Check that DELETE can remove zero rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> one partition mixed parts</span>
      Check DELETE with a table that has one partition, one large part, and many small parts.
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete all rows</span>
        Check that DELETE can remove all rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete all rows from half of parts</span>
        Check that DELETE can remove all rows from half of the parts.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete large subset</span>
        Check that DELETE can remove a large subset of rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete one row</span>
        Check that DELETE can remove one row.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete small subset</span>
        Check that DELETE can remove a small subset of rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete zero rows</span>
        Check that DELETE can remove zero rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> one partition many parts</span>
      Check DELETE with a table that has one partition and many parts.
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete all rows</span>
        Check that DELETE can remove all rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete all rows from half of parts</span>
        Check that DELETE can remove all rows from half of the parts.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete large subset</span>
        Check that DELETE can remove a large subset of rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete one row</span>
        Check that DELETE can remove one row.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete small subset</span>
        Check that DELETE can remove a small subset of rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete zero rows</span>
        Check that DELETE can remove zero rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> one partition one part</span>
      Check DELETE with a table that has one partition and one part.
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete all rows</span>
        Check that DELETE can remove all rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete all rows from half of parts</span>
        Check that DELETE can remove all rows from half of the parts.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete large subset</span>
        Check that DELETE can remove a large subset of rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete one row</span>
        Check that DELETE can remove one row.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete small subset</span>
        Check that DELETE can remove a small subset of rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete zero rows</span>
        Check that DELETE can remove zero rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">  </span><span class="kn">Feature</span><span class="nn"> specific deletes</span>
    Check that clickhouse support random deletes and deletes with stop merges.
<span class="ro">  OK</span><span class="re"></span>
<span class="re">Error</span> lightweight delete, TypeError
  Traceback (most recent call last):
    File &quot;/usr/lib/python3.10/threading.py&quot;, line 966, in _bootstrap
      self._bootstrap_inner()
    File &quot;/usr/lib/python3.10/threading.py&quot;, line 1009, in _bootstrap_inner
      self.run()
    File &quot;/usr/lib/python3.10/threading.py&quot;, line 946, in run
      self._target(*self._args, **self._kwargs)
    File &quot;/usr/lib/python3.10/concurrent/futures/thread.py&quot;, line 58, in run
      result = self.fn(*self.args, **self.kwargs)
  TypeError: delete_odd() got an unexpected keyword argument &#39;check&#39;
</code></pre></div>


</div>

<section class="requirement"><span class="requirement-inline"><i class="utf-icon color-ok">✔</i>RQ.SRS-023.ClickHouse.LightweightDelete.ImmediateRemovalForSelects</span></section>

<div class="requirement-description hidden">

<p><a target="_blank" rel="nofollow noopener noreferrer" href="https://clickhouse.yandex">ClickHouse</a> SHALL immediately remove all rows for subsequent <code>SELECT</code>s after <code>DELETE</code> statement is executed
and the subsequent <code>SELECT</code> statements SHALL not apply the original <code>WHERE</code> conditions specified in the <code>DELETE</code>.</p>

<p>For example,</p>

<div class="highlight"><pre><span></span><code><span class="k">SELECT</span> <span class="k">count</span><span class="p">()</span> <span class="k">FROM</span> <span class="k">table</span><span class="p">;</span>
<span class="k">DELETE</span> <span class="k">FROM</span> <span class="k">table</span> <span class="k">WHERE</span> <span class="o">&lt;</span><span class="n">conditions</span> <span class="n">which</span> <span class="n">may</span> <span class="n">expensive</span> <span class="k">to</span> <span class="n">calculate</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">SELECT</span> <span class="k">count</span><span class="p">()</span> <span class="k">FROM</span> <span class="k">table</span><span class="p">;</span>  <span class="c1">-- deleted rows are not returned</span>
</code></pre></div>

</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">15s 999ms</span>/lightweight delete/immediate removal/MergeTree/delete most of the table</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete most of the table</span>
        Check that clickhouse immediately remove all rows for subsequent SELECTs
        after DELETE statement is executed.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_680f9399_3423_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_680f9399_3423_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert a lot of data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_680f9399_3423_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmp72s7xum0
            cat &quot;/tmp/tmp72s7xum0&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_680f9399_3423_11ed_b9de_572e856b5561 WHERE NOT(id&gt;0)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I delete all rows from the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_680f9399_3423_11ed_b9de_572e856b5561 WHERE id &gt; 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check that rows are deleted immediately
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_680f9399_3423_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_680f9399_3423_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">12s 348ms</span>/lightweight delete/immediate removal/ReplacingMergeTree/delete most of the table</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete most of the table</span>
        Check that clickhouse immediately remove all rows for subsequent SELECTs
        after DELETE statement is executed.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_721dd7a2_3423_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_721dd7a2_3423_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplacingMergeTree() PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert a lot of data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_721dd7a2_3423_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpg0lvr510
            cat &quot;/tmp/tmpg0lvr510&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_721dd7a2_3423_11ed_b9de_572e856b5561 WHERE NOT(id&gt;0)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I delete all rows from the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_721dd7a2_3423_11ed_b9de_572e856b5561 WHERE id &gt; 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check that rows are deleted immediately
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_721dd7a2_3423_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_721dd7a2_3423_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">11s 40ms</span>/lightweight delete/immediate removal/SummingMergeTree/delete most of the table</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete most of the table</span>
        Check that clickhouse immediately remove all rows for subsequent SELECTs
        after DELETE statement is executed.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_797b4c5a_3423_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_797b4c5a_3423_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = SummingMergeTree(x) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert a lot of data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_797b4c5a_3423_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpods82lhq
            cat &quot;/tmp/tmpods82lhq&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_797b4c5a_3423_11ed_b9de_572e856b5561 WHERE NOT(id&gt;0)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I delete all rows from the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_797b4c5a_3423_11ed_b9de_572e856b5561 WHERE id &gt; 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check that rows are deleted immediately
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_797b4c5a_3423_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_797b4c5a_3423_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">14s 541ms</span>/lightweight delete/immediate removal/AggregatingMergeTree/delete most of the table</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete most of the table</span>
        Check that clickhouse immediately remove all rows for subsequent SELECTs
        after DELETE statement is executed.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_800fbfa6_3423_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_800fbfa6_3423_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = AggregatingMergeTree() PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert a lot of data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_800fbfa6_3423_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpakhebl8r
            cat &quot;/tmp/tmpakhebl8r&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_800fbfa6_3423_11ed_b9de_572e856b5561 WHERE NOT(id&gt;0)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I delete all rows from the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_800fbfa6_3423_11ed_b9de_572e856b5561 WHERE id &gt; 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check that rows are deleted immediately
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_800fbfa6_3423_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_800fbfa6_3423_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">11s 653ms</span>/lightweight delete/immediate removal/CollapsingMergeTree/delete most of the table</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete most of the table</span>
        Check that clickhouse immediately remove all rows for subsequent SELECTs
        after DELETE statement is executed.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_88bab6ba_3423_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_88bab6ba_3423_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = CollapsingMergeTree(Sign) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert a lot of data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_88bab6ba_3423_11ed_b9de_572e856b5561 VALUES (0,0,1),(0,1,1),(0,2,1),(0,3,1),(0,4,1...&quot; &gt; /tmp/tmpzi2otwo_
            cat &quot;/tmp/tmpzi2otwo_&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_88bab6ba_3423_11ed_b9de_572e856b5561 WHERE NOT(id&gt;0)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I delete all rows from the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_88bab6ba_3423_11ed_b9de_572e856b5561 WHERE id &gt; 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check that rows are deleted immediately
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_88bab6ba_3423_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_88bab6ba_3423_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">13s 341ms</span>/lightweight delete/immediate removal/VersionedCollapsingMergeTree/delete most of the table</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete most of the table</span>
        Check that clickhouse immediately remove all rows for subsequent SELECTs
        after DELETE statement is executed.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_8fad4f32_3423_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_8fad4f32_3423_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = VersionedCollapsingMergeTree(Sign, id) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert a lot of data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_8fad4f32_3423_11ed_b9de_572e856b5561 VALUES (0,0,1),(0,1,1),(0,2,1),(0,3,1),(0,4,1...&quot; &gt; /tmp/tmpu48ih77q
            cat &quot;/tmp/tmpu48ih77q&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_8fad4f32_3423_11ed_b9de_572e856b5561 WHERE NOT(id&gt;0)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I delete all rows from the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_8fad4f32_3423_11ed_b9de_572e856b5561 WHERE id &gt; 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check that rows are deleted immediately
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_8fad4f32_3423_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_8fad4f32_3423_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">32s 711ms</span>/lightweight delete/immediate removal/GraphiteMergeTree/delete most of the table</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete most of the table</span>
        Check that clickhouse immediately remove all rows for subsequent SELECTs
        after DELETE statement is executed.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_97a09cd0_3423_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_97a09cd0_3423_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Path String, Time DateTime, Value Int64, Timestamp Int64) Engine = GraphiteMergeTree(&#39;graphite_rollup_example&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert a lot of data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_97a09cd0_3423_11ed_b9de_572e856b5561 VALUES (0,0, &#39;1&#39;, toDateTime(10), 10, 10),(0,...&quot; &gt; /tmp/tmp0ka8trla
            cat &quot;/tmp/tmp0ka8trla&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_97a09cd0_3423_11ed_b9de_572e856b5561 WHERE NOT(id&gt;0)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I delete all rows from the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_97a09cd0_3423_11ed_b9de_572e856b5561 WHERE id &gt; 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check that rows are deleted immediately
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_97a09cd0_3423_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_97a09cd0_3423_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<section class="requirement"><span class="requirement-inline"><i class="utf-icon color-ok">✔</i>RQ.SRS-023.ClickHouse.LightweightDelete.MultipleDeletes</span></section>

<div class="requirement-description hidden">

<p><a target="_blank" rel="nofollow noopener noreferrer" href="https://clickhouse.yandex">ClickHouse</a> SHALL support using multiple <code>DELETE</code> statements on the same table.</p>

</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">1s 508ms</span>/lightweight delete/multiple delete limitations/MergeTree/multiple delete</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> multiple delete</span>
        Check that clickhouse supports using multiple DELETE statements on the same table.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_bb758125_3407_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_bb758125_3407_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert a lot of data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_bb758125_3407_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpn__7vxv2
            cat &quot;/tmp/tmpn__7vxv2&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_bb758125_3407_11ed_b9de_572e856b5561 WHERE NOT(x &lt; 10)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I perform multiple delete
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_bb758125_3407_11ed_b9de_572e856b5561 WHERE  x = 0;DELETE FROM table_bb758125_3407_11ed_b9de_572e856b5561 WHERE  x = 1;DELETE FROM table_bb758125_3407_11ed_b9de_572e856b5561 WHERE  x = 2;DELETE FROM table_bb758125_3407_11ed_b9de_572e856b5561 WHERE  x = 3;DELETE FROM table_bb758125_3407_11ed_b9de_572e856b5561 WHERE  x = 4;DELETE FROM table_bb758125_3407_11ed_b9de_572e856b5561 WHERE  x = 5;DELETE FROM table_bb758125_3407_11ed_b9de_572e856b5561 WHERE  x = 6;DELETE FROM table_bb758125_3407_11ed_b9de_572e856b5561 WHERE  x = 7;DELETE FROM table_bb758125_3407_11ed_b9de_572e856b5561 WHERE  x = 8;DELETE FROM table_bb758125_3407_11ed_b9de_572e856b5561 WHERE  x = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check that rows are deleted
<span class="ro">        OK</span>
          Retry try #0
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_bb758125_3407_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_bb758125_3407_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">1s 510ms</span>/lightweight delete/multiple delete limitations/ReplacingMergeTree/multiple delete</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> multiple delete</span>
        Check that clickhouse supports using multiple DELETE statements on the same table.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_bb75816b_3407_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_bb75816b_3407_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplacingMergeTree() PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert a lot of data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_bb75816b_3407_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpo2z3kzh8
            cat &quot;/tmp/tmpo2z3kzh8&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_bb75816b_3407_11ed_b9de_572e856b5561 WHERE NOT(x &lt; 10)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I perform multiple delete
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_bb75816b_3407_11ed_b9de_572e856b5561 WHERE  x = 0;DELETE FROM table_bb75816b_3407_11ed_b9de_572e856b5561 WHERE  x = 1;DELETE FROM table_bb75816b_3407_11ed_b9de_572e856b5561 WHERE  x = 2;DELETE FROM table_bb75816b_3407_11ed_b9de_572e856b5561 WHERE  x = 3;DELETE FROM table_bb75816b_3407_11ed_b9de_572e856b5561 WHERE  x = 4;DELETE FROM table_bb75816b_3407_11ed_b9de_572e856b5561 WHERE  x = 5;DELETE FROM table_bb75816b_3407_11ed_b9de_572e856b5561 WHERE  x = 6;DELETE FROM table_bb75816b_3407_11ed_b9de_572e856b5561 WHERE  x = 7;DELETE FROM table_bb75816b_3407_11ed_b9de_572e856b5561 WHERE  x = 8;DELETE FROM table_bb75816b_3407_11ed_b9de_572e856b5561 WHERE  x = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check that rows are deleted
<span class="ro">        OK</span>
          Retry try #0
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_bb75816b_3407_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_bb75816b_3407_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">1s 354ms</span>/lightweight delete/multiple delete limitations/SummingMergeTree/multiple delete</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> multiple delete</span>
        Check that clickhouse supports using multiple DELETE statements on the same table.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_bc88a7de_3407_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_bc88a7de_3407_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = SummingMergeTree(x) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert a lot of data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_bc88a7de_3407_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpnmhfw199
            cat &quot;/tmp/tmpnmhfw199&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_bc88a7de_3407_11ed_b9de_572e856b5561 WHERE NOT(x &lt; 10)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I perform multiple delete
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_bc88a7de_3407_11ed_b9de_572e856b5561 WHERE  x = 0;DELETE FROM table_bc88a7de_3407_11ed_b9de_572e856b5561 WHERE  x = 1;DELETE FROM table_bc88a7de_3407_11ed_b9de_572e856b5561 WHERE  x = 2;DELETE FROM table_bc88a7de_3407_11ed_b9de_572e856b5561 WHERE  x = 3;DELETE FROM table_bc88a7de_3407_11ed_b9de_572e856b5561 WHERE  x = 4;DELETE FROM table_bc88a7de_3407_11ed_b9de_572e856b5561 WHERE  x = 5;DELETE FROM table_bc88a7de_3407_11ed_b9de_572e856b5561 WHERE  x = 6;DELETE FROM table_bc88a7de_3407_11ed_b9de_572e856b5561 WHERE  x = 7;DELETE FROM table_bc88a7de_3407_11ed_b9de_572e856b5561 WHERE  x = 8;DELETE FROM table_bc88a7de_3407_11ed_b9de_572e856b5561 WHERE  x = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check that rows are deleted
<span class="ro">        OK</span>
          Retry try #0
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_bc88a7de_3407_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_bc88a7de_3407_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">1s 502ms</span>/lightweight delete/multiple delete limitations/AggregatingMergeTree/multiple delete</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> multiple delete</span>
        Check that clickhouse supports using multiple DELETE statements on the same table.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_bdc3fbd1_3407_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_bdc3fbd1_3407_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = AggregatingMergeTree() PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert a lot of data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_bdc3fbd1_3407_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpzqqaro57
            cat &quot;/tmp/tmpzqqaro57&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_bdc3fbd1_3407_11ed_b9de_572e856b5561 WHERE NOT(x &lt; 10)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I perform multiple delete
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_bdc3fbd1_3407_11ed_b9de_572e856b5561 WHERE  x = 0;DELETE FROM table_bdc3fbd1_3407_11ed_b9de_572e856b5561 WHERE  x = 1;DELETE FROM table_bdc3fbd1_3407_11ed_b9de_572e856b5561 WHERE  x = 2;DELETE FROM table_bdc3fbd1_3407_11ed_b9de_572e856b5561 WHERE  x = 3;DELETE FROM table_bdc3fbd1_3407_11ed_b9de_572e856b5561 WHERE  x = 4;DELETE FROM table_bdc3fbd1_3407_11ed_b9de_572e856b5561 WHERE  x = 5;DELETE FROM table_bdc3fbd1_3407_11ed_b9de_572e856b5561 WHERE  x = 6;DELETE FROM table_bdc3fbd1_3407_11ed_b9de_572e856b5561 WHERE  x = 7;DELETE FROM table_bdc3fbd1_3407_11ed_b9de_572e856b5561 WHERE  x = 8;DELETE FROM table_bdc3fbd1_3407_11ed_b9de_572e856b5561 WHERE  x = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check that rows are deleted
<span class="ro">        OK</span>
          Retry try #0
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_bdc3fbd1_3407_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_bdc3fbd1_3407_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">6s 845ms</span>/lightweight delete/multiple delete limitations/CollapsingMergeTree/multiple delete</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> multiple delete</span>
        Check that clickhouse supports using multiple DELETE statements on the same table.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_bef4b2a9_3407_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_bef4b2a9_3407_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = CollapsingMergeTree(Sign) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert a lot of data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_bef4b2a9_3407_11ed_b9de_572e856b5561 VALUES (0,0,1),(0,1,1),(0,2,1),(0,3,1),(0,4,1...&quot; &gt; /tmp/tmpz0lqniyn
            cat &quot;/tmp/tmpz0lqniyn&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_bef4b2a9_3407_11ed_b9de_572e856b5561 WHERE NOT(x &lt; 10)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I perform multiple delete
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_bef4b2a9_3407_11ed_b9de_572e856b5561 WHERE  x = 0;DELETE FROM table_bef4b2a9_3407_11ed_b9de_572e856b5561 WHERE  x = 1;DELETE FROM table_bef4b2a9_3407_11ed_b9de_572e856b5561 WHERE  x = 2;DELETE FROM table_bef4b2a9_3407_11ed_b9de_572e856b5561 WHERE  x = 3;DELETE FROM table_bef4b2a9_3407_11ed_b9de_572e856b5561 WHERE  x = 4;DELETE FROM table_bef4b2a9_3407_11ed_b9de_572e856b5561 WHERE  x = 5;DELETE FROM table_bef4b2a9_3407_11ed_b9de_572e856b5561 WHERE  x = 6;DELETE FROM table_bef4b2a9_3407_11ed_b9de_572e856b5561 WHERE  x = 7;DELETE FROM table_bef4b2a9_3407_11ed_b9de_572e856b5561 WHERE  x = 8;DELETE FROM table_bef4b2a9_3407_11ed_b9de_572e856b5561 WHERE  x = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check that rows are deleted
<span class="ro">        OK</span>
          Retry try #0
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_bef4b2a9_3407_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_bef4b2a9_3407_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">1s 509ms</span>/lightweight delete/multiple delete limitations/VersionedCollapsingMergeTree/multiple delete</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> multiple delete</span>
        Check that clickhouse supports using multiple DELETE statements on the same table.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_c30775b1_3407_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_c30775b1_3407_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = VersionedCollapsingMergeTree(Sign, id) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert a lot of data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_c30775b1_3407_11ed_b9de_572e856b5561 VALUES (0,0,1),(0,1,1),(0,2,1),(0,3,1),(0,4,1...&quot; &gt; /tmp/tmpxqkgi8ud
            cat &quot;/tmp/tmpxqkgi8ud&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_c30775b1_3407_11ed_b9de_572e856b5561 WHERE NOT(x &lt; 10)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I perform multiple delete
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_c30775b1_3407_11ed_b9de_572e856b5561 WHERE  x = 0;DELETE FROM table_c30775b1_3407_11ed_b9de_572e856b5561 WHERE  x = 1;DELETE FROM table_c30775b1_3407_11ed_b9de_572e856b5561 WHERE  x = 2;DELETE FROM table_c30775b1_3407_11ed_b9de_572e856b5561 WHERE  x = 3;DELETE FROM table_c30775b1_3407_11ed_b9de_572e856b5561 WHERE  x = 4;DELETE FROM table_c30775b1_3407_11ed_b9de_572e856b5561 WHERE  x = 5;DELETE FROM table_c30775b1_3407_11ed_b9de_572e856b5561 WHERE  x = 6;DELETE FROM table_c30775b1_3407_11ed_b9de_572e856b5561 WHERE  x = 7;DELETE FROM table_c30775b1_3407_11ed_b9de_572e856b5561 WHERE  x = 8;DELETE FROM table_c30775b1_3407_11ed_b9de_572e856b5561 WHERE  x = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check that rows are deleted
<span class="ro">        OK</span>
          Retry try #0
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_c30775b1_3407_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_c30775b1_3407_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">1s 336ms</span>/lightweight delete/multiple delete limitations/GraphiteMergeTree/multiple delete</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> multiple delete</span>
        Check that clickhouse supports using multiple DELETE statements on the same table.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_c3f2803d_3407_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_c3f2803d_3407_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Path String, Time DateTime, Value Int64, Timestamp Int64) Engine = GraphiteMergeTree(&#39;graphite_rollup_example&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert a lot of data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_c3f2803d_3407_11ed_b9de_572e856b5561 VALUES (0,0, &#39;1&#39;, toDateTime(10), 10, 10),(0,...&quot; &gt; /tmp/tmp4dribhgm
            cat &quot;/tmp/tmp4dribhgm&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_c3f2803d_3407_11ed_b9de_572e856b5561 WHERE NOT(x &lt; 10)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I perform multiple delete
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_c3f2803d_3407_11ed_b9de_572e856b5561 WHERE  x = 0;DELETE FROM table_c3f2803d_3407_11ed_b9de_572e856b5561 WHERE  x = 1;DELETE FROM table_c3f2803d_3407_11ed_b9de_572e856b5561 WHERE  x = 2;DELETE FROM table_c3f2803d_3407_11ed_b9de_572e856b5561 WHERE  x = 3;DELETE FROM table_c3f2803d_3407_11ed_b9de_572e856b5561 WHERE  x = 4;DELETE FROM table_c3f2803d_3407_11ed_b9de_572e856b5561 WHERE  x = 5;DELETE FROM table_c3f2803d_3407_11ed_b9de_572e856b5561 WHERE  x = 6;DELETE FROM table_c3f2803d_3407_11ed_b9de_572e856b5561 WHERE  x = 7;DELETE FROM table_c3f2803d_3407_11ed_b9de_572e856b5561 WHERE  x = 8;DELETE FROM table_c3f2803d_3407_11ed_b9de_572e856b5561 WHERE  x = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check that rows are deleted
<span class="ro">        OK</span>
          Retry try #0
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_c3f2803d_3407_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_c3f2803d_3407_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<section class="requirement"><span class="requirement-inline"><i class="utf-icon color-ok">✔</i>RQ.SRS-023.ClickHouse.LightweightDelete.MultipleDeletes.Limitations</span></section>

<div class="requirement-description hidden">

<p><a target="_blank" rel="nofollow noopener noreferrer" href="https://clickhouse.yandex">ClickHouse</a> SHALL have the same limitations on the number of <code>DELETE</code>s as for the number of <code>INSERT</code>s.</p>

</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">1s 508ms</span>/lightweight delete/multiple delete limitations/MergeTree/multiple delete</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> multiple delete</span>
        Check that clickhouse supports using multiple DELETE statements on the same table.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_bb758125_3407_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_bb758125_3407_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert a lot of data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_bb758125_3407_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpn__7vxv2
            cat &quot;/tmp/tmpn__7vxv2&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_bb758125_3407_11ed_b9de_572e856b5561 WHERE NOT(x &lt; 10)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I perform multiple delete
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_bb758125_3407_11ed_b9de_572e856b5561 WHERE  x = 0;DELETE FROM table_bb758125_3407_11ed_b9de_572e856b5561 WHERE  x = 1;DELETE FROM table_bb758125_3407_11ed_b9de_572e856b5561 WHERE  x = 2;DELETE FROM table_bb758125_3407_11ed_b9de_572e856b5561 WHERE  x = 3;DELETE FROM table_bb758125_3407_11ed_b9de_572e856b5561 WHERE  x = 4;DELETE FROM table_bb758125_3407_11ed_b9de_572e856b5561 WHERE  x = 5;DELETE FROM table_bb758125_3407_11ed_b9de_572e856b5561 WHERE  x = 6;DELETE FROM table_bb758125_3407_11ed_b9de_572e856b5561 WHERE  x = 7;DELETE FROM table_bb758125_3407_11ed_b9de_572e856b5561 WHERE  x = 8;DELETE FROM table_bb758125_3407_11ed_b9de_572e856b5561 WHERE  x = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check that rows are deleted
<span class="ro">        OK</span>
          Retry try #0
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_bb758125_3407_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_bb758125_3407_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">1s 510ms</span>/lightweight delete/multiple delete limitations/ReplacingMergeTree/multiple delete</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> multiple delete</span>
        Check that clickhouse supports using multiple DELETE statements on the same table.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_bb75816b_3407_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_bb75816b_3407_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplacingMergeTree() PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert a lot of data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_bb75816b_3407_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpo2z3kzh8
            cat &quot;/tmp/tmpo2z3kzh8&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_bb75816b_3407_11ed_b9de_572e856b5561 WHERE NOT(x &lt; 10)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I perform multiple delete
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_bb75816b_3407_11ed_b9de_572e856b5561 WHERE  x = 0;DELETE FROM table_bb75816b_3407_11ed_b9de_572e856b5561 WHERE  x = 1;DELETE FROM table_bb75816b_3407_11ed_b9de_572e856b5561 WHERE  x = 2;DELETE FROM table_bb75816b_3407_11ed_b9de_572e856b5561 WHERE  x = 3;DELETE FROM table_bb75816b_3407_11ed_b9de_572e856b5561 WHERE  x = 4;DELETE FROM table_bb75816b_3407_11ed_b9de_572e856b5561 WHERE  x = 5;DELETE FROM table_bb75816b_3407_11ed_b9de_572e856b5561 WHERE  x = 6;DELETE FROM table_bb75816b_3407_11ed_b9de_572e856b5561 WHERE  x = 7;DELETE FROM table_bb75816b_3407_11ed_b9de_572e856b5561 WHERE  x = 8;DELETE FROM table_bb75816b_3407_11ed_b9de_572e856b5561 WHERE  x = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check that rows are deleted
<span class="ro">        OK</span>
          Retry try #0
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_bb75816b_3407_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_bb75816b_3407_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">1s 354ms</span>/lightweight delete/multiple delete limitations/SummingMergeTree/multiple delete</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> multiple delete</span>
        Check that clickhouse supports using multiple DELETE statements on the same table.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_bc88a7de_3407_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_bc88a7de_3407_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = SummingMergeTree(x) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert a lot of data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_bc88a7de_3407_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpnmhfw199
            cat &quot;/tmp/tmpnmhfw199&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_bc88a7de_3407_11ed_b9de_572e856b5561 WHERE NOT(x &lt; 10)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I perform multiple delete
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_bc88a7de_3407_11ed_b9de_572e856b5561 WHERE  x = 0;DELETE FROM table_bc88a7de_3407_11ed_b9de_572e856b5561 WHERE  x = 1;DELETE FROM table_bc88a7de_3407_11ed_b9de_572e856b5561 WHERE  x = 2;DELETE FROM table_bc88a7de_3407_11ed_b9de_572e856b5561 WHERE  x = 3;DELETE FROM table_bc88a7de_3407_11ed_b9de_572e856b5561 WHERE  x = 4;DELETE FROM table_bc88a7de_3407_11ed_b9de_572e856b5561 WHERE  x = 5;DELETE FROM table_bc88a7de_3407_11ed_b9de_572e856b5561 WHERE  x = 6;DELETE FROM table_bc88a7de_3407_11ed_b9de_572e856b5561 WHERE  x = 7;DELETE FROM table_bc88a7de_3407_11ed_b9de_572e856b5561 WHERE  x = 8;DELETE FROM table_bc88a7de_3407_11ed_b9de_572e856b5561 WHERE  x = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check that rows are deleted
<span class="ro">        OK</span>
          Retry try #0
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_bc88a7de_3407_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_bc88a7de_3407_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">1s 502ms</span>/lightweight delete/multiple delete limitations/AggregatingMergeTree/multiple delete</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> multiple delete</span>
        Check that clickhouse supports using multiple DELETE statements on the same table.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_bdc3fbd1_3407_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_bdc3fbd1_3407_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = AggregatingMergeTree() PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert a lot of data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_bdc3fbd1_3407_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpzqqaro57
            cat &quot;/tmp/tmpzqqaro57&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_bdc3fbd1_3407_11ed_b9de_572e856b5561 WHERE NOT(x &lt; 10)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I perform multiple delete
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_bdc3fbd1_3407_11ed_b9de_572e856b5561 WHERE  x = 0;DELETE FROM table_bdc3fbd1_3407_11ed_b9de_572e856b5561 WHERE  x = 1;DELETE FROM table_bdc3fbd1_3407_11ed_b9de_572e856b5561 WHERE  x = 2;DELETE FROM table_bdc3fbd1_3407_11ed_b9de_572e856b5561 WHERE  x = 3;DELETE FROM table_bdc3fbd1_3407_11ed_b9de_572e856b5561 WHERE  x = 4;DELETE FROM table_bdc3fbd1_3407_11ed_b9de_572e856b5561 WHERE  x = 5;DELETE FROM table_bdc3fbd1_3407_11ed_b9de_572e856b5561 WHERE  x = 6;DELETE FROM table_bdc3fbd1_3407_11ed_b9de_572e856b5561 WHERE  x = 7;DELETE FROM table_bdc3fbd1_3407_11ed_b9de_572e856b5561 WHERE  x = 8;DELETE FROM table_bdc3fbd1_3407_11ed_b9de_572e856b5561 WHERE  x = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check that rows are deleted
<span class="ro">        OK</span>
          Retry try #0
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_bdc3fbd1_3407_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_bdc3fbd1_3407_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">6s 845ms</span>/lightweight delete/multiple delete limitations/CollapsingMergeTree/multiple delete</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> multiple delete</span>
        Check that clickhouse supports using multiple DELETE statements on the same table.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_bef4b2a9_3407_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_bef4b2a9_3407_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = CollapsingMergeTree(Sign) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert a lot of data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_bef4b2a9_3407_11ed_b9de_572e856b5561 VALUES (0,0,1),(0,1,1),(0,2,1),(0,3,1),(0,4,1...&quot; &gt; /tmp/tmpz0lqniyn
            cat &quot;/tmp/tmpz0lqniyn&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_bef4b2a9_3407_11ed_b9de_572e856b5561 WHERE NOT(x &lt; 10)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I perform multiple delete
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_bef4b2a9_3407_11ed_b9de_572e856b5561 WHERE  x = 0;DELETE FROM table_bef4b2a9_3407_11ed_b9de_572e856b5561 WHERE  x = 1;DELETE FROM table_bef4b2a9_3407_11ed_b9de_572e856b5561 WHERE  x = 2;DELETE FROM table_bef4b2a9_3407_11ed_b9de_572e856b5561 WHERE  x = 3;DELETE FROM table_bef4b2a9_3407_11ed_b9de_572e856b5561 WHERE  x = 4;DELETE FROM table_bef4b2a9_3407_11ed_b9de_572e856b5561 WHERE  x = 5;DELETE FROM table_bef4b2a9_3407_11ed_b9de_572e856b5561 WHERE  x = 6;DELETE FROM table_bef4b2a9_3407_11ed_b9de_572e856b5561 WHERE  x = 7;DELETE FROM table_bef4b2a9_3407_11ed_b9de_572e856b5561 WHERE  x = 8;DELETE FROM table_bef4b2a9_3407_11ed_b9de_572e856b5561 WHERE  x = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check that rows are deleted
<span class="ro">        OK</span>
          Retry try #0
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_bef4b2a9_3407_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_bef4b2a9_3407_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">1s 509ms</span>/lightweight delete/multiple delete limitations/VersionedCollapsingMergeTree/multiple delete</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> multiple delete</span>
        Check that clickhouse supports using multiple DELETE statements on the same table.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_c30775b1_3407_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_c30775b1_3407_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = VersionedCollapsingMergeTree(Sign, id) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert a lot of data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_c30775b1_3407_11ed_b9de_572e856b5561 VALUES (0,0,1),(0,1,1),(0,2,1),(0,3,1),(0,4,1...&quot; &gt; /tmp/tmpxqkgi8ud
            cat &quot;/tmp/tmpxqkgi8ud&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_c30775b1_3407_11ed_b9de_572e856b5561 WHERE NOT(x &lt; 10)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I perform multiple delete
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_c30775b1_3407_11ed_b9de_572e856b5561 WHERE  x = 0;DELETE FROM table_c30775b1_3407_11ed_b9de_572e856b5561 WHERE  x = 1;DELETE FROM table_c30775b1_3407_11ed_b9de_572e856b5561 WHERE  x = 2;DELETE FROM table_c30775b1_3407_11ed_b9de_572e856b5561 WHERE  x = 3;DELETE FROM table_c30775b1_3407_11ed_b9de_572e856b5561 WHERE  x = 4;DELETE FROM table_c30775b1_3407_11ed_b9de_572e856b5561 WHERE  x = 5;DELETE FROM table_c30775b1_3407_11ed_b9de_572e856b5561 WHERE  x = 6;DELETE FROM table_c30775b1_3407_11ed_b9de_572e856b5561 WHERE  x = 7;DELETE FROM table_c30775b1_3407_11ed_b9de_572e856b5561 WHERE  x = 8;DELETE FROM table_c30775b1_3407_11ed_b9de_572e856b5561 WHERE  x = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check that rows are deleted
<span class="ro">        OK</span>
          Retry try #0
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_c30775b1_3407_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_c30775b1_3407_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">1s 336ms</span>/lightweight delete/multiple delete limitations/GraphiteMergeTree/multiple delete</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> multiple delete</span>
        Check that clickhouse supports using multiple DELETE statements on the same table.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_c3f2803d_3407_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_c3f2803d_3407_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Path String, Time DateTime, Value Int64, Timestamp Int64) Engine = GraphiteMergeTree(&#39;graphite_rollup_example&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert a lot of data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_c3f2803d_3407_11ed_b9de_572e856b5561 VALUES (0,0, &#39;1&#39;, toDateTime(10), 10, 10),(0,...&quot; &gt; /tmp/tmp4dribhgm
            cat &quot;/tmp/tmp4dribhgm&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_c3f2803d_3407_11ed_b9de_572e856b5561 WHERE NOT(x &lt; 10)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I perform multiple delete
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_c3f2803d_3407_11ed_b9de_572e856b5561 WHERE  x = 0;DELETE FROM table_c3f2803d_3407_11ed_b9de_572e856b5561 WHERE  x = 1;DELETE FROM table_c3f2803d_3407_11ed_b9de_572e856b5561 WHERE  x = 2;DELETE FROM table_c3f2803d_3407_11ed_b9de_572e856b5561 WHERE  x = 3;DELETE FROM table_c3f2803d_3407_11ed_b9de_572e856b5561 WHERE  x = 4;DELETE FROM table_c3f2803d_3407_11ed_b9de_572e856b5561 WHERE  x = 5;DELETE FROM table_c3f2803d_3407_11ed_b9de_572e856b5561 WHERE  x = 6;DELETE FROM table_c3f2803d_3407_11ed_b9de_572e856b5561 WHERE  x = 7;DELETE FROM table_c3f2803d_3407_11ed_b9de_572e856b5561 WHERE  x = 8;DELETE FROM table_c3f2803d_3407_11ed_b9de_572e856b5561 WHERE  x = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check that rows are deleted
<span class="ro">        OK</span>
          Retry try #0
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_c3f2803d_3407_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_c3f2803d_3407_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<section class="requirement"><span class="requirement-inline"><i class="utf-icon color-fail">✘</i>RQ.SRS-023.ClickHouse.LightweightDelete.MultipleDeletes.ConcurrentDelete</span></section>

<div class="requirement-description hidden">

<p><a target="_blank" rel="nofollow noopener noreferrer" href="https://clickhouse.yandex">ClickHouse</a> <code>DELETE</code> statement SHALL perform correctly when there are multiple concurrent <code>DELETE</code> statements.</p>

</div>

<div class="test"><span class="result result-inline result-error">Error</span><span class="time time-inline">26m 25s</span>/lightweight delete/concurrent delete</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">  </span><span class="kn">Feature</span><span class="nn"> concurrent delete</span>
    Check, that clickhouse DELETE statement SHALL perform correctly when there are
    multiple concurrent DELETE statements.
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> MergeTree</span><span class="re"></span>
<span class="re">    Error</span> MergeTree, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete with overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple concurrent DELETE statements targeting the same rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete with overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting the same rows.
<span class="re">      Error</span> concurrent delete with overlap with alter delete, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple concurrent DELETE statements targeting different rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete without overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting different rows.
<span class="re">      Error</span> concurrent delete without overlap with alter delete, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 25 percent of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting 25 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 25 percent of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting 25 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 75 percent of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting 75 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 75 percent of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting 75 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete entire table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting entire table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete entire table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting entire table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete half of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting half of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete half of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting half of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplacingMergeTree</span><span class="re"></span>
<span class="re">    Error</span> ReplacingMergeTree, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete with overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple concurrent DELETE statements targeting the same rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete with overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting the same rows.
<span class="re">      Error</span> concurrent delete with overlap with alter delete, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple concurrent DELETE statements targeting different rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete without overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting different rows.
<span class="re">      Error</span> concurrent delete without overlap with alter delete, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 25 percent of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting 25 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 25 percent of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting 25 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 75 percent of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting 75 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 75 percent of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting 75 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete entire table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting entire table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete entire table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting entire table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete half of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting half of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete half of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting half of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> SummingMergeTree</span><span class="re"></span>
<span class="re">    Error</span> SummingMergeTree, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete with overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple concurrent DELETE statements targeting the same rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete with overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting the same rows.
<span class="re">      Error</span> concurrent delete with overlap with alter delete, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple concurrent DELETE statements targeting different rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete without overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting different rows.
<span class="re">      Error</span> concurrent delete without overlap with alter delete, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 25 percent of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting 25 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 25 percent of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting 25 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 75 percent of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting 75 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 75 percent of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting 75 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete entire table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting entire table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete entire table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting entire table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete half of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting half of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete half of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting half of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> AggregatingMergeTree</span><span class="re"></span>
<span class="re">    Error</span> AggregatingMergeTree, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete with overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple concurrent DELETE statements targeting the same rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete with overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting the same rows.
<span class="re">      Error</span> concurrent delete with overlap with alter delete, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple concurrent DELETE statements targeting different rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete without overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting different rows.
<span class="re">      Error</span> concurrent delete without overlap with alter delete, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 25 percent of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting 25 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 25 percent of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting 25 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 75 percent of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting 75 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 75 percent of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting 75 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete entire table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting entire table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete entire table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting entire table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete half of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting half of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete half of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting half of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> CollapsingMergeTree</span><span class="re"></span>
<span class="re">    Error</span> CollapsingMergeTree, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete with overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple concurrent DELETE statements targeting the same rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete with overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting the same rows.
<span class="re">      Error</span> concurrent delete with overlap with alter delete, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple concurrent DELETE statements targeting different rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete without overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting different rows.
<span class="re">      Error</span> concurrent delete without overlap with alter delete, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 25 percent of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting 25 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 25 percent of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting 25 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 75 percent of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting 75 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 75 percent of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting 75 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete entire table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting entire table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete entire table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting entire table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete half of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting half of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete half of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting half of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> VersionedCollapsingMergeTree</span><span class="re"></span>
<span class="re">    Error</span> VersionedCollapsingMergeTree, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete with overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple concurrent DELETE statements targeting the same rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete with overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting the same rows.
<span class="re">      Error</span> concurrent delete with overlap with alter delete, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple concurrent DELETE statements targeting different rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete without overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting different rows.
<span class="re">      Error</span> concurrent delete without overlap with alter delete, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 25 percent of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting 25 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 25 percent of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting 25 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 75 percent of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting 75 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 75 percent of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting 75 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete entire table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting entire table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete entire table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting entire table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete half of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting half of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete half of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting half of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> GraphiteMergeTree</span><span class="re"></span>
<span class="re">    Error</span> GraphiteMergeTree, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete with overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple concurrent DELETE statements targeting the same rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete with overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting the same rows.
<span class="re">      Error</span> concurrent delete with overlap with alter delete, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple concurrent DELETE statements targeting different rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete without overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting different rows.
<span class="re">      Error</span> concurrent delete without overlap with alter delete, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 25 percent of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting 25 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 25 percent of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting 25 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 75 percent of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting 75 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 75 percent of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting 75 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete entire table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting entire table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete entire table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting entire table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete half of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting half of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete half of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting half of the table.
<span class="ro">      OK</span><span class="re"></span>
<span class="re">  Error</span> concurrent delete, TypeError
</code></pre></div>


</div>

<section class="requirement"><span class="requirement-inline"><i class="utf-icon color-fail">✘</i>RQ.SRS-023.ClickHouse.LightweightDelete.MultipleDeletes.ConcurrentDeleteOverlap</span></section>

<div class="requirement-description hidden">

<p><a target="_blank" rel="nofollow noopener noreferrer" href="https://clickhouse.yandex">ClickHouse</a> <code>DELETE</code> statement SHALL perform correctly when there are multiple concurrent <code>DELETE</code> statements targetting the same rows.</p>

</div>

<div class="test"><span class="result result-inline result-error">Error</span><span class="time time-inline">26m 25s</span>/lightweight delete/concurrent delete</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">  </span><span class="kn">Feature</span><span class="nn"> concurrent delete</span>
    Check, that clickhouse DELETE statement SHALL perform correctly when there are
    multiple concurrent DELETE statements.
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> MergeTree</span><span class="re"></span>
<span class="re">    Error</span> MergeTree, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete with overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple concurrent DELETE statements targeting the same rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete with overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting the same rows.
<span class="re">      Error</span> concurrent delete with overlap with alter delete, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple concurrent DELETE statements targeting different rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete without overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting different rows.
<span class="re">      Error</span> concurrent delete without overlap with alter delete, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 25 percent of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting 25 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 25 percent of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting 25 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 75 percent of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting 75 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 75 percent of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting 75 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete entire table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting entire table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete entire table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting entire table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete half of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting half of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete half of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting half of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplacingMergeTree</span><span class="re"></span>
<span class="re">    Error</span> ReplacingMergeTree, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete with overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple concurrent DELETE statements targeting the same rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete with overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting the same rows.
<span class="re">      Error</span> concurrent delete with overlap with alter delete, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple concurrent DELETE statements targeting different rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete without overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting different rows.
<span class="re">      Error</span> concurrent delete without overlap with alter delete, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 25 percent of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting 25 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 25 percent of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting 25 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 75 percent of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting 75 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 75 percent of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting 75 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete entire table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting entire table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete entire table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting entire table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete half of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting half of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete half of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting half of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> SummingMergeTree</span><span class="re"></span>
<span class="re">    Error</span> SummingMergeTree, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete with overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple concurrent DELETE statements targeting the same rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete with overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting the same rows.
<span class="re">      Error</span> concurrent delete with overlap with alter delete, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple concurrent DELETE statements targeting different rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete without overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting different rows.
<span class="re">      Error</span> concurrent delete without overlap with alter delete, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 25 percent of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting 25 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 25 percent of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting 25 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 75 percent of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting 75 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 75 percent of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting 75 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete entire table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting entire table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete entire table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting entire table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete half of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting half of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete half of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting half of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> AggregatingMergeTree</span><span class="re"></span>
<span class="re">    Error</span> AggregatingMergeTree, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete with overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple concurrent DELETE statements targeting the same rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete with overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting the same rows.
<span class="re">      Error</span> concurrent delete with overlap with alter delete, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple concurrent DELETE statements targeting different rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete without overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting different rows.
<span class="re">      Error</span> concurrent delete without overlap with alter delete, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 25 percent of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting 25 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 25 percent of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting 25 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 75 percent of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting 75 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 75 percent of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting 75 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete entire table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting entire table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete entire table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting entire table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete half of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting half of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete half of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting half of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> CollapsingMergeTree</span><span class="re"></span>
<span class="re">    Error</span> CollapsingMergeTree, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete with overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple concurrent DELETE statements targeting the same rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete with overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting the same rows.
<span class="re">      Error</span> concurrent delete with overlap with alter delete, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple concurrent DELETE statements targeting different rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete without overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting different rows.
<span class="re">      Error</span> concurrent delete without overlap with alter delete, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 25 percent of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting 25 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 25 percent of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting 25 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 75 percent of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting 75 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 75 percent of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting 75 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete entire table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting entire table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete entire table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting entire table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete half of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting half of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete half of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting half of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> VersionedCollapsingMergeTree</span><span class="re"></span>
<span class="re">    Error</span> VersionedCollapsingMergeTree, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete with overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple concurrent DELETE statements targeting the same rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete with overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting the same rows.
<span class="re">      Error</span> concurrent delete with overlap with alter delete, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple concurrent DELETE statements targeting different rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete without overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting different rows.
<span class="re">      Error</span> concurrent delete without overlap with alter delete, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 25 percent of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting 25 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 25 percent of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting 25 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 75 percent of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting 75 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 75 percent of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting 75 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete entire table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting entire table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete entire table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting entire table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete half of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting half of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete half of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting half of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> GraphiteMergeTree</span><span class="re"></span>
<span class="re">    Error</span> GraphiteMergeTree, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete with overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple concurrent DELETE statements targeting the same rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete with overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting the same rows.
<span class="re">      Error</span> concurrent delete with overlap with alter delete, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple concurrent DELETE statements targeting different rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete without overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting different rows.
<span class="re">      Error</span> concurrent delete without overlap with alter delete, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 25 percent of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting 25 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 25 percent of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting 25 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 75 percent of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting 75 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 75 percent of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting 75 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete entire table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting entire table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete entire table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting entire table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete half of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting half of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete half of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting half of the table.
<span class="ro">      OK</span><span class="re"></span>
<span class="re">  Error</span> concurrent delete, TypeError
</code></pre></div>


</div>

<section class="requirement"><span class="requirement-inline"><i class="utf-icon color-fail">✘</i>RQ.SRS-023.ClickHouse.LightweightDelete.SynchronousOperationOnSingleNode</span></section>

<div class="requirement-description hidden">

<p><a target="_blank" rel="nofollow noopener noreferrer" href="https://clickhouse.yandex">ClickHouse</a> SHALL support synchronous operation of the <code>DELETE</code> statement on a single node.</p>

</div>

<div class="test"><span class="result result-inline result-error">Error</span><span class="time time-inline">26m 25s</span>/lightweight delete/concurrent delete</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">  </span><span class="kn">Feature</span><span class="nn"> concurrent delete</span>
    Check, that clickhouse DELETE statement SHALL perform correctly when there are
    multiple concurrent DELETE statements.
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> MergeTree</span><span class="re"></span>
<span class="re">    Error</span> MergeTree, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete with overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple concurrent DELETE statements targeting the same rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete with overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting the same rows.
<span class="re">      Error</span> concurrent delete with overlap with alter delete, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple concurrent DELETE statements targeting different rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete without overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting different rows.
<span class="re">      Error</span> concurrent delete without overlap with alter delete, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 25 percent of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting 25 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 25 percent of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting 25 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 75 percent of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting 75 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 75 percent of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting 75 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete entire table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting entire table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete entire table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting entire table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete half of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting half of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete half of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting half of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplacingMergeTree</span><span class="re"></span>
<span class="re">    Error</span> ReplacingMergeTree, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete with overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple concurrent DELETE statements targeting the same rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete with overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting the same rows.
<span class="re">      Error</span> concurrent delete with overlap with alter delete, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple concurrent DELETE statements targeting different rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete without overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting different rows.
<span class="re">      Error</span> concurrent delete without overlap with alter delete, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 25 percent of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting 25 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 25 percent of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting 25 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 75 percent of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting 75 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 75 percent of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting 75 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete entire table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting entire table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete entire table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting entire table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete half of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting half of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete half of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting half of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> SummingMergeTree</span><span class="re"></span>
<span class="re">    Error</span> SummingMergeTree, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete with overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple concurrent DELETE statements targeting the same rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete with overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting the same rows.
<span class="re">      Error</span> concurrent delete with overlap with alter delete, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple concurrent DELETE statements targeting different rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete without overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting different rows.
<span class="re">      Error</span> concurrent delete without overlap with alter delete, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 25 percent of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting 25 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 25 percent of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting 25 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 75 percent of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting 75 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 75 percent of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting 75 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete entire table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting entire table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete entire table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting entire table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete half of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting half of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete half of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting half of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> AggregatingMergeTree</span><span class="re"></span>
<span class="re">    Error</span> AggregatingMergeTree, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete with overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple concurrent DELETE statements targeting the same rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete with overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting the same rows.
<span class="re">      Error</span> concurrent delete with overlap with alter delete, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple concurrent DELETE statements targeting different rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete without overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting different rows.
<span class="re">      Error</span> concurrent delete without overlap with alter delete, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 25 percent of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting 25 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 25 percent of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting 25 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 75 percent of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting 75 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 75 percent of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting 75 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete entire table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting entire table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete entire table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting entire table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete half of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting half of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete half of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting half of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> CollapsingMergeTree</span><span class="re"></span>
<span class="re">    Error</span> CollapsingMergeTree, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete with overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple concurrent DELETE statements targeting the same rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete with overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting the same rows.
<span class="re">      Error</span> concurrent delete with overlap with alter delete, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple concurrent DELETE statements targeting different rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete without overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting different rows.
<span class="re">      Error</span> concurrent delete without overlap with alter delete, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 25 percent of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting 25 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 25 percent of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting 25 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 75 percent of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting 75 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 75 percent of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting 75 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete entire table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting entire table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete entire table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting entire table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete half of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting half of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete half of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting half of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> VersionedCollapsingMergeTree</span><span class="re"></span>
<span class="re">    Error</span> VersionedCollapsingMergeTree, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete with overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple concurrent DELETE statements targeting the same rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete with overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting the same rows.
<span class="re">      Error</span> concurrent delete with overlap with alter delete, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple concurrent DELETE statements targeting different rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete without overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting different rows.
<span class="re">      Error</span> concurrent delete without overlap with alter delete, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 25 percent of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting 25 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 25 percent of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting 25 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 75 percent of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting 75 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 75 percent of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting 75 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete entire table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting entire table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete entire table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting entire table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete half of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting half of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete half of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting half of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> GraphiteMergeTree</span><span class="re"></span>
<span class="re">    Error</span> GraphiteMergeTree, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete with overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple concurrent DELETE statements targeting the same rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete with overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting the same rows.
<span class="re">      Error</span> concurrent delete with overlap with alter delete, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple concurrent DELETE statements targeting different rows.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete without overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting different rows.
<span class="re">      Error</span> concurrent delete without overlap with alter delete, TypeError
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 25 percent of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting 25 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 25 percent of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting 25 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 75 percent of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting 75 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete 75 percent of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting 75 percents of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete entire table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting entire table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete entire table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting entire table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete half of the table</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting the same rows when deleting half of the table.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> random delete half of the table without overlap</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        multiple random concurrent DELETE statements targeting different rows when deleting half of the table.
<span class="ro">      OK</span><span class="re"></span>
<span class="re">  Error</span> concurrent delete, TypeError
</code></pre></div>


</div>

<section class="requirement"><span class="requirement-inline"><i class="utf-icon color-fail">✘</i>RQ.SRS-023.ClickHouse.LightweightDelete.EfficientPhysicalDataRemoval</span></section>

<div class="requirement-description hidden">

<p><a target="_blank" rel="nofollow noopener noreferrer" href="https://clickhouse.yandex">ClickHouse</a> SHALL support efficient removal of physical data from the tables that had rows 
deleted using the <code>DELETE</code> statement.</p>

</div>

<div class="test"><span class="result result-inline result-xfail">XFail</span><span class="time time-inline">1m 42s</span>/lightweight delete/efficient physical data removal/delete and check size of the table</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">    </span><span class="kn">Scenario</span><span class="nn"> delete and check size of the table</span>
      Check that ClickHouse support efficient removal of physical data from the tables that
      had rows deleted using the DELETE statement by deleting from the table and checking table
      size in storage and in system.parts table.
<span class="k">      Given</span> I have a table
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        Given</span> I have a table table_7e9c19a5_3407_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_7e9c19a5_3407_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  SETTINGS old_parts_lifetime = 0&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">      When</span> I insert a lot of data into the table
        10 parts random values
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO table_7e9c19a5_3407_11ed_b9de_572e856b5561 SELECT number % 10  AS id, rand64() AS x FROM numbers(1,10000000)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">      When</span> I force merges
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;OPTIMIZE TABLE table_7e9c19a5_3407_11ed_b9de_572e856b5561 FINAL&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">      When</span> I check size of the table in system.parts table
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">      When</span> I check size of the table on disk
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">        OK</span><span class="k"></span>
<span class="k">      When</span> I delete all rows from the table
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_7e9c19a5_3407_11ed_b9de_572e856b5561 WHERE id &gt; 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">      Then</span> I check that rows are deleted immediately
<span class="rf">      Fail</span> I check that rows are deleted immediately, AssertionError
        Retry try #0
<span class="rf">        Fail</span> try #0, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #1
<span class="rf">        Fail</span> try #1, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #2
<span class="rf">        Fail</span> try #2, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #3
<span class="rf">        Fail</span> try #3, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #4
<span class="rf">        Fail</span> try #4, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #5
<span class="rf">        Fail</span> try #5, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #6
<span class="rf">        Fail</span> try #6, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #7
<span class="rf">        Fail</span> try #7, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #8
<span class="rf">        Fail</span> try #8, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #9
<span class="rf">        Fail</span> try #9, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #10
<span class="rf">        Fail</span> try #10, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #11
<span class="rf">        Fail</span> try #11, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #12
<span class="rf">        Fail</span> try #12, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #13
<span class="rf">        Fail</span> try #13, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #14
<span class="rf">        Fail</span> try #14, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #15
<span class="rf">        Fail</span> try #15, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #16
<span class="rf">        Fail</span> try #16, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #17
<span class="rf">        Fail</span> try #17, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #18
<span class="rf">        Fail</span> try #18, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #19
<span class="rf">        Fail</span> try #19, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #20
<span class="rf">        Fail</span> try #20, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #21
<span class="rf">        Fail</span> try #21, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #22
<span class="rf">        Fail</span> try #22, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #23
<span class="rf">        Fail</span> try #23, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #24
<span class="rf">        Fail</span> try #24, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #25
<span class="rf">        Fail</span> try #25, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #26
<span class="rf">        Fail</span> try #26, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #27
<span class="rf">        Fail</span> try #27, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #28
<span class="rf">        Fail</span> try #28, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #29
<span class="rf">        Fail</span> try #29, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #30
<span class="rf">        Fail</span> try #30, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #31
<span class="rf">        Fail</span> try #31, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #32
<span class="rf">        Fail</span> try #32, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #33
<span class="rf">        Fail</span> try #33, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #34
<span class="rf">        Fail</span> try #34, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #35
<span class="rf">        Fail</span> try #35, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #36
<span class="rf">        Fail</span> try #36, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #37
<span class="rf">        Fail</span> try #37, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #38
<span class="rf">        Fail</span> try #38, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #39
<span class="rf">        Fail</span> try #39, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #40
<span class="rf">        Fail</span> try #40, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #41
<span class="rf">        Fail</span> try #41, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #42
<span class="rf">        Fail</span> try #42, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #43
<span class="rf">        Fail</span> try #43, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #44
<span class="rf">        Fail</span> try #44, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #45
<span class="rf">        Fail</span> try #45, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #46
<span class="rf">        Fail</span> try #46, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #47
<span class="rf">        Fail</span> try #47, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #48
<span class="rf">        Fail</span> try #48, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #49
<span class="rf">        Fail</span> try #49, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #50
<span class="rf">        Fail</span> try #50, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #51
<span class="rf">        Fail</span> try #51, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #52
<span class="rf">        Fail</span> try #52, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #53
<span class="rf">        Fail</span> try #53, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #54
<span class="rf">        Fail</span> try #54, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #55
<span class="rf">        Fail</span> try #55, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #56
<span class="rf">        Fail</span> try #56, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #57
<span class="rf">        Fail</span> try #57, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #58
<span class="rf">        Fail</span> try #58, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #59
<span class="rf">        Fail</span> try #59, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #60
<span class="rf">        Fail</span> try #60, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #61
<span class="rf">        Fail</span> try #61, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #62
<span class="rf">        Fail</span> try #62, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #63
<span class="rf">        Fail</span> try #63, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #64
<span class="rf">        Fail</span> try #64, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #65
<span class="rf">        Fail</span> try #65, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #66
<span class="rf">        Fail</span> try #66, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #67
<span class="rf">        Fail</span> try #67, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #68
<span class="rf">        Fail</span> try #68, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #69
<span class="rf">        Fail</span> try #69, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #70
<span class="rf">        Fail</span> try #70, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #71
<span class="rf">        Fail</span> try #71, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #72
<span class="rf">        Fail</span> try #72, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #73
<span class="rf">        Fail</span> try #73, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #74
<span class="rf">        Fail</span> try #74, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #75
<span class="rf">        Fail</span> try #75, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #76
<span class="rf">        Fail</span> try #76, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #77
<span class="rf">        Fail</span> try #77, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #78
<span class="rf">        Fail</span> try #78, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #79
<span class="rf">        Fail</span> try #79, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #80
<span class="rf">        Fail</span> try #80, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #81
<span class="rf">        Fail</span> try #81, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #82
<span class="rf">        Fail</span> try #82, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #83
<span class="rf">        Fail</span> try #83, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #84
<span class="rf">        Fail</span> try #84, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #85
<span class="rf">        Fail</span> try #85, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #86
<span class="rf">        Fail</span> try #86, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #87
<span class="rf">        Fail</span> try #87, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #88
<span class="rf">        Fail</span> try #88, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #89
<span class="rf">        Fail</span> try #89, AssertionError
<span class="k">          By</span> executing command
            du -s /var/lib/clickhouse/store | awk &#39;{print $1}&#39;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT sum(bytes_on_disk) from system.parts where table = &#39;table_7e9c19a5_3407_11ed_b9de_572e856b5561&#39; AND active=1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">      Finally</span> I clean up
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        Finally</span> I remove the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_7e9c19a5_3407_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="rx"></span>
<span class="rx">    XFail</span> delete and check size of the table, Does not match space requirements.
</code></pre></div>


</div>

<section class="requirement"><span class="requirement-inline"><i class="utf-icon color-error">✎</i>RQ.SRS-023.ClickHouse.LightweightDelete.DiskSpace</span></section>

<div class="requirement-description hidden">

<p><a target="_blank" rel="nofollow noopener noreferrer" href="https://clickhouse.yandex">ClickHouse</a> SHALL not greatly increase size of the table on disk after lightweight delete.</p>

</div>

<div class="no-tests">
<span class="result-inline">✎</span>
No tests
</div>

<section class="requirement"><span class="requirement-inline"><i class="utf-icon color-ok">✔</i>RQ.SRS-023.ClickHouse.LightweightDelete.Performance</span></section>

<div class="requirement-description hidden">

<p><a target="_blank" rel="nofollow noopener noreferrer" href="https://clickhouse.yandex">ClickHouse</a> SHALL have similar performance between <code>DELETE</code> and <code>SELECT</code> statements using the same condition
and SHALL use table primary key and secondary indexes if present.</p>

</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">55s 781ms</span>/lightweight delete/performance</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">  </span><span class="kn">Feature</span><span class="nn"> performance</span>
    Check that clickhouse lightweight delete statement has good performance.
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> performance post delete select</span>
      Check that clickhouse select statement performance is not degrade or degrade insignificantly on
      tables that contain rows deleted using the DELETE statement.
<span class="ro">    OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> performance with primary key many partitions</span>
      Check that clickhouse have similar performance between delete and select statements with primary key.
<span class="ro">    OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> performance with primary key many parts</span>
      Check that clickhouse have similar performance between delete and select statements with primary key.
<span class="ro">    OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> performance without primary key</span>
      Check that clickhouse have similar performance between delete and select statements without primary key.
<span class="ro">    OK</span>
<span class="ro">  OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">15s 821ms</span>/lightweight delete/performance/performance with primary key many partitions</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">    </span><span class="kn">Scenario</span><span class="nn"> performance with primary key many partitions</span>
      Check that clickhouse have similar performance between delete and select statements with primary key.
<span class="k">      Given</span> I have a table
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        Given</span> I have a table table_fd69cda6_3418_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_fd69cda6_3418_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">      When</span> I insert a lot of data into the table
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          echo -e &quot;INSERT INTO table_fd69cda6_3418_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpyv6xno17
          cat &quot;/tmp/tmpyv6xno17&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">      When</span> I mark the time that was spent on select query
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_fd69cda6_3418_11ed_b9de_572e856b5561 WHERE id % 2 = 0&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">      When</span> I mark the time that was spent on delete query
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_fd69cda6_3418_11ed_b9de_572e856b5561 WHERE id % 2 = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">      Then</span> I check performance
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      Finally</span> I clean up
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        Finally</span> I remove the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_fd69cda6_3418_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
<span class="ro">    OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">11s 810ms</span>/lightweight delete/performance/performance with primary key many parts</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">    </span><span class="kn">Scenario</span><span class="nn"> performance with primary key many parts</span>
      Check that clickhouse have similar performance between delete and select statements with primary key.
<span class="k">      Given</span> I have a table
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        Given</span> I have a table table_06f997b9_3419_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_06f997b9_3419_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">      When</span> I insert a lot of data into the table
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          echo -e &quot;INSERT INTO table_06f997b9_3419_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpck97st2x
          cat &quot;/tmp/tmpck97st2x&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">      When</span> I mark the time that was spent on select query
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_06f997b9_3419_11ed_b9de_572e856b5561 WHERE id % 2 = 0&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">      When</span> I mark the time that was spent on delete query
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_06f997b9_3419_11ed_b9de_572e856b5561 WHERE id % 2 = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">      Then</span> I check performance
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      Finally</span> I clean up
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        Finally</span> I remove the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_06f997b9_3419_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
<span class="ro">    OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">15s 655ms</span>/lightweight delete/performance/performance without primary key</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">    </span><span class="kn">Scenario</span><span class="nn"> performance without primary key</span>
      Check that clickhouse have similar performance between delete and select statements without primary key.
<span class="k">      Given</span> I have a table
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        Given</span> I have a table table_0e03df33_3419_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_0e03df33_3419_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">      When</span> I insert a lot of data into the table
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          echo -e &quot;INSERT INTO table_0e03df33_3419_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpw6vwfn52
          cat &quot;/tmp/tmpw6vwfn52&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">      When</span> I mark the time that spended on select query
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_0e03df33_3419_11ed_b9de_572e856b5561 WHERE x % 2 = 0&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">      When</span> I delete all rows from the table
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_0e03df33_3419_11ed_b9de_572e856b5561 WHERE x % 2 = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">      Then</span> I check performance
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      Finally</span> I clean up
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        Finally</span> I remove the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_0e03df33_3419_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
<span class="ro">    OK</span>
</code></pre></div>


</div>

<section class="requirement"><span class="requirement-inline"><i class="utf-icon color-ok">✔</i>RQ.SRS-023.ClickHouse.LightweightDelete.Performance.ConcurrentQueries</span></section>

<div class="requirement-description hidden">

<p><a target="_blank" rel="nofollow noopener noreferrer" href="https://clickhouse.yandex">ClickHouse</a> SHALL not have major degradation in query response times during the deletion operation.</p>

</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">5m 58s</span>/lightweight delete/acceptance</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">  </span><span class="kn">Feature</span><span class="nn"> acceptance</span>
    Check that clickhouse supports lightweight delete operations applied to acceptance dataset.
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> delete_query_0</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> acceptance concurrent select delete execution time</span>
        Check that clickhouse keeps reference dataset table usable while the delete reference queries
        are being executed concurrently with the select reference queries.
        No major degradation in query response time SHALL be seen.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> acceptance concurrent insert delete execution time</span>
        Check that clickhouse is not slow down or lockup data ingestion into the reference dataset table
        when delete reference queries are executed concurrently with the insert reference queries.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> acceptance delete execution time</span>
        Check that clickhouse execute each query in the delete reference queries
        set against the reference dataset table within 2 sec.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> acceptance insert execution time after delete</span>
        Check that clickhouse insert queries are not slow down after lightweight delete.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> delete_query_1</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> acceptance concurrent select delete execution time</span>
        Check that clickhouse keeps reference dataset table usable while the delete reference queries
        are being executed concurrently with the select reference queries.
        No major degradation in query response time SHALL be seen.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> acceptance concurrent insert delete execution time</span>
        Check that clickhouse is not slow down or lockup data ingestion into the reference dataset table
        when delete reference queries are executed concurrently with the insert reference queries.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> acceptance delete execution time</span>
        Check that clickhouse execute each query in the delete reference queries
        set against the reference dataset table within 2 sec.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> acceptance insert execution time after delete</span>
        Check that clickhouse insert queries are not slow down after lightweight delete.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> delete_query_2</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> acceptance concurrent select delete execution time</span>
        Check that clickhouse keeps reference dataset table usable while the delete reference queries
        are being executed concurrently with the select reference queries.
        No major degradation in query response time SHALL be seen.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> acceptance concurrent insert delete execution time</span>
        Check that clickhouse is not slow down or lockup data ingestion into the reference dataset table
        when delete reference queries are executed concurrently with the insert reference queries.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> acceptance delete execution time</span>
        Check that clickhouse execute each query in the delete reference queries
        set against the reference dataset table within 2 sec.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> acceptance insert execution time after delete</span>
        Check that clickhouse insert queries are not slow down after lightweight delete.
<span class="ro">      OK</span>
<span class="ro">  OK</span>
</code></pre></div>


</div>

<section class="requirement"><span class="requirement-inline"><i class="utf-icon color-ok">✔</i>RQ.SRS-023.ClickHouse.LightweightDelete.Performance.PostDelete</span></section>

<div class="requirement-description hidden">

<p><a target="_blank" rel="nofollow noopener noreferrer" href="https://clickhouse.yandex">ClickHouse</a> <code>SELECT</code> statement performance SHALL not degrade or degrade insignificantly on tables that contain rows deleted
using the <code>DELETE</code> statement.</p>

</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">12s 492ms</span>/lightweight delete/performance/performance post delete select</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">    </span><span class="kn">Scenario</span><span class="nn"> performance post delete select</span>
      Check that clickhouse select statement performance is not degrade or degrade insignificantly on
      tables that contain rows deleted using the DELETE statement.
<span class="k">      Given</span> I have a table 1
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        Given</span> I have a table table_f60d6498_3418_11ed_b9de_572e856b5561_1
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_f60d6498_3418_11ed_b9de_572e856b5561_1  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">      Given</span> I have a table 2
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        Given</span> I have a table table_f60d6499_3418_11ed_b9de_572e856b5561_2
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_f60d6499_3418_11ed_b9de_572e856b5561_2  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">      When</span> I insert a lot of data into the first table
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          echo -e &quot;INSERT INTO table_f60d6498_3418_11ed_b9de_572e856b5561_1 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),...&quot; &gt; /tmp/tmpef2xi62_
          cat &quot;/tmp/tmpef2xi62_&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">      When</span> I insert a lot of data into the second table
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          echo -e &quot;INSERT INTO table_f60d6499_3418_11ed_b9de_572e856b5561_2 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),...&quot; &gt; /tmp/tmp3nkb01nw
          cat &quot;/tmp/tmp3nkb01nw&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">      Then</span> I delete a lot of data from the first table
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_f60d6498_3418_11ed_b9de_572e856b5561_1 WHERE id &gt; 10&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">      When</span> I mark the time that was spent on delete query
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) from table_f60d6498_3418_11ed_b9de_572e856b5561_1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">      When</span> I mark the time that was spent on delete query
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) from table_f60d6499_3418_11ed_b9de_572e856b5561_2&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">      Then</span> I compare time spent for select statement with and without delete
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      Finally</span> I clean up
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        Finally</span> I remove the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_f60d6499_3418_11ed_b9de_572e856b5561_2 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I remove the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_f60d6498_3418_11ed_b9de_572e856b5561_1 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
<span class="ro">    OK</span>
</code></pre></div>


</div>

<section class="requirement"><span class="requirement-inline"><i class="utf-icon color-ok">✔</i>RQ.SRS-023.ClickHouse.LightweightDelete.Performance.LargeNumberOfPartitions</span></section>

<div class="requirement-description hidden">

<p><a target="_blank" rel="nofollow noopener noreferrer" href="https://clickhouse.yandex">ClickHouse</a> <code>DELETE</code> statement SHALL have acceptable performance when tables have a very large number of partitions.</p>

</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">15s 821ms</span>/lightweight delete/performance/performance with primary key many partitions</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">    </span><span class="kn">Scenario</span><span class="nn"> performance with primary key many partitions</span>
      Check that clickhouse have similar performance between delete and select statements with primary key.
<span class="k">      Given</span> I have a table
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        Given</span> I have a table table_fd69cda6_3418_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_fd69cda6_3418_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">      When</span> I insert a lot of data into the table
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          echo -e &quot;INSERT INTO table_fd69cda6_3418_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpyv6xno17
          cat &quot;/tmp/tmpyv6xno17&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">      When</span> I mark the time that was spent on select query
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_fd69cda6_3418_11ed_b9de_572e856b5561 WHERE id % 2 = 0&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">      When</span> I mark the time that was spent on delete query
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_fd69cda6_3418_11ed_b9de_572e856b5561 WHERE id % 2 = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">      Then</span> I check performance
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      Finally</span> I clean up
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        Finally</span> I remove the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_fd69cda6_3418_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
<span class="ro">    OK</span>
</code></pre></div>


</div>

<section class="requirement"><span class="requirement-inline"><i class="utf-icon color-ok">✔</i>RQ.SRS-023.ClickHouse.LightweightDelete.Performance.LargeNumberOfPartsInPartitions</span></section>

<div class="requirement-description hidden">

<p><a target="_blank" rel="nofollow noopener noreferrer" href="https://clickhouse.yandex">ClickHouse</a> <code>DELETE</code> statement SHALL have acceptable performance when tables have a very large number of parts in partitions.</p>

</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">11s 810ms</span>/lightweight delete/performance/performance with primary key many parts</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">    </span><span class="kn">Scenario</span><span class="nn"> performance with primary key many parts</span>
      Check that clickhouse have similar performance between delete and select statements with primary key.
<span class="k">      Given</span> I have a table
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        Given</span> I have a table table_06f997b9_3419_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_06f997b9_3419_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">      When</span> I insert a lot of data into the table
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          echo -e &quot;INSERT INTO table_06f997b9_3419_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpck97st2x
          cat &quot;/tmp/tmpck97st2x&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">      When</span> I mark the time that was spent on select query
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_06f997b9_3419_11ed_b9de_572e856b5561 WHERE id % 2 = 0&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">      When</span> I mark the time that was spent on delete query
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_06f997b9_3419_11ed_b9de_572e856b5561 WHERE id % 2 = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">      Then</span> I check performance
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      Finally</span> I clean up
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        Finally</span> I remove the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_06f997b9_3419_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
<span class="ro">    OK</span>
</code></pre></div>


</div>

<section class="requirement"><span class="requirement-inline"><i class="utf-icon color-ok">✔</i>RQ.SRS-023.ClickHouse.LightweightDelete.Performance.Acceptance.OnTimeDataset.Inserts</span></section>

<div class="requirement-description hidden">

<p><a target="_blank" rel="nofollow noopener noreferrer" href="https://clickhouse.yandex">ClickHouse</a> SHALL have a similar ingestion performance when the reference dataset table 
has deleted rows vs no deleted rows when using <a href="#insert-reference-queries">insert reference queries</a>.</p>

</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">32s 775ms</span>/lightweight delete/acceptance/delete_query_0/acceptance insert execution time after delete</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> acceptance insert execution time after delete</span>
        Check that clickhouse insert queries are not slow down after lightweight delete.
<span class="k">        Given</span> I have acceptance table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have acceptance table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE acceptance_table (
                Date Date,
                timestamp UInt32,
                version LowCardinality(String),
                remoteIP String,
                clientIP String,
                Id UInt64 DEFAULT CAST(0, &#39;UInt64&#39;),
                originIds Array(UInt64),
                Ids Array(UInt64),
                str String,
                str_arr Array(String),
                a UInt8,
                b UInt16,
                c UInt16,
                int_arr Array(UInt32),
              )
              ENGINE = ReplicatedMergeTree(&#39;/clickhouse/tables/acceptance_table/{shard}&#39;, &#39;{replica}&#39;)
              PARTITION BY (Date, timestamp)
              ORDER BY (Id, Ids[1], originIds[1], timestamp)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;insert into acceptance_table select &#39;2019-01-01&#39;, (timestamp % 100),
            version,remoteIP,clientIP,
            (Id % 10), [(originIds[1] % 10)],[(Ids[1] % 10)],
            str, str_arr,
            a, b,
            c,[(int_arr[1] % 10)]
            from generateRandom(&#39;eventDate Date,
            timestamp UInt32,
            version String,
            remoteIP String,
            clientIP String,
            serverIP String,
            Id UInt64,
            originIds Array(UInt64),
            Ids Array(UInt64),
            str String,
            str_arr Array(String),
            a UInt8,
            b UInt16,
            c UInt16,
            int_arr Array(UInt32)&#39;, 1, 1, 1) limit 100000&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I perform insert query and time it
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;insert into acceptance_table select * from acceptance_table limit 1000&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I perform delete operation
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM acceptance_table WHERE Id = 1 and has(Ids, 2)&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I perform insert query on table with deleted rows and time it
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;insert into acceptance_table select * from acceptance_table limit 1000&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check execution time does not change a lot
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS acceptance_table SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">31s 621ms</span>/lightweight delete/acceptance/delete_query_1/acceptance insert execution time after delete</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> acceptance insert execution time after delete</span>
        Check that clickhouse insert queries are not slow down after lightweight delete.
<span class="k">        Given</span> I have acceptance table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have acceptance table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE acceptance_table (
                Date Date,
                timestamp UInt32,
                version LowCardinality(String),
                remoteIP String,
                clientIP String,
                Id UInt64 DEFAULT CAST(0, &#39;UInt64&#39;),
                originIds Array(UInt64),
                Ids Array(UInt64),
                str String,
                str_arr Array(String),
                a UInt8,
                b UInt16,
                c UInt16,
                int_arr Array(UInt32),
              )
              ENGINE = ReplicatedMergeTree(&#39;/clickhouse/tables/acceptance_table/{shard}&#39;, &#39;{replica}&#39;)
              PARTITION BY (Date, timestamp)
              ORDER BY (Id, Ids[1], originIds[1], timestamp)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;insert into acceptance_table select &#39;2019-01-01&#39;, (timestamp % 100),
            version,remoteIP,clientIP,
            (Id % 10), [(originIds[1] % 10)],[(Ids[1] % 10)],
            str, str_arr,
            a, b,
            c,[(int_arr[1] % 10)]
            from generateRandom(&#39;eventDate Date,
            timestamp UInt32,
            version String,
            remoteIP String,
            clientIP String,
            serverIP String,
            Id UInt64,
            originIds Array(UInt64),
            Ids Array(UInt64),
            str String,
            str_arr Array(String),
            a UInt8,
            b UInt16,
            c UInt16,
            int_arr Array(UInt32)&#39;, 1, 1, 1) limit 100000&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I perform insert query and time it
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;insert into acceptance_table select * from acceptance_table limit 1000&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I perform delete operation
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM acceptance_table WHERE has(Ids, 1)&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I perform insert query on table with deleted rows and time it
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;insert into acceptance_table select * from acceptance_table limit 1000&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check execution time does not change a lot
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS acceptance_table SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">29s 843ms</span>/lightweight delete/acceptance/delete_query_2/acceptance insert execution time after delete</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> acceptance insert execution time after delete</span>
        Check that clickhouse insert queries are not slow down after lightweight delete.
<span class="k">        Given</span> I have acceptance table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have acceptance table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE acceptance_table (
                Date Date,
                timestamp UInt32,
                version LowCardinality(String),
                remoteIP String,
                clientIP String,
                Id UInt64 DEFAULT CAST(0, &#39;UInt64&#39;),
                originIds Array(UInt64),
                Ids Array(UInt64),
                str String,
                str_arr Array(String),
                a UInt8,
                b UInt16,
                c UInt16,
                int_arr Array(UInt32),
              )
              ENGINE = ReplicatedMergeTree(&#39;/clickhouse/tables/acceptance_table/{shard}&#39;, &#39;{replica}&#39;)
              PARTITION BY (Date, timestamp)
              ORDER BY (Id, Ids[1], originIds[1], timestamp)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;insert into acceptance_table select &#39;2019-01-01&#39;, (timestamp % 100),
            version,remoteIP,clientIP,
            (Id % 10), [(originIds[1] % 10)],[(Ids[1] % 10)],
            str, str_arr,
            a, b,
            c,[(int_arr[1] % 10)]
            from generateRandom(&#39;eventDate Date,
            timestamp UInt32,
            version String,
            remoteIP String,
            clientIP String,
            serverIP String,
            Id UInt64,
            originIds Array(UInt64),
            Ids Array(UInt64),
            str String,
            str_arr Array(String),
            a UInt8,
            b UInt16,
            c UInt16,
            int_arr Array(UInt32)&#39;, 1, 1, 1) limit 100000&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I perform insert query and time it
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;insert into acceptance_table select * from acceptance_table limit 1000&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I perform delete operation
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM acceptance_table WHERE has(int_arr, 1)&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I perform insert query on table with deleted rows and time it
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;insert into acceptance_table select * from acceptance_table limit 1000&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check execution time does not change a lot
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS acceptance_table SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<section class="requirement"><span class="requirement-inline"><i class="utf-icon color-ok">✔</i>RQ.SRS-023.ClickHouse.LightweightDelete.Performance.Acceptance.OnTimeDataset.DeleteQueryExecutionTime</span></section>

<div class="requirement-description hidden">

<p><a target="_blank" rel="nofollow noopener noreferrer" href="https://clickhouse.yandex">ClickHouse</a> SHALL execute each query in the <a href="#delete-reference-queries">delete reference queries</a> set against the reference dataset table within 2 sec.</p>

</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">28s 539ms</span>/lightweight delete/acceptance/delete_query_0/acceptance delete execution time</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> acceptance delete execution time</span>
        Check that clickhouse execute each query in the delete reference queries
        set against the reference dataset table within 2 sec.
<span class="k">        Given</span> I have acceptance table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have acceptance table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE acceptance_table (
                Date Date,
                timestamp UInt32,
                version LowCardinality(String),
                remoteIP String,
                clientIP String,
                Id UInt64 DEFAULT CAST(0, &#39;UInt64&#39;),
                originIds Array(UInt64),
                Ids Array(UInt64),
                str String,
                str_arr Array(String),
                a UInt8,
                b UInt16,
                c UInt16,
                int_arr Array(UInt32),
              )
              ENGINE = ReplicatedMergeTree(&#39;/clickhouse/tables/acceptance_table/{shard}&#39;, &#39;{replica}&#39;)
              PARTITION BY (Date, timestamp)
              ORDER BY (Id, Ids[1], originIds[1], timestamp)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;insert into acceptance_table select &#39;2019-01-01&#39;, (timestamp % 100),
            version,remoteIP,clientIP,
            (Id % 10), [(originIds[1] % 10)],[(Ids[1] % 10)],
            str, str_arr,
            a, b,
            c,[(int_arr[1] % 10)]
            from generateRandom(&#39;eventDate Date,
            timestamp UInt32,
            version String,
            remoteIP String,
            clientIP String,
            serverIP String,
            Id UInt64,
            originIds Array(UInt64),
            Ids Array(UInt64),
            str String,
            str_arr Array(String),
            a UInt8,
            b UInt16,
            c UInt16,
            int_arr Array(UInt32)&#39;, 1, 1, 1) limit 100000&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I perform delete operation
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM acceptance_table WHERE Id = 1 and has(Ids, 2)&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check delete execution time is less than 2 seconds
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS acceptance_table SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">32s 584ms</span>/lightweight delete/acceptance/delete_query_1/acceptance delete execution time</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> acceptance delete execution time</span>
        Check that clickhouse execute each query in the delete reference queries
        set against the reference dataset table within 2 sec.
<span class="k">        Given</span> I have acceptance table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have acceptance table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE acceptance_table (
                Date Date,
                timestamp UInt32,
                version LowCardinality(String),
                remoteIP String,
                clientIP String,
                Id UInt64 DEFAULT CAST(0, &#39;UInt64&#39;),
                originIds Array(UInt64),
                Ids Array(UInt64),
                str String,
                str_arr Array(String),
                a UInt8,
                b UInt16,
                c UInt16,
                int_arr Array(UInt32),
              )
              ENGINE = ReplicatedMergeTree(&#39;/clickhouse/tables/acceptance_table/{shard}&#39;, &#39;{replica}&#39;)
              PARTITION BY (Date, timestamp)
              ORDER BY (Id, Ids[1], originIds[1], timestamp)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;insert into acceptance_table select &#39;2019-01-01&#39;, (timestamp % 100),
            version,remoteIP,clientIP,
            (Id % 10), [(originIds[1] % 10)],[(Ids[1] % 10)],
            str, str_arr,
            a, b,
            c,[(int_arr[1] % 10)]
            from generateRandom(&#39;eventDate Date,
            timestamp UInt32,
            version String,
            remoteIP String,
            clientIP String,
            serverIP String,
            Id UInt64,
            originIds Array(UInt64),
            Ids Array(UInt64),
            str String,
            str_arr Array(String),
            a UInt8,
            b UInt16,
            c UInt16,
            int_arr Array(UInt32)&#39;, 1, 1, 1) limit 100000&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I perform delete operation
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM acceptance_table WHERE has(Ids, 1)&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check delete execution time is less than 2 seconds
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS acceptance_table SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">28s 901ms</span>/lightweight delete/acceptance/delete_query_2/acceptance delete execution time</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> acceptance delete execution time</span>
        Check that clickhouse execute each query in the delete reference queries
        set against the reference dataset table within 2 sec.
<span class="k">        Given</span> I have acceptance table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have acceptance table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE acceptance_table (
                Date Date,
                timestamp UInt32,
                version LowCardinality(String),
                remoteIP String,
                clientIP String,
                Id UInt64 DEFAULT CAST(0, &#39;UInt64&#39;),
                originIds Array(UInt64),
                Ids Array(UInt64),
                str String,
                str_arr Array(String),
                a UInt8,
                b UInt16,
                c UInt16,
                int_arr Array(UInt32),
              )
              ENGINE = ReplicatedMergeTree(&#39;/clickhouse/tables/acceptance_table/{shard}&#39;, &#39;{replica}&#39;)
              PARTITION BY (Date, timestamp)
              ORDER BY (Id, Ids[1], originIds[1], timestamp)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;insert into acceptance_table select &#39;2019-01-01&#39;, (timestamp % 100),
            version,remoteIP,clientIP,
            (Id % 10), [(originIds[1] % 10)],[(Ids[1] % 10)],
            str, str_arr,
            a, b,
            c,[(int_arr[1] % 10)]
            from generateRandom(&#39;eventDate Date,
            timestamp UInt32,
            version String,
            remoteIP String,
            clientIP String,
            serverIP String,
            Id UInt64,
            originIds Array(UInt64),
            Ids Array(UInt64),
            str String,
            str_arr Array(String),
            a UInt8,
            b UInt16,
            c UInt16,
            int_arr Array(UInt32)&#39;, 1, 1, 1) limit 100000&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I perform delete operation
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM acceptance_table WHERE has(int_arr, 1)&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check delete execution time is less than 2 seconds
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS acceptance_table SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<section class="requirement"><span class="requirement-inline"><i class="utf-icon color-ok">✔</i>RQ.SRS-023.ClickHouse.LightweightDelete.Performance.Acceptance.OnTimeDataset.ConcurrentSelectsAndDeletes</span></section>

<div class="requirement-description hidden">

<p><a target="_blank" rel="nofollow noopener noreferrer" href="https://clickhouse.yandex">ClickHouse</a> SHALL keep reference dataset table usable while the <a href="#delete-reference-queries">delete reference queries</a>
are being executed concurrently with the <a href="#select-reference-queries">select reference queries</a>. 
No major degradation in query response time SHALL be seen.</p>

</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">33s 410ms</span>/lightweight delete/acceptance/delete_query_0/acceptance concurrent select delete execution time</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> acceptance concurrent select delete execution time</span>
        Check that clickhouse keeps reference dataset table usable while the delete reference queries
        are being executed concurrently with the select reference queries.
        No major degradation in query response time SHALL be seen.
<span class="k">        Given</span> I have acceptance table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have acceptance table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE acceptance_table (
                Date Date,
                timestamp UInt32,
                version LowCardinality(String),
                remoteIP String,
                clientIP String,
                Id UInt64 DEFAULT CAST(0, &#39;UInt64&#39;),
                originIds Array(UInt64),
                Ids Array(UInt64),
                str String,
                str_arr Array(String),
                a UInt8,
                b UInt16,
                c UInt16,
                int_arr Array(UInt32),
              )
              ENGINE = ReplicatedMergeTree(&#39;/clickhouse/tables/acceptance_table/{shard}&#39;, &#39;{replica}&#39;)
              PARTITION BY (Date, timestamp)
              ORDER BY (Id, Ids[1], originIds[1], timestamp)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;insert into acceptance_table select &#39;2019-01-01&#39;, (timestamp % 100),
            version,remoteIP,clientIP,
            (Id % 10), [(originIds[1] % 10)],[(Ids[1] % 10)],
            str, str_arr,
            a, b,
            c,[(int_arr[1] % 10)]
            from generateRandom(&#39;eventDate Date,
            timestamp UInt32,
            version String,
            remoteIP String,
            clientIP String,
            serverIP String,
            Id UInt64,
            originIds Array(UInt64),
            Ids Array(UInt64),
            str String,
            str_arr Array(String),
            a UInt8,
            b UInt16,
            c UInt16,
            int_arr Array(UInt32)&#39;, 1, 1, 1) limit 100000&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I perform select query and time it
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM (SELECT * FROM acceptance_table where has(Ids, 123))&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent select and delete
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Step</span> I perform select operation
            Select from acceptance table.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM (SELECT * FROM acceptance_table where has(Ids, 123))&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          Step</span> I perform delete operation
            Usable delete query 1.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM acceptance_table WHERE Id = 1 and has(Ids, 2)&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check execution time does not change a lot
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS acceptance_table SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">28s 985ms</span>/lightweight delete/acceptance/delete_query_1/acceptance concurrent select delete execution time</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> acceptance concurrent select delete execution time</span>
        Check that clickhouse keeps reference dataset table usable while the delete reference queries
        are being executed concurrently with the select reference queries.
        No major degradation in query response time SHALL be seen.
<span class="k">        Given</span> I have acceptance table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have acceptance table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE acceptance_table (
                Date Date,
                timestamp UInt32,
                version LowCardinality(String),
                remoteIP String,
                clientIP String,
                Id UInt64 DEFAULT CAST(0, &#39;UInt64&#39;),
                originIds Array(UInt64),
                Ids Array(UInt64),
                str String,
                str_arr Array(String),
                a UInt8,
                b UInt16,
                c UInt16,
                int_arr Array(UInt32),
              )
              ENGINE = ReplicatedMergeTree(&#39;/clickhouse/tables/acceptance_table/{shard}&#39;, &#39;{replica}&#39;)
              PARTITION BY (Date, timestamp)
              ORDER BY (Id, Ids[1], originIds[1], timestamp)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;insert into acceptance_table select &#39;2019-01-01&#39;, (timestamp % 100),
            version,remoteIP,clientIP,
            (Id % 10), [(originIds[1] % 10)],[(Ids[1] % 10)],
            str, str_arr,
            a, b,
            c,[(int_arr[1] % 10)]
            from generateRandom(&#39;eventDate Date,
            timestamp UInt32,
            version String,
            remoteIP String,
            clientIP String,
            serverIP String,
            Id UInt64,
            originIds Array(UInt64),
            Ids Array(UInt64),
            str String,
            str_arr Array(String),
            a UInt8,
            b UInt16,
            c UInt16,
            int_arr Array(UInt32)&#39;, 1, 1, 1) limit 100000&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I perform select query and time it
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM (SELECT * FROM acceptance_table where has(Ids, 123))&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent select and delete
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Step</span> I perform select operation
            Select from acceptance table.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM (SELECT * FROM acceptance_table where has(Ids, 123))&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          Step</span> I perform delete operation
            Usable delete query 2.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM acceptance_table WHERE has(Ids, 1)&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check execution time does not change a lot
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS acceptance_table SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">29s 176ms</span>/lightweight delete/acceptance/delete_query_2/acceptance concurrent select delete execution time</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> acceptance concurrent select delete execution time</span>
        Check that clickhouse keeps reference dataset table usable while the delete reference queries
        are being executed concurrently with the select reference queries.
        No major degradation in query response time SHALL be seen.
<span class="k">        Given</span> I have acceptance table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have acceptance table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE acceptance_table (
                Date Date,
                timestamp UInt32,
                version LowCardinality(String),
                remoteIP String,
                clientIP String,
                Id UInt64 DEFAULT CAST(0, &#39;UInt64&#39;),
                originIds Array(UInt64),
                Ids Array(UInt64),
                str String,
                str_arr Array(String),
                a UInt8,
                b UInt16,
                c UInt16,
                int_arr Array(UInt32),
              )
              ENGINE = ReplicatedMergeTree(&#39;/clickhouse/tables/acceptance_table/{shard}&#39;, &#39;{replica}&#39;)
              PARTITION BY (Date, timestamp)
              ORDER BY (Id, Ids[1], originIds[1], timestamp)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;insert into acceptance_table select &#39;2019-01-01&#39;, (timestamp % 100),
            version,remoteIP,clientIP,
            (Id % 10), [(originIds[1] % 10)],[(Ids[1] % 10)],
            str, str_arr,
            a, b,
            c,[(int_arr[1] % 10)]
            from generateRandom(&#39;eventDate Date,
            timestamp UInt32,
            version String,
            remoteIP String,
            clientIP String,
            serverIP String,
            Id UInt64,
            originIds Array(UInt64),
            Ids Array(UInt64),
            str String,
            str_arr Array(String),
            a UInt8,
            b UInt16,
            c UInt16,
            int_arr Array(UInt32)&#39;, 1, 1, 1) limit 100000&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I perform select query and time it
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM (SELECT * FROM acceptance_table where has(Ids, 123))&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent select and delete
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Step</span> I perform select operation
            Select from acceptance table.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM (SELECT * FROM acceptance_table where has(Ids, 123))&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          Step</span> I perform delete operation
            Usable delete query 1.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM acceptance_table WHERE has(int_arr, 1)&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check execution time does not change a lot
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS acceptance_table SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<section class="requirement"><span class="requirement-inline"><i class="utf-icon color-ok">✔</i>RQ.SRS-023.ClickHouse.LightweightDelete.Performance.Acceptance.OnTimeDataset.ConcurrentInsertsAndDeletes</span></section>

<div class="requirement-description hidden">

<p><a target="_blank" rel="nofollow noopener noreferrer" href="https://clickhouse.yandex">ClickHouse</a> SHALL not slow down or lockup data ingestion into the reference dataset table
when <a href="#delete-reference-queries">delete reference queries</a> are executed concurrently with the <a href="#insert-reference-queries">insert reference queries</a>.</p>

</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">29s 590ms</span>/lightweight delete/acceptance/delete_query_0/acceptance concurrent insert delete execution time</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> acceptance concurrent insert delete execution time</span>
        Check that clickhouse is not slow down or lockup data ingestion into the reference dataset table
        when delete reference queries are executed concurrently with the insert reference queries.
<span class="k">        Given</span> I have acceptance table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have acceptance table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE acceptance_table (
                Date Date,
                timestamp UInt32,
                version LowCardinality(String),
                remoteIP String,
                clientIP String,
                Id UInt64 DEFAULT CAST(0, &#39;UInt64&#39;),
                originIds Array(UInt64),
                Ids Array(UInt64),
                str String,
                str_arr Array(String),
                a UInt8,
                b UInt16,
                c UInt16,
                int_arr Array(UInt32),
              )
              ENGINE = ReplicatedMergeTree(&#39;/clickhouse/tables/acceptance_table/{shard}&#39;, &#39;{replica}&#39;)
              PARTITION BY (Date, timestamp)
              ORDER BY (Id, Ids[1], originIds[1], timestamp)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;insert into acceptance_table select &#39;2019-01-01&#39;, (timestamp % 100),
            version,remoteIP,clientIP,
            (Id % 10), [(originIds[1] % 10)],[(Ids[1] % 10)],
            str, str_arr,
            a, b,
            c,[(int_arr[1] % 10)]
            from generateRandom(&#39;eventDate Date,
            timestamp UInt32,
            version String,
            remoteIP String,
            clientIP String,
            serverIP String,
            Id UInt64,
            originIds Array(UInt64),
            Ids Array(UInt64),
            str String,
            str_arr Array(String),
            a UInt8,
            b UInt16,
            c UInt16,
            int_arr Array(UInt32)&#39;, 1, 1, 1) limit 100000&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I perform insert query and time it
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;insert into acceptance_table select * from acceptance_table limit 1000&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent insert and delete
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Step</span> I perform insert operation
            Insert into acceptance_table table.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;insert into acceptance_table select * from acceptance_table limit 1000&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          Step</span> I perform delete operation
            Usable delete query 1.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM acceptance_table WHERE Id = 1 and has(Ids, 2)&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check execution time does not change a lot
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS acceptance_table SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">29s 965ms</span>/lightweight delete/acceptance/delete_query_1/acceptance concurrent insert delete execution time</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> acceptance concurrent insert delete execution time</span>
        Check that clickhouse is not slow down or lockup data ingestion into the reference dataset table
        when delete reference queries are executed concurrently with the insert reference queries.
<span class="k">        Given</span> I have acceptance table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have acceptance table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE acceptance_table (
                Date Date,
                timestamp UInt32,
                version LowCardinality(String),
                remoteIP String,
                clientIP String,
                Id UInt64 DEFAULT CAST(0, &#39;UInt64&#39;),
                originIds Array(UInt64),
                Ids Array(UInt64),
                str String,
                str_arr Array(String),
                a UInt8,
                b UInt16,
                c UInt16,
                int_arr Array(UInt32),
              )
              ENGINE = ReplicatedMergeTree(&#39;/clickhouse/tables/acceptance_table/{shard}&#39;, &#39;{replica}&#39;)
              PARTITION BY (Date, timestamp)
              ORDER BY (Id, Ids[1], originIds[1], timestamp)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;insert into acceptance_table select &#39;2019-01-01&#39;, (timestamp % 100),
            version,remoteIP,clientIP,
            (Id % 10), [(originIds[1] % 10)],[(Ids[1] % 10)],
            str, str_arr,
            a, b,
            c,[(int_arr[1] % 10)]
            from generateRandom(&#39;eventDate Date,
            timestamp UInt32,
            version String,
            remoteIP String,
            clientIP String,
            serverIP String,
            Id UInt64,
            originIds Array(UInt64),
            Ids Array(UInt64),
            str String,
            str_arr Array(String),
            a UInt8,
            b UInt16,
            c UInt16,
            int_arr Array(UInt32)&#39;, 1, 1, 1) limit 100000&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I perform insert query and time it
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;insert into acceptance_table select * from acceptance_table limit 1000&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent insert and delete
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Step</span> I perform insert operation
            Insert into acceptance_table table.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;insert into acceptance_table select * from acceptance_table limit 1000&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          Step</span> I perform delete operation
            Usable delete query 2.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM acceptance_table WHERE has(Ids, 1)&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check execution time does not change a lot
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS acceptance_table SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">23s 264ms</span>/lightweight delete/acceptance/delete_query_2/acceptance concurrent insert delete execution time</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> acceptance concurrent insert delete execution time</span>
        Check that clickhouse is not slow down or lockup data ingestion into the reference dataset table
        when delete reference queries are executed concurrently with the insert reference queries.
<span class="k">        Given</span> I have acceptance table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have acceptance table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE acceptance_table (
                Date Date,
                timestamp UInt32,
                version LowCardinality(String),
                remoteIP String,
                clientIP String,
                Id UInt64 DEFAULT CAST(0, &#39;UInt64&#39;),
                originIds Array(UInt64),
                Ids Array(UInt64),
                str String,
                str_arr Array(String),
                a UInt8,
                b UInt16,
                c UInt16,
                int_arr Array(UInt32),
              )
              ENGINE = ReplicatedMergeTree(&#39;/clickhouse/tables/acceptance_table/{shard}&#39;, &#39;{replica}&#39;)
              PARTITION BY (Date, timestamp)
              ORDER BY (Id, Ids[1], originIds[1], timestamp)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;insert into acceptance_table select &#39;2019-01-01&#39;, (timestamp % 100),
            version,remoteIP,clientIP,
            (Id % 10), [(originIds[1] % 10)],[(Ids[1] % 10)],
            str, str_arr,
            a, b,
            c,[(int_arr[1] % 10)]
            from generateRandom(&#39;eventDate Date,
            timestamp UInt32,
            version String,
            remoteIP String,
            clientIP String,
            serverIP String,
            Id UInt64,
            originIds Array(UInt64),
            Ids Array(UInt64),
            str String,
            str_arr Array(String),
            a UInt8,
            b UInt16,
            c UInt16,
            int_arr Array(UInt32)&#39;, 1, 1, 1) limit 100000&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I perform insert query and time it
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;insert into acceptance_table select * from acceptance_table limit 1000&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent insert and delete
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Step</span> I perform insert operation
            Insert into acceptance_table table.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;insert into acceptance_table select * from acceptance_table limit 1000&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">          Step</span> I perform delete operation
            Usable delete query 1.
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM acceptance_table WHERE has(int_arr, 1)&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="ro">              OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check execution time does not change a lot
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS acceptance_table SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<section class="requirement"><span class="requirement-inline"><i class="utf-icon color-ok">✔</i>RQ.SRS-023.ClickHouse.LightweightDelete.ImmutablePartsAndGarbageCollection</span></section>

<div class="requirement-description hidden">

<p><a target="_blank" rel="nofollow noopener noreferrer" href="https://clickhouse.yandex">ClickHouse</a> parts affected by the <code>DELETE</code> statement SHALL stay immutable and
the deleted rows SHALL be garbage collected in a scheduled merge.</p>

</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">5s 774ms</span>/lightweight delete/immutable parts and garbage collection/MergeTree/immutable parts and garbage collection</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> immutable parts and garbage collection</span>
        Check that parts affected by the DELETE statement are stay immutable and
        the deleted rows are garbage collected in a scheduled merge.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_388e1632_340a_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_388e1632_340a_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert a lot of data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_388e1632_340a_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmp9e42avb_
            cat &quot;/tmp/tmp9e42avb_&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I stop merges
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I compute path
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT path FROM system.parts WHERE table = &#39;table_388e1632_340a_11ed_b9de_572e856b5561&#39; ORDER BY partition LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I compute hash of part file
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /var/lib/clickhouse/store/01a/01a0c0b0-e171-4bdc-94b0-0a9f4840ab9a/0_1_1_0/data.bin | sha1sum
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I delete while merges are stopped
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_388e1632_340a_11ed_b9de_572e856b5561 WHERE id = 0 AND (x % 2 = 0)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check hash is not changed
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /var/lib/clickhouse/store/01a/01a0c0b0-e171-4bdc-94b0-0a9f4840ab9a/0_1_1_0/data.bin | sha1sum
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_388e1632_340a_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">1s 218ms</span>/lightweight delete/immutable parts and garbage collection/ReplacingMergeTree/immutable parts and garbage collection</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> immutable parts and garbage collection</span>
        Check that parts affected by the DELETE statement are stay immutable and
        the deleted rows are garbage collected in a scheduled merge.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_3c105215_340a_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_3c105215_340a_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplacingMergeTree() PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert a lot of data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_3c105215_340a_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpbkabxhbk
            cat &quot;/tmp/tmpbkabxhbk&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I stop merges
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I compute path
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT path FROM system.parts WHERE table = &#39;table_3c105215_340a_11ed_b9de_572e856b5561&#39; ORDER BY partition LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I compute hash of part file
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /var/lib/clickhouse/store/a7d/a7d2f196-0e80-41c7-b7ef-e485a1deb3c6/0_1_1_0/data.bin | sha1sum
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I delete while merges are stopped
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_3c105215_340a_11ed_b9de_572e856b5561 WHERE id = 0 AND (x % 2 = 0)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check hash is not changed
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /var/lib/clickhouse/store/a7d/a7d2f196-0e80-41c7-b7ef-e485a1deb3c6/0_1_1_0/data.bin | sha1sum
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_3c105215_340a_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">1s 119ms</span>/lightweight delete/immutable parts and garbage collection/SummingMergeTree/immutable parts and garbage collection</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> immutable parts and garbage collection</span>
        Check that parts affected by the DELETE statement are stay immutable and
        the deleted rows are garbage collected in a scheduled merge.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_3c105264_340a_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_3c105264_340a_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = SummingMergeTree(x) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert a lot of data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_3c105264_340a_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmp_at0f4s7
            cat &quot;/tmp/tmp_at0f4s7&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I stop merges
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I compute path
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT path FROM system.parts WHERE table = &#39;table_3c105264_340a_11ed_b9de_572e856b5561&#39; ORDER BY partition LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I compute hash of part file
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /var/lib/clickhouse/store/a03/a03a4cd6-8080-40fd-a8d8-ca3341d2b45f/0_1_1_0/data.bin | sha1sum
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I delete while merges are stopped
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_3c105264_340a_11ed_b9de_572e856b5561 WHERE id = 0 AND (x % 2 = 0)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check hash is not changed
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /var/lib/clickhouse/store/a03/a03a4cd6-8080-40fd-a8d8-ca3341d2b45f/0_1_1_0/data.bin | sha1sum
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_3c105264_340a_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">2s 241ms</span>/lightweight delete/immutable parts and garbage collection/AggregatingMergeTree/immutable parts and garbage collection</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> immutable parts and garbage collection</span>
        Check that parts affected by the DELETE statement are stay immutable and
        the deleted rows are garbage collected in a scheduled merge.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_3d4c80d2_340a_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_3d4c80d2_340a_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = AggregatingMergeTree() PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert a lot of data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_3d4c80d2_340a_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmp8fu_21gv
            cat &quot;/tmp/tmp8fu_21gv&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I stop merges
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I compute path
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT path FROM system.parts WHERE table = &#39;table_3d4c80d2_340a_11ed_b9de_572e856b5561&#39; ORDER BY partition LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I compute hash of part file
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /var/lib/clickhouse/store/7a9/7a9ddebe-66ab-4488-8a67-986be8a896b2/0_1_1_0/data.bin | sha1sum
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I delete while merges are stopped
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_3d4c80d2_340a_11ed_b9de_572e856b5561 WHERE id = 0 AND (x % 2 = 0)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check hash is not changed
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /var/lib/clickhouse/store/7a9/7a9ddebe-66ab-4488-8a67-986be8a896b2/0_1_1_0/data.bin | sha1sum
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_3d4c80d2_340a_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">1s 310ms</span>/lightweight delete/immutable parts and garbage collection/CollapsingMergeTree/immutable parts and garbage collection</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> immutable parts and garbage collection</span>
        Check that parts affected by the DELETE statement are stay immutable and
        the deleted rows are garbage collected in a scheduled merge.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_3ec0e12b_340a_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_3ec0e12b_340a_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = CollapsingMergeTree(Sign) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert a lot of data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_3ec0e12b_340a_11ed_b9de_572e856b5561 VALUES (0,0,1),(0,1,1),(0,2,1),(0,3,1),(0,4,1...&quot; &gt; /tmp/tmptt440kv6
            cat &quot;/tmp/tmptt440kv6&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I stop merges
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I compute path
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT path FROM system.parts WHERE table = &#39;table_3ec0e12b_340a_11ed_b9de_572e856b5561&#39; ORDER BY partition LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I compute hash of part file
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /var/lib/clickhouse/store/82e/82ea50c5-bf1d-4e64-806d-42ae0d8526fb/0_1_1_0/data.bin | sha1sum
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I delete while merges are stopped
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_3ec0e12b_340a_11ed_b9de_572e856b5561 WHERE id = 0 AND (x % 2 = 0)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check hash is not changed
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /var/lib/clickhouse/store/82e/82ea50c5-bf1d-4e64-806d-42ae0d8526fb/0_1_1_0/data.bin | sha1sum
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_3ec0e12b_340a_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">1s 152ms</span>/lightweight delete/immutable parts and garbage collection/VersionedCollapsingMergeTree/immutable parts and garbage collection</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> immutable parts and garbage collection</span>
        Check that parts affected by the DELETE statement are stay immutable and
        the deleted rows are garbage collected in a scheduled merge.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_3ec0e17a_340a_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_3ec0e17a_340a_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = VersionedCollapsingMergeTree(Sign, id) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert a lot of data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_3ec0e17a_340a_11ed_b9de_572e856b5561 VALUES (0,0,1),(0,1,1),(0,2,1),(0,3,1),(0,4,1...&quot; &gt; /tmp/tmpwj5d33i6
            cat &quot;/tmp/tmpwj5d33i6&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I stop merges
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I compute path
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT path FROM system.parts WHERE table = &#39;table_3ec0e17a_340a_11ed_b9de_572e856b5561&#39; ORDER BY partition LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I compute hash of part file
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /var/lib/clickhouse/store/126/126c5bc3-b5e5-4a2f-9d6f-c15f426f4c20/0_1_1_0/data.bin | sha1sum
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I delete while merges are stopped
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_3ec0e17a_340a_11ed_b9de_572e856b5561 WHERE id = 0 AND (x % 2 = 0)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check hash is not changed
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /var/lib/clickhouse/store/126/126c5bc3-b5e5-4a2f-9d6f-c15f426f4c20/0_1_1_0/data.bin | sha1sum
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_3ec0e17a_340a_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">1s 164ms</span>/lightweight delete/immutable parts and garbage collection/GraphiteMergeTree/immutable parts and garbage collection</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> immutable parts and garbage collection</span>
        Check that parts affected by the DELETE statement are stay immutable and
        the deleted rows are garbage collected in a scheduled merge.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_3faf1749_340a_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_3faf1749_340a_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Path String, Time DateTime, Value Int64, Timestamp Int64) Engine = GraphiteMergeTree(&#39;graphite_rollup_example&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert a lot of data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_3faf1749_340a_11ed_b9de_572e856b5561 VALUES (0,0, &#39;1&#39;, toDateTime(10), 10, 10),(0,...&quot; &gt; /tmp/tmp9zfntzyt
            cat &quot;/tmp/tmp9zfntzyt&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I stop merges
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I compute path
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT path FROM system.parts WHERE table = &#39;table_3faf1749_340a_11ed_b9de_572e856b5561&#39; ORDER BY partition LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I compute hash of part file
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /var/lib/clickhouse/store/9a0/9a08368d-4817-4b65-ae6e-b964caf49dbd/0_1_1_0/data.bin | sha1sum
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I delete while merges are stopped
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_3faf1749_340a_11ed_b9de_572e856b5561 WHERE id = 0 AND (x % 2 = 0)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check hash is not changed
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /var/lib/clickhouse/store/9a0/9a08368d-4817-4b65-ae6e-b964caf49dbd/0_1_1_0/data.bin | sha1sum
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_3faf1749_340a_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<section class="requirement"><span class="requirement-inline"><i class="utf-icon color-ok">✔</i>RQ.SRS-023.ClickHouse.LightweightDelete.Compatibility.ConcurrentOperations</span></section>

<div class="requirement-description hidden">

<p><a target="_blank" rel="nofollow noopener noreferrer" href="https://clickhouse.yandex">ClickHouse</a> <code>DELETE</code> statement SHALL perform correctly with the other concurrent database operations.
The cluster SHALL remain usable and not slow down during the deletion operation.
Examples of operations,</p>

<ul>
<li><code>INSERT</code></li>
<li><code>SELECT</code></li>
<li><code>ALTER DELETE</code></li>
<li><code>ALTER UPDATE</code></li>
<li><code>ALTER ADD/REMOVE/MODIFY COLUMN</code></li>
<li>Background merge</li>
<li>Replication</li>
<li>TTL moves</li>
<li>TTL deletes</li>
<li>Column TTL</li>
</ul>

</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">11m 6s</span>/lightweight delete/replicated table with concurrent alter and delete</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">  </span><span class="kn">Feature</span><span class="nn"> replicated table with concurrent alter and delete</span>
    Check that delete operations replicate in an eventually consistent manner between replicas.
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> concurrent add drop column and delete in replicated table on single node</span>
      Check that concurrent delete and add drop column perform
      correctly with replicated table on single node.
<span class="ro">    OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> concurrent add drop column and delete in replicated table on two nodes</span>
      Check that concurrent delete and add drop column perform
      correctly with replicated table on two nodes.
<span class="ro">    OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> concurrent clear update and delete in replicated table on single node</span>
      Check that concurrent delete and clear update+ column perform
      correctly with replicated table on single node.
<span class="ro">    OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> concurrent clear update and delete in replicated table on two nodes</span>
      Check that concurrent delete and clear update column perform
      correctly with replicated table on two nodes.
<span class="ro">    OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> concurrent delete attach detach partition in replicated table on single node</span>
      Check that concurrent delete detach partition and attach partition perform
      correctly with replicated table on single node.
<span class="ro">    OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> concurrent delete attach detach partition in replicated table on two nodes</span>
      Check that concurrent delete detach partition and attach partition perform
      correctly with replicated table on two nodes.
<span class="ro">    OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> concurrent modify column and delete in replicated table on single node</span>
      Check that concurrent delete and modify column perform
      correctly with replicated table on single node.
<span class="ro">    OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> concurrent modify column and delete in replicated table on two nodes</span>
      Check that concurrent delete and modify column perform
      correctly with replicated table on two nodes.
<span class="ro">    OK</span>
<span class="ro">  OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">45s 735ms</span>/lightweight delete/random concurrent alter</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">  </span><span class="kn">Feature</span><span class="nn"> random concurrent alter</span>
    Check that clickhouse supports concurrent deletes with alter operations.
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> random concurrent alter</span>
      Check that clickhouse supports concurrent deletes with alter operations
      when random alter operations perform in ransom order.
<span class="ro">    OK</span>
<span class="ro">  OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">10m 4s</span>/lightweight delete/concurrent alter and delete</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">  </span><span class="kn">Feature</span><span class="nn"> concurrent alter and delete</span>
    Check that clickhouse supports concurrent deletes with alter operations.
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> MergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent add drop column and delete</span>
        Check that concurrent delete and add drop column perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent clear update and delete</span>
        Check that concurrent clear column update column and delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete attach detach partition</span>
        Check that concurrent delete and attach detach partition perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete drop partition</span>
        Check that concurrent delete and drop partition perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete freeze partition</span>
        Check that concurrent delete and freeze partition perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent modify column and delete</span>
        Check that concurrent delete and add drop column perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> ReplacingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent add drop column and delete</span>
        Check that concurrent delete and add drop column perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent clear update and delete</span>
        Check that concurrent clear column update column and delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete attach detach partition</span>
        Check that concurrent delete and attach detach partition perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete drop partition</span>
        Check that concurrent delete and drop partition perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete freeze partition</span>
        Check that concurrent delete and freeze partition perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent modify column and delete</span>
        Check that concurrent delete and add drop column perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> SummingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent add drop column and delete</span>
        Check that concurrent delete and add drop column perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent clear update and delete</span>
        Check that concurrent clear column update column and delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete attach detach partition</span>
        Check that concurrent delete and attach detach partition perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete drop partition</span>
        Check that concurrent delete and drop partition perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete freeze partition</span>
        Check that concurrent delete and freeze partition perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent modify column and delete</span>
        Check that concurrent delete and add drop column perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> AggregatingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent add drop column and delete</span>
        Check that concurrent delete and add drop column perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent clear update and delete</span>
        Check that concurrent clear column update column and delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete attach detach partition</span>
        Check that concurrent delete and attach detach partition perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete drop partition</span>
        Check that concurrent delete and drop partition perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete freeze partition</span>
        Check that concurrent delete and freeze partition perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent modify column and delete</span>
        Check that concurrent delete and add drop column perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> CollapsingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent add drop column and delete</span>
        Check that concurrent delete and add drop column perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent clear update and delete</span>
        Check that concurrent clear column update column and delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete attach detach partition</span>
        Check that concurrent delete and attach detach partition perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete drop partition</span>
        Check that concurrent delete and drop partition perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete freeze partition</span>
        Check that concurrent delete and freeze partition perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent modify column and delete</span>
        Check that concurrent delete and add drop column perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> VersionedCollapsingMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent add drop column and delete</span>
        Check that concurrent delete and add drop column perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent clear update and delete</span>
        Check that concurrent clear column update column and delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete attach detach partition</span>
        Check that concurrent delete and attach detach partition perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete drop partition</span>
        Check that concurrent delete and drop partition perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete freeze partition</span>
        Check that concurrent delete and freeze partition perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent modify column and delete</span>
        Check that concurrent delete and add drop column perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> GraphiteMergeTree</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent add drop column and delete</span>
        Check that concurrent delete and add drop column perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent clear update and delete</span>
        Check that concurrent clear column update column and delete perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete attach detach partition</span>
        Check that concurrent delete and attach detach partition perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete drop partition</span>
        Check that concurrent delete and drop partition perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete freeze partition</span>
        Check that concurrent delete and freeze partition perform correctly.
<span class="ro">      OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent modify column and delete</span>
        Check that concurrent delete and add drop column perform correctly.
<span class="ro">      OK</span>
<span class="ro">  OK</span>
</code></pre></div>


</div>

<section class="requirement"><span class="requirement-inline"><i class="utf-icon color-ok">✔</i>RQ.SRS-023.ClickHouse.LightweightDelete.Compatibility.ConcurrentInserts&DeletesOnManyParts</span></section>

<div class="requirement-description hidden">

<p><a target="_blank" rel="nofollow noopener noreferrer" href="https://clickhouse.yandex">ClickHouse</a> SHALL execute <code>INSERT</code> and <code>DELETE</code> statements concurrently when <code>INSERT</code> creates many parts.</p>

</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">9s 353ms</span>/lightweight delete/compatibility/concurrent insert delete many parts</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">    </span><span class="kn">Scenario</span><span class="nn"> concurrent insert delete many parts</span>
      Check that clickhouse support executing INSERT and DELETE statements concurrently
      when INSERT creates many parts.
<span class="k">      Given</span> I have a table
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        Given</span> I have a table table_2f9cdbbe_340a_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_2f9cdbbe_340a_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">      When</span> I insert a lot of data into the table
        10 partitions 1 part block_size=100
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          echo -e &quot;INSERT INTO table_2f9cdbbe_340a_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmplu9gzdxm
          cat &quot;/tmp/tmplu9gzdxm&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">      Then</span> I perform concurrent operations
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        Step</span> insert rows in loop
          Inserting the same data in loop.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Step</span> delete in loop
          Deleting the same data in loop.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_2f9cdbbe_340a_11ed_b9de_572e856b5561 WHERE x &lt; 25&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> attempt #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_2f9cdbbe_340a_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpgkeiop7n
            cat &quot;/tmp/tmpgkeiop7n&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;50&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> attempt #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> attempt #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_2f9cdbbe_340a_11ed_b9de_572e856b5561 WHERE x &lt; 25&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_2f9cdbbe_340a_11ed_b9de_572e856b5561 WHERE x &lt; 25&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_2f9cdbbe_340a_11ed_b9de_572e856b5561 WHERE x &lt; 25&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_2f9cdbbe_340a_11ed_b9de_572e856b5561 WHERE x &lt; 25&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_2f9cdbbe_340a_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpj9ybkuyc
            cat &quot;/tmp/tmpj9ybkuyc&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;50&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_2f9cdbbe_340a_11ed_b9de_572e856b5561 WHERE x &lt; 25&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_2f9cdbbe_340a_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpkb7uhayk
            cat &quot;/tmp/tmpkb7uhayk&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;50&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_2f9cdbbe_340a_11ed_b9de_572e856b5561 WHERE x &lt; 25&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_2f9cdbbe_340a_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpx81ldzcq
            cat &quot;/tmp/tmpx81ldzcq&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;50&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_2f9cdbbe_340a_11ed_b9de_572e856b5561 WHERE x &lt; 25&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_2f9cdbbe_340a_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmp2rk2qhcs
            cat &quot;/tmp/tmp2rk2qhcs&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;50&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_2f9cdbbe_340a_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmphmhz1595
            cat &quot;/tmp/tmphmhz1595&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;50&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_2f9cdbbe_340a_11ed_b9de_572e856b5561 WHERE x &lt; 25&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_2f9cdbbe_340a_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpyae5w9x5
            cat &quot;/tmp/tmpyae5w9x5&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;50&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_2f9cdbbe_340a_11ed_b9de_572e856b5561 WHERE x &lt; 25&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_2f9cdbbe_340a_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpj4hiyytq
            cat &quot;/tmp/tmpj4hiyytq&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;50&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_2f9cdbbe_340a_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpn8xva4n7
            cat &quot;/tmp/tmpn8xva4n7&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;50&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_2f9cdbbe_340a_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpncnyda1x
            cat &quot;/tmp/tmpncnyda1x&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;50&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">      Then</span> I check that rows are deleted
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_2f9cdbbe_340a_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">      Finally</span> I clean up
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        Finally</span> I remove the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_2f9cdbbe_340a_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
<span class="ro">    OK</span>
</code></pre></div>


</div>

<section class="requirement"><span class="requirement-inline"><i class="utf-icon color-ok">✔</i>RQ.SRS-023.ClickHouse.LightweightDelete.Compatibility.ConcurrentInserts&DeletesOfTheSameData</span></section>

<div class="requirement-description hidden">

<p><a target="_blank" rel="nofollow noopener noreferrer" href="https://clickhouse.yandex">ClickHouse</a> SHALL execute <code>INSERT</code> and <code>DELETE</code> statements that use the same data in the order they were ran.</p>

</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">4s 676ms</span>/lightweight delete/compatibility/concurrent insert delete the same data</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">    </span><span class="kn">Scenario</span><span class="nn"> concurrent insert delete the same data</span>
      Check that clickhouse support executing INSERT and DELETE statements concurrently
      on the same data.
<span class="k">      Given</span> I have a table
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        Given</span> I have a table table_35c0f22a_340a_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_35c0f22a_340a_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">      When</span> I insert a lot of data into the table
        10 partitions, 1 part, block_size=100
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          echo -e &quot;INSERT INTO table_35c0f22a_340a_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpeu4_zblh
          cat &quot;/tmp/tmpeu4_zblh&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">      Then</span> I perform concurrent operations
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        Step</span> insert rows in loop
          Inserting the same data in loop.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO table_35c0f22a_340a_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0,6),(0,7),(0,8),(0,9),(0,10),(0,11),(0,12),(0,13),(0,14),(0,15),(0,16),(0,17),(0,18),(0,19),(0,20),(0,21),(0,22),(0,23),(0,24)&quot; | clickhouse client -n --max_block_size &quot;25&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Step</span> delete in loop
          Deleting the same data in loop.
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_35c0f22a_340a_11ed_b9de_572e856b5561 WHERE id = 0 AND x &lt; 25&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> attempt #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> attempt #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> attempt #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO table_35c0f22a_340a_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0,6),(0,7),(0,8),(0,9),(0,10),(0,11),(0,12),(0,13),(0,14),(0,15),(0,16),(0,17),(0,18),(0,19),(0,20),(0,21),(0,22),(0,23),(0,24)&quot; | clickhouse client -n --max_block_size &quot;25&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> attempt #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO table_35c0f22a_340a_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0,6),(0,7),(0,8),(0,9),(0,10),(0,11),(0,12),(0,13),(0,14),(0,15),(0,16),(0,17),(0,18),(0,19),(0,20),(0,21),(0,22),(0,23),(0,24)&quot; | clickhouse client -n --max_block_size &quot;25&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_35c0f22a_340a_11ed_b9de_572e856b5561 WHERE id = 0 AND x &lt; 25&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO table_35c0f22a_340a_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0,6),(0,7),(0,8),(0,9),(0,10),(0,11),(0,12),(0,13),(0,14),(0,15),(0,16),(0,17),(0,18),(0,19),(0,20),(0,21),(0,22),(0,23),(0,24)&quot; | clickhouse client -n --max_block_size &quot;25&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_35c0f22a_340a_11ed_b9de_572e856b5561 WHERE id = 0 AND x &lt; 25&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO table_35c0f22a_340a_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0,6),(0,7),(0,8),(0,9),(0,10),(0,11),(0,12),(0,13),(0,14),(0,15),(0,16),(0,17),(0,18),(0,19),(0,20),(0,21),(0,22),(0,23),(0,24)&quot; | clickhouse client -n --max_block_size &quot;25&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO table_35c0f22a_340a_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0,6),(0,7),(0,8),(0,9),(0,10),(0,11),(0,12),(0,13),(0,14),(0,15),(0,16),(0,17),(0,18),(0,19),(0,20),(0,21),(0,22),(0,23),(0,24)&quot; | clickhouse client -n --max_block_size &quot;25&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO table_35c0f22a_340a_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0,6),(0,7),(0,8),(0,9),(0,10),(0,11),(0,12),(0,13),(0,14),(0,15),(0,16),(0,17),(0,18),(0,19),(0,20),(0,21),(0,22),(0,23),(0,24)&quot; | clickhouse client -n --max_block_size &quot;25&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_35c0f22a_340a_11ed_b9de_572e856b5561 WHERE id = 0 AND x &lt; 25&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO table_35c0f22a_340a_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0,6),(0,7),(0,8),(0,9),(0,10),(0,11),(0,12),(0,13),(0,14),(0,15),(0,16),(0,17),(0,18),(0,19),(0,20),(0,21),(0,22),(0,23),(0,24)&quot; | clickhouse client -n --max_block_size &quot;25&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_35c0f22a_340a_11ed_b9de_572e856b5561 WHERE id = 0 AND x &lt; 25&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO table_35c0f22a_340a_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0,6),(0,7),(0,8),(0,9),(0,10),(0,11),(0,12),(0,13),(0,14),(0,15),(0,16),(0,17),(0,18),(0,19),(0,20),(0,21),(0,22),(0,23),(0,24)&quot; | clickhouse client -n --max_block_size &quot;25&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_35c0f22a_340a_11ed_b9de_572e856b5561 WHERE id = 0 AND x &lt; 25&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO table_35c0f22a_340a_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0,6),(0,7),(0,8),(0,9),(0,10),(0,11),(0,12),(0,13),(0,14),(0,15),(0,16),(0,17),(0,18),(0,19),(0,20),(0,21),(0,22),(0,23),(0,24)&quot; | clickhouse client -n --max_block_size &quot;25&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_35c0f22a_340a_11ed_b9de_572e856b5561 WHERE id = 0 AND x &lt; 25&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_35c0f22a_340a_11ed_b9de_572e856b5561 WHERE id = 0 AND x &lt; 25&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_35c0f22a_340a_11ed_b9de_572e856b5561 WHERE id = 0 AND x &lt; 25&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_35c0f22a_340a_11ed_b9de_572e856b5561 WHERE id = 0 AND x &lt; 25&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">      Then</span> I check that rows are deleted
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_35c0f22a_340a_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">      Finally</span> I clean up
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        Finally</span> I remove the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_35c0f22a_340a_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
<span class="ro">    OK</span>
</code></pre></div>


</div>

<section class="requirement"><span class="requirement-inline"><i class="utf-icon color-fail">✘</i>RQ.SRS-023.ClickHouse.LightweightDelete.Compatibility.ConcurrentDelete&AlterDelete</span></section>

<div class="requirement-description hidden">

<p><a target="_blank" rel="nofollow noopener noreferrer" href="https://clickhouse.yandex">ClickHouse</a> SHALL support executing <code>DELETE</code> and <code>ALTER TABLE DELETE</code> statements concurrently.</p>

</div>

<div class="test"><span class="result result-inline result-error">Error</span><span class="time time-inline">2s 363ms</span>/lightweight delete/concurrent delete/MergeTree/concurrent delete with overlap with alter delete</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete with overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting the same rows.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_b5e0c4ca_341f_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_b5e0c4ca_341f_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert a lot of data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_b5e0c4ca_341f_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpqjgs3rrb
            cat &quot;/tmp/tmpqjgs3rrb&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_b5e0c4ca_341f_11ed_b9de_572e856b5561 WHERE NOT(x % 2 == 0)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes with overlap
<span class="re">        Error</span> I perform concurrent deletes with overlap, TypeError
<span class="k">          Step</span> delete odd first time
            Delete all odd `x` rows in all partitions.
<span class="re">          Error</span> delete odd first time, NameError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_b5e0c4ca_341f_11ed_b9de_572e856b5561 WHERE id == 0 AND x % 2 == 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="rs">            Skip</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="rs">              Skip</span><span class="k"></span>
<span class="k">          Step</span> delete odd second time
            Delete all odd `x` rows in all partitions.
<span class="re">          Error</span> delete odd second time, TypeError
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_b5e0c4ca_341f_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="re"></span>
<span class="re">      Error</span> concurrent delete with overlap with alter delete, TypeError
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-error">Error</span><span class="time time-inline">8s 492ms</span>/lightweight delete/concurrent delete/MergeTree/concurrent delete without overlap with alter delete</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete without overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting different rows.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_c1d2230a_341f_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_c1d2230a_341f_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert a lot of data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_c1d2230a_341f_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmp52mikffj
            cat &quot;/tmp/tmp52mikffj&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes without overlap
<span class="re">        Error</span> I perform concurrent deletes without overlap, TypeError
          Retry try #0
<span class="re">          Error</span> try #0, TypeError
<span class="k">            Step</span> delete odd rows
              Delete all odd `x` rows in all partitions.
<span class="re">            Error</span> delete odd rows, NameError
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_c1d2230a_341f_11ed_b9de_572e856b5561 WHERE id == 0 AND x % 2 == 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="rs">              Skip</span><span class="k"></span>
<span class="k">                By</span> attempt #0
<span class="rs">                Skip</span><span class="k"></span>
<span class="k">            Step</span> delete even rows
              Delete all even `x` rows in all partitions.
<span class="re">            Error</span> delete even rows, TypeError
          Retry try #1
<span class="re">          Error</span> try #1, TypeError
<span class="k">            Step</span> delete odd rows
              Delete all odd `x` rows in all partitions.
<span class="re">            Error</span> delete odd rows, NameError
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_c1d2230a_341f_11ed_b9de_572e856b5561 WHERE id == 0 AND x % 2 == 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="rs">              Skip</span><span class="k"></span>
<span class="k">                By</span> attempt #0
<span class="rs">                Skip</span><span class="k"></span>
<span class="k">            Step</span> delete even rows
              Delete all even `x` rows in all partitions.
<span class="re">            Error</span> delete even rows, TypeError
          Retry try #2
<span class="re">          Error</span> try #2, TypeError
<span class="k">            Step</span> delete odd rows
              Delete all odd `x` rows in all partitions.
<span class="re">            Error</span> delete odd rows, NameError
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_c1d2230a_341f_11ed_b9de_572e856b5561 WHERE id == 0 AND x % 2 == 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="rs">              Skip</span><span class="k"></span>
<span class="k">                By</span> attempt #0
<span class="rs">                Skip</span><span class="k"></span>
<span class="k">            Step</span> delete even rows
              Delete all even `x` rows in all partitions.
<span class="re">            Error</span> delete even rows, TypeError
          Retry try #3
<span class="re">          Error</span> try #3, TypeError
<span class="k">            Step</span> delete odd rows
              Delete all odd `x` rows in all partitions.
<span class="re">            Error</span> delete odd rows, NameError
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_c1d2230a_341f_11ed_b9de_572e856b5561 WHERE id == 0 AND x % 2 == 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="rs">              Skip</span><span class="k"></span>
<span class="k">                By</span> attempt #0
<span class="rs">                Skip</span><span class="k"></span>
<span class="k">            Step</span> delete even rows
              Delete all even `x` rows in all partitions.
<span class="re">            Error</span> delete even rows, TypeError
          Retry try #4
<span class="re">          Error</span> try #4, TypeError
<span class="k">            Step</span> delete odd rows
              Delete all odd `x` rows in all partitions.
<span class="re">            Error</span> delete odd rows, NameError
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_c1d2230a_341f_11ed_b9de_572e856b5561 WHERE id == 0 AND x % 2 == 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="rs">              Skip</span><span class="k"></span>
<span class="k">                By</span> attempt #0
<span class="rs">                Skip</span><span class="k"></span>
<span class="k">            Step</span> delete even rows
              Delete all even `x` rows in all partitions.
<span class="re">            Error</span> delete even rows, TypeError
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_c1d2230a_341f_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="re"></span>
<span class="re">      Error</span> concurrent delete without overlap with alter delete, TypeError
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-error">Error</span><span class="time time-inline">2s 521ms</span>/lightweight delete/concurrent delete/ReplacingMergeTree/concurrent delete with overlap with alter delete</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete with overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting the same rows.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_22c02e3c_3420_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_22c02e3c_3420_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplacingMergeTree() PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert a lot of data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_22c02e3c_3420_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpojg55b5u
            cat &quot;/tmp/tmpojg55b5u&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_22c02e3c_3420_11ed_b9de_572e856b5561 WHERE NOT(x % 2 == 0)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes with overlap
<span class="re">        Error</span> I perform concurrent deletes with overlap, TypeError
<span class="k">          Step</span> delete odd first time
            Delete all odd `x` rows in all partitions.
<span class="re">          Error</span> delete odd first time, NameError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_22c02e3c_3420_11ed_b9de_572e856b5561 WHERE id == 0 AND x % 2 == 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="rs">            Skip</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="rs">              Skip</span><span class="k"></span>
<span class="k">          Step</span> delete odd second time
            Delete all odd `x` rows in all partitions.
<span class="re">          Error</span> delete odd second time, TypeError
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_22c02e3c_3420_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="re"></span>
<span class="re">      Error</span> concurrent delete with overlap with alter delete, TypeError
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-error">Error</span><span class="time time-inline">5s 97ms</span>/lightweight delete/concurrent delete/ReplacingMergeTree/concurrent delete without overlap with alter delete</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete without overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting different rows.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_2b3d5724_3420_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_2b3d5724_3420_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplacingMergeTree() PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert a lot of data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_2b3d5724_3420_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpe4kfq_xt
            cat &quot;/tmp/tmpe4kfq_xt&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes without overlap
<span class="re">        Error</span> I perform concurrent deletes without overlap, TypeError
          Retry try #0
<span class="re">          Error</span> try #0, TypeError
<span class="k">            Step</span> delete odd rows
              Delete all odd `x` rows in all partitions.
<span class="re">            Error</span> delete odd rows, NameError
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_2b3d5724_3420_11ed_b9de_572e856b5561 WHERE id == 0 AND x % 2 == 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="rs">              Skip</span><span class="k"></span>
<span class="k">                By</span> attempt #0
<span class="rs">                Skip</span><span class="k"></span>
<span class="k">            Step</span> delete even rows
              Delete all even `x` rows in all partitions.
<span class="re">            Error</span> delete even rows, TypeError
          Retry try #1
<span class="re">          Error</span> try #1, TypeError
<span class="k">            Step</span> delete odd rows
              Delete all odd `x` rows in all partitions.
<span class="re">            Error</span> delete odd rows, NameError
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_2b3d5724_3420_11ed_b9de_572e856b5561 WHERE id == 0 AND x % 2 == 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="rs">              Skip</span><span class="k"></span>
<span class="k">                By</span> attempt #0
<span class="rs">                Skip</span><span class="k"></span>
<span class="k">            Step</span> delete even rows
              Delete all even `x` rows in all partitions.
<span class="re">            Error</span> delete even rows, TypeError
          Retry try #2
<span class="re">          Error</span> try #2, TypeError
<span class="k">            Step</span> delete odd rows
              Delete all odd `x` rows in all partitions.
<span class="re">            Error</span> delete odd rows, NameError
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_2b3d5724_3420_11ed_b9de_572e856b5561 WHERE id == 0 AND x % 2 == 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="rs">              Skip</span><span class="k"></span>
<span class="k">                By</span> attempt #0
<span class="rs">                Skip</span><span class="k"></span>
<span class="k">            Step</span> delete even rows
              Delete all even `x` rows in all partitions.
<span class="re">            Error</span> delete even rows, TypeError
          Retry try #3
<span class="re">          Error</span> try #3, TypeError
<span class="k">            Step</span> delete odd rows
              Delete all odd `x` rows in all partitions.
<span class="re">            Error</span> delete odd rows, NameError
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_2b3d5724_3420_11ed_b9de_572e856b5561 WHERE id == 0 AND x % 2 == 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="rs">              Skip</span><span class="k"></span>
<span class="k">                By</span> attempt #0
<span class="rs">                Skip</span><span class="k"></span>
<span class="k">            Step</span> delete even rows
              Delete all even `x` rows in all partitions.
<span class="re">            Error</span> delete even rows, TypeError
          Retry try #4
<span class="re">          Error</span> try #4, TypeError
<span class="k">            Step</span> delete odd rows
              Delete all odd `x` rows in all partitions.
<span class="re">            Error</span> delete odd rows, NameError
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_2b3d5724_3420_11ed_b9de_572e856b5561 WHERE id == 0 AND x % 2 == 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="rs">              Skip</span><span class="k"></span>
<span class="k">                By</span> attempt #0
<span class="rs">                Skip</span><span class="k"></span>
<span class="k">            Step</span> delete even rows
              Delete all even `x` rows in all partitions.
<span class="re">            Error</span> delete even rows, TypeError
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_2b3d5724_3420_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="re"></span>
<span class="re">      Error</span> concurrent delete without overlap with alter delete, TypeError
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-error">Error</span><span class="time time-inline">23s 150ms</span>/lightweight delete/concurrent delete/SummingMergeTree/concurrent delete with overlap with alter delete</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete with overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting the same rows.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_38dae866_3421_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_38dae866_3421_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = SummingMergeTree(x) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert a lot of data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_38dae866_3421_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmphqoqaj05
            cat &quot;/tmp/tmphqoqaj05&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_38dae866_3421_11ed_b9de_572e856b5561 WHERE NOT(x % 2 == 0)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes with overlap
<span class="re">        Error</span> I perform concurrent deletes with overlap, TypeError
<span class="k">          Step</span> delete odd first time
            Delete all odd `x` rows in all partitions.
<span class="re">          Error</span> delete odd first time, NameError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_38dae866_3421_11ed_b9de_572e856b5561 WHERE id == 0 AND x % 2 == 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="rs">            Skip</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="rs">              Skip</span><span class="k"></span>
<span class="k">          Step</span> delete odd second time
            Delete all odd `x` rows in all partitions.
<span class="re">          Error</span> delete odd second time, TypeError
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_38dae866_3421_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="re"></span>
<span class="re">      Error</span> concurrent delete with overlap with alter delete, TypeError
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-error">Error</span><span class="time time-inline">18s 19ms</span>/lightweight delete/concurrent delete/SummingMergeTree/concurrent delete without overlap with alter delete</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete without overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting different rows.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_85ebe09a_3421_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_85ebe09a_3421_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = SummingMergeTree(x) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert a lot of data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_85ebe09a_3421_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmp89knu63o
            cat &quot;/tmp/tmp89knu63o&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes without overlap
<span class="re">        Error</span> I perform concurrent deletes without overlap, TypeError
          Retry try #0
<span class="re">          Error</span> try #0, TypeError
<span class="k">            Step</span> delete odd rows
              Delete all odd `x` rows in all partitions.
<span class="re">            Error</span> delete odd rows, NameError
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_85ebe09a_3421_11ed_b9de_572e856b5561 WHERE id == 0 AND x % 2 == 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="rs">              Skip</span><span class="k"></span>
<span class="k">                By</span> attempt #0
<span class="rs">                Skip</span><span class="k"></span>
<span class="k">            Step</span> delete even rows
              Delete all even `x` rows in all partitions.
<span class="re">            Error</span> delete even rows, TypeError
          Retry try #1
<span class="re">          Error</span> try #1, TypeError
<span class="k">            Step</span> delete odd rows
              Delete all odd `x` rows in all partitions.
<span class="re">            Error</span> delete odd rows, NameError
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_85ebe09a_3421_11ed_b9de_572e856b5561 WHERE id == 0 AND x % 2 == 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="rs">              Skip</span><span class="k"></span>
<span class="k">                By</span> attempt #0
<span class="rs">                Skip</span><span class="k"></span>
<span class="k">            Step</span> delete even rows
              Delete all even `x` rows in all partitions.
<span class="re">            Error</span> delete even rows, TypeError
          Retry try #2
<span class="re">          Error</span> try #2, TypeError
<span class="k">            Step</span> delete odd rows
              Delete all odd `x` rows in all partitions.
<span class="re">            Error</span> delete odd rows, NameError
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_85ebe09a_3421_11ed_b9de_572e856b5561 WHERE id == 0 AND x % 2 == 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="rs">              Skip</span><span class="k"></span>
<span class="k">                By</span> attempt #0
<span class="rs">                Skip</span><span class="k"></span>
<span class="k">            Step</span> delete even rows
              Delete all even `x` rows in all partitions.
<span class="re">            Error</span> delete even rows, TypeError
          Retry try #3
<span class="re">          Error</span> try #3, TypeError
<span class="k">            Step</span> delete odd rows
              Delete all odd `x` rows in all partitions.
<span class="re">            Error</span> delete odd rows, NameError
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_85ebe09a_3421_11ed_b9de_572e856b5561 WHERE id == 0 AND x % 2 == 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="rs">              Skip</span><span class="k"></span>
<span class="k">                By</span> attempt #0
<span class="rs">                Skip</span><span class="k"></span>
<span class="k">            Step</span> delete even rows
              Delete all even `x` rows in all partitions.
<span class="re">            Error</span> delete even rows, TypeError
          Retry try #4
<span class="re">          Error</span> try #4, TypeError
<span class="k">            Step</span> delete odd rows
              Delete all odd `x` rows in all partitions.
<span class="re">            Error</span> delete odd rows, NameError
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_85ebe09a_3421_11ed_b9de_572e856b5561 WHERE id == 0 AND x % 2 == 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="rs">              Skip</span><span class="k"></span>
<span class="k">                By</span> attempt #0
<span class="rs">                Skip</span><span class="k"></span>
<span class="k">            Step</span> delete even rows
              Delete all even `x` rows in all partitions.
<span class="re">            Error</span> delete even rows, TypeError
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_85ebe09a_3421_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="re"></span>
<span class="re">      Error</span> concurrent delete without overlap with alter delete, TypeError
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-error">Error</span><span class="time time-inline">2s 65ms</span>/lightweight delete/concurrent delete/AggregatingMergeTree/concurrent delete with overlap with alter delete</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete with overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting the same rows.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_e0b717ba_3421_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_e0b717ba_3421_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = AggregatingMergeTree() PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert a lot of data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_e0b717ba_3421_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpp9kp94tw
            cat &quot;/tmp/tmpp9kp94tw&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_e0b717ba_3421_11ed_b9de_572e856b5561 WHERE NOT(x % 2 == 0)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes with overlap
<span class="re">        Error</span> I perform concurrent deletes with overlap, TypeError
<span class="k">          Step</span> delete odd first time
            Delete all odd `x` rows in all partitions.
<span class="re">          Error</span> delete odd first time, NameError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_e0b717ba_3421_11ed_b9de_572e856b5561 WHERE id == 0 AND x % 2 == 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="rs">            Skip</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="rs">              Skip</span><span class="k"></span>
<span class="k">          Step</span> delete odd second time
            Delete all odd `x` rows in all partitions.
<span class="re">          Error</span> delete odd second time, TypeError
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_e0b717ba_3421_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="re"></span>
<span class="re">      Error</span> concurrent delete with overlap with alter delete, TypeError
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-error">Error</span><span class="time time-inline">3s 990ms</span>/lightweight delete/concurrent delete/AggregatingMergeTree/concurrent delete without overlap with alter delete</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete without overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting different rows.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_e80c1c22_3421_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_e80c1c22_3421_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = AggregatingMergeTree() PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert a lot of data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_e80c1c22_3421_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmplp8__msl
            cat &quot;/tmp/tmplp8__msl&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes without overlap
<span class="re">        Error</span> I perform concurrent deletes without overlap, TypeError
          Retry try #0
<span class="re">          Error</span> try #0, TypeError
<span class="k">            Step</span> delete odd rows
              Delete all odd `x` rows in all partitions.
<span class="re">            Error</span> delete odd rows, NameError
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_e80c1c22_3421_11ed_b9de_572e856b5561 WHERE id == 0 AND x % 2 == 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="rs">              Skip</span><span class="k"></span>
<span class="k">                By</span> attempt #0
<span class="rs">                Skip</span><span class="k"></span>
<span class="k">            Step</span> delete even rows
              Delete all even `x` rows in all partitions.
<span class="re">            Error</span> delete even rows, TypeError
          Retry try #1
<span class="re">          Error</span> try #1, TypeError
<span class="k">            Step</span> delete odd rows
              Delete all odd `x` rows in all partitions.
<span class="re">            Error</span> delete odd rows, NameError
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_e80c1c22_3421_11ed_b9de_572e856b5561 WHERE id == 0 AND x % 2 == 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="rs">              Skip</span><span class="k"></span>
<span class="k">                By</span> attempt #0
<span class="rs">                Skip</span><span class="k"></span>
<span class="k">            Step</span> delete even rows
              Delete all even `x` rows in all partitions.
<span class="re">            Error</span> delete even rows, TypeError
          Retry try #2
<span class="re">          Error</span> try #2, TypeError
<span class="k">            Step</span> delete odd rows
              Delete all odd `x` rows in all partitions.
<span class="re">            Error</span> delete odd rows, NameError
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_e80c1c22_3421_11ed_b9de_572e856b5561 WHERE id == 0 AND x % 2 == 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="rs">              Skip</span><span class="k"></span>
<span class="k">                By</span> attempt #0
<span class="rs">                Skip</span><span class="k"></span>
<span class="k">            Step</span> delete even rows
              Delete all even `x` rows in all partitions.
<span class="re">            Error</span> delete even rows, TypeError
          Retry try #3
<span class="re">          Error</span> try #3, TypeError
<span class="k">            Step</span> delete odd rows
              Delete all odd `x` rows in all partitions.
<span class="re">            Error</span> delete odd rows, NameError
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_e80c1c22_3421_11ed_b9de_572e856b5561 WHERE id == 0 AND x % 2 == 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="rs">              Skip</span><span class="k"></span>
<span class="k">                By</span> attempt #0
<span class="rs">                Skip</span><span class="k"></span>
<span class="k">            Step</span> delete even rows
              Delete all even `x` rows in all partitions.
<span class="re">            Error</span> delete even rows, TypeError
          Retry try #4
<span class="re">          Error</span> try #4, TypeError
<span class="k">            Step</span> delete odd rows
              Delete all odd `x` rows in all partitions.
<span class="re">            Error</span> delete odd rows, NameError
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_e80c1c22_3421_11ed_b9de_572e856b5561 WHERE id == 0 AND x % 2 == 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="rs">              Skip</span><span class="k"></span>
<span class="k">                By</span> attempt #0
<span class="rs">                Skip</span><span class="k"></span>
<span class="k">            Step</span> delete even rows
              Delete all even `x` rows in all partitions.
<span class="re">            Error</span> delete even rows, TypeError
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_e80c1c22_3421_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="re"></span>
<span class="re">      Error</span> concurrent delete without overlap with alter delete, TypeError
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-error">Error</span><span class="time time-inline">2s 685ms</span>/lightweight delete/concurrent delete/CollapsingMergeTree/concurrent delete with overlap with alter delete</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete with overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting the same rows.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_2b6ce852_3422_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_2b6ce852_3422_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = CollapsingMergeTree(Sign) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert a lot of data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_2b6ce852_3422_11ed_b9de_572e856b5561 VALUES (0,0,1),(0,1,1),(0,2,1),(0,3,1),(0,4,1...&quot; &gt; /tmp/tmpsnfd4t4x
            cat &quot;/tmp/tmpsnfd4t4x&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_2b6ce852_3422_11ed_b9de_572e856b5561 WHERE NOT(x % 2 == 0)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes with overlap
<span class="re">        Error</span> I perform concurrent deletes with overlap, TypeError
<span class="k">          Step</span> delete odd first time
            Delete all odd `x` rows in all partitions.
<span class="re">          Error</span> delete odd first time, NameError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_2b6ce852_3422_11ed_b9de_572e856b5561 WHERE id == 0 AND x % 2 == 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="rs">            Skip</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="rs">              Skip</span><span class="k"></span>
<span class="k">          Step</span> delete odd second time
            Delete all odd `x` rows in all partitions.
<span class="re">          Error</span> delete odd second time, TypeError
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_2b6ce852_3422_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="re"></span>
<span class="re">      Error</span> concurrent delete with overlap with alter delete, TypeError
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-error">Error</span><span class="time time-inline">4s 919ms</span>/lightweight delete/concurrent delete/CollapsingMergeTree/concurrent delete without overlap with alter delete</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete without overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting different rows.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_37046fdc_3422_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_37046fdc_3422_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = CollapsingMergeTree(Sign) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert a lot of data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_37046fdc_3422_11ed_b9de_572e856b5561 VALUES (0,0,1),(0,1,1),(0,2,1),(0,3,1),(0,4,1...&quot; &gt; /tmp/tmpl3jjlrcr
            cat &quot;/tmp/tmpl3jjlrcr&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes without overlap
<span class="re">        Error</span> I perform concurrent deletes without overlap, TypeError
          Retry try #0
<span class="re">          Error</span> try #0, TypeError
<span class="k">            Step</span> delete odd rows
              Delete all odd `x` rows in all partitions.
<span class="re">            Error</span> delete odd rows, NameError
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_37046fdc_3422_11ed_b9de_572e856b5561 WHERE id == 0 AND x % 2 == 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="rs">              Skip</span><span class="k"></span>
<span class="k">                By</span> attempt #0
<span class="rs">                Skip</span><span class="k"></span>
<span class="k">            Step</span> delete even rows
              Delete all even `x` rows in all partitions.
<span class="re">            Error</span> delete even rows, TypeError
          Retry try #1
<span class="re">          Error</span> try #1, TypeError
<span class="k">            Step</span> delete odd rows
              Delete all odd `x` rows in all partitions.
<span class="re">            Error</span> delete odd rows, NameError
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_37046fdc_3422_11ed_b9de_572e856b5561 WHERE id == 0 AND x % 2 == 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="rs">              Skip</span><span class="k"></span>
<span class="k">                By</span> attempt #0
<span class="rs">                Skip</span><span class="k"></span>
<span class="k">            Step</span> delete even rows
              Delete all even `x` rows in all partitions.
<span class="re">            Error</span> delete even rows, TypeError
          Retry try #2
<span class="re">          Error</span> try #2, TypeError
<span class="k">            Step</span> delete odd rows
              Delete all odd `x` rows in all partitions.
<span class="re">            Error</span> delete odd rows, NameError
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_37046fdc_3422_11ed_b9de_572e856b5561 WHERE id == 0 AND x % 2 == 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="rs">              Skip</span><span class="k"></span>
<span class="k">                By</span> attempt #0
<span class="rs">                Skip</span><span class="k"></span>
<span class="k">            Step</span> delete even rows
              Delete all even `x` rows in all partitions.
<span class="re">            Error</span> delete even rows, TypeError
          Retry try #3
<span class="re">          Error</span> try #3, TypeError
<span class="k">            Step</span> delete odd rows
              Delete all odd `x` rows in all partitions.
<span class="re">            Error</span> delete odd rows, NameError
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_37046fdc_3422_11ed_b9de_572e856b5561 WHERE id == 0 AND x % 2 == 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="rs">              Skip</span><span class="k"></span>
<span class="k">                By</span> attempt #0
<span class="rs">                Skip</span><span class="k"></span>
<span class="k">            Step</span> delete even rows
              Delete all even `x` rows in all partitions.
<span class="re">            Error</span> delete even rows, TypeError
          Retry try #4
<span class="re">          Error</span> try #4, TypeError
<span class="k">            Step</span> delete odd rows
              Delete all odd `x` rows in all partitions.
<span class="re">            Error</span> delete odd rows, NameError
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_37046fdc_3422_11ed_b9de_572e856b5561 WHERE id == 0 AND x % 2 == 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="rs">              Skip</span><span class="k"></span>
<span class="k">                By</span> attempt #0
<span class="rs">                Skip</span><span class="k"></span>
<span class="k">            Step</span> delete even rows
              Delete all even `x` rows in all partitions.
<span class="re">            Error</span> delete even rows, TypeError
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_37046fdc_3422_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="re"></span>
<span class="re">      Error</span> concurrent delete without overlap with alter delete, TypeError
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-error">Error</span><span class="time time-inline">2s 52ms</span>/lightweight delete/concurrent delete/VersionedCollapsingMergeTree/concurrent delete with overlap with alter delete</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete with overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting the same rows.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_872caa1a_3422_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_872caa1a_3422_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = VersionedCollapsingMergeTree(Sign, id) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert a lot of data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_872caa1a_3422_11ed_b9de_572e856b5561 VALUES (0,0,1),(0,1,1),(0,2,1),(0,3,1),(0,4,1...&quot; &gt; /tmp/tmpbo1d3_xe
            cat &quot;/tmp/tmpbo1d3_xe&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_872caa1a_3422_11ed_b9de_572e856b5561 WHERE NOT(x % 2 == 0)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes with overlap
<span class="re">        Error</span> I perform concurrent deletes with overlap, TypeError
<span class="k">          Step</span> delete odd first time
            Delete all odd `x` rows in all partitions.
<span class="re">          Error</span> delete odd first time, NameError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_872caa1a_3422_11ed_b9de_572e856b5561 WHERE id == 0 AND x % 2 == 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="rs">            Skip</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="rs">              Skip</span><span class="k"></span>
<span class="k">          Step</span> delete odd second time
            Delete all odd `x` rows in all partitions.
<span class="re">          Error</span> delete odd second time, TypeError
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_872caa1a_3422_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="re"></span>
<span class="re">      Error</span> concurrent delete with overlap with alter delete, TypeError
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-error">Error</span><span class="time time-inline">4s 713ms</span>/lightweight delete/concurrent delete/VersionedCollapsingMergeTree/concurrent delete without overlap with alter delete</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete without overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting different rows.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_9668fbe6_3422_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_9668fbe6_3422_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = VersionedCollapsingMergeTree(Sign, id) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert a lot of data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_9668fbe6_3422_11ed_b9de_572e856b5561 VALUES (0,0,1),(0,1,1),(0,2,1),(0,3,1),(0,4,1...&quot; &gt; /tmp/tmpu2zkjvuo
            cat &quot;/tmp/tmpu2zkjvuo&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes without overlap
<span class="re">        Error</span> I perform concurrent deletes without overlap, TypeError
          Retry try #0
<span class="re">          Error</span> try #0, TypeError
<span class="k">            Step</span> delete odd rows
              Delete all odd `x` rows in all partitions.
<span class="re">            Error</span> delete odd rows, NameError
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_9668fbe6_3422_11ed_b9de_572e856b5561 WHERE id == 0 AND x % 2 == 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="rs">              Skip</span><span class="k"></span>
<span class="k">                By</span> attempt #0
<span class="rs">                Skip</span><span class="k"></span>
<span class="k">            Step</span> delete even rows
              Delete all even `x` rows in all partitions.
<span class="re">            Error</span> delete even rows, TypeError
          Retry try #1
<span class="re">          Error</span> try #1, TypeError
<span class="k">            Step</span> delete odd rows
              Delete all odd `x` rows in all partitions.
<span class="re">            Error</span> delete odd rows, NameError
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_9668fbe6_3422_11ed_b9de_572e856b5561 WHERE id == 0 AND x % 2 == 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="rs">              Skip</span><span class="k"></span>
<span class="k">                By</span> attempt #0
<span class="rs">                Skip</span><span class="k"></span>
<span class="k">            Step</span> delete even rows
              Delete all even `x` rows in all partitions.
<span class="re">            Error</span> delete even rows, TypeError
          Retry try #2
<span class="re">          Error</span> try #2, TypeError
<span class="k">            Step</span> delete odd rows
              Delete all odd `x` rows in all partitions.
<span class="re">            Error</span> delete odd rows, NameError
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_9668fbe6_3422_11ed_b9de_572e856b5561 WHERE id == 0 AND x % 2 == 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="rs">              Skip</span><span class="k"></span>
<span class="k">                By</span> attempt #0
<span class="rs">                Skip</span><span class="k"></span>
<span class="k">            Step</span> delete even rows
              Delete all even `x` rows in all partitions.
<span class="re">            Error</span> delete even rows, TypeError
          Retry try #3
<span class="re">          Error</span> try #3, TypeError
<span class="k">            Step</span> delete odd rows
              Delete all odd `x` rows in all partitions.
<span class="re">            Error</span> delete odd rows, NameError
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_9668fbe6_3422_11ed_b9de_572e856b5561 WHERE id == 0 AND x % 2 == 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="rs">              Skip</span><span class="k"></span>
<span class="k">                By</span> attempt #0
<span class="rs">                Skip</span><span class="k"></span>
<span class="k">            Step</span> delete even rows
              Delete all even `x` rows in all partitions.
<span class="re">            Error</span> delete even rows, TypeError
          Retry try #4
<span class="re">          Error</span> try #4, TypeError
<span class="k">            Step</span> delete odd rows
              Delete all odd `x` rows in all partitions.
<span class="re">            Error</span> delete odd rows, NameError
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_9668fbe6_3422_11ed_b9de_572e856b5561 WHERE id == 0 AND x % 2 == 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="rs">              Skip</span><span class="k"></span>
<span class="k">                By</span> attempt #0
<span class="rs">                Skip</span><span class="k"></span>
<span class="k">            Step</span> delete even rows
              Delete all even `x` rows in all partitions.
<span class="re">            Error</span> delete even rows, TypeError
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_9668fbe6_3422_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="re"></span>
<span class="re">      Error</span> concurrent delete without overlap with alter delete, TypeError
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-error">Error</span><span class="time time-inline">3s 423ms</span>/lightweight delete/concurrent delete/GraphiteMergeTree/concurrent delete with overlap with alter delete</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete with overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting the same rows.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_18da0692_3423_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_18da0692_3423_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Path String, Time DateTime, Value Int64, Timestamp Int64) Engine = GraphiteMergeTree(&#39;graphite_rollup_example&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert a lot of data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_18da0692_3423_11ed_b9de_572e856b5561 VALUES (0,0, &#39;1&#39;, toDateTime(10), 10, 10),(0,...&quot; &gt; /tmp/tmpq1hoq709
            cat &quot;/tmp/tmpq1hoq709&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_18da0692_3423_11ed_b9de_572e856b5561 WHERE NOT(x % 2 == 0)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes with overlap
<span class="re">        Error</span> I perform concurrent deletes with overlap, TypeError
<span class="k">          Step</span> delete odd first time
            Delete all odd `x` rows in all partitions.
<span class="re">          Error</span> delete odd first time, NameError
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_18da0692_3423_11ed_b9de_572e856b5561 WHERE id == 0 AND x % 2 == 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="rs">            Skip</span><span class="k"></span>
<span class="k">              By</span> attempt #0
<span class="rs">              Skip</span><span class="k"></span>
<span class="k">          Step</span> delete odd second time
            Delete all odd `x` rows in all partitions.
<span class="re">          Error</span> delete odd second time, TypeError
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_18da0692_3423_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="re"></span>
<span class="re">      Error</span> concurrent delete with overlap with alter delete, TypeError
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-error">Error</span><span class="time time-inline">4s 923ms</span>/lightweight delete/concurrent delete/GraphiteMergeTree/concurrent delete without overlap with alter delete</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> concurrent delete without overlap with alter delete</span>
        Check, that clickhouse DELETE statement SHALL perform correctly when there are
        concurrent DELETE statement and alter delete targeting different rows.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_2214b996_3423_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_2214b996_3423_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Path String, Time DateTime, Value Int64, Timestamp Int64) Engine = GraphiteMergeTree(&#39;graphite_rollup_example&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert a lot of data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_2214b996_3423_11ed_b9de_572e856b5561 VALUES (0,0, &#39;1&#39;, toDateTime(10), 10, 10),(0,...&quot; &gt; /tmp/tmpaup0n4xj
            cat &quot;/tmp/tmpaup0n4xj&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I perform concurrent deletes without overlap
<span class="re">        Error</span> I perform concurrent deletes without overlap, TypeError
          Retry try #0
<span class="re">          Error</span> try #0, TypeError
<span class="k">            Step</span> delete odd rows
              Delete all odd `x` rows in all partitions.
<span class="re">            Error</span> delete odd rows, NameError
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_2214b996_3423_11ed_b9de_572e856b5561 WHERE id == 0 AND x % 2 == 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="rs">              Skip</span><span class="k"></span>
<span class="k">                By</span> attempt #0
<span class="rs">                Skip</span><span class="k"></span>
<span class="k">            Step</span> delete even rows
              Delete all even `x` rows in all partitions.
<span class="re">            Error</span> delete even rows, TypeError
          Retry try #1
<span class="re">          Error</span> try #1, TypeError
<span class="k">            Step</span> delete odd rows
              Delete all odd `x` rows in all partitions.
<span class="re">            Error</span> delete odd rows, NameError
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_2214b996_3423_11ed_b9de_572e856b5561 WHERE id == 0 AND x % 2 == 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="rs">              Skip</span><span class="k"></span>
<span class="k">                By</span> attempt #0
<span class="rs">                Skip</span><span class="k"></span>
<span class="k">            Step</span> delete even rows
              Delete all even `x` rows in all partitions.
<span class="re">            Error</span> delete even rows, TypeError
          Retry try #2
<span class="re">          Error</span> try #2, TypeError
<span class="k">            Step</span> delete odd rows
              Delete all odd `x` rows in all partitions.
<span class="re">            Error</span> delete odd rows, NameError
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_2214b996_3423_11ed_b9de_572e856b5561 WHERE id == 0 AND x % 2 == 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="rs">              Skip</span><span class="k"></span>
<span class="k">                By</span> attempt #0
<span class="rs">                Skip</span><span class="k"></span>
<span class="k">            Step</span> delete even rows
              Delete all even `x` rows in all partitions.
<span class="re">            Error</span> delete even rows, TypeError
          Retry try #3
<span class="re">          Error</span> try #3, TypeError
<span class="k">            Step</span> delete odd rows
              Delete all odd `x` rows in all partitions.
<span class="re">            Error</span> delete odd rows, NameError
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_2214b996_3423_11ed_b9de_572e856b5561 WHERE id == 0 AND x % 2 == 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="rs">              Skip</span><span class="k"></span>
<span class="k">                By</span> attempt #0
<span class="rs">                Skip</span><span class="k"></span>
<span class="k">            Step</span> delete even rows
              Delete all even `x` rows in all partitions.
<span class="re">            Error</span> delete even rows, TypeError
          Retry try #4
<span class="re">          Error</span> try #4, TypeError
<span class="k">            Step</span> delete odd rows
              Delete all odd `x` rows in all partitions.
<span class="re">            Error</span> delete odd rows, NameError
<span class="k">              By</span> executing command
                (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_2214b996_3423_11ed_b9de_572e856b5561 WHERE id == 0 AND x % 2 == 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="rs">              Skip</span><span class="k"></span>
<span class="k">                By</span> attempt #0
<span class="rs">                Skip</span><span class="k"></span>
<span class="k">            Step</span> delete even rows
              Delete all even `x` rows in all partitions.
<span class="re">            Error</span> delete even rows, TypeError
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_2214b996_3423_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="re"></span>
<span class="re">      Error</span> concurrent delete without overlap with alter delete, TypeError
</code></pre></div>


</div>

<section class="requirement"><span class="requirement-inline"><i class="utf-icon color-ok">✔</i>RQ.SRS-023.ClickHouse.LightweightDelete.Compatibility.Projections</span></section>

<div class="requirement-description hidden">

<p><a target="_blank" rel="nofollow noopener noreferrer" href="https://clickhouse.yandex">ClickHouse</a> <code>DELETE</code> statement SHALL be compatible with tables that have one or more projections.</p>

</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">3s 530ms</span>/lightweight delete/projections</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">  </span><span class="kn">Feature</span><span class="nn"> projections</span>
    Check that tables that have one or more projections work with delete.
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> simple projection</span>
      Check delete on a table that has simple projection
      which optimizes query with a simple where clause.
<span class="rx">    XFail</span> simple projection, engine type not supported.
<span class="ro">  OK</span>
</code></pre></div>


</div>

<section class="requirement"><span class="requirement-inline"><i class="utf-icon color-ok">✔</i>RQ.SRS-023.ClickHouse.LightweightDelete.Compatibility.Views</span></section>

<div class="requirement-description hidden">

<p><a target="_blank" rel="nofollow noopener noreferrer" href="https://clickhouse.yandex">ClickHouse</a> <code>DELETE</code> statement SHALL be compatible with tables that have one or more views. 
Including </p>

<ul>
<li>normal</li>
<li>materialized</li>
<li>live</li>
<li>window</li>
</ul>

</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">15s 260ms</span>/lightweight delete/views</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">  </span><span class="kn">Feature</span><span class="nn"> views</span>
    Check that clickhouse DELETE statement is compatible with tables that have one or more views.
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> live view</span>
      Check that clickhouse DELETE statement is compatible with tables that have one or more live views.
<span class="rx">    XFail</span> live view, not implemented
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> materialized view</span>
      Check that clickhouse DELETE statement is compatible with tables that have one or more normal views.
<span class="rx">    XFail</span> materialized view, not implemented
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> normal view</span>
      Check that clickhouse DELETE statement is compatible with tables that have one or more normal views.
<span class="ro">    OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> window view</span>
      Check that clickhouse DELETE statement is compatible with tables that have one or more window views.
<span class="rx">    XFail</span> window view, not implemented
<span class="ro">  OK</span>
</code></pre></div>


</div>

<section class="requirement"><span class="requirement-inline"><i class="utf-icon color-ok">✔</i>RQ.SRS-023.ClickHouse.LightweightDelete.HardRestarts</span></section>

<div class="requirement-description hidden">

<p><a target="_blank" rel="nofollow noopener noreferrer" href="https://clickhouse.yandex">ClickHouse</a> SHALL either finish the <code>DELETE</code> or return the system to before the <code>DELETE</code> started after a hard restart.</p>

</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">15m 28s</span>/lightweight delete/hard restart</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">  </span><span class="kn">Feature</span><span class="nn"> hard restart</span>
    Check that clickhouse either finish the DELETE or return the system
    to before the DELETE started after a hard restart.
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> SIGKILL</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> hard restart</span>
        Check that clickhouse either completes DELETE operation or
        leaves data in the same state after a hard restart
        by using signal.
<span class="ro">      OK</span>
<span class="ro">  OK</span>
</code></pre></div>


</div>

<section class="requirement"><span class="requirement-inline"><i class="utf-icon color-ok">✔</i>RQ.SRS-023.ClickHouse.LightweightDelete.NonCorruptedServerState</span></section>

<div class="requirement-description hidden">

<p><a target="_blank" rel="nofollow noopener noreferrer" href="https://clickhouse.yandex">ClickHouse</a> SHALL prevent server state from being corrupted if the server crashes during a <code>DELETE</code>.</p>

</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">15m 28s</span>/lightweight delete/hard restart</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">  </span><span class="kn">Feature</span><span class="nn"> hard restart</span>
    Check that clickhouse either finish the DELETE or return the system
    to before the DELETE started after a hard restart.
<span class="k">    </span><span class="kn">Feature</span><span class="nn"> SIGKILL</span><span class="ro"></span>
<span class="ro">    OK</span><span class="k"></span>
<span class="k">      </span><span class="kn">Scenario</span><span class="nn"> hard restart</span>
        Check that clickhouse either completes DELETE operation or
        leaves data in the same state after a hard restart
        by using signal.
<span class="ro">      OK</span>
<span class="ro">  OK</span>
</code></pre></div>


</div>

<section class="requirement"><span class="requirement-inline"><i class="utf-icon color-ok">✔</i>RQ.SRS-023.ClickHouse.LightweightDelete.ServerRestart</span></section>

<div class="requirement-description hidden">

<p><a target="_blank" rel="nofollow noopener noreferrer" href="https://clickhouse.yandex">ClickHouse</a> SHALL keep rows deleted after a server restart.</p>

</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">35s 652ms</span>/lightweight delete/basic checks/one million datapoints/delete all rows</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete all rows</span>
        Check that DELETE can remove all rows.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_ab200497_3423_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_ab200497_3423_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert one million entries
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_ab200497_3423_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpzjvltl3u
            cat &quot;/tmp/tmpzjvltl3u&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I delete all rows from table_ab200497_3423_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_ab200497_3423_11ed_b9de_572e856b5561 WHERE id &gt; -1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check table_ab200497_3423_11ed_b9de_572e856b5561 is empty
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_ab200497_3423_11ed_b9de_572e856b5561 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_ab200497_3423_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="rf">            Fail</span> try #1, ClickHouse server is not healthy
            Retry try #2
<span class="rf">            Fail</span> try #2, ClickHouse server is not healthy
            Retry try #3
<span class="rf">            Fail</span> try #3, ClickHouse server is not healthy
            Retry try #4
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_ab200497_3423_11ed_b9de_572e856b5561 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_ab200497_3423_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_ab200497_3423_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">16s 646ms</span>/lightweight delete/basic checks/one million datapoints/delete all rows from half of parts</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete all rows from half of parts</span>
        Check that DELETE can remove all rows from half of the parts.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_bfa91248_3423_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_bfa91248_3423_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert one million entries
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_bfa91248_3423_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpzjmtlhni
            cat &quot;/tmp/tmpzjmtlhni&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_bfa91248_3423_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_bfa91248_3423_11ed_b9de_572e856b5561 WHERE id &lt; 5&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        When</span> I delete all rows from table_bfa91248_3423_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_bfa91248_3423_11ed_b9de_572e856b5561 WHERE id &lt; 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check table_bfa91248_3423_11ed_b9de_572e856b5561 is empty
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_bfa91248_3423_11ed_b9de_572e856b5561 WHERE id &lt; 5 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_bfa91248_3423_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_bfa91248_3423_11ed_b9de_572e856b5561 WHERE id &lt; 5 ORDER BY id FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_bfa91248_3423_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_bfa91248_3423_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">17s 327ms</span>/lightweight delete/basic checks/one million datapoints/delete large subset</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete large subset</span>
        Check that DELETE can remove a large subset of rows.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_ca46e9f3_3423_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_ca46e9f3_3423_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert one million entries
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_ca46e9f3_3423_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmp7rzf2q2h
            cat &quot;/tmp/tmp7rzf2q2h&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_ca46e9f3_3423_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_ca46e9f3_3423_11ed_b9de_572e856b5561 WHERE x &gt; 10&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        When</span> I delete all rows from table_ca46e9f3_3423_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_ca46e9f3_3423_11ed_b9de_572e856b5561 WHERE x &gt; 10&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check table_ca46e9f3_3423_11ed_b9de_572e856b5561 is empty
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_ca46e9f3_3423_11ed_b9de_572e856b5561 WHERE x &gt; 10 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_ca46e9f3_3423_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_ca46e9f3_3423_11ed_b9de_572e856b5561 WHERE x &gt; 10 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_ca46e9f3_3423_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_ca46e9f3_3423_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">22s 439ms</span>/lightweight delete/basic checks/one million datapoints/delete one row</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete one row</span>
        Check that DELETE can remove one row.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_d3e48ccf_3423_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_d3e48ccf_3423_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert one million entries
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_d3e48ccf_3423_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpnci9rzt5
            cat &quot;/tmp/tmpnci9rzt5&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_d3e48ccf_3423_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> I have one distinct row
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO table_d3e48ccf_3423_11ed_b9de_572e856b5561 VALUES (-1,-1)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I delete the row
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_d3e48ccf_3423_11ed_b9de_572e856b5561 WHERE id &lt; 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check the table is the same as before the insert
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_d3e48ccf_3423_11ed_b9de_572e856b5561 WHERE id &lt; 0 ORDER BY id FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_d3e48ccf_3423_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_d3e48ccf_3423_11ed_b9de_572e856b5561 WHERE id &lt; 0 ORDER BY id FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_d3e48ccf_3423_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_d3e48ccf_3423_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">18s 458ms</span>/lightweight delete/basic checks/one million datapoints/delete small subset</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete small subset</span>
        Check that DELETE can remove a small subset of rows.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_e14b1d6b_3423_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_e14b1d6b_3423_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert one million entries
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_e14b1d6b_3423_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpnw58hty7
            cat &quot;/tmp/tmpnw58hty7&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_e14b1d6b_3423_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_e14b1d6b_3423_11ed_b9de_572e856b5561 WHERE x &lt; 10&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        When</span> I delete all rows from table_e14b1d6b_3423_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_e14b1d6b_3423_11ed_b9de_572e856b5561 WHERE x &lt; 10&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check table_e14b1d6b_3423_11ed_b9de_572e856b5561 is empty
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_e14b1d6b_3423_11ed_b9de_572e856b5561 WHERE x &lt; 10 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_e14b1d6b_3423_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_e14b1d6b_3423_11ed_b9de_572e856b5561 WHERE x &lt; 10 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_e14b1d6b_3423_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_e14b1d6b_3423_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">17s 881ms</span>/lightweight delete/basic checks/one million datapoints/delete zero rows</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete zero rows</span>
        Check that DELETE can remove zero rows.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_ecddfc84_3423_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_ecddfc84_3423_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert one million entries
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_ecddfc84_3423_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmprfcwp1rg
            cat &quot;/tmp/tmprfcwp1rg&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I record the table data
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_ecddfc84_3423_11ed_b9de_572e856b5561 FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I delete zero rows from table_ecddfc84_3423_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_ecddfc84_3423_11ed_b9de_572e856b5561 WHERE id &lt; -1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check table_ecddfc84_3423_11ed_b9de_572e856b5561 is empty
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_ecddfc84_3423_11ed_b9de_572e856b5561 FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_ecddfc84_3423_11ed_b9de_572e856b5561 FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_ecddfc84_3423_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">13s 925ms</span>/lightweight delete/basic checks/many partition mixed parts/delete all rows</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete all rows</span>
        Check that DELETE can remove all rows.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_f79f4f6e_3423_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_f79f4f6e_3423_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert one large part
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_f79f4f6e_3423_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmp2oypkms1
            cat &quot;/tmp/tmp2oypkms1&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;10000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I insert many small parts
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_f79f4f6e_3423_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmp833bj2hd
            cat &quot;/tmp/tmp833bj2hd&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;10&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I delete all rows from table_f79f4f6e_3423_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_f79f4f6e_3423_11ed_b9de_572e856b5561 WHERE id &gt; -1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check table_f79f4f6e_3423_11ed_b9de_572e856b5561 is empty
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_f79f4f6e_3423_11ed_b9de_572e856b5561 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_f79f4f6e_3423_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_f79f4f6e_3423_11ed_b9de_572e856b5561 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_f79f4f6e_3423_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_f79f4f6e_3423_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">15s 385ms</span>/lightweight delete/basic checks/many partition mixed parts/delete all rows from half of parts</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete all rows from half of parts</span>
        Check that DELETE can remove all rows from half of the parts.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_ffeb03b2_3423_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_ffeb03b2_3423_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert one large part
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_ffeb03b2_3423_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpgdjk6xwr
            cat &quot;/tmp/tmpgdjk6xwr&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;10000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I insert many small parts
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_ffeb03b2_3423_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpskubn2g7
            cat &quot;/tmp/tmpskubn2g7&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;10&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_ffeb03b2_3423_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_ffeb03b2_3423_11ed_b9de_572e856b5561 WHERE id &lt; 5&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        When</span> I delete all rows from table_ffeb03b2_3423_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_ffeb03b2_3423_11ed_b9de_572e856b5561 WHERE id &lt; 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check table_ffeb03b2_3423_11ed_b9de_572e856b5561 is empty
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_ffeb03b2_3423_11ed_b9de_572e856b5561 WHERE id &lt; 5 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_ffeb03b2_3423_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_ffeb03b2_3423_11ed_b9de_572e856b5561 WHERE id &lt; 5 ORDER BY id FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_ffeb03b2_3423_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_ffeb03b2_3423_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">19s 324ms</span>/lightweight delete/basic checks/many partition mixed parts/delete large subset</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete large subset</span>
        Check that DELETE can remove a large subset of rows.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_085c4f29_3424_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_085c4f29_3424_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert one large part
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_085c4f29_3424_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpze7gwgzb
            cat &quot;/tmp/tmpze7gwgzb&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;10000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I insert many small parts
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_085c4f29_3424_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpduw23tqm
            cat &quot;/tmp/tmpduw23tqm&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;10&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_085c4f29_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_085c4f29_3424_11ed_b9de_572e856b5561 WHERE x &gt; 10&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        When</span> I delete all rows from table_085c4f29_3424_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_085c4f29_3424_11ed_b9de_572e856b5561 WHERE x &gt; 10&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check table_085c4f29_3424_11ed_b9de_572e856b5561 is empty
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_085c4f29_3424_11ed_b9de_572e856b5561 WHERE x &gt; 10 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_085c4f29_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_085c4f29_3424_11ed_b9de_572e856b5561 WHERE x &gt; 10 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_085c4f29_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_085c4f29_3424_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">15s 864ms</span>/lightweight delete/basic checks/many partition mixed parts/delete one row</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete one row</span>
        Check that DELETE can remove one row.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_13f430d1_3424_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_13f430d1_3424_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert one large part
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_13f430d1_3424_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpxjrkxn1g
            cat &quot;/tmp/tmpxjrkxn1g&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;10000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I insert many small parts
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_13f430d1_3424_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpp__4ar8x
            cat &quot;/tmp/tmpp__4ar8x&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;10&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_13f430d1_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> I have one distinct row
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO table_13f430d1_3424_11ed_b9de_572e856b5561 VALUES (-1,-1)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I delete the row
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_13f430d1_3424_11ed_b9de_572e856b5561 WHERE id &lt; 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check the table is the same as before the insert
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_13f430d1_3424_11ed_b9de_572e856b5561 WHERE id &lt; 0 ORDER BY id FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_13f430d1_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_13f430d1_3424_11ed_b9de_572e856b5561 WHERE id &lt; 0 ORDER BY id FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_13f430d1_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_13f430d1_3424_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">13s 713ms</span>/lightweight delete/basic checks/many partition mixed parts/delete small subset</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete small subset</span>
        Check that DELETE can remove a small subset of rows.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_1d61707f_3424_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_1d61707f_3424_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert one large part
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_1d61707f_3424_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmposrbd02s
            cat &quot;/tmp/tmposrbd02s&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;10000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I insert many small parts
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_1d61707f_3424_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmp61dgm1b5
            cat &quot;/tmp/tmp61dgm1b5&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;10&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_1d61707f_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_1d61707f_3424_11ed_b9de_572e856b5561 WHERE x &lt; 10&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        When</span> I delete all rows from table_1d61707f_3424_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_1d61707f_3424_11ed_b9de_572e856b5561 WHERE x &lt; 10&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check table_1d61707f_3424_11ed_b9de_572e856b5561 is empty
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_1d61707f_3424_11ed_b9de_572e856b5561 WHERE x &lt; 10 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_1d61707f_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_1d61707f_3424_11ed_b9de_572e856b5561 WHERE x &lt; 10 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_1d61707f_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_1d61707f_3424_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">18s 727ms</span>/lightweight delete/basic checks/many partition mixed parts/delete zero rows</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete zero rows</span>
        Check that DELETE can remove zero rows.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_25880c19_3424_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_25880c19_3424_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert one large part
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_25880c19_3424_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpazl78gf0
            cat &quot;/tmp/tmpazl78gf0&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;10000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I insert many small parts
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_25880c19_3424_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmp0zmolgbk
            cat &quot;/tmp/tmp0zmolgbk&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;10&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I record the table data
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_25880c19_3424_11ed_b9de_572e856b5561 FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I delete zero rows from table_25880c19_3424_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_25880c19_3424_11ed_b9de_572e856b5561 WHERE id &lt; -1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check table_25880c19_3424_11ed_b9de_572e856b5561 is empty
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_25880c19_3424_11ed_b9de_572e856b5561 FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_25880c19_3424_11ed_b9de_572e856b5561 FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_25880c19_3424_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">18s 937ms</span>/lightweight delete/basic checks/many partition many parts/delete all rows</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete all rows</span>
        Check that DELETE can remove all rows.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_31681dca_3424_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_31681dca_3424_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert some data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_31681dca_3424_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpm97lkwfp
            cat &quot;/tmp/tmpm97lkwfp&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I delete all rows from table_31681dca_3424_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_31681dca_3424_11ed_b9de_572e856b5561 WHERE id &gt; -1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check table_31681dca_3424_11ed_b9de_572e856b5561 is empty
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_31681dca_3424_11ed_b9de_572e856b5561 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_31681dca_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_31681dca_3424_11ed_b9de_572e856b5561 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_31681dca_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_31681dca_3424_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">23s 505ms</span>/lightweight delete/basic checks/many partition many parts/delete all rows from half of parts</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete all rows from half of parts</span>
        Check that DELETE can remove all rows from half of the parts.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_3cb88f9f_3424_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_3cb88f9f_3424_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert some data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_3cb88f9f_3424_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmp33rn765m
            cat &quot;/tmp/tmp33rn765m&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_3cb88f9f_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_3cb88f9f_3424_11ed_b9de_572e856b5561 WHERE id &lt; 5&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        When</span> I delete all rows from table_3cb88f9f_3424_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_3cb88f9f_3424_11ed_b9de_572e856b5561 WHERE id &lt; 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check table_3cb88f9f_3424_11ed_b9de_572e856b5561 is empty
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_3cb88f9f_3424_11ed_b9de_572e856b5561 WHERE id &lt; 5 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_3cb88f9f_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_3cb88f9f_3424_11ed_b9de_572e856b5561 WHERE id &lt; 5 ORDER BY id FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_3cb88f9f_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_3cb88f9f_3424_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">20s 843ms</span>/lightweight delete/basic checks/many partition many parts/delete large subset</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete large subset</span>
        Check that DELETE can remove a large subset of rows.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_4a70dee8_3424_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_4a70dee8_3424_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert some data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_4a70dee8_3424_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmp5l9pw1vf
            cat &quot;/tmp/tmp5l9pw1vf&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_4a70dee8_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_4a70dee8_3424_11ed_b9de_572e856b5561 WHERE x &gt; 10&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        When</span> I delete all rows from table_4a70dee8_3424_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_4a70dee8_3424_11ed_b9de_572e856b5561 WHERE x &gt; 10&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check table_4a70dee8_3424_11ed_b9de_572e856b5561 is empty
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_4a70dee8_3424_11ed_b9de_572e856b5561 WHERE x &gt; 10 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_4a70dee8_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_4a70dee8_3424_11ed_b9de_572e856b5561 WHERE x &gt; 10 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_4a70dee8_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_4a70dee8_3424_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">16s 240ms</span>/lightweight delete/basic checks/many partition many parts/delete one row</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete one row</span>
        Check that DELETE can remove one row.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_56691a8f_3424_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_56691a8f_3424_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert some data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_56691a8f_3424_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpd6386k26
            cat &quot;/tmp/tmpd6386k26&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_56691a8f_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> I have one distinct row
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO table_56691a8f_3424_11ed_b9de_572e856b5561 VALUES (-1,-1)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I delete the row
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_56691a8f_3424_11ed_b9de_572e856b5561 WHERE id &lt; 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check the table is the same as before the insert
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_56691a8f_3424_11ed_b9de_572e856b5561 WHERE id &lt; 0 ORDER BY id FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_56691a8f_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_56691a8f_3424_11ed_b9de_572e856b5561 WHERE id &lt; 0 ORDER BY id FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_56691a8f_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_56691a8f_3424_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">23s 943ms</span>/lightweight delete/basic checks/many partition many parts/delete small subset</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete small subset</span>
        Check that DELETE can remove a small subset of rows.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_6014fdd3_3424_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_6014fdd3_3424_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert some data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_6014fdd3_3424_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmp9pb3fu3r
            cat &quot;/tmp/tmp9pb3fu3r&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_6014fdd3_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_6014fdd3_3424_11ed_b9de_572e856b5561 WHERE x &lt; 10&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        When</span> I delete all rows from table_6014fdd3_3424_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_6014fdd3_3424_11ed_b9de_572e856b5561 WHERE x &lt; 10&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check table_6014fdd3_3424_11ed_b9de_572e856b5561 is empty
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_6014fdd3_3424_11ed_b9de_572e856b5561 WHERE x &lt; 10 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_6014fdd3_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_6014fdd3_3424_11ed_b9de_572e856b5561 WHERE x &lt; 10 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_6014fdd3_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_6014fdd3_3424_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">14s 90ms</span>/lightweight delete/basic checks/many partition many parts/delete zero rows</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete zero rows</span>
        Check that DELETE can remove zero rows.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_6e5be6ef_3424_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_6e5be6ef_3424_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert some data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_6e5be6ef_3424_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpetmwlncd
            cat &quot;/tmp/tmpetmwlncd&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I record the table data
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_6e5be6ef_3424_11ed_b9de_572e856b5561 FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I delete zero rows from table_6e5be6ef_3424_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_6e5be6ef_3424_11ed_b9de_572e856b5561 WHERE id &lt; -1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check table_6e5be6ef_3424_11ed_b9de_572e856b5561 is empty
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_6e5be6ef_3424_11ed_b9de_572e856b5561 FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_6e5be6ef_3424_11ed_b9de_572e856b5561 FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_6e5be6ef_3424_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">17s 915ms</span>/lightweight delete/basic checks/many partition one part/delete all rows</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete all rows</span>
        Check that DELETE can remove all rows.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_76d05cbf_3424_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_76d05cbf_3424_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert some data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_76d05cbf_3424_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmp47pp3c0k
            cat &quot;/tmp/tmp47pp3c0k&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I delete all rows from table_76d05cbf_3424_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_76d05cbf_3424_11ed_b9de_572e856b5561 WHERE id &gt; -1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check table_76d05cbf_3424_11ed_b9de_572e856b5561 is empty
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_76d05cbf_3424_11ed_b9de_572e856b5561 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_76d05cbf_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_76d05cbf_3424_11ed_b9de_572e856b5561 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_76d05cbf_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_76d05cbf_3424_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">13s 732ms</span>/lightweight delete/basic checks/many partition one part/delete all rows from half of parts</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete all rows from half of parts</span>
        Check that DELETE can remove all rows from half of the parts.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_81814e95_3424_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_81814e95_3424_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert some data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_81814e95_3424_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmp40z54k87
            cat &quot;/tmp/tmp40z54k87&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_81814e95_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_81814e95_3424_11ed_b9de_572e856b5561 WHERE id &lt; 5&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        When</span> I delete all rows from table_81814e95_3424_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_81814e95_3424_11ed_b9de_572e856b5561 WHERE id &lt; 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check table_81814e95_3424_11ed_b9de_572e856b5561 is empty
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_81814e95_3424_11ed_b9de_572e856b5561 WHERE id &lt; 5 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_81814e95_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_81814e95_3424_11ed_b9de_572e856b5561 WHERE id &lt; 5 ORDER BY id FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_81814e95_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_81814e95_3424_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">12s 163ms</span>/lightweight delete/basic checks/many partition one part/delete large subset</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete large subset</span>
        Check that DELETE can remove a large subset of rows.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_89adb6d5_3424_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_89adb6d5_3424_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert some data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_89adb6d5_3424_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmp4qhq7v20
            cat &quot;/tmp/tmp4qhq7v20&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_89adb6d5_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_89adb6d5_3424_11ed_b9de_572e856b5561 WHERE x &gt; 10&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        When</span> I delete all rows from table_89adb6d5_3424_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_89adb6d5_3424_11ed_b9de_572e856b5561 WHERE x &gt; 10&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check table_89adb6d5_3424_11ed_b9de_572e856b5561 is empty
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_89adb6d5_3424_11ed_b9de_572e856b5561 WHERE x &gt; 10 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_89adb6d5_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_89adb6d5_3424_11ed_b9de_572e856b5561 WHERE x &gt; 10 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_89adb6d5_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_89adb6d5_3424_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">18s 771ms</span>/lightweight delete/basic checks/many partition one part/delete one row</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete one row</span>
        Check that DELETE can remove one row.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_90ea1ae7_3424_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_90ea1ae7_3424_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert some data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_90ea1ae7_3424_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpyfix_1bj
            cat &quot;/tmp/tmpyfix_1bj&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_90ea1ae7_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> I have one distinct row
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO table_90ea1ae7_3424_11ed_b9de_572e856b5561 VALUES (-1,-1)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I delete the row
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_90ea1ae7_3424_11ed_b9de_572e856b5561 WHERE id &lt; 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check the table is the same as before the insert
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_90ea1ae7_3424_11ed_b9de_572e856b5561 WHERE id &lt; 0 ORDER BY id FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_90ea1ae7_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_90ea1ae7_3424_11ed_b9de_572e856b5561 WHERE id &lt; 0 ORDER BY id FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_90ea1ae7_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_90ea1ae7_3424_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">13s 180ms</span>/lightweight delete/basic checks/many partition one part/delete small subset</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete small subset</span>
        Check that DELETE can remove a small subset of rows.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_9c18fc03_3424_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_9c18fc03_3424_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert some data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_9c18fc03_3424_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpujligvel
            cat &quot;/tmp/tmpujligvel&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_9c18fc03_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_9c18fc03_3424_11ed_b9de_572e856b5561 WHERE x &lt; 10&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        When</span> I delete all rows from table_9c18fc03_3424_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_9c18fc03_3424_11ed_b9de_572e856b5561 WHERE x &lt; 10&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check table_9c18fc03_3424_11ed_b9de_572e856b5561 is empty
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_9c18fc03_3424_11ed_b9de_572e856b5561 WHERE x &lt; 10 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_9c18fc03_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_9c18fc03_3424_11ed_b9de_572e856b5561 WHERE x &lt; 10 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_9c18fc03_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_9c18fc03_3424_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">13s 469ms</span>/lightweight delete/basic checks/many partition one part/delete zero rows</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete zero rows</span>
        Check that DELETE can remove zero rows.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_a3fb88cd_3424_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_a3fb88cd_3424_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert some data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_a3fb88cd_3424_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmp5p2sy1fk
            cat &quot;/tmp/tmp5p2sy1fk&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I record the table data
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_a3fb88cd_3424_11ed_b9de_572e856b5561 FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I delete zero rows from table_a3fb88cd_3424_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_a3fb88cd_3424_11ed_b9de_572e856b5561 WHERE id &lt; -1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check table_a3fb88cd_3424_11ed_b9de_572e856b5561 is empty
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_a3fb88cd_3424_11ed_b9de_572e856b5561 FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_a3fb88cd_3424_11ed_b9de_572e856b5561 FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_a3fb88cd_3424_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">20s 928ms</span>/lightweight delete/basic checks/one partition mixed parts/delete all rows</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete all rows</span>
        Check that DELETE can remove all rows.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_acc437cf_3424_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_acc437cf_3424_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert one large part
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_acc437cf_3424_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmp2pkqqqp0
            cat &quot;/tmp/tmp2pkqqqp0&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I insert many small parts
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_acc437cf_3424_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpa_p_p_lt
            cat &quot;/tmp/tmpa_p_p_lt&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;10&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I delete all rows from table_acc437cf_3424_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_acc437cf_3424_11ed_b9de_572e856b5561 WHERE id &gt; -1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check table_acc437cf_3424_11ed_b9de_572e856b5561 is empty
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_acc437cf_3424_11ed_b9de_572e856b5561 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_acc437cf_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_acc437cf_3424_11ed_b9de_572e856b5561 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_acc437cf_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_acc437cf_3424_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">14s 615ms</span>/lightweight delete/basic checks/one partition mixed parts/delete all rows from half of parts</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete all rows from half of parts</span>
        Check that DELETE can remove all rows from half of the parts.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_b944a638_3424_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_b944a638_3424_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert one large part
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_b944a638_3424_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmp7lljvnpx
            cat &quot;/tmp/tmp7lljvnpx&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I insert many small parts
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_b944a638_3424_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpz31jq3g6
            cat &quot;/tmp/tmpz31jq3g6&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;10&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_b944a638_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_b944a638_3424_11ed_b9de_572e856b5561 WHERE id &lt; 5&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        When</span> I delete all rows from table_b944a638_3424_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_b944a638_3424_11ed_b9de_572e856b5561 WHERE id &lt; 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check table_b944a638_3424_11ed_b9de_572e856b5561 is empty
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_b944a638_3424_11ed_b9de_572e856b5561 WHERE id &lt; 5 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_b944a638_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_b944a638_3424_11ed_b9de_572e856b5561 WHERE id &lt; 5 ORDER BY id FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_b944a638_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_b944a638_3424_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">13s 729ms</span>/lightweight delete/basic checks/one partition mixed parts/delete large subset</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete large subset</span>
        Check that DELETE can remove a large subset of rows.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_c1322023_3424_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_c1322023_3424_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert one large part
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_c1322023_3424_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpvpsfyuzr
            cat &quot;/tmp/tmpvpsfyuzr&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I insert many small parts
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_c1322023_3424_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpjlxzebzh
            cat &quot;/tmp/tmpjlxzebzh&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;10&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_c1322023_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_c1322023_3424_11ed_b9de_572e856b5561 WHERE x &gt; 10&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        When</span> I delete all rows from table_c1322023_3424_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_c1322023_3424_11ed_b9de_572e856b5561 WHERE x &gt; 10&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check table_c1322023_3424_11ed_b9de_572e856b5561 is empty
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_c1322023_3424_11ed_b9de_572e856b5561 WHERE x &gt; 10 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_c1322023_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_c1322023_3424_11ed_b9de_572e856b5561 WHERE x &gt; 10 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_c1322023_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_c1322023_3424_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">19s 286ms</span>/lightweight delete/basic checks/one partition mixed parts/delete one row</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete one row</span>
        Check that DELETE can remove one row.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_c95f0685_3424_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_c95f0685_3424_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert one large part
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_c95f0685_3424_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpfjm77fc9
            cat &quot;/tmp/tmpfjm77fc9&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I insert many small parts
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_c95f0685_3424_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpryhfx8dn
            cat &quot;/tmp/tmpryhfx8dn&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;10&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_c95f0685_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> I have one distinct row
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO table_c95f0685_3424_11ed_b9de_572e856b5561 VALUES (-1,-1)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I delete the row
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_c95f0685_3424_11ed_b9de_572e856b5561 WHERE id &lt; 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check the table is the same as before the insert
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_c95f0685_3424_11ed_b9de_572e856b5561 WHERE id &lt; 0 ORDER BY id FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_c95f0685_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_c95f0685_3424_11ed_b9de_572e856b5561 WHERE id &lt; 0 ORDER BY id FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_c95f0685_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_c95f0685_3424_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">16s 166ms</span>/lightweight delete/basic checks/one partition mixed parts/delete small subset</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete small subset</span>
        Check that DELETE can remove a small subset of rows.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_d4e0a559_3424_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_d4e0a559_3424_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert one large part
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_d4e0a559_3424_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmp73z4vyto
            cat &quot;/tmp/tmp73z4vyto&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I insert many small parts
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_d4e0a559_3424_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpp_t8hwfj
            cat &quot;/tmp/tmpp_t8hwfj&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;10&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_d4e0a559_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_d4e0a559_3424_11ed_b9de_572e856b5561 WHERE x &lt; 10&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        When</span> I delete all rows from table_d4e0a559_3424_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_d4e0a559_3424_11ed_b9de_572e856b5561 WHERE x &lt; 10&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check table_d4e0a559_3424_11ed_b9de_572e856b5561 is empty
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_d4e0a559_3424_11ed_b9de_572e856b5561 WHERE x &lt; 10 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_d4e0a559_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_d4e0a559_3424_11ed_b9de_572e856b5561 WHERE x &lt; 10 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_d4e0a559_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_d4e0a559_3424_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">13s 484ms</span>/lightweight delete/basic checks/one partition mixed parts/delete zero rows</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete zero rows</span>
        Check that DELETE can remove zero rows.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_de827295_3424_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_de827295_3424_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert one large part
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_de827295_3424_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpj1s6ilna
            cat &quot;/tmp/tmpj1s6ilna&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I insert many small parts
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_de827295_3424_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpd_u1ue7f
            cat &quot;/tmp/tmpd_u1ue7f&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;10&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I record the table data
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_de827295_3424_11ed_b9de_572e856b5561 FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I delete zero rows from table_de827295_3424_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_de827295_3424_11ed_b9de_572e856b5561 WHERE id &lt; -1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check table_de827295_3424_11ed_b9de_572e856b5561 is empty
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_de827295_3424_11ed_b9de_572e856b5561 FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_de827295_3424_11ed_b9de_572e856b5561 FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_de827295_3424_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">19s 777ms</span>/lightweight delete/basic checks/one partition many parts/delete all rows</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete all rows</span>
        Check that DELETE can remove all rows.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_e735b59a_3424_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_e735b59a_3424_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert some data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_e735b59a_3424_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpzhxh3rcr
            cat &quot;/tmp/tmpzhxh3rcr&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I delete all rows from table_e735b59a_3424_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_e735b59a_3424_11ed_b9de_572e856b5561 WHERE id &gt; -1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check table_e735b59a_3424_11ed_b9de_572e856b5561 is empty
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_e735b59a_3424_11ed_b9de_572e856b5561 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_e735b59a_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_e735b59a_3424_11ed_b9de_572e856b5561 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_e735b59a_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_e735b59a_3424_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">16s 77ms</span>/lightweight delete/basic checks/one partition many parts/delete all rows from half of parts</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete all rows from half of parts</span>
        Check that DELETE can remove all rows from half of the parts.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_f3188098_3424_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_f3188098_3424_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert some data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_f3188098_3424_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpdrqvhd0r
            cat &quot;/tmp/tmpdrqvhd0r&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_f3188098_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_f3188098_3424_11ed_b9de_572e856b5561 WHERE id &lt; 5&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        When</span> I delete all rows from table_f3188098_3424_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_f3188098_3424_11ed_b9de_572e856b5561 WHERE id &lt; 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check table_f3188098_3424_11ed_b9de_572e856b5561 is empty
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_f3188098_3424_11ed_b9de_572e856b5561 WHERE id &lt; 5 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_f3188098_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_f3188098_3424_11ed_b9de_572e856b5561 WHERE id &lt; 5 ORDER BY id FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_f3188098_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_f3188098_3424_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">18s 405ms</span>/lightweight delete/basic checks/one partition many parts/delete large subset</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete large subset</span>
        Check that DELETE can remove a large subset of rows.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_fca1ee0f_3424_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_fca1ee0f_3424_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert some data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_fca1ee0f_3424_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpd8_qm2lm
            cat &quot;/tmp/tmpd8_qm2lm&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_fca1ee0f_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_fca1ee0f_3424_11ed_b9de_572e856b5561 WHERE x &gt; 10&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        When</span> I delete all rows from table_fca1ee0f_3424_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_fca1ee0f_3424_11ed_b9de_572e856b5561 WHERE x &gt; 10&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check table_fca1ee0f_3424_11ed_b9de_572e856b5561 is empty
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_fca1ee0f_3424_11ed_b9de_572e856b5561 WHERE x &gt; 10 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_fca1ee0f_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_fca1ee0f_3424_11ed_b9de_572e856b5561 WHERE x &gt; 10 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_fca1ee0f_3424_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_fca1ee0f_3424_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">13s 380ms</span>/lightweight delete/basic checks/one partition many parts/delete one row</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete one row</span>
        Check that DELETE can remove one row.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_06daaaaf_3425_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_06daaaaf_3425_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert some data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_06daaaaf_3425_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpqk8u7n19
            cat &quot;/tmp/tmpqk8u7n19&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_06daaaaf_3425_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> I have one distinct row
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO table_06daaaaf_3425_11ed_b9de_572e856b5561 VALUES (-1,-1)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I delete the row
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_06daaaaf_3425_11ed_b9de_572e856b5561 WHERE id &lt; 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check the table is the same as before the insert
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_06daaaaf_3425_11ed_b9de_572e856b5561 WHERE id &lt; 0 ORDER BY id FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_06daaaaf_3425_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_06daaaaf_3425_11ed_b9de_572e856b5561 WHERE id &lt; 0 ORDER BY id FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_06daaaaf_3425_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_06daaaaf_3425_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">14s 247ms</span>/lightweight delete/basic checks/one partition many parts/delete small subset</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete small subset</span>
        Check that DELETE can remove a small subset of rows.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_0eded091_3425_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_0eded091_3425_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert some data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_0eded091_3425_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpi0t07p4e
            cat &quot;/tmp/tmpi0t07p4e&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_0eded091_3425_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_0eded091_3425_11ed_b9de_572e856b5561 WHERE x &lt; 10&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        When</span> I delete all rows from table_0eded091_3425_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_0eded091_3425_11ed_b9de_572e856b5561 WHERE x &lt; 10&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check table_0eded091_3425_11ed_b9de_572e856b5561 is empty
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_0eded091_3425_11ed_b9de_572e856b5561 WHERE x &lt; 10 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_0eded091_3425_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_0eded091_3425_11ed_b9de_572e856b5561 WHERE x &lt; 10 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_0eded091_3425_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_0eded091_3425_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">13s 279ms</span>/lightweight delete/basic checks/one partition many parts/delete zero rows</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete zero rows</span>
        Check that DELETE can remove zero rows.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_181114e1_3425_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_181114e1_3425_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert some data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_181114e1_3425_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpe3ojcfab
            cat &quot;/tmp/tmpe3ojcfab&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I record the table data
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_181114e1_3425_11ed_b9de_572e856b5561 FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I delete zero rows from table_181114e1_3425_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_181114e1_3425_11ed_b9de_572e856b5561 WHERE id &lt; -1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check table_181114e1_3425_11ed_b9de_572e856b5561 is empty
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_181114e1_3425_11ed_b9de_572e856b5561 FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_181114e1_3425_11ed_b9de_572e856b5561 FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_181114e1_3425_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">18s 736ms</span>/lightweight delete/basic checks/one partition one part/delete all rows</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete all rows</span>
        Check that DELETE can remove all rows.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_1f449e83_3425_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_1f449e83_3425_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert some data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_1f449e83_3425_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpc9uykase
            cat &quot;/tmp/tmpc9uykase&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I delete all rows from table_1f449e83_3425_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_1f449e83_3425_11ed_b9de_572e856b5561 WHERE id &gt; -1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check table_1f449e83_3425_11ed_b9de_572e856b5561 is empty
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_1f449e83_3425_11ed_b9de_572e856b5561 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_1f449e83_3425_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_1f449e83_3425_11ed_b9de_572e856b5561 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_1f449e83_3425_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_1f449e83_3425_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">15s 702ms</span>/lightweight delete/basic checks/one partition one part/delete all rows from half of parts</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete all rows from half of parts</span>
        Check that DELETE can remove all rows from half of the parts.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_2b2687b9_3425_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_2b2687b9_3425_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert some data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_2b2687b9_3425_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpwl5fgzyv
            cat &quot;/tmp/tmpwl5fgzyv&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_2b2687b9_3425_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_2b2687b9_3425_11ed_b9de_572e856b5561 WHERE id &lt; 5&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        When</span> I delete all rows from table_2b2687b9_3425_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_2b2687b9_3425_11ed_b9de_572e856b5561 WHERE id &lt; 5&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check table_2b2687b9_3425_11ed_b9de_572e856b5561 is empty
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_2b2687b9_3425_11ed_b9de_572e856b5561 WHERE id &lt; 5 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_2b2687b9_3425_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_2b2687b9_3425_11ed_b9de_572e856b5561 WHERE id &lt; 5 ORDER BY id FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_2b2687b9_3425_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_2b2687b9_3425_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">19s 163ms</span>/lightweight delete/basic checks/one partition one part/delete large subset</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete large subset</span>
        Check that DELETE can remove a large subset of rows.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_33c057ef_3425_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_33c057ef_3425_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert some data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_33c057ef_3425_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmptddly67c
            cat &quot;/tmp/tmptddly67c&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_33c057ef_3425_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_33c057ef_3425_11ed_b9de_572e856b5561 WHERE x &gt; 10&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        When</span> I delete all rows from table_33c057ef_3425_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_33c057ef_3425_11ed_b9de_572e856b5561 WHERE x &gt; 10&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check table_33c057ef_3425_11ed_b9de_572e856b5561 is empty
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_33c057ef_3425_11ed_b9de_572e856b5561 WHERE x &gt; 10 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_33c057ef_3425_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_33c057ef_3425_11ed_b9de_572e856b5561 WHERE x &gt; 10 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_33c057ef_3425_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_33c057ef_3425_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">13s 519ms</span>/lightweight delete/basic checks/one partition one part/delete one row</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete one row</span>
        Check that DELETE can remove one row.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_3ffbbe48_3425_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_3ffbbe48_3425_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert some data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_3ffbbe48_3425_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmp5z18ry8p
            cat &quot;/tmp/tmp5z18ry8p&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_3ffbbe48_3425_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> I have one distinct row
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO table_3ffbbe48_3425_11ed_b9de_572e856b5561 VALUES (-1,-1)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I delete the row
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_3ffbbe48_3425_11ed_b9de_572e856b5561 WHERE id &lt; 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check the table is the same as before the insert
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_3ffbbe48_3425_11ed_b9de_572e856b5561 WHERE id &lt; 0 ORDER BY id FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_3ffbbe48_3425_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_3ffbbe48_3425_11ed_b9de_572e856b5561 WHERE id &lt; 0 ORDER BY id FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_3ffbbe48_3425_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_3ffbbe48_3425_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">15s 620ms</span>/lightweight delete/basic checks/one partition one part/delete small subset</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete small subset</span>
        Check that DELETE can remove a small subset of rows.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_474855ab_3425_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_474855ab_3425_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert some data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_474855ab_3425_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpkb1l7r1e
            cat &quot;/tmp/tmpkb1l7r1e&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_474855ab_3425_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_474855ab_3425_11ed_b9de_572e856b5561 WHERE x &lt; 10&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        When</span> I delete all rows from table_474855ab_3425_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_474855ab_3425_11ed_b9de_572e856b5561 WHERE x &lt; 10&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check table_474855ab_3425_11ed_b9de_572e856b5561 is empty
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_474855ab_3425_11ed_b9de_572e856b5561 WHERE x &lt; 10 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_474855ab_3425_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT * FROM table_474855ab_3425_11ed_b9de_572e856b5561 WHERE x &lt; 10 ORDER BY id, x FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check row count after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_474855ab_3425_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_474855ab_3425_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">19s 369ms</span>/lightweight delete/basic checks/one partition one part/delete zero rows</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> delete zero rows</span>
        Check that DELETE can remove zero rows.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_514d04bd_3425_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_514d04bd_3425_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert some data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_514d04bd_3425_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpyzabuch9
            cat &quot;/tmp/tmpyzabuch9&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I record the table data
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_514d04bd_3425_11ed_b9de_572e856b5561 FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I delete zero rows from table_514d04bd_3425_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_514d04bd_3425_11ed_b9de_572e856b5561 WHERE id &lt; -1&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check table_514d04bd_3425_11ed_b9de_572e856b5561 is empty
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_514d04bd_3425_11ed_b9de_572e856b5561 FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I restart clickhouse
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            cat /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MOVES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM STOP MERGES&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SYSTEM FLUSH LOGS&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> waiting for 5 sec for moves and merges to stop
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> forcing to sync everything to disk
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              sync
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> exitcode should be 0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> sending kill -TERM to ClickHouse server process on clickhouse1
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              ls /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              cat /tmp/clickhouse-server.pid
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> checking pid does not exist
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, pid still alive
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> deleting ClickHouse server pid file
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            ls /tmp/clickhouse-server.pid
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> starting ClickHouse server process
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          By</span> checking that ClickHouse server pid file was created
<span class="ro">          OK</span>
            Retry try #0
<span class="ro">            OK</span><span class="k"></span>
<span class="k">          By</span> waiting until ClickHouse server on clickhouse1 is healthy
<span class="ro">          OK</span>
            Retry try #0
<span class="rf">            Fail</span> try #0, ClickHouse server is not healthy
            Retry try #1
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Then</span> I check the data is not changed after restart
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_514d04bd_3425_11ed_b9de_572e856b5561 FORMAT JSONEachRow&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_514d04bd_3425_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<section class="requirement"><span class="requirement-inline"><i class="utf-icon color-ok">✔</i>RQ.SRS-023.ClickHouse.LightweightDelete.NonDeterministicFunctions</span></section>

<div class="requirement-description hidden">

<p><a target="_blank" rel="nofollow noopener noreferrer" href="https://clickhouse.yandex">ClickHouse</a> SHALL support delete statement with non deterministic functions in the <code>WHERE</code> condition.</p>

</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">3s 28ms</span>/lightweight delete/non deterministic functions/nondeterministic function</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">    </span><span class="kn">Scenario</span><span class="nn"> nondeterministic function</span>
      Check that clickhouse support delete statement when where clause contains
      nondeterministic function now().
<span class="k">      Given</span> I have a table
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        Given</span> I have a table table_f454f24b_3418_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_f454f24b_3418_11ed_b9de_572e856b5561  (id Int64, x Int64, d DateTime) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">      When</span> I insert data into the table
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO table_f454f24b_3418_11ed_b9de_572e856b5561 VALUES (1, 1, toDateTime(1663151730.4787302))&quot; | clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO table_f454f24b_3418_11ed_b9de_572e856b5561 VALUES (2, 2, toDateTime(1663149870.4787302))&quot; | clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO table_f454f24b_3418_11ed_b9de_572e856b5561 VALUES (3, 3, toDateTime(1663148010.4787302))&quot; | clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO table_f454f24b_3418_11ed_b9de_572e856b5561 VALUES (4, 4, toDateTime(1663146150.4787302))&quot; | clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO table_f454f24b_3418_11ed_b9de_572e856b5561 VALUES (5, 5, toDateTime(1663144290.4787302))&quot; | clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO table_f454f24b_3418_11ed_b9de_572e856b5561 VALUES (6, 6, toDateTime(1663142430.4787302))&quot; | clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO table_f454f24b_3418_11ed_b9de_572e856b5561 VALUES (7, 7, toDateTime(1663140570.4787302))&quot; | clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO table_f454f24b_3418_11ed_b9de_572e856b5561 VALUES (8, 8, toDateTime(1663138710.4787302))&quot; | clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO table_f454f24b_3418_11ed_b9de_572e856b5561 VALUES (9, 9, toDateTime(1663136850.4787302))&quot; | clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO table_f454f24b_3418_11ed_b9de_572e856b5561 VALUES (10, 10, toDateTime(1663134990.4787302))&quot; | clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO table_f454f24b_3418_11ed_b9de_572e856b5561 VALUES (11, 11, toDateTime(1663133130.4787302))&quot; | clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO table_f454f24b_3418_11ed_b9de_572e856b5561 VALUES (12, 12, toDateTime(1663131270.4787302))&quot; | clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO table_f454f24b_3418_11ed_b9de_572e856b5561 VALUES (13, 13, toDateTime(1663129410.4787302))&quot; | clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO table_f454f24b_3418_11ed_b9de_572e856b5561 VALUES (14, 14, toDateTime(1663127550.4787302))&quot; | clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO table_f454f24b_3418_11ed_b9de_572e856b5561 VALUES (15, 15, toDateTime(1663125690.4787302))&quot; | clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO table_f454f24b_3418_11ed_b9de_572e856b5561 VALUES (16, 16, toDateTime(1663123830.4787302))&quot; | clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO table_f454f24b_3418_11ed_b9de_572e856b5561 VALUES (17, 17, toDateTime(1663121970.4787302))&quot; | clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO table_f454f24b_3418_11ed_b9de_572e856b5561 VALUES (18, 18, toDateTime(1663120110.4787302))&quot; | clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO table_f454f24b_3418_11ed_b9de_572e856b5561 VALUES (19, 19, toDateTime(1663118250.4787302))&quot; | clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO table_f454f24b_3418_11ed_b9de_572e856b5561 VALUES (20, 20, toDateTime(1663116390.4787302))&quot; | clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO table_f454f24b_3418_11ed_b9de_572e856b5561 VALUES (21, 21, toDateTime(1663114530.4787302))&quot; | clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO table_f454f24b_3418_11ed_b9de_572e856b5561 VALUES (22, 22, toDateTime(1663112670.4787302))&quot; | clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO table_f454f24b_3418_11ed_b9de_572e856b5561 VALUES (23, 23, toDateTime(1663110810.4787302))&quot; | clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO table_f454f24b_3418_11ed_b9de_572e856b5561 VALUES (24, 24, toDateTime(1663108950.4787302))&quot; | clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO table_f454f24b_3418_11ed_b9de_572e856b5561 VALUES (25, 25, toDateTime(1663107090.4787302))&quot; | clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO table_f454f24b_3418_11ed_b9de_572e856b5561 VALUES (26, 26, toDateTime(1663105230.4787302))&quot; | clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO table_f454f24b_3418_11ed_b9de_572e856b5561 VALUES (27, 27, toDateTime(1663103370.4787302))&quot; | clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO table_f454f24b_3418_11ed_b9de_572e856b5561 VALUES (28, 28, toDateTime(1663101510.4787302))&quot; | clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO table_f454f24b_3418_11ed_b9de_572e856b5561 VALUES (29, 29, toDateTime(1663099650.4787302))&quot; | clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;INSERT INTO table_f454f24b_3418_11ed_b9de_572e856b5561 VALUES (30, 30, toDateTime(1663097790.4787302))&quot; | clickhouse client -n --max_block_size &quot;1000&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">      When</span> I delete rows from the table using nondeterministic function
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_f454f24b_3418_11ed_b9de_572e856b5561 WHERE  toInt64(d) &lt; toInt64(now()) - 27900&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">      Then</span> I check that rows are deleted
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_f454f24b_3418_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">      Finally</span> I clean up
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        Finally</span> I remove the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_f454f24b_3418_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
<span class="ro">    OK</span>
</code></pre></div>


</div>

<section class="requirement"><span class="requirement-inline"><i class="utf-icon color-ok">✔</i>RQ.SRS-023.ClickHouse.LightweightDelete.LackOfDiskSpace</span></section>

<div class="requirement-description hidden">

<p><a target="_blank" rel="nofollow noopener noreferrer" href="https://clickhouse.yandex">ClickHouse</a> SHALL reserve space to avoid breaking in the middle.</p>

</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">46s 353ms</span>/lightweight delete/lack of disk space</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">  </span><span class="kn">Feature</span><span class="nn"> lack of disk space</span>
    Check that clickhouse reserve space to avoid breaking in the middle.
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> lack of disk space</span>
      Check that clickhouse reserve space to avoid breaking in the middle.
      I fill the disk and delete insert the data in loop until the error and
      check the state of the table in the end when table stored on the disk.
<span class="ro">    OK</span><span class="k"></span>
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> lack of disk space tiered storage</span>
      Check that clickhouse reserve space to avoid breaking in the middle.
      I fill the disk and delete insert the data in loop until the error and
      check the state of the table in the end when table stored on two disks.
<span class="ro">    OK</span>
<span class="ro">  OK</span>
</code></pre></div>


</div>

<section class="requirement"><span class="requirement-inline"><i class="utf-icon color-ok">✔</i>RQ.SRS-023.ClickHouse.LightweightDelete.MultidiskConfigurations</span></section>

<div class="requirement-description hidden">

<p><a target="_blank" rel="nofollow noopener noreferrer" href="https://clickhouse.yandex">ClickHouse</a> SHALL store the masks used for <code>DELETE</code> on the same disks as the parts.</p>

</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">22s 682ms</span>/lightweight delete/multi disk</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">  </span><span class="kn">Feature</span><span class="nn"> multi disk</span>
    Check ClickHouse supports policies with different number of
    disks in one volume, and with different disks configurations.
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> multi disk volume</span>
      Check ClickHouse supports policies with different number of
      disks in one volume, and with different disks configurations.
<span class="ro">    OK</span>
<span class="ro">  OK</span>
</code></pre></div>


</div>

<section class="requirement"><span class="requirement-inline"><i class="utf-icon color-ok">✔</i>RQ.SRS-023.ClickHouse.LightweightDelete.S3Disks</span></section>

<div class="requirement-description hidden">

<p><a target="_blank" rel="nofollow noopener noreferrer" href="https://clickhouse.yandex">ClickHouse</a> SHALL support using <code>DELETE</code> on S3 disks.</p>

</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">18s 306ms</span>/lightweight delete/s3</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">  </span><span class="kn">Feature</span><span class="nn"> s3</span>
    Check that clickhouse support using DELETE on S3 disks.
<span class="k">    </span><span class="kn">Scenario</span><span class="nn"> s3</span>
      Check that clickhouse support using DELETE on S3 disks.
<span class="ro">    OK</span>
<span class="ro">  OK</span>
</code></pre></div>


</div>

<section class="requirement"><span class="requirement-inline"><i class="utf-icon color-error">✎</i>RQ.SRS-023.ClickHouse.LightweightDelete.Backups.Mask</span></section>

<div class="requirement-description hidden">

<p><a target="_blank" rel="nofollow noopener noreferrer" href="https://clickhouse.yandex">ClickHouse</a> SHALL keep masks during backups and finish executing any running <code>DELETE</code> queries.</p>

</div>

<div class="no-tests">
<span class="result-inline">✎</span>
No tests
</div>

<section class="requirement"><span class="requirement-inline"><i class="utf-icon color-error">✎</i>RQ.SRS-023.ClickHouse.LightweightDelete.Backups.BackupAfterLightweightDelete</span></section>

<div class="requirement-description hidden">

<p><a target="_blank" rel="nofollow noopener noreferrer" href="https://clickhouse.yandex">ClickHouse</a> SHALL support backups for tables that have deleted rows.</p>

</div>

<div class="no-tests">
<span class="result-inline">✎</span>
No tests
</div>

<section class="requirement"><span class="requirement-inline"><i class="utf-icon color-ok">✔</i>RQ.SRS-023.ClickHouse.LightweightDelete.DropEmptyPart</span></section>

<div class="requirement-description hidden">

<p><a target="_blank" rel="nofollow noopener noreferrer" href="https://clickhouse.yandex">ClickHouse</a> SHALL schedule dropping the part if all of the rows are deleted from the table.</p>

</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">4s 21ms</span>/lightweight delete/drop empty part/drop empty part</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">    </span><span class="kn">Scenario</span><span class="nn"> drop empty part</span>
      Check that clickhouse schedules dropping the part if all of the rows are deleted from this part.
<span class="k">      Given</span> I have a table
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        Given</span> I have a table table_245a416a_340a_11ed_b9de_572e856b5561
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_245a416a_340a_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">      When</span> I insert a lot of data into the table
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          echo -e &quot;INSERT INTO table_245a416a_340a_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpfjmqyxr4
          cat &quot;/tmp/tmpfjmqyxr4&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">      When</span> I check partition 0 exists in the system.parts table
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;SELECT partition FROM system.parts WHERE table = &#39;table_245a416a_340a_11ed_b9de_572e856b5561&#39; and active = 1         ORDER BY partition LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">      Then</span> I delete part 0 and force merges
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_245a416a_340a_11ed_b9de_572e856b5561 WHERE id = 0&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        By</span> executing command
          (set -o pipefail &amp;&amp; echo -e &quot;OPTIMIZE TABLE table_245a416a_340a_11ed_b9de_572e856b5561 FINAL&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">        OK</span><span class="k"></span>
<span class="k">        Then</span> check if output has exception
<span class="ro">        OK</span><span class="k"></span>
<span class="k">      When</span> I check partition is deleted
<span class="ro">      OK</span>
        Retry try #0
<span class="rf">        Fail</span> try #0, AssertionError
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT partition FROM system.parts WHERE table = &#39;table_245a416a_340a_11ed_b9de_572e856b5561&#39; and active = 1                 ORDER BY partition LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #1
<span class="rf">        Fail</span> try #1, AssertionError
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT partition FROM system.parts WHERE table = &#39;table_245a416a_340a_11ed_b9de_572e856b5561&#39; and active = 1                 ORDER BY partition LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
        Retry try #2
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT partition FROM system.parts WHERE table = &#39;table_245a416a_340a_11ed_b9de_572e856b5561&#39; and active = 1                 ORDER BY partition LIMIT 1&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">      Finally</span> I clean up
<span class="ro">      OK</span><span class="k"></span>
<span class="k">        Finally</span> I remove the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_245a416a_340a_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span>
<span class="ro">    OK</span>
</code></pre></div>


</div>

<section class="requirement"><span class="requirement-inline"><i class="utf-icon color-ok">✔</i>RQ.SRS-023.ClickHouse.LightweightDelete.DeletesPerSecond</span></section>

<div class="requirement-description hidden">

<p><a target="_blank" rel="nofollow noopener noreferrer" href="https://clickhouse.yandex">ClickHouse</a> SHALL only run a few <code>DELETE</code> statements per second.</p>

</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">1s 508ms</span>/lightweight delete/multiple delete limitations/MergeTree/multiple delete</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> multiple delete</span>
        Check that clickhouse supports using multiple DELETE statements on the same table.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_bb758125_3407_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_bb758125_3407_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = MergeTree PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert a lot of data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_bb758125_3407_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpn__7vxv2
            cat &quot;/tmp/tmpn__7vxv2&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_bb758125_3407_11ed_b9de_572e856b5561 WHERE NOT(x &lt; 10)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I perform multiple delete
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_bb758125_3407_11ed_b9de_572e856b5561 WHERE  x = 0;DELETE FROM table_bb758125_3407_11ed_b9de_572e856b5561 WHERE  x = 1;DELETE FROM table_bb758125_3407_11ed_b9de_572e856b5561 WHERE  x = 2;DELETE FROM table_bb758125_3407_11ed_b9de_572e856b5561 WHERE  x = 3;DELETE FROM table_bb758125_3407_11ed_b9de_572e856b5561 WHERE  x = 4;DELETE FROM table_bb758125_3407_11ed_b9de_572e856b5561 WHERE  x = 5;DELETE FROM table_bb758125_3407_11ed_b9de_572e856b5561 WHERE  x = 6;DELETE FROM table_bb758125_3407_11ed_b9de_572e856b5561 WHERE  x = 7;DELETE FROM table_bb758125_3407_11ed_b9de_572e856b5561 WHERE  x = 8;DELETE FROM table_bb758125_3407_11ed_b9de_572e856b5561 WHERE  x = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check that rows are deleted
<span class="ro">        OK</span>
          Retry try #0
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_bb758125_3407_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_bb758125_3407_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">1s 510ms</span>/lightweight delete/multiple delete limitations/ReplacingMergeTree/multiple delete</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> multiple delete</span>
        Check that clickhouse supports using multiple DELETE statements on the same table.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_bb75816b_3407_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_bb75816b_3407_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = ReplacingMergeTree() PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert a lot of data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_bb75816b_3407_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpo2z3kzh8
            cat &quot;/tmp/tmpo2z3kzh8&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_bb75816b_3407_11ed_b9de_572e856b5561 WHERE NOT(x &lt; 10)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I perform multiple delete
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_bb75816b_3407_11ed_b9de_572e856b5561 WHERE  x = 0;DELETE FROM table_bb75816b_3407_11ed_b9de_572e856b5561 WHERE  x = 1;DELETE FROM table_bb75816b_3407_11ed_b9de_572e856b5561 WHERE  x = 2;DELETE FROM table_bb75816b_3407_11ed_b9de_572e856b5561 WHERE  x = 3;DELETE FROM table_bb75816b_3407_11ed_b9de_572e856b5561 WHERE  x = 4;DELETE FROM table_bb75816b_3407_11ed_b9de_572e856b5561 WHERE  x = 5;DELETE FROM table_bb75816b_3407_11ed_b9de_572e856b5561 WHERE  x = 6;DELETE FROM table_bb75816b_3407_11ed_b9de_572e856b5561 WHERE  x = 7;DELETE FROM table_bb75816b_3407_11ed_b9de_572e856b5561 WHERE  x = 8;DELETE FROM table_bb75816b_3407_11ed_b9de_572e856b5561 WHERE  x = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check that rows are deleted
<span class="ro">        OK</span>
          Retry try #0
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_bb75816b_3407_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_bb75816b_3407_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">1s 354ms</span>/lightweight delete/multiple delete limitations/SummingMergeTree/multiple delete</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> multiple delete</span>
        Check that clickhouse supports using multiple DELETE statements on the same table.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_bc88a7de_3407_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_bc88a7de_3407_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = SummingMergeTree(x) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert a lot of data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_bc88a7de_3407_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpnmhfw199
            cat &quot;/tmp/tmpnmhfw199&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_bc88a7de_3407_11ed_b9de_572e856b5561 WHERE NOT(x &lt; 10)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I perform multiple delete
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_bc88a7de_3407_11ed_b9de_572e856b5561 WHERE  x = 0;DELETE FROM table_bc88a7de_3407_11ed_b9de_572e856b5561 WHERE  x = 1;DELETE FROM table_bc88a7de_3407_11ed_b9de_572e856b5561 WHERE  x = 2;DELETE FROM table_bc88a7de_3407_11ed_b9de_572e856b5561 WHERE  x = 3;DELETE FROM table_bc88a7de_3407_11ed_b9de_572e856b5561 WHERE  x = 4;DELETE FROM table_bc88a7de_3407_11ed_b9de_572e856b5561 WHERE  x = 5;DELETE FROM table_bc88a7de_3407_11ed_b9de_572e856b5561 WHERE  x = 6;DELETE FROM table_bc88a7de_3407_11ed_b9de_572e856b5561 WHERE  x = 7;DELETE FROM table_bc88a7de_3407_11ed_b9de_572e856b5561 WHERE  x = 8;DELETE FROM table_bc88a7de_3407_11ed_b9de_572e856b5561 WHERE  x = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check that rows are deleted
<span class="ro">        OK</span>
          Retry try #0
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_bc88a7de_3407_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_bc88a7de_3407_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">1s 502ms</span>/lightweight delete/multiple delete limitations/AggregatingMergeTree/multiple delete</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> multiple delete</span>
        Check that clickhouse supports using multiple DELETE statements on the same table.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_bdc3fbd1_3407_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_bdc3fbd1_3407_11ed_b9de_572e856b5561  (id Int64, x Int64) Engine = AggregatingMergeTree() PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert a lot of data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_bdc3fbd1_3407_11ed_b9de_572e856b5561 VALUES (0,0),(0,1),(0,2),(0,3),(0,4),(0,5),(0...&quot; &gt; /tmp/tmpzqqaro57
            cat &quot;/tmp/tmpzqqaro57&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_bdc3fbd1_3407_11ed_b9de_572e856b5561 WHERE NOT(x &lt; 10)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I perform multiple delete
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_bdc3fbd1_3407_11ed_b9de_572e856b5561 WHERE  x = 0;DELETE FROM table_bdc3fbd1_3407_11ed_b9de_572e856b5561 WHERE  x = 1;DELETE FROM table_bdc3fbd1_3407_11ed_b9de_572e856b5561 WHERE  x = 2;DELETE FROM table_bdc3fbd1_3407_11ed_b9de_572e856b5561 WHERE  x = 3;DELETE FROM table_bdc3fbd1_3407_11ed_b9de_572e856b5561 WHERE  x = 4;DELETE FROM table_bdc3fbd1_3407_11ed_b9de_572e856b5561 WHERE  x = 5;DELETE FROM table_bdc3fbd1_3407_11ed_b9de_572e856b5561 WHERE  x = 6;DELETE FROM table_bdc3fbd1_3407_11ed_b9de_572e856b5561 WHERE  x = 7;DELETE FROM table_bdc3fbd1_3407_11ed_b9de_572e856b5561 WHERE  x = 8;DELETE FROM table_bdc3fbd1_3407_11ed_b9de_572e856b5561 WHERE  x = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check that rows are deleted
<span class="ro">        OK</span>
          Retry try #0
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_bdc3fbd1_3407_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_bdc3fbd1_3407_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">6s 845ms</span>/lightweight delete/multiple delete limitations/CollapsingMergeTree/multiple delete</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> multiple delete</span>
        Check that clickhouse supports using multiple DELETE statements on the same table.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_bef4b2a9_3407_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_bef4b2a9_3407_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = CollapsingMergeTree(Sign) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert a lot of data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_bef4b2a9_3407_11ed_b9de_572e856b5561 VALUES (0,0,1),(0,1,1),(0,2,1),(0,3,1),(0,4,1...&quot; &gt; /tmp/tmpz0lqniyn
            cat &quot;/tmp/tmpz0lqniyn&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_bef4b2a9_3407_11ed_b9de_572e856b5561 WHERE NOT(x &lt; 10)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I perform multiple delete
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_bef4b2a9_3407_11ed_b9de_572e856b5561 WHERE  x = 0;DELETE FROM table_bef4b2a9_3407_11ed_b9de_572e856b5561 WHERE  x = 1;DELETE FROM table_bef4b2a9_3407_11ed_b9de_572e856b5561 WHERE  x = 2;DELETE FROM table_bef4b2a9_3407_11ed_b9de_572e856b5561 WHERE  x = 3;DELETE FROM table_bef4b2a9_3407_11ed_b9de_572e856b5561 WHERE  x = 4;DELETE FROM table_bef4b2a9_3407_11ed_b9de_572e856b5561 WHERE  x = 5;DELETE FROM table_bef4b2a9_3407_11ed_b9de_572e856b5561 WHERE  x = 6;DELETE FROM table_bef4b2a9_3407_11ed_b9de_572e856b5561 WHERE  x = 7;DELETE FROM table_bef4b2a9_3407_11ed_b9de_572e856b5561 WHERE  x = 8;DELETE FROM table_bef4b2a9_3407_11ed_b9de_572e856b5561 WHERE  x = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check that rows are deleted
<span class="ro">        OK</span>
          Retry try #0
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_bef4b2a9_3407_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_bef4b2a9_3407_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">1s 509ms</span>/lightweight delete/multiple delete limitations/VersionedCollapsingMergeTree/multiple delete</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> multiple delete</span>
        Check that clickhouse supports using multiple DELETE statements on the same table.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_c30775b1_3407_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_c30775b1_3407_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Sign Int8) Engine = VersionedCollapsingMergeTree(Sign, id) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert a lot of data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_c30775b1_3407_11ed_b9de_572e856b5561 VALUES (0,0,1),(0,1,1),(0,2,1),(0,3,1),(0,4,1...&quot; &gt; /tmp/tmpxqkgi8ud
            cat &quot;/tmp/tmpxqkgi8ud&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_c30775b1_3407_11ed_b9de_572e856b5561 WHERE NOT(x &lt; 10)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I perform multiple delete
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_c30775b1_3407_11ed_b9de_572e856b5561 WHERE  x = 0;DELETE FROM table_c30775b1_3407_11ed_b9de_572e856b5561 WHERE  x = 1;DELETE FROM table_c30775b1_3407_11ed_b9de_572e856b5561 WHERE  x = 2;DELETE FROM table_c30775b1_3407_11ed_b9de_572e856b5561 WHERE  x = 3;DELETE FROM table_c30775b1_3407_11ed_b9de_572e856b5561 WHERE  x = 4;DELETE FROM table_c30775b1_3407_11ed_b9de_572e856b5561 WHERE  x = 5;DELETE FROM table_c30775b1_3407_11ed_b9de_572e856b5561 WHERE  x = 6;DELETE FROM table_c30775b1_3407_11ed_b9de_572e856b5561 WHERE  x = 7;DELETE FROM table_c30775b1_3407_11ed_b9de_572e856b5561 WHERE  x = 8;DELETE FROM table_c30775b1_3407_11ed_b9de_572e856b5561 WHERE  x = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check that rows are deleted
<span class="ro">        OK</span>
          Retry try #0
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_c30775b1_3407_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_c30775b1_3407_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<div class="test"><span class="result result-inline result-ok">OK</span><span class="time time-inline">1s 336ms</span>/lightweight delete/multiple delete limitations/GraphiteMergeTree/multiple delete</div>
<div class="test-procedure hidden">

<div class="highlight"><pre><span></span><code><span class="k">      </span><span class="kn">Scenario</span><span class="nn"> multiple delete</span>
        Check that clickhouse supports using multiple DELETE statements on the same table.
<span class="k">        Given</span> I have a table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Given</span> I have a table table_c3f2803d_3407_11ed_b9de_572e856b5561
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;CREATE TABLE table_c3f2803d_3407_11ed_b9de_572e856b5561  (id Int64, x Int64 ,Path String, Time DateTime, Value Int64, Timestamp Int64) Engine = GraphiteMergeTree(&#39;graphite_rollup_example&#39;) PARTITION BY id ORDER BY id  &quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        When</span> I insert a lot of data into the table
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            echo -e &quot;INSERT INTO table_c3f2803d_3407_11ed_b9de_572e856b5561 VALUES (0,0, &#39;1&#39;, toDateTime(10), 10, 10),(0,...&quot; &gt; /tmp/tmp4dribhgm
            cat &quot;/tmp/tmp4dribhgm&quot; | docker-compose --ansi never --project-directory &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env&quot; --file &quot;/home/antip/job/github/clickhouse-regression/lightweight_delete/lightweight_delete_env/docker-compose.yml&quot; exec -T clickhouse1 bash -c &quot;(set -o pipefail &amp;&amp; clickhouse client -n --max_block_size &quot;100&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)&quot;
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I compute expected output
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_c3f2803d_3407_11ed_b9de_572e856b5561 WHERE NOT(x &lt; 10)&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        When</span> I perform multiple delete
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          By</span> executing command
            (set -o pipefail &amp;&amp; echo -e &quot;DELETE FROM table_c3f2803d_3407_11ed_b9de_572e856b5561 WHERE  x = 0;DELETE FROM table_c3f2803d_3407_11ed_b9de_572e856b5561 WHERE  x = 1;DELETE FROM table_c3f2803d_3407_11ed_b9de_572e856b5561 WHERE  x = 2;DELETE FROM table_c3f2803d_3407_11ed_b9de_572e856b5561 WHERE  x = 3;DELETE FROM table_c3f2803d_3407_11ed_b9de_572e856b5561 WHERE  x = 4;DELETE FROM table_c3f2803d_3407_11ed_b9de_572e856b5561 WHERE  x = 5;DELETE FROM table_c3f2803d_3407_11ed_b9de_572e856b5561 WHERE  x = 6;DELETE FROM table_c3f2803d_3407_11ed_b9de_572e856b5561 WHERE  x = 7;DELETE FROM table_c3f2803d_3407_11ed_b9de_572e856b5561 WHERE  x = 8;DELETE FROM table_c3f2803d_3407_11ed_b9de_572e856b5561 WHERE  x = 9&quot; | clickhouse client -n --mutations_sync &quot;2&quot; --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">          OK</span><span class="k"></span>
<span class="k">          Then</span> check if output has exception
<span class="ro">          OK</span><span class="k"></span>
<span class="k">        Then</span> I check that rows are deleted
<span class="ro">        OK</span>
          Retry try #0
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;SELECT count(*) FROM table_c3f2803d_3407_11ed_b9de_572e856b5561&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span><span class="k"></span>
<span class="k">        Finally</span> I clean up
<span class="ro">        OK</span><span class="k"></span>
<span class="k">          Finally</span> I remove the table
<span class="ro">          OK</span><span class="k"></span>
<span class="k">            By</span> executing command
              (set -o pipefail &amp;&amp; echo -e &quot;DROP TABLE IF EXISTS table_c3f2803d_3407_11ed_b9de_572e856b5561 SYNC&quot; | clickhouse client -n --allow_experimental_lightweight_delete &quot;1&quot; 2&gt;&amp;1 | head -c -0)
<span class="ro">            OK</span><span class="k"></span>
<span class="k">            Then</span> check if output has exception
<span class="ro">            OK</span>
<span class="ro">      OK</span>
</code></pre></div>


</div>

<section class="requirement"><span class="requirement-inline"><i class="utf-icon color-error">✎</i>RQ.SRS-023.ClickHouse.LightweightDelete.UpgradeServer</span></section>

<div class="requirement-description hidden">

<p><a target="_blank" rel="nofollow noopener noreferrer" href="https://clickhouse.yandex">ClickHouse</a> SHALL require servers to upgrade when delete mask format changes.</p>

</div>

<div class="no-tests">
<span class="result-inline">✎</span>
No tests
</div>

<section class="requirement"><span class="requirement-inline"><i class="utf-icon color-error">✎</i>RQ.SRS-023.ClickHouse.LightweightDelete.Load.Merges</span></section>

<div class="requirement-description hidden">

<p><a target="_blank" rel="nofollow noopener noreferrer" href="https://clickhouse.yandex">ClickHouse</a> SHALL perform correctly with concurrent lightweight delete and a lot of merges.</p>

</div>

<div class="no-tests">
<span class="result-inline">✎</span>
No tests
</div>

<section class="requirement"><span class="requirement-inline"><i class="utf-icon color-error">✎</i>RQ.SRS-023.ClickHouse.LightweightDelete.Load.Insert</span></section>

<div class="requirement-description hidden">

<p><a target="_blank" rel="nofollow noopener noreferrer" href="https://clickhouse.yandex">ClickHouse</a> SHALL perform correctly with high insert pressure and lightweight delete.</p>

</div>

<div class="no-tests">
<span class="result-inline">✎</span>
No tests
</div>

<section class="requirement"><span class="requirement-inline"><i class="utf-icon color-error">✎</i>RQ.SRS-023.ClickHouse.LightweightDelete.Load.ExcessiveMutations</span></section>

<div class="requirement-description hidden">

<p><a target="_blank" rel="nofollow noopener noreferrer" href="https://clickhouse.yandex">ClickHouse</a> SHALL not create excessive mutations during lightweight delete operations.</p>

</div>

<div class="no-tests">
<span class="result-inline">✎</span>
No tests
</div>

<section class="requirement"><span class="requirement-inline"><i class="utf-icon color-error">✎</i>RQ.SRS-023.ClickHouse.LightweightDelete.Load.Zookeeper</span></section>

<div class="requirement-description hidden">

<p><a target="_blank" rel="nofollow noopener noreferrer" href="https://clickhouse.yandex">ClickHouse</a> SHALL not create huge transactions in zookeeper during lightweight delete operations.</p>

</div>

<div class="no-tests">
<span class="result-inline">✎</span>
No tests
</div>

<hr />

<p>Generated by <span class="testflows-logo"></span> <a target="_blank" rel="nofollow noopener noreferrer" href="https://testflows.com"><span class="logo-test">Test</span><span class="logo-flows">Flows</span></a> Open-Source Test Framework</p>

<script>

window.onload = function(){
    // Toggle requirement description on click
    document.querySelectorAll('.requirement').forEach(
        function(item){
            item.addEventListener('click', function(){
                item.nextElementSibling.classList.toggle('show');
                item.children[0].classList.toggle('active');
            });
        });

    // Toggle test procedure on click
    document.querySelectorAll('.test').forEach(
        function(item){
            item.addEventListener('click', function(){
                item.nextElementSibling.classList.toggle('show');
                item.classList.toggle('active');
            });
        });
}

</script>

</body>
<script>
var requirements = document.querySelectorAll('h1[id^="rqsrs"],h2[id^="rqsrs"],h3[id^="rqsrs"],h4[id^="rqsrs"],h5[id^="rqsrs"],h6[id^="rqsrs"]');

requirements.forEach(function(item){
  item.addEventListener('click', function(event){
    element = document.querySelector('#table-of-contents + ul a[href="#' + event.target.id + '"]').parentElement;
    element.scrollIntoView({block: "center"});
    element.classList.add("infocus");
    setTimeout(function(){
        element.classList.remove("infocus");
    }, 1500);
  }, false)
});


</script>
</html>